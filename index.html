<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<!-- –ü—É–±–ª–∏—á–Ω—ã–π URL —Ç–≤–æ–µ–≥–æ –±–æ—Ç–∞ –Ω–∞ Railway -->
<meta name="api-base" content="https://lucky-slots-production.up.railway.app">
<title>Lucky Slots</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<style>
/* ... (–≤–µ—Å—å —Ç–≤–æ–π CSS –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π) ... */
@import url('https://fonts.googleapis.com/css2?family=Fredoka+One&family=Nunito:wght@400;700;900&display=swap');
:root { --bg1: #0d001f; --bg2: #1a0040; --gold: #ffd700; --pink: #ff4da6; --cyan: #00f5d4; --win: #00e676; --lose: #ff5252; --wild: #ff9500; --scatter: #ff4da6; }
* { margin:0; padding:0; box-sizing:border-box; -webkit-tap-highlight-color:transparent; }
body { background: radial-gradient(ellipse at 50% 0%, #2d0060, var(--bg1) 65%); min-height: 100vh; font-family: 'Nunito', sans-serif; color: #fff; overflow-x: hidden; user-select: none; }
.stars { position:fixed; inset:0; pointer-events:none; z-index:0; overflow:hidden; }
.star { position:absolute; border-radius:50%; background:#fff; animation: twinkle var(--d) ease-in-out infinite alternate; opacity:0; }
@keyframes twinkle { from { opacity:0; transform:scale(0.5); } to { opacity:0.6; transform:scale(1.2); } }
.wrap { position:relative; z-index:1; max-width:440px; margin:0 auto; padding:10px 8px 24px; display:flex; flex-direction:column; gap:10px; }
.header { display:flex; justify-content:space-between; align-items:center; }
.logo { font-family:'Fredoka One',sans-serif; font-size:22px; background:linear-gradient(135deg,var(--gold),var(--pink)); -webkit-background-clip:text; -webkit-text-fill-color:transparent; filter:drop-shadow(0 0 6px rgba(255,215,0,0.3)); }
.balance-box { background:rgba(255,255,255,0.07); border:1px solid rgba(255,215,0,0.3); border-radius:20px; padding:5px 12px; display:flex; align-items:center; gap:5px; }
.balance-val { font-family:'Fredoka One',sans-serif; font-size:17px; color:var(--gold); }
.info-bar { display:flex; gap:6px; justify-content:center; }
.info-pill { background:rgba(255,255,255,0.06); border:1px solid rgba(255,255,255,0.1); border-radius:12px; padding:4px 10px; font-size:11px; color:rgba(255,255,255,0.6); display:flex; align-items:center; gap:4px; }
.info-pill span { color:#fff; font-weight:700; }
.grid-outer { background:rgba(0,0,0,0.5); border:2px solid rgba(255,215,0,0.2); border-radius:20px; padding:10px 6px; position:relative; overflow:hidden; }
.grid-outer::before { content:''; position:absolute; inset:0; background:linear-gradient(180deg, rgba(0,0,0,0.5) 0%, transparent 15%, transparent 85%, rgba(0,0,0,0.5) 100%); pointer-events:none; z-index:3; }
.grid { display:grid; grid-template-columns:repeat(6, 1fr); grid-template-rows:repeat(5, 1fr); gap:3px; position:relative; z-index:1; }
.cell { width:100%; aspect-ratio:1; display:flex; align-items:center; justify-content:center; font-size:clamp(20px, 5vw, 32px); border-radius:10px; background:rgba(255,255,255,0.04); border:1px solid rgba(255,255,255,0.06); transition:background 0.2s, transform 0.15s; position:relative; overflow:hidden; }
.cell.spinning { animation: cellSpin 0.15s ease-in-out infinite alternate; }
@keyframes cellSpin { from { transform:translateY(-3px); opacity:0.7; } to { transform:translateY(3px); opacity:1; } }
.cell.winning { background:rgba(255,215,0,0.2); border-color:rgba(255,215,0,0.6); animation: winCell 0.4s ease-in-out infinite alternate; z-index:2; }
@keyframes winCell { from { transform:scale(1); box-shadow:0 0 8px rgba(255,215,0,0.3); } to { transform:scale(1.12); box-shadow:0 0 20px rgba(255,215,0,0.7); } }
.cell.wild-cell { background: rgba(255,149,0,0.15); border-color: rgba(255,149,0,0.5); }
.cell.wild-flash { animation: wildFlash 0.6s ease-out forwards; }
@keyframes wildFlash { 0% { background:rgba(255,255,255,0.9); transform:scale(1.3); box-shadow:0 0 30px #fff, 0 0 60px var(--wild); } 30% { background:rgba(255,149,0,0.6); transform:scale(1.15); box-shadow:0 0 20px var(--wild); } 100% { background:rgba(255,149,0,0.15); transform:scale(1); box-shadow:none; } }
.cell.scatter-cell { background: rgba(255,77,166,0.15); border-color: rgba(255,77,166,0.5); }
.cell.scatter-flash { animation: scatterFlash 0.7s ease-out forwards; }
@keyframes scatterFlash { 0% { background:rgba(255,77,166,0.9); transform:scale(1.3) rotate(10deg); box-shadow:0 0 30px var(--scatter); } 40% { background:rgba(255,77,166,0.5); transform:scale(1.1) rotate(-5deg); } 100% { background:rgba(255,77,166,0.15);transform:scale(1) rotate(0deg); box-shadow:none; } }
.scatter-count-badge { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%) scale(0); background: linear-gradient(135deg, var(--scatter), #9b00ff); color: #fff; font-family: 'Fredoka One', sans-serif; font-size: 28px; padding: 16px 28px; border-radius: 20px; border: 2px solid rgba(255,255,255,0.3); box-shadow: 0 0 40px rgba(255,77,166,0.6); z-index: 50; pointer-events: none; text-align: center; animation: scatterPopup 2s ease forwards; }
@keyframes scatterPopup { 0% { transform:translate(-50%,-50%) scale(0); opacity:0; } 15% { transform:translate(-50%,-50%) scale(1.1); opacity:1; } 25% { transform:translate(-50%,-50%) scale(1); opacity:1; } 75% { transform:translate(-50%,-50%) scale(1); opacity:1; } 100% { transform:translate(-50%,-50%) scale(0.8); opacity:0; } }
.result-bar { min-height:36px; display:flex; align-items:center; justify-content:center; }
.result-text { font-family:'Fredoka One',sans-serif; font-size:20px; opacity:0; transform:scale(0.6) translateY(6px); transition:all 0.35s cubic-bezier(0.34,1.56,0.64,1); text-align:center; }
.result-text.show { opacity:1; transform:scale(1) translateY(0); }
.result-text.win { color:var(--win); text-shadow:0 0 16px var(--win); }
.result-text.lose { color:rgba(255,255,255,0.4); font-size:15px; }
.controls { display:flex; gap:8px; align-items:center; }
.bet-wrap { flex:1; }
.bet-label { font-size:10px; color:rgba(255,255,255,0.4); text-transform:uppercase; letter-spacing:1px; margin-bottom:5px; }
.bet-row { display:flex; gap:5px; }
.bet-btn { flex:1; padding:8px 0; border-radius:10px; border:2px solid rgba(255,215,0,0.25); background:rgba(255,215,0,0.06); color:var(--gold); font-family:'Fredoka One',sans-serif; font-size:14px; cursor:pointer; transition:all 0.15s; }
.bet-btn.active { background:rgba(255,215,0,0.2); border-color:var(--gold); }
.spin-btn { width:90px; height:70px; border-radius:16px; border:none; background:linear-gradient(135deg,#ff4da6,#ff9500); color:#fff; font-family:'Fredoka One',sans-serif; font-size:13px; cursor:pointer; transition:all 0.2s; box-shadow:0 5px 20px rgba(255,77,166,0.4); display:flex; flex-direction:column; align-items:center; justify-content:center; gap:2px; line-height:1; }
.spin-btn .spin-icon { font-size:26px; }
.spin-btn:disabled { background:linear-gradient(135deg,#444,#222); box-shadow:none; cursor:not-allowed; opacity:0.7; }
.spin-btn.go { animation:spinBtnGlow 0.8s ease-in-out infinite alternate; }
@keyframes spinBtnGlow { from { box-shadow:0 5px 20px rgba(255,77,166,0.4); } to { box-shadow:0 5px 40px rgba(255,77,166,0.9); } }
.history-wrap { background:rgba(255,255,255,0.03); border-radius:16px; padding:10px 12px; }
.win-overlay { position:fixed; inset:0; display:flex; align-items:center; justify-content:center; z-index:100; pointer-events:none; opacity:0; transition:opacity 0.3s; }
.win-overlay.show { opacity:1; }
.turbo-btn { width:44px; height:70px; border-radius:12px; border:2px solid rgba(255,255,255,0.15); background:rgba(255,255,255,0.06); color:rgba(255,255,255,0.5); font-size:22px; cursor:pointer; display:flex; flex-direction:column; align-items:center; justify-content:center; }
.turbo-btn.active { background:rgba(255,215,0,0.15); border-color:var(--gold); color:var(--gold); }
.confetti { position:fixed; pointer-events:none; z-index:99; border-radius:2px; animation:confettiFall var(--dur) ease-in forwards; }
@keyframes confettiFall { 0%{transform:translateY(-20px) rotate(0);opacity:1} 100%{transform:translateY(100vh) rotate(720deg);opacity:0} }
</style>
</head>
<body>
<div class="stars" id="stars"></div>

<div class="win-overlay" id="winOverlay">
  <div class="win-popup" style="background:radial-gradient(ellipse,#2d0060,#0d001f); border:3px solid var(--gold); border-radius:28px; padding:24px 44px; text-align:center;">
    <div class="win-emoji" style="font-size:48px;">üéâ</div>
    <div class="win-title" style="font-family:'Fredoka One',sans-serif; font-size:28px; color:var(--gold);">WYGRANA!</div>
    <div class="win-amount" id="winAmount" style="font-family:'Fredoka One',sans-serif; font-size:44px; color:var(--win);">+0</div>
  </div>
</div>

<div class="wrap">
  <div class="header">
    <div class="logo">üç≠ Lucky Bonanza</div>
    <div class="balance-box">
      <span>ü™ô</span>
      <span class="balance-val" id="balVal">0</span>
    </div>
  </div>

  <div class="info-bar">
    <div class="info-pill">RTP <span>90%</span></div>
    <div class="info-pill">Pole <span>6√ó5</span></div>
    <div class="info-pill">Max <span>√ó200</span></div>
  </div>

  <div class="grid-outer">
    <div class="grid" id="grid"></div>
  </div>

  <div class="result-bar">
    <div class="result-text" id="resultText"></div>
  </div>

  <div class="controls">
    <div class="bet-wrap">
      <div class="bet-label">Stawka (≈ºetony)</div>
      <div class="bet-row">
        <button class="bet-btn active" data-bet="5" onclick="selectBet(5)">5</button>
        <button class="bet-btn" data-bet="10" onclick="selectBet(10)">10</button>
        <button class="bet-btn" data-bet="25" onclick="selectBet(25)">25</button>
        <button class="bet-btn" data-bet="50" onclick="selectBet(50)">50</button>
      </div>
    </div>
    <button class="turbo-btn" id="turboBtn" onclick="toggleTurbo()">‚ö°<span>Turbo</span></button>
    <button class="spin-btn go" id="spinBtn" onclick="spin()">
      <span class="spin-icon">üé∞</span>
      <span id="spinBtnText">ZAKRƒòƒÜ</span>
    </button>
  </div>

  <div class="history-wrap">
    <div class="history-title">Ostatnie spiny</div>
    <div class="history-list" id="histList">
        <div id="no-history" style="text-align:center;color:rgba(255,255,255,0.25);font-size:12px">Brak historii</div>
    </div>
  </div>
</div>

<script>
const tg = window.Telegram.WebApp;
tg.ready(); tg.expand();

// –£–∑–Ω–∞–µ–º –∞–¥—Ä–µ—Å API –∏–∑ —Å—Å—ã–ª–∫–∏ –∏–ª–∏ –º–µ—Ç–∞-—Ç–µ–≥–∞
const urlParams = new URLSearchParams(window.location.search);
const API_URL = urlParams.get('api') || document.querySelector('meta[name="api-base"]').content;

const SYMS = ['üçí','üçã','üçä','üçá','üç´','üç≠','üç¨','üíé'];
const WILD = 'üåü';
const SCATTER = 'üí•';

let balance = 0;
let bet = 5;
let spinning = false;
let freeSpins = 0;
let turboMode = false;
let history = [];

// ==================== API ====================
async function fetchBalance() {
    try {
        const response = await fetch(`${API_URL}/api/balance?init_data=${encodeURIComponent(tg.initData)}`);
        const data = await response.json();
        if (data.ok) {
            balance = data.balance;
            updateUI();
        }
    } catch (e) { console.error("Balance error:", e); }
}

function updateUI() {
    // –û–±–Ω–æ–≤–ª—è–µ–º –±–∞–ª–∞–Ω—Å
    const balEl = document.getElementById('balVal');
    balEl.innerText = balance;

    // –û–±–Ω–æ–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É
    const btn = document.getElementById('spinBtn');
    const btnText = document.getElementById('spinBtnText');
    
    if (balance <= 0 && freeSpins <= 0) {
        btnText.innerText = "DO≈ÅADUJ";
        btn.style.background = "linear-gradient(135deg, #555, #222)";
    } else {
        btnText.innerText = "ZAKRƒòƒÜ";
        btn.style.background = "linear-gradient(135deg, #ff4da6, #ff9500)";
    }
}

// ==================== GAME LOGIC ====================
async function spin() {
    if (spinning) return;

    if (balance < bet && freeSpins <= 0) {
        tg.showAlert("Brak ≈ºeton√≥w! Wr√≥ƒá do bota, aby do≈Çadowaƒá konto üí∞");
        return;
    }

    spinning = true;
    const btn = document.getElementById('spinBtn');
    btn.disabled = true;

    // 1. –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç –∑–∞—Ä–∞–Ω–µ–µ
    const tempGrid = generateGrid();
    const result = calculateWin(tempGrid, bet, freeSpins > 0);

    // 2. –°–†–ê–ó–£ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –±–æ—Ç—É (–ë–µ–∑–æ–ø–∞—Å–Ω–æ–µ —Å–ø–∏—Å–∞–Ω–∏–µ)
    try {
        const response = await fetch(`${API_URL}/api/spin`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                init_data: tg.initData,
                bet: freeSpins > 0 ? 0 : bet,
                winnings: result.winnings
            })
        });
        const data = await response.json();
        if (!data.ok) throw new Error(data.error);
        
        balance = data.balance; // –ê–∫—Ç—É–∞–ª—å–Ω—ã–π –±–∞–ª–∞–Ω—Å –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞
        updateUI();
    } catch (e) {
        tg.showAlert("B≈ÇƒÖd po≈ÇƒÖczenia!");
        spinning = false; btn.disabled = false;
        return;
    }

    // 3. –ê–Ω–∏–º–∞—Ü–∏—è
    setResultText("", "");
    await animateSpin(tempGrid);
    
    // 4. –ü–æ–∫–∞–∑ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
    renderGrid(tempGrid, result.winCells);
    if (result.winnings > 0) {
        showWinOverlay(result.winnings);
        confetti(result.winnings > bet * 10);
        setResultText(`üéâ +${result.winnings} ≈ºet.`, "win");
    } else {
        setResultText("üòî Brak wygranej", "lose");
    }

    addHistory(result.winnings, bet);
    spinning = false;
    btn.disabled = false;
}

// –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ (—É–ø—Ä–æ—â–µ–Ω–Ω–æ –¥–ª—è –ø—Ä–∏–º–µ—Ä–∞)
function generateGrid() {
    let g = [];
    for(let i=0; i<6; i++) {
        let col = [];
        for(let j=0; j<5; j++) col.push(SYMS[Math.floor(Math.random()*SYMS.length)]);
        g.push(col);
    }
    return g;
}

function calculateWin(g, b, isFS) {
    // –ü—Ä–æ—Å—Ç–∞—è –ª–æ–≥–∏–∫–∞: –µ—Å–ª–∏ –µ—Å—Ç—å 8+ –æ–¥–∏–Ω–∞–∫–æ–≤—ã—Ö
    let flat = g.flat();
    let counts = {};
    flat.forEach(s => counts[s] = (counts[s] || 0) + 1);
    let win = 0;
    for (let s in counts) { if (counts[s] >= 8) win += b * 2; }
    return { winnings: win, winCells: [] };
}

async function animateSpin(finalGrid) {
    const cells = document.querySelectorAll('.cell');
    for(let i=0; i < (turboMode ? 5 : 15); i++) {
        cells.forEach(c => c.innerText = SYMS[Math.floor(Math.random()*SYMS.length)]);
        await new Promise(r => setTimeout(r, 70));
    }
}

function renderGrid(g, wins) {
    for(let c=0; c<6; c++) {
        for(let r=0; r<5; r++) {
            document.getElementById(`cell-${c}-${r}`).innerText = g[c][r];
        }
    }
}

function selectBet(v) {
    bet = v;
    document.querySelectorAll('.bet-btn').forEach(b => b.classList.toggle('active', parseInt(b.dataset.bet) === v));
}

function toggleTurbo() {
    turboMode = !turboMode;
    document.getElementById('turboBtn').classList.toggle('active', turboMode);
}

function setResultText(t, cls) {
    const el = document.getElementById('resultText');
    el.innerText = t; el.className = `result-text show ${cls}`;
}

function showWinOverlay(a) {
    const ov = document.getElementById('winOverlay');
    document.getElementById('winAmount').innerText = `+${a}`;
    ov.classList.add('show');
    setTimeout(() => ov.classList.remove('show'), 2000);
}

function addHistory(w, b) {
    const list = document.getElementById('histList');
    const noHist = document.getElementById('no-history');
    if (noHist) noHist.remove();
    const item = document.createElement('div');
    item.className = 'h-item';
    item.innerHTML = `<span>üé∞ Spin</span><span class="${w>0?'win':'lose'}">${w > 0 ? '+'+w : '-'+b} ≈ºet.</span>`;
    list.prepend(item);
}

function confetti(big) {
    for(let i=0; i<(big?50:20); i++) {
        const c = document.createElement('div');
        c.className = 'confetti';
        c.style.left = Math.random()*100+'vw';
        c.style.background = ['#ffd700','#ff4da6','#00f5d4'][Math.floor(Math.random()*3)];
        c.style.width = c.style.height = '8px';
        c.style.setProperty('--dur', (Math.random()*2+1)+'s');
        document.body.appendChild(c);
        setTimeout(() => c.remove(), 2000);
    }
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
function init() {
    const g = document.getElementById('grid');
    for(let r=0; r<5; r++) {
        for(let c=0; c<6; c++) {
            const cell = document.createElement('div');
            cell.className = 'cell';
            cell.id = `cell-${c}-${r}`;
            cell.innerText = SYMS[Math.floor(Math.random()*SYMS.length)];
            g.appendChild(cell);
        }
    }
    fetchBalance();
    // –°–æ–∑–¥–∞–µ–º –∑–≤–µ–∑–¥—ã
    const stars = document.getElementById('stars');
    for(let i=0; i<30; i++) {
        const s = document.createElement('div');
        s.className = 'star';
        s.style.left = Math.random()*100+'%';
        s.style.top = Math.random()*100+'%';
        s.style.setProperty('--d', (Math.random()*3+1)+'s');
        stars.appendChild(s);
    }
}

init();
</script>
</body>
</html>
