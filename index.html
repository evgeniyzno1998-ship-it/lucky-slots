<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Lucky Slots</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<style>
@import url('https://fonts.googleapis.com/css2?family=Fredoka+One&family=Nunito:wght@400;700;900&display=swap');
:root { --bg1:#0d001f; --gold:#ffd700; --pink:#ff4da6; --win:#00e676; --bomb:#ff3d00; }
*,*::before,*::after{box-sizing:border-box}
body{background:radial-gradient(ellipse at 50% 0%,#2d0060,var(--bg1) 65%);min-height:100vh;font-family:'Nunito',sans-serif;color:#fff;user-select:none;margin:0;padding:0;overflow-x:hidden}
.wrap{max-width:440px;margin:0 auto;padding:10px;display:flex;flex-direction:column;gap:10px}
.header{display:flex;justify-content:space-between;align-items:center}
.logo{font-family:'Fredoka One';font-size:22px;background:linear-gradient(135deg,var(--gold),var(--pink));-webkit-background-clip:text;-webkit-text-fill-color:transparent}
.balance-box{background:rgba(255,255,255,.1);border:1px solid var(--gold);border-radius:20px;padding:5px 12px;font-family:'Fredoka One';color:var(--gold);transition:all .3s}
.balance-box.low{border-color:var(--win);color:var(--win);animation:pulse-g 1.5s infinite}
@keyframes pulse-g{0%,100%{box-shadow:0 0 0 0 rgba(0,230,118,.4)}50%{box-shadow:0 0 14px 4px rgba(0,230,118,.3)}}
.grid-outer{background:rgba(0,0,0,.5);border:2px solid rgba(255,215,0,.2);border-radius:20px;padding:8px;position:relative;overflow:hidden}
.grid-outer.bonus-active{border-color:var(--pink);box-shadow:0 0 30px rgba(255,77,166,.3);animation:bonus-border 1s infinite}
@keyframes bonus-border{0%,100%{box-shadow:0 0 15px rgba(255,77,166,.3)}50%{box-shadow:0 0 35px rgba(255,77,166,.5)}}
.grid{display:grid;grid-template-columns:repeat(6,1fr);gap:3px}
.cell{width:100%;aspect-ratio:1;display:flex;align-items:center;justify-content:center;font-size:24px;border-radius:8px;background:rgba(255,255,255,.05);transition:transform .2s,background .2s}
.cell.win-cell{background:rgba(255,215,0,.25);transform:scale(1.1)}
.cell.scatter-cell{background:rgba(255,77,166,.3);animation:scatter-pulse .6s infinite}
@keyframes scatter-pulse{0%,100%{transform:scale(1)}50%{transform:scale(1.15)}}
.cell.bomb-cell{background:rgba(255,61,0,.3);animation:bomb-shake .3s infinite}
@keyframes bomb-shake{0%,100%{transform:rotate(0)}25%{transform:rotate(-3deg)}75%{transform:rotate(3deg)}}
.controls{display:flex;gap:8px;align-items:center}
.bet-group{flex:1;display:flex;gap:4px}
.bet-btn{flex:1;padding:10px 0;border-radius:10px;border:2px solid rgba(255,215,0,.2);background:rgba(255,255,255,.05);color:var(--gold);font-family:'Fredoka One';cursor:pointer;font-size:14px}
.bet-btn.active{border-color:var(--gold);background:rgba(255,215,0,.2)}
.spin-btn{width:110px;height:75px;border-radius:18px;border:none;color:#fff;font-family:'Fredoka One';cursor:pointer;font-size:15px;transition:all .3s}
.spin-btn.mode-spin{background:linear-gradient(135deg,#ff4da6,#ff9500)}
.spin-btn.mode-deposit{background:linear-gradient(135deg,#00e676,#00c853);box-shadow:0 0 20px rgba(0,230,118,.5);animation:glow-d 1.5s infinite}
@keyframes glow-d{0%,100%{box-shadow:0 0 10px rgba(0,230,118,.4)}50%{box-shadow:0 0 25px rgba(0,230,118,.6)}}
.spin-btn.mode-loading{background:rgba(255,255,255,.1);cursor:wait}
.spin-btn:disabled{opacity:.5;cursor:not-allowed}
.buy-bonus-btn{width:100%;padding:12px;border-radius:14px;border:2px solid var(--pink);background:rgba(255,255,255,.05);color:#fff;display:flex;justify-content:space-between;align-items:center;cursor:pointer;font-size:14px;transition:all .3s}
.buy-bonus-btn:active{transform:scale(.97)}
.history-wrap{background:rgba(255,255,255,.03);border-radius:16px;padding:12px;min-height:60px}
.h-item{display:flex;justify-content:space-between;font-size:12px;padding:4px 0;border-bottom:1px solid rgba(255,255,255,.05)}
.h-item.bonus-item{color:var(--pink);border-bottom-color:rgba(255,77,166,.2)}
.paytable{display:grid;grid-template-columns:repeat(4,1fr);gap:5px;background:rgba(255,255,255,.03);padding:10px;border-radius:16px}
.pt-item{text-align:center;font-size:8px;background:rgba(255,255,255,.05);padding:5px;border-radius:8px}
.error-banner{background:rgba(255,77,77,.15);border:1px solid rgba(255,77,77,.3);border-radius:10px;padding:8px 12px;text-align:center;font-size:12px;display:none;color:#ff6b6b}
.section-title{font-size:10px;opacity:.4;margin-top:10px}

/* ===== BONUS OVERLAY ===== */
.bonus-overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.85);z-index:1000;display:none;flex-direction:column;align-items:center;justify-content:center;gap:15px;padding:20px}
.bonus-overlay.active{display:flex}
.bonus-title{font-family:'Fredoka One';font-size:28px;background:linear-gradient(135deg,var(--gold),var(--pink));-webkit-background-clip:text;-webkit-text-fill-color:transparent;text-align:center;animation:bonus-title-pop .5s ease-out}
@keyframes bonus-title-pop{0%{transform:scale(0)}50%{transform:scale(1.2)}100%{transform:scale(1)}}
.bonus-info{display:flex;gap:20px;font-family:'Fredoka One';font-size:14px}
.bonus-info-item{text-align:center;padding:8px 16px;border-radius:12px;background:rgba(255,255,255,.1)}
.bonus-info-item .label{font-size:10px;opacity:.6;font-family:'Nunito'}
.bonus-info-item .value{color:var(--gold);font-size:18px}
.bonus-grid-wrap{width:100%;max-width:400px;background:rgba(0,0,0,.5);border:2px solid var(--pink);border-radius:20px;padding:8px}
.bonus-grid{display:grid;grid-template-columns:repeat(6,1fr);gap:3px}
.bonus-result{font-family:'Fredoka One';font-size:20px;color:var(--win);text-align:center;min-height:30px}
.bonus-total{font-family:'Fredoka One';font-size:32px;color:var(--gold);text-align:center;text-shadow:0 0 20px rgba(255,215,0,.5)}
.bonus-close-btn{padding:12px 40px;border-radius:14px;border:none;background:linear-gradient(135deg,var(--gold),#ff9500);color:#000;font-family:'Fredoka One';font-size:16px;cursor:pointer;display:none}
.bomb-popup{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);font-family:'Fredoka One';font-size:48px;color:var(--bomb);z-index:1100;pointer-events:none;animation:bomb-pop .8s ease-out forwards}
@keyframes bomb-pop{0%{transform:translate(-50%,-50%) scale(0);opacity:1}50%{transform:translate(-50%,-50%) scale(1.5);opacity:1}100%{transform:translate(-50%,-70%) scale(1);opacity:0}}
</style>
</head>
<body>
<div class="wrap">
    <div class="header">
        <div class="logo">üç≠ Lucky Bonanza</div>
        <div class="balance-box" id="balanceBox">ü™ô <span id="balVal">...</span></div>
    </div>
    <div id="errorBanner" class="error-banner"></div>
    <div class="grid-outer" id="gridOuter"><div class="grid" id="grid"></div></div>
    <div id="resultText" style="text-align:center;height:30px;font-family:'Fredoka One'"></div>
    <div class="controls">
        <div class="bet-group">
            <button class="bet-btn active" onclick="selectBet(5)">5</button>
            <button class="bet-btn" onclick="selectBet(10)">10</button>
            <button class="bet-btn" onclick="selectBet(25)">25</button>
            <button class="bet-btn" onclick="selectBet(50)">50</button>
        </div>
        <button class="spin-btn mode-loading" id="spinBtn" onclick="handleMainAction()">
            <span id="spinBtnText">...</span>
        </button>
    </div>
    <button class="buy-bonus-btn" id="buyBonusBtn" onclick="buyBonus()">
        <div style="text-align:left">
            <div id="bbTitle" style="font-family:'Fredoka One'">üî• BUY BONUS</div>
            <div id="bbDesc" style="font-size:10px;opacity:.6">10+ free spins</div>
        </div>
        <div id="bbPrice" style="font-family:'Fredoka One';color:var(--pink)">500 ü™ô</div>
    </button>
    <div id="histTitle" class="section-title"></div>
    <div class="history-wrap" id="histList"></div>
    <div id="ptTitle" class="section-title"></div>
    <div class="paytable" id="pt"></div>
</div>

<!-- BONUS OVERLAY -->
<div class="bonus-overlay" id="bonusOverlay">
    <div class="bonus-title" id="bonusTitle">üé∞ BONUS ROUND üé∞</div>
    <div class="bonus-info">
        <div class="bonus-info-item"><div class="label" id="bonusSpinLabel">SPIN</div><div class="value" id="bonusSpinCounter">0/10</div></div>
        <div class="bonus-info-item"><div class="label" id="bonusTotalLabel">TOTAL WIN</div><div class="value" id="bonusRunningTotal">0</div></div>
    </div>
    <div class="bonus-grid-wrap"><div class="bonus-grid" id="bonusGrid"></div></div>
    <div class="bonus-result" id="bonusSpinResult"></div>
    <div class="bonus-total" id="bonusFinalTotal"></div>
    <button class="bonus-close-btn" id="bonusCloseBtn" onclick="closeBonus()">COLLECT ü™ô</button>
</div>

<script>
const tg = window.Telegram.WebApp; tg.ready(); tg.expand();
const P = new URLSearchParams(window.location.search);
const API_URL = P.get('api') || "https://lucky-slots-production.up.railway.app";
const BOT_NAME = P.get('bot') || "testplcas_bot";
const LANG = P.get('lang') || 'pl';
const UID = P.get('uid') || '';
const TOKEN = P.get('token') || '';

const L = {
    pl:{spin:"ZAKRƒòƒÜ",deposit:"DEPOZYT",bbTitle:"üî• KUP BONUS",bbDesc:"10+ darmowych spin√≥w",hist:"OSTATNIE SPINY",pt:"TABELA WYP≈ÅAT",win:"WYGRANA",lose:"Brak wygranej",noMoney:"Do≈Çaduj konto!",error:"B≈ÇƒÖd",bonusTitle:"üé∞ RUNDA BONUSOWA üé∞",bonusSpin:"SPIN",bonusTotal:"WYGRANA",bonusTrigger:"BONUS!",bonusRetrigger:"+5 SPIN√ìW!",collect:"ODBIERZ",bombHit:"üí£ MNO≈ªNIK"},
    ua:{spin:"–ì–†–ê–¢–ò",deposit:"–î–ï–ü–û–ó–ò–¢",bbTitle:"üî• –ö–£–ü–ò–¢–ò –ë–û–ù–£–°",bbDesc:"10+ –±–µ–∑–∫–æ—à—Ç–æ–≤–Ω–∏—Ö —Å–ø—ñ–Ω—ñ–≤",hist:"–û–°–¢–ê–ù–ù–Ü –°–ü–Ü–ù–ò",pt:"–¢–ê–ë–õ–ò–¶–Ø –í–ò–ü–õ–ê–¢",win:"–í–ò–ì–†–ê–®",lose:"–ë–µ–∑ –≤–∏–≥—Ä–∞—à—É",noMoney:"–ü–æ–ø–æ–≤–Ω—ñ—Ç—å!",error:"–ü–æ–º–∏–ª–∫–∞",bonusTitle:"üé∞ –ë–û–ù–£–° –†–ê–£–ù–î üé∞",bonusSpin:"–°–ü–Ü–ù",bonusTotal:"–í–ò–ì–†–ê–®",bonusTrigger:"–ë–û–ù–£–°!",bonusRetrigger:"+5 –°–ü–Ü–ù–Ü–í!",collect:"–ó–ê–ë–†–ê–¢–ò",bombHit:"üí£ –ú–ù–û–ñ–ù–ò–ö"},
    ru:{spin:"–ò–ì–†–ê–¢–¨",deposit:"–î–ï–ü–û–ó–ò–¢",bbTitle:"üî• –ö–£–ü–ò–¢–¨ –ë–û–ù–£–°",bbDesc:"10+ –±–µ—Å–ø–ª–∞—Ç–Ω—ã—Ö —Å–ø–∏–Ω–æ–≤",hist:"–ü–û–°–õ–ï–î–ù–ò–ï –°–ü–ò–ù–´",pt:"–¢–ê–ë–õ–ò–¶–ê –í–´–ü–õ–ê–¢",win:"–í–´–ò–ì–†–´–®",lose:"–ù–µ—Ç –≤—ã–∏–≥—Ä—ã—à–∞",noMoney:"–ü–æ–ø–æ–ª–Ω–∏—Ç–µ!",error:"–û—à–∏–±–∫–∞",bonusTitle:"üé∞ –ë–û–ù–£–° –†–ê–£–ù–î üé∞",bonusSpin:"–°–ü–ò–ù",bonusTotal:"–í–´–ò–ì–†–´–®",bonusTrigger:"–ë–û–ù–£–°!",bonusRetrigger:"+5 –°–ü–ò–ù–û–í!",collect:"–ó–ê–ë–†–ê–¢–¨",bombHit:"üí£ –ú–ù–û–ñ–ò–¢–ï–õ–¨"},
    en:{spin:"SPIN",deposit:"DEPOSIT",bbTitle:"üî• BUY BONUS",bbDesc:"10+ free spins",hist:"LAST SPINS",pt:"PAYTABLE",win:"WIN",lose:"No win",noMoney:"Deposit!",error:"Error",bonusTitle:"üé∞ BONUS ROUND üé∞",bonusSpin:"SPIN",bonusTotal:"TOTAL WIN",bonusTrigger:"BONUS!",bonusRetrigger:"+5 SPINS!",collect:"COLLECT",bombHit:"üí£ MULTIPLIER"}
};
const T = L[LANG] || L.pl;
const BASE_SYMS = ['üçí','üçã','üçä','üçá','üç´','üç≠','üç¨','üíé'];
const BONUS_SYMS = ['üëë','üíé','‚≠ê','‚ù§Ô∏è','üçÄ','üß≤','üí∞','üåà'];
const SCATTER = 'üé∞';
const BOMB = 'üí£';

let balance=null, bet=5, spinning=false;

function authParams(){const p={};if(tg.initData)p.init_data=tg.initData;if(UID)p.uid=UID;if(TOKEN)p.token=TOKEN;return p}
function authQS(){return new URLSearchParams(authParams()).toString()}

// ==================== UI ====================
function updateUI(){
    const balEl=document.getElementById('balVal'),btn=document.getElementById('spinBtn'),btnText=document.getElementById('spinBtnText'),balBox=document.getElementById('balanceBox');
    balEl.innerText=(balance!==null)?balance:'...';
    btn.className='spin-btn';balBox.classList.remove('low');
    if(balance===null){btn.classList.add('mode-loading');btnText.innerText='...';btn.disabled=true}
    else if(balance<bet){btn.classList.add('mode-deposit');btnText.innerText=T.deposit;btn.disabled=false;balBox.classList.add('low')}
    else{btn.classList.add('mode-spin');btnText.innerText=T.spin;btn.disabled=false}
}
function showError(m){const b=document.getElementById('errorBanner');b.innerText=m||T.error;b.style.display='block';setTimeout(()=>b.style.display='none',4000)}

// ==================== BALANCE ====================
let balR=0;
async function fetchBalance(){
    try{const r=await fetch(`${API_URL}/api/balance?${authQS()}`);const d=await r.json();if(d.ok){balance=d.balance;balR=0;updateUI();return}}catch(e){}
    if(++balR<=5)setTimeout(fetchBalance,Math.min(1000*Math.pow(2,balR-1),8000));else{balance=0;updateUI()}
}

// ==================== ACTIONS ====================
function handleMainAction(){
    if(balance===null)return;
    if(balance<bet){tg.openTelegramLink(`https://t.me/${BOT_NAME}?start=deposit`);tg.close();return}
    spin();
}
function selectBet(v){
    if(spinning)return;bet=v;
    document.querySelectorAll('.bet-btn').forEach(b=>b.classList.toggle('active',parseInt(b.innerText)===v));
    document.getElementById('bbPrice').innerText=(v*100)+' ü™ô';updateUI();
}

// ==================== BASE SPIN ====================
async function spin(){
    if(spinning||balance===null||balance<bet)return;
    spinning=true;const btn=document.getElementById('spinBtn');btn.disabled=true;
    document.getElementById('resultText').innerHTML='';
    document.querySelectorAll('.cell').forEach(c=>{c.className='cell'});
    const cells=document.querySelectorAll('.cell');
    const anim=setInterval(()=>cells.forEach(c=>c.innerText=BASE_SYMS[Math.floor(Math.random()*BASE_SYMS.length)]),80);

    try{
        const r=await fetch(`${API_URL}/api/spin`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({...authParams(),bet})});
        const d=await r.json();clearInterval(anim);
        if(!d.ok){if(d.error==='insufficient_funds'&&d.balance!==undefined)balance=d.balance;showError(d.error==='insufficient_funds'?T.noMoney:T.error);spinning=false;btn.disabled=false;updateUI();return}

        balance=d.balance;const win=d.winnings;
        d.grid.forEach((s,i)=>{cells[i].innerText=s;
            if(s===SCATTER)cells[i].classList.add('scatter-cell');
        });

        // –ü–æ–¥—Å–≤–µ—Ç–∫–∞ –≤—ã–∏–≥—Ä—ã—à–Ω—ã—Ö
        if(win>0){const co={};d.grid.forEach(s=>{if(s!==SCATTER)co[s]=(co[s]||0)+1});
            const ws=new Set(Object.entries(co).filter(([,c])=>c>=8).map(([s])=>s));
            cells.forEach(c=>{if(ws.has(c.innerText))c.classList.add('win-cell')});
        }

        const resEl=document.getElementById('resultText');
        if(d.triggered_bonus){
            resEl.innerHTML=`<span style="color:var(--pink);font-size:22px;animation:bonus-title-pop .5s">${T.bonusTrigger} ${d.scatter_count}x ${SCATTER}</span>`;
            addHistory(win,false);updateUI();
            // –ó–∞–ø—É—Å–∫–∞–µ–º –±–æ–Ω—É—Å —á–µ—Ä–µ–∑ 1.5—Å
            setTimeout(()=>startBonusRound('triggered'),1500);
        }else{
            resEl.innerHTML=win>0?`<span style="color:var(--win)">${T.win}: +${win} ü™ô</span>`:`<span style="color:rgba(255,255,255,.4)">${T.lose}</span>`;
            addHistory(win,false);updateUI();
        }
    }catch(e){clearInterval(anim);showError(T.error);fetchBalance()}
    spinning=false;btn.disabled=false;
}

// ==================== BONUS ROUND ====================
async function startBonusRound(mode){
    spinning=true;
    const overlay=document.getElementById('bonusOverlay');
    overlay.classList.add('active');
    document.getElementById('bonusTitle').innerText=T.bonusTitle;
    document.getElementById('bonusSpinLabel').innerText=T.bonusSpin;
    document.getElementById('bonusTotalLabel').innerText=T.bonusTotal;
    document.getElementById('bonusCloseBtn').style.display='none';
    document.getElementById('bonusFinalTotal').innerText='';
    document.getElementById('bonusSpinResult').innerText='';
    document.getElementById('bonusSpinCounter').innerText='0/10';
    document.getElementById('bonusRunningTotal').innerText='0';
    document.getElementById('gridOuter').classList.add('bonus-active');

    // –°–æ–∑–¥–∞—ë–º –±–æ–Ω—É—Å–Ω—É—é —Å–µ—Ç–∫—É
    const bg=document.getElementById('bonusGrid');
    bg.innerHTML='';
    for(let i=0;i<30;i++){const c=document.createElement('div');c.className='cell';c.innerText=BONUS_SYMS[Math.floor(Math.random()*BONUS_SYMS.length)];bg.appendChild(c)}

    try{
        const r=await fetch(`${API_URL}/api/bonus`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({...authParams(),bet,mode})});
        const d=await r.json();
        if(!d.ok){showError(T.error);closeBonus();return}

        // –ü—Ä–æ–∏–≥—Ä—ã–≤–∞–µ–º –∫–∞–∂–¥—ã–π —Å–ø–∏–Ω —Å –∞–Ω–∏–º–∞—Ü–∏–µ–π
        const bonusCells=bg.querySelectorAll('.cell');
        for(let i=0;i<d.spins.length;i++){
            const sp=d.spins[i];
            document.getElementById('bonusSpinCounter').innerText=`${sp.spin_number}/${sp.total_spins}`;

            // –ê–Ω–∏–º–∞—Ü–∏—è –≤—Ä–∞—â–µ–Ω–∏—è
            for(let t=0;t<8;t++){
                bonusCells.forEach(c=>c.innerText=BONUS_SYMS[Math.floor(Math.random()*BONUS_SYMS.length)]);
                await sleep(60);
            }

            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
            sp.grid.forEach((s,idx)=>{
                bonusCells[idx].innerText=s;
                bonusCells[idx].className='cell';
                if(s===SCATTER)bonusCells[idx].classList.add('scatter-cell');
                else if(s===BOMB)bonusCells[idx].classList.add('bomb-cell');
            });

            // –ü–æ–¥—Å–≤–µ—Ç–∫–∞ –≤—ã–∏–≥—Ä—ã—à–Ω—ã—Ö
            if(sp.winning_symbols){
                const ws=new Set(Object.keys(sp.winning_symbols));
                bonusCells.forEach(c=>{if(ws.has(c.innerText))c.classList.add('win-cell')});
            }

            await sleep(300);

            // –ë–æ–º–±—ã ‚Äî –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ–ø–∞–ø
            if(sp.bombs&&sp.bombs.length>0&&sp.base_win>0){
                for(const bomb of sp.bombs){
                    showBombPopup(bomb.mult);
                    await sleep(500);
                }
            }

            // –†–µ–∑—É–ª—å—Ç–∞—Ç —Å–ø–∏–Ω–∞
            const resEl=document.getElementById('bonusSpinResult');
            if(sp.winnings>0){
                let txt=`+${sp.winnings} ü™ô`;
                if(sp.total_bomb_mult>1)txt+=` (${T.bombHit} x${sp.total_bomb_mult})`;
                resEl.innerHTML=`<span style="color:var(--win)">${txt}</span>`;
            }else{
                resEl.innerHTML=`<span style="opacity:.4">‚Äî</span>`;
            }

            // –†–µ—Ç—Ä–∏–≥–≥–µ—Ä
            if(sp.retrigger){
                resEl.innerHTML+=`<br><span style="color:var(--pink);font-size:16px">${T.bonusRetrigger}</span>`;
                await sleep(800);
            }

            // Running total
            document.getElementById('bonusRunningTotal').innerText=sp.running_total;
            await sleep(600);
        }

        // –§–∏–Ω–∞–ª!
        balance=d.balance;
        document.getElementById('bonusSpinResult').innerHTML='';
        document.getElementById('bonusFinalTotal').innerHTML=`üèÜ ${T.bonusTotal}: <span style="color:var(--win)">${d.total_win} ü™ô</span>`;
        document.getElementById('bonusCloseBtn').innerText=`${T.collect} ${d.total_win} ü™ô`;
        document.getElementById('bonusCloseBtn').style.display='block';
        addHistory(d.total_win,true);

    }catch(e){console.error('Bonus error:',e);showError(T.error);closeBonus()}
}

function closeBonus(){
    document.getElementById('bonusOverlay').classList.remove('active');
    document.getElementById('gridOuter').classList.remove('bonus-active');
    spinning=false;updateUI();
}

function showBombPopup(mult){
    const el=document.createElement('div');
    el.className='bomb-popup';
    el.innerText=`üí£ x${mult}`;
    document.body.appendChild(el);
    setTimeout(()=>el.remove(),900);
}

function sleep(ms){return new Promise(r=>setTimeout(r,ms))}

// ==================== BUY BONUS ====================
async function buyBonus(){
    if(balance===null)return;
    const cost=bet*100;
    if(balance<cost){tg.showAlert(T.noMoney);return}
    startBonusRound('bought');
}

// ==================== HISTORY ====================
function addHistory(win,isBonus){
    const list=document.getElementById('histList');
    const div=document.createElement('div');
    div.className='h-item'+(isBonus?' bonus-item':'');
    const icon=isBonus?'üéÅ':'üé∞';
    const label=isBonus?'Bonus':'Spin';
    const sign=win>0?'+':'-';
    const val=win>0?win:bet;
    const color=win>0?'var(--win)':'#ff6b6b';
    div.innerHTML=`<span>${icon} ${label} (${bet})</span><span style="color:${color}">${sign}${val}</span>`;
    list.prepend(div);if(list.children.length>10)list.lastChild.remove();
}

// ==================== INIT ====================
function init(){
    const g=document.getElementById('grid');
    for(let i=0;i<30;i++){const c=document.createElement('div');c.className='cell';c.innerText=BASE_SYMS[Math.floor(Math.random()*BASE_SYMS.length)];g.appendChild(c)}
    const pt=document.getElementById('pt');
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏ –±–∞–∑–æ–≤—ã–µ –∏ –±–æ–Ω—É—Å–Ω—ã–µ —Å–∏–º–≤–æ–ª—ã –≤ paytable
    BASE_SYMS.forEach(s=>{const it=document.createElement('div');it.className='pt-item';it.innerHTML=`<div style="font-size:16px">${s}</div>8+ x1.5<br>12+ x5`;pt.appendChild(it)});

    document.getElementById('bbTitle').innerText=T.bbTitle;
    document.getElementById('bbDesc').innerText=T.bbDesc;
    document.getElementById('histTitle').innerText=T.hist;
    document.getElementById('ptTitle').innerText=T.pt;
    updateUI();setTimeout(fetchBalance,200);
}
init();
</script>
</body>
</html>
