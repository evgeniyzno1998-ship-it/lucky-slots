<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<!-- Ğ—ĞĞœĞ•ĞĞ˜ ĞĞ Ğ¡Ğ’ĞĞ™ ngrok/VPS URL ĞºĞ¾Ğ³Ğ´Ğ° Ğ·Ğ°Ğ´ĞµĞ¿Ğ»Ğ¾Ğ¸ÑˆÑŒ Ğ±Ğ¾Ñ‚Ğ°: -->
<meta name="api-base" content="https://lucky-slots-production.up.railway.app">
<title>Lucky Slots</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<style>
@import url('https://fonts.googleapis.com/css2?family=Fredoka+One&family=Nunito:wght@400;700;900&display=swap');

:root {
  --bg1: #0d001f;
  --bg2: #1a0040;
  --gold: #ffd700;
  --pink: #ff4da6;
  --cyan: #00f5d4;
  --win: #00e676;
  --lose: #ff5252;
  --wild: #ff9500;
  --scatter: #ff4da6;
}

* { margin:0; padding:0; box-sizing:border-box; -webkit-tap-highlight-color:transparent; }

body {
  background: radial-gradient(ellipse at 50% 0%, #2d0060, var(--bg1) 65%);
  min-height: 100vh;
  font-family: 'Nunito', sans-serif;
  color: #fff;
  overflow-x: hidden;
  user-select: none;
}

/* Stars */
.stars { position:fixed; inset:0; pointer-events:none; z-index:0; overflow:hidden; }
.star {
  position:absolute; border-radius:50%; background:#fff;
  animation: twinkle var(--d) ease-in-out infinite alternate;
  opacity:0;
}
@keyframes twinkle {
  from { opacity:0; transform:scale(0.5); }
  to   { opacity:0.6; transform:scale(1.2); }
}

.wrap {
  position:relative; z-index:1;
  max-width:440px; margin:0 auto;
  padding:10px 8px 24px;
  display:flex; flex-direction:column; gap:10px;
}

/* Header */
.header { display:flex; justify-content:space-between; align-items:center; }
.logo {
  font-family:'Fredoka One',sans-serif; font-size:22px;
  background:linear-gradient(135deg,var(--gold),var(--pink));
  -webkit-background-clip:text; -webkit-text-fill-color:transparent;
  filter:drop-shadow(0 0 6px rgba(255,215,0,0.3));
}
.balance-box {
  background:rgba(255,255,255,0.07); border:1px solid rgba(255,215,0,0.3);
  border-radius:20px; padding:5px 12px;
  display:flex; align-items:center; gap:5px;
}
.balance-val { font-family:'Fredoka One',sans-serif; font-size:17px; color:var(--gold); }

/* Info bar */
.info-bar {
  display:flex; gap:6px; justify-content:center;
}
.info-pill {
  background:rgba(255,255,255,0.06); border:1px solid rgba(255,255,255,0.1);
  border-radius:12px; padding:4px 10px; font-size:11px; color:rgba(255,255,255,0.6);
  display:flex; align-items:center; gap:4px;
}
.info-pill span { color:#fff; font-weight:700; }

/* GRID */
.grid-outer {
  background:rgba(0,0,0,0.5); border:2px solid rgba(255,215,0,0.2);
  border-radius:20px; padding:10px 6px; position:relative; overflow:hidden;
}

.grid-outer::before {
  content:''; position:absolute; inset:0;
  background:linear-gradient(180deg, rgba(0,0,0,0.5) 0%, transparent 15%, transparent 85%, rgba(0,0,0,0.5) 100%);
  pointer-events:none; z-index:3;
}

.grid {
  display:grid;
  grid-template-columns:repeat(6, 1fr);
  grid-template-rows:repeat(5, 1fr);
  gap:3px;
  position:relative; z-index:1;
}

.cell {
  width:100%; aspect-ratio:1;
  display:flex; align-items:center; justify-content:center;
  font-size:clamp(20px, 5vw, 32px);
  border-radius:10px;
  background:rgba(255,255,255,0.04);
  border:1px solid rgba(255,255,255,0.06);
  transition:background 0.2s, transform 0.15s;
  position:relative;
  overflow:hidden;
}

.cell.spinning {
  animation: cellSpin 0.15s ease-in-out infinite alternate;
}
@keyframes cellSpin {
  from { transform:translateY(-3px); opacity:0.7; }
  to   { transform:translateY(3px);  opacity:1; }
}

.cell.winning {
  background:rgba(255,215,0,0.2);
  border-color:rgba(255,215,0,0.6);
  animation: winCell 0.4s ease-in-out infinite alternate;
  z-index:2;
}
@keyframes winCell {
  from { transform:scale(1); box-shadow:0 0 8px rgba(255,215,0,0.3); }
  to   { transform:scale(1.12); box-shadow:0 0 20px rgba(255,215,0,0.7); }
}

.cell.wild-cell {
  background: rgba(255,149,0,0.15);
  border-color: rgba(255,149,0,0.5);
}
.cell.wild-flash {
  animation: wildFlash 0.6s ease-out forwards;
}
@keyframes wildFlash {
  0%   { background:rgba(255,255,255,0.9); transform:scale(1.3); box-shadow:0 0 30px #fff, 0 0 60px var(--wild); }
  30%  { background:rgba(255,149,0,0.6);   transform:scale(1.15); box-shadow:0 0 20px var(--wild); }
  100% { background:rgba(255,149,0,0.15);  transform:scale(1);    box-shadow:none; }
}

.cell.scatter-cell {
  background: rgba(255,77,166,0.15);
  border-color: rgba(255,77,166,0.5);
}
.cell.scatter-flash {
  animation: scatterFlash 0.7s ease-out forwards;
}
@keyframes scatterFlash {
  0%   { background:rgba(255,77,166,0.9); transform:scale(1.3) rotate(10deg); box-shadow:0 0 30px var(--scatter); }
  40%  { background:rgba(255,77,166,0.5); transform:scale(1.1)  rotate(-5deg); }
  100% { background:rgba(255,77,166,0.15);transform:scale(1)    rotate(0deg);  box-shadow:none; }
}

/* Scatter counter badge */
.scatter-count-badge {
  position: fixed;
  top: 50%; left: 50%;
  transform: translate(-50%, -50%) scale(0);
  background: linear-gradient(135deg, var(--scatter), #9b00ff);
  color: #fff;
  font-family: 'Fredoka One', sans-serif;
  font-size: 28px;
  padding: 16px 28px;
  border-radius: 20px;
  border: 2px solid rgba(255,255,255,0.3);
  box-shadow: 0 0 40px rgba(255,77,166,0.6);
  z-index: 50;
  pointer-events: none;
  text-align: center;
  animation: scatterPopup 2s ease forwards;
}
@keyframes scatterPopup {
  0%   { transform:translate(-50%,-50%) scale(0);   opacity:0; }
  15%  { transform:translate(-50%,-50%) scale(1.1); opacity:1; }
  25%  { transform:translate(-50%,-50%) scale(1);   opacity:1; }
  75%  { transform:translate(-50%,-50%) scale(1);   opacity:1; }
  100% { transform:translate(-50%,-50%) scale(0.8); opacity:0; }
}

/* Multiplier badge on cell */
.mult-badge {
  position:absolute; top:1px; right:1px;
  background:rgba(255,149,0,0.9);
  color:#fff; font-size:8px; font-weight:900;
  border-radius:4px; padding:1px 3px;
  line-height:1;
}

/* Result display */
.result-bar {
  min-height:36px; display:flex; align-items:center; justify-content:center;
}
.result-text {
  font-family:'Fredoka One',sans-serif; font-size:20px;
  opacity:0; transform:scale(0.6) translateY(6px);
  transition:all 0.35s cubic-bezier(0.34,1.56,0.64,1);
  text-align:center;
}
.result-text.show { opacity:1; transform:scale(1) translateY(0); }
.result-text.win  { color:var(--win); text-shadow:0 0 16px var(--win); }
.result-text.lose { color:rgba(255,255,255,0.4); font-size:15px; }
.result-text.push { color:var(--gold); }
.result-text.fs   { color:var(--scatter); text-shadow:0 0 16px var(--scatter); }

/* Bet + controls */
.controls { display:flex; gap:8px; align-items:center; }
.bet-wrap { flex:1; }
.bet-label { font-size:10px; color:rgba(255,255,255,0.4); text-transform:uppercase; letter-spacing:1px; margin-bottom:5px; }
.bet-row { display:flex; gap:5px; }
.bet-btn {
  flex:1; padding:8px 0;
  border-radius:10px; border:2px solid rgba(255,215,0,0.25);
  background:rgba(255,215,0,0.06); color:var(--gold);
  font-family:'Fredoka One',sans-serif; font-size:14px;
  cursor:pointer; transition:all 0.15s;
}
.bet-btn.active, .bet-btn:hover {
  background:rgba(255,215,0,0.2); border-color:var(--gold);
  transform:translateY(-1px);
}

.spin-btn {
  width:90px; height:70px;
  border-radius:16px; border:none;
  background:linear-gradient(135deg,#ff4da6,#ff9500);
  color:#fff; font-family:'Fredoka One',sans-serif; font-size:13px;
  cursor:pointer; transition:all 0.2s;
  box-shadow:0 5px 20px rgba(255,77,166,0.4);
  display:flex; flex-direction:column; align-items:center; justify-content:center; gap:2px;
  line-height:1;
}
.spin-btn .spin-icon { font-size:26px; }
.spin-btn:active { transform:scale(0.96); }
.spin-btn:disabled { background:linear-gradient(135deg,#444,#222); box-shadow:none; cursor:not-allowed; opacity:0.7; }
.spin-btn.go { animation:spinBtnGlow 0.8s ease-in-out infinite alternate; }
@keyframes spinBtnGlow {
  from { box-shadow:0 5px 20px rgba(255,77,166,0.4); }
  to   { box-shadow:0 5px 40px rgba(255,77,166,0.9); }
}

/* Freespin indicator */
.fs-banner {
  display:none; text-align:center;
  background:linear-gradient(135deg,rgba(255,77,166,0.2),rgba(255,149,0,0.2));
  border:1px solid var(--scatter); border-radius:14px; padding:8px;
  font-family:'Fredoka One',sans-serif; font-size:16px; color:var(--scatter);
}
.fs-banner.active { display:block; }

/* History */
.history-wrap {
  background:rgba(255,255,255,0.03); border-radius:16px; padding:10px 12px;
}
.history-title { font-size:10px; color:rgba(255,255,255,0.35); text-transform:uppercase; letter-spacing:1px; margin-bottom:8px; }
.history-list { display:flex; flex-direction:column; gap:4px; }
.h-item {
  display:flex; justify-content:space-between; align-items:center;
  padding:5px 8px; border-radius:8px; background:rgba(255,255,255,0.04);
  font-size:12px; animation:slideIn 0.25s ease;
}
@keyframes slideIn { from{opacity:0;transform:translateX(-8px)} to{opacity:1;transform:translateX(0)} }
.h-syms { font-size:14px; letter-spacing:1px; }
.h-res { font-weight:700; }
.h-res.win  { color:var(--win); }
.h-res.lose { color:rgba(255,255,255,0.3); }
.h-res.push { color:var(--gold); }
.h-res.fs   { color:var(--scatter); }

/* Paytable */
.paytable-wrap {
  background:rgba(255,255,255,0.03); border-radius:16px; padding:10px 12px;
}
.pt-title { font-size:10px; color:rgba(255,255,255,0.35); text-transform:uppercase; letter-spacing:1px; margin-bottom:8px; }
.pt-grid { display:grid; grid-template-columns:repeat(4,1fr); gap:5px; }
.pt-item { background:rgba(255,255,255,0.04); border-radius:8px; padding:6px 4px; text-align:center; }
.pt-sym { font-size:20px; }
.pt-rows { margin-top:3px; }
.pt-row { font-size:9px; color:rgba(255,255,255,0.5); }
.pt-row span { color:var(--gold); font-weight:700; }
.pt-special { margin-top:6px; display:flex; gap:5px; }
.pt-spec-item { flex:1; background:rgba(255,255,255,0.04); border-radius:8px; padding:6px; text-align:center; font-size:11px; }

/* Buy Bonus */
.buy-bonus-btn {
  width:100%; padding:12px 14px;
  border-radius:14px; border:2px solid rgba(255,77,166,0.35);
  background:linear-gradient(135deg,rgba(255,77,166,0.1),rgba(155,0,255,0.1));
  color:#fff; font-family:'Fredoka One',sans-serif; font-size:15px;
  cursor:pointer; transition:all 0.2s;
  display:flex; align-items:center; justify-content:space-between;
}
.buy-bonus-btn:hover:not(:disabled) {
  background:linear-gradient(135deg,rgba(255,77,166,0.22),rgba(155,0,255,0.22));
  border-color:var(--scatter); transform:translateY(-1px);
  box-shadow:0 4px 20px rgba(255,77,166,0.3);
}
.buy-bonus-btn:disabled { opacity:0.4; cursor:not-allowed; }
.bb-left { display:flex; align-items:center; gap:8px; }
.bb-title { font-size:15px; }
.bb-desc  { font-size:11px; color:rgba(255,255,255,0.45); font-family:'Nunito',sans-serif; margin-top:1px; }
.bb-price { font-size:17px; color:var(--scatter); white-space:nowrap; }

.bb-modal {
  display:none; position:fixed; inset:0;
  background:rgba(0,0,0,0.78); z-index:80;
  align-items:center; justify-content:center;
}
.bb-modal.show { display:flex; animation:fadeIn 0.2s ease; }
@keyframes fadeIn { from{opacity:0} to{opacity:1} }
.bb-box {
  background:linear-gradient(160deg,#1a0040,#0d001f);
  border:2px solid rgba(255,77,166,0.4); border-radius:24px;
  padding:24px 20px; width:90%; max-width:340px;
  animation:popIn 0.35s cubic-bezier(0.34,1.56,0.64,1);
}
.bb-box-title {
  font-family:'Fredoka One',sans-serif; font-size:22px; text-align:center;
  background:linear-gradient(135deg,var(--scatter),#9b00ff);
  -webkit-background-clip:text; -webkit-text-fill-color:transparent;
  margin-bottom:4px;
}
.bb-box-sub { text-align:center; font-size:12px; color:rgba(255,255,255,0.4); margin-bottom:16px; }
.bb-info {
  background:rgba(255,255,255,0.05); border-radius:14px;
  padding:14px; margin-bottom:16px; text-align:center;
}
.bb-fs-num { font-family:'Fredoka One',sans-serif; font-size:36px; color:var(--scatter); text-shadow:0 0 16px var(--scatter); }
.bb-cost   { font-size:14px; color:rgba(255,255,255,0.55); margin-top:4px; }
.bb-cost span { color:var(--gold); font-weight:700; }
.bb-btns { display:flex; gap:10px; }
.bb-cancel {
  flex:1; padding:11px; border-radius:12px;
  border:1px solid rgba(255,255,255,0.15);
  background:rgba(255,255,255,0.06); color:rgba(255,255,255,0.6);
  font-family:'Fredoka One',sans-serif; font-size:15px; cursor:pointer;
}
.bb-confirm {
  flex:2; padding:11px; border-radius:12px; border:none;
  background:linear-gradient(135deg,var(--scatter),#9b00ff);
  color:#fff; font-family:'Fredoka One',sans-serif; font-size:15px; cursor:pointer;
  box-shadow:0 4px 16px rgba(255,77,166,0.4); transition:all 0.2s;
}
.bb-confirm:hover { transform:translateY(-1px); }
.bb-splash {
  position:fixed; inset:0; pointer-events:none; z-index:90;
  background:radial-gradient(ellipse at center,rgba(255,77,166,0.5),transparent 70%);
  animation:bbSplash 1.2s ease forwards;
}
@keyframes bbSplash {
  0%   { opacity:0; transform:scale(0.4); }
  25%  { opacity:1; transform:scale(1); }
  100% { opacity:0; transform:scale(1.3); }
}

/* Win overlay */
.win-overlay {
  position:fixed; inset:0; display:flex; align-items:center; justify-content:center;
  z-index:100; pointer-events:none; opacity:0; transition:opacity 0.3s;
}
.win-overlay.show { opacity:1; }
.win-popup {
  background:radial-gradient(ellipse,#2d0060,#0d001f);
  border:3px solid var(--gold); border-radius:28px;
  padding:24px 44px; text-align:center;
  box-shadow:0 0 60px rgba(255,215,0,0.5);
  animation:popIn 0.4s cubic-bezier(0.34,1.56,0.64,1);
}
@keyframes popIn { from{transform:scale(0.3) rotate(-8deg);opacity:0} to{transform:scale(1) rotate(0);opacity:1} }
.win-emoji { font-size:48px; margin-bottom:4px; }
.win-title { font-family:'Fredoka One',sans-serif; font-size:28px; color:var(--gold); text-shadow:0 0 16px var(--gold); }
.win-amount { font-family:'Fredoka One',sans-serif; font-size:44px; color:var(--win); text-shadow:0 0 24px var(--win); }
.win-mult { font-size:14px; color:rgba(255,255,255,0.6); margin-top:2px; }

.turbo-btn {
  width:44px; height:70px;
  border-radius:12px; border:2px solid rgba(255,255,255,0.15);
  background:rgba(255,255,255,0.06);
  color:rgba(255,255,255,0.5);
  font-size:22px; cursor:pointer;
  transition:all 0.2s;
  display:flex; flex-direction:column; align-items:center; justify-content:center; gap:2px;
  flex-shrink:0;
}
.turbo-btn span { font-size:9px; text-transform:uppercase; letter-spacing:0.5px; line-height:1; }
.turbo-btn.active {
  background:rgba(255,215,0,0.15);
  border-color:var(--gold);
  color:var(--gold);
  box-shadow:0 0 14px rgba(255,215,0,0.25);
}

/* Reel column wrappers */
.col {
  display:flex; flex-direction:column; gap:3px;
  transition:none;
}
.col.stopping {
  animation:colBounce 0.25s cubic-bezier(0.22,1,0.36,1);
}
@keyframes colBounce {
  0%   { transform:translateY(-8px); }
  60%  { transform:translateY(4px); }
  100% { transform:translateY(0); }
}

/* Confetti */
.confetti { position:fixed; pointer-events:none; z-index:99; border-radius:2px; animation:confettiFall var(--dur) ease-in forwards; }
@keyframes confettiFall { 0%{transform:translateY(-20px) rotate(0);opacity:1} 100%{transform:translateY(100vh) rotate(720deg);opacity:0} }
</style>
</head>
<body>
<div class="stars" id="stars"></div>

<div class="win-overlay" id="winOverlay">
  <div class="win-popup">
    <div class="win-emoji">ğŸ‰</div>
    <div class="win-title">WYGRANA!</div>
    <div class="win-amount" id="winAmount">+500</div>
    <div class="win-mult" id="winMult"></div>
  </div>
</div>

<div class="wrap">
  <div class="header">
    <div class="logo">ğŸ­ Lucky Bonanza</div>
    <div class="balance-box">
      <span>ğŸª™</span>
      <span class="balance-val" id="balVal">â€”</span>
    </div>
  </div>

  <div class="info-bar">
    <div class="info-pill">RTP <span>90%</span></div>
    <div class="info-pill">Pole <span>6Ã—5</span></div>
    <div class="info-pill">Max <span>Ã—200</span></div>
  </div>

  <div class="fs-banner" id="fsBanner">ğŸ° DARMOWE SPINY: <span id="fsCount">0</span> pozostaÅ‚o!</div>

  <!-- 6x5 Grid -->
  <div class="grid-outer">
    <div class="grid" id="grid"></div>
  </div>

  <div class="result-bar">
    <div class="result-text" id="resultText"></div>
  </div>

  <!-- Controls -->
  <div class="controls">
    <div class="bet-wrap">
      <div class="bet-label">Stawka (Å¼etony)</div>
      <div class="bet-row">
        <button class="bet-btn active" data-bet="5"  onclick="selectBet(5)">5</button>
        <button class="bet-btn"        data-bet="10" onclick="selectBet(10)">10</button>
        <button class="bet-btn"        data-bet="25" onclick="selectBet(25)">25</button>
        <button class="bet-btn"        data-bet="50" onclick="selectBet(50)">50</button>
      </div>
    </div>
    <button class="turbo-btn" id="turboBtn" onclick="toggleTurbo()">
      âš¡<span>Turbo</span>
    </button>
    <button class="spin-btn go" id="spinBtn" onclick="spin()">
      <span class="spin-icon">ğŸ°</span>
      <span>ZAKRÄ˜Ä†</span>
    </button>
  </div>

  <!-- Buy Bonus -->
  <button class="buy-bonus-btn" id="buyBonusBtn" onclick="openBuyBonus()">
    <div class="bb-left">
      <span style="font-size:22px">ğŸ</span>
      <div>
        <div class="bb-title">Buy Bonus</div>
        <div class="bb-desc">10 Free SpinÃ³w natychmiast!</div>
      </div>
    </div>
    <div class="bb-price" id="bbPrice">500 ğŸª™</div>
  </button>

  <!-- History -->
  <div class="history-wrap">
    <div class="history-title">Ostatnie spiny</div>
    <div class="history-list" id="histList">
      <div style="text-align:center;color:rgba(255,255,255,0.25);font-size:12px">Brak historii</div>
    </div>
  </div>

  <!-- Paytable -->
  <div class="paytable-wrap">
    <div class="pt-title">Tabela wypÅ‚at (8+ symboli = wygrana)</div>
    <div class="pt-grid">
      <div class="pt-item"><div class="pt-sym">ğŸ’</div><div class="pt-rows">
        <div class="pt-row">8+ â†’ <span>Ã—0.5</span></div>
        <div class="pt-row">12+ â†’ <span>Ã—1</span></div>
        <div class="pt-row">20+ â†’ <span>Ã—3</span></div>
      </div></div>
      <div class="pt-item"><div class="pt-sym">ğŸ‹</div><div class="pt-rows">
        <div class="pt-row">8+ â†’ <span>Ã—0.8</span></div>
        <div class="pt-row">12+ â†’ <span>Ã—2</span></div>
        <div class="pt-row">20+ â†’ <span>Ã—5</span></div>
      </div></div>
      <div class="pt-item"><div class="pt-sym">ğŸŠ</div><div class="pt-rows">
        <div class="pt-row">8+ â†’ <span>Ã—1</span></div>
        <div class="pt-row">12+ â†’ <span>Ã—3</span></div>
        <div class="pt-row">20+ â†’ <span>Ã—8</span></div>
      </div></div>
      <div class="pt-item"><div class="pt-sym">ğŸ‡</div><div class="pt-rows">
        <div class="pt-row">8+ â†’ <span>Ã—1.5</span></div>
        <div class="pt-row">12+ â†’ <span>Ã—5</span></div>
        <div class="pt-row">20+ â†’ <span>Ã—15</span></div>
      </div></div>
      <div class="pt-item"><div class="pt-sym">ğŸ­</div><div class="pt-rows">
        <div class="pt-row">8+ â†’ <span>Ã—3</span></div>
        <div class="pt-row">12+ â†’ <span>Ã—10</span></div>
        <div class="pt-row">20+ â†’ <span>Ã—50</span></div>
      </div></div>
      <div class="pt-item"><div class="pt-sym">ğŸ¬</div><div class="pt-rows">
        <div class="pt-row">8+ â†’ <span>Ã—5</span></div>
        <div class="pt-row">12+ â†’ <span>Ã—20</span></div>
        <div class="pt-row">20+ â†’ <span>Ã—100</span></div>
      </div></div>
      <div class="pt-item"><div class="pt-sym">ğŸ’</div><div class="pt-rows">
        <div class="pt-row">8+ â†’ <span>Ã—10</span></div>
        <div class="pt-row">12+ â†’ <span>Ã—40</span></div>
        <div class="pt-row">20+ â†’ <span>Ã—200</span></div>
      </div></div>
      <div class="pt-item"><div class="pt-sym">ğŸ«</div><div class="pt-rows">
        <div class="pt-row">8+ â†’ <span>Ã—2</span></div>
        <div class="pt-row">12+ â†’ <span>Ã—7</span></div>
        <div class="pt-row">20+ â†’ <span>Ã—30</span></div>
      </div></div>
    </div>
    <div class="pt-special">
      <div class="pt-spec-item">ğŸŒŸ <b>Wild</b><br><span style="color:var(--wild);font-size:10px">ZastÄ™puje + Ã—2/Ã—3</span></div>
      <div class="pt-spec-item">ğŸ’¥ <b>Scatter</b><br><span style="color:var(--scatter);font-size:10px">4+ = 10 Free SpinÃ³w</span></div>
    </div>
  </div>
</div>

<!-- Buy Bonus Modal -->
<div class="bb-modal" id="bbModal">
  <div class="bb-box">
    <div class="bb-box-title">ğŸ Buy Bonus</div>
    <div class="bb-box-sub">Kup Free Spiny bez czekania na Scattery</div>
    <div class="bb-info">
      <div class="bb-fs-num">10 Free SpinÃ³w</div>
      <div style="font-size:13px;color:rgba(255,255,255,0.5);margin-top:4px">Scatter dziaÅ‚a normalnie podczas FS</div>
      <div class="bb-cost" style="margin-top:10px">Koszt: <span id="bbModalPrice">500</span> ğŸª™</div>
      <div style="font-size:11px;color:rgba(255,255,255,0.35);margin-top:2px">TwÃ³j balans: <span id="bbModalBalance">â€”</span> ğŸª™</div>
    </div>
    <div class="bb-btns">
      <button class="bb-cancel" onclick="closeBuyBonus()">Anuluj</button>
      <button class="bb-confirm" id="bbConfirmBtn" onclick="confirmBuyBonus()">ğŸ° Kup teraz!</button>
    </div>
  </div>
</div>

<script>
// ==================== TELEGRAM ====================
const tg = window.Telegram?.WebApp;
if (tg) { tg.ready(); tg.expand(); tg.setHeaderColor('#0d001f'); tg.setBackgroundColor('#0d001f'); }
const initDataRaw = tg?.initData || '';

// ==================== GAME CONFIG ====================
// Scatter pays: Ğ²Ñ‹Ğ¿Ğ»Ğ°Ñ‚Ğ° Ğ·Ğ° N+ Ğ¾Ğ´Ğ¸Ğ½Ğ°ĞºĞ¾Ğ²Ñ‹Ñ… ÑĞ¸Ğ¼Ğ²Ğ¾Ğ»Ğ¾Ğ² Ğ½Ğ° Ğ¿Ğ¾Ğ»Ğµ (Ğ»ÑĞ±Ğ°Ñ Ğ¿Ğ¾Ğ·Ğ¸Ñ†Ğ¸Ñ)
const SYMS = ['ğŸ’','ğŸ‹','ğŸŠ','ğŸ‡','ğŸ«','ğŸ­','ğŸ¬','ğŸ’'];
const WILD = 'ğŸŒŸ';
const SCATTER = 'ğŸ’¥';

// Ğ¡Ğ¸Ğ¼Ğ²Ğ¾Ğ»ÑŒĞ½Ñ‹Ğµ Ğ»ĞµĞ½Ñ‚Ñ‹ â€” Scatter Ğ²ÑÑ‚Ñ€ĞµÑ‡Ğ°ĞµÑ‚ÑÑ 1 Ñ€Ğ°Ğ· Ğ½Ğ° 80 Ğ¿Ğ¾Ğ·Ğ¸Ñ†Ğ¸Ğ¹ (Ğ±Ñ‹Ğ»Ğ¾ 1/40 â€” ÑĞ»Ğ¸ÑˆĞºĞ¾Ğ¼ Ñ‡Ğ°ÑÑ‚Ğ¾)
// Wild â€” 1 Ñ€Ğ°Ğ· Ğ½Ğ° 50. Ğ­Ñ‚Ğ¾ Ğ´Ğ°Ñ‘Ñ‚ Ğ¼Ğ°Ñ‚ĞµĞ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¸ ĞºĞ¾Ñ€Ñ€ĞµĞºÑ‚Ğ½Ñ‹Ğ¹ RTP ~90%
const REELSTRIPS = [
  // Ğ‘Ğ°Ñ€Ğ°Ğ±Ğ°Ğ½ 1 (80 Ğ¿Ğ¾Ğ·Ğ¸Ñ†Ğ¸Ğ¹)
  ['ğŸ’','ğŸ‹','ğŸ’','ğŸŠ','ğŸ‡','ğŸ’','ğŸ‹','ğŸ«','ğŸ’','ğŸŠ','ğŸ’','ğŸ‹','ğŸ’','ğŸ‡','ğŸ’','ğŸŠ','ğŸ­','ğŸ’','ğŸ‹','ğŸ’',
   'ğŸ’','ğŸ‹','ğŸŠ','ğŸ’','ğŸ‡','ğŸ’','ğŸŠ','ğŸ‹','ğŸ’','ğŸ‡','ğŸ’','ğŸŠ','ğŸ‹','ğŸ’','ğŸ«','ğŸ’','ğŸ‹','ğŸ’','ğŸŠ','ğŸ’',
   'ğŸŒŸ','ğŸ’','ğŸ‹','ğŸ‡','ğŸ’','ğŸŠ','ğŸ­','ğŸ’','ğŸ‹','ğŸ’','ğŸŠ','ğŸ‹','ğŸ’','ğŸ‡','ğŸ’','ğŸŠ','ğŸ‹','ğŸ’','ğŸ«','ğŸ’',
   'ğŸ’','ğŸ‹','ğŸŠ','ğŸ’','ğŸ‡','ğŸ’','ğŸŠ','ğŸ‹','ğŸ’','ğŸ¬','ğŸ’','ğŸ‹','ğŸ’','ğŸŠ','ğŸ’','ğŸ‡','ğŸ’','ğŸŠ','ğŸ’¥','ğŸ’'],
  // Ğ‘Ğ°Ñ€Ğ°Ğ±Ğ°Ğ½ 2
  ['ğŸ‹','ğŸ’','ğŸŠ','ğŸ’','ğŸ‹','ğŸ‡','ğŸ’','ğŸŠ','ğŸ‹','ğŸ’','ğŸ‹','ğŸ’','ğŸŠ','ğŸ‹','ğŸ’','ğŸ‡','ğŸ‹','ğŸ’','ğŸŠ','ğŸ‹',
   'ğŸ’','ğŸ«','ğŸ‹','ğŸ’','ğŸŠ','ğŸ‹','ğŸ’','ğŸ‡','ğŸ‹','ğŸ’','ğŸŠ','ğŸ‹','ğŸ’','ğŸ­','ğŸ‹','ğŸ’','ğŸŠ','ğŸ‹','ğŸ’','ğŸ‹',
   'ğŸŒŸ','ğŸ‹','ğŸ’','ğŸŠ','ğŸ‹','ğŸ’','ğŸ‡','ğŸ‹','ğŸ’','ğŸŠ','ğŸ‹','ğŸ’','ğŸ‹','ğŸ’','ğŸŠ','ğŸ‹','ğŸ‡','ğŸ’','ğŸŠ','ğŸ‹',
   'ğŸ’','ğŸ¬','ğŸ‹','ğŸ’','ğŸŠ','ğŸ‹','ğŸ’','ğŸ‡','ğŸ‹','ğŸ’','ğŸŠ','ğŸ‹','ğŸ’','ğŸ‹','ğŸ’','ğŸŠ','ğŸ‹','ğŸ’¥','ğŸ’','ğŸ‹'],
  // Ğ‘Ğ°Ñ€Ğ°Ğ±Ğ°Ğ½ 3
  ['ğŸŠ','ğŸ’','ğŸ‹','ğŸŠ','ğŸ’','ğŸ‹','ğŸŠ','ğŸ‡','ğŸŠ','ğŸ’','ğŸ‹','ğŸŠ','ğŸ’','ğŸ‹','ğŸŠ','ğŸ‡','ğŸŠ','ğŸ’','ğŸ­','ğŸŠ',
   'ğŸ’','ğŸ‹','ğŸŠ','ğŸ’','ğŸŠ','ğŸ‹','ğŸ’','ğŸŠ','ğŸ‡','ğŸ’','ğŸŠ','ğŸ‹','ğŸ’','ğŸŠ','ğŸ«','ğŸŠ','ğŸ’','ğŸ‹','ğŸŠ','ğŸ’',
   'ğŸŒŸ','ğŸŠ','ğŸ’','ğŸ‹','ğŸŠ','ğŸ’','ğŸ‡','ğŸŠ','ğŸ’','ğŸ‹','ğŸŠ','ğŸ’','ğŸ‹','ğŸŠ','ğŸ’','ğŸ‡','ğŸŠ','ğŸ’','ğŸŠ','ğŸ‹',
   'ğŸ’','ğŸŠ','ğŸ‡','ğŸ’','ğŸ‹','ğŸŠ','ğŸ’','ğŸ’','ğŸŠ','ğŸ’','ğŸ‹','ğŸŠ','ğŸ’','ğŸ‡','ğŸŠ','ğŸ’','ğŸ‹','ğŸŠ','ğŸ’¥','ğŸ’'],
  // Ğ‘Ğ°Ñ€Ğ°Ğ±Ğ°Ğ½ 4
  ['ğŸ‡','ğŸŠ','ğŸ’','ğŸ‹','ğŸ‡','ğŸŠ','ğŸ’','ğŸ‡','ğŸ‹','ğŸŠ','ğŸ‡','ğŸ’','ğŸ‹','ğŸ‡','ğŸŠ','ğŸ’','ğŸ‡','ğŸŠ','ğŸ’','ğŸ‹',
   'ğŸ‡','ğŸ’','ğŸŠ','ğŸ‹','ğŸ‡','ğŸ’','ğŸ‡','ğŸŠ','ğŸ‹','ğŸ’','ğŸ‡','ğŸŠ','ğŸ’','ğŸ‹','ğŸ‡','ğŸŠ','ğŸ­','ğŸ‡','ğŸ’','ğŸ‹',
   'ğŸŒŸ','ğŸ‡','ğŸŠ','ğŸ’','ğŸ‹','ğŸ‡','ğŸ’','ğŸŠ','ğŸ‡','ğŸ‹','ğŸ’','ğŸ‡','ğŸŠ','ğŸ’','ğŸ‹','ğŸ‡','ğŸ«','ğŸŠ','ğŸ’','ğŸ‡',
   'ğŸ‹','ğŸ’','ğŸ‡','ğŸŠ','ğŸ’','ğŸ‹','ğŸ‡','ğŸ’','ğŸŠ','ğŸ‡','ğŸ‹','ğŸ’','ğŸ‡','ğŸ¬','ğŸŠ','ğŸ’','ğŸ‹','ğŸ‡','ğŸ’¥','ğŸ’'],
  // Ğ‘Ğ°Ñ€Ğ°Ğ±Ğ°Ğ½ 5
  ['ğŸ­','ğŸ‡','ğŸŠ','ğŸ’','ğŸ‹','ğŸ­','ğŸ’','ğŸŠ','ğŸ‹','ğŸ‡','ğŸ­','ğŸ’','ğŸŠ','ğŸ­','ğŸ‹','ğŸ‡','ğŸ­','ğŸ’','ğŸŠ','ğŸ­',
   'ğŸ‹','ğŸ’','ğŸ­','ğŸŠ','ğŸ‡','ğŸ­','ğŸ’','ğŸ‹','ğŸ­','ğŸŠ','ğŸ’','ğŸ­','ğŸ‡','ğŸ‹','ğŸ­','ğŸ’','ğŸŠ','ğŸ­','ğŸ‹','ğŸ’',
   'ğŸŒŸ','ğŸ­','ğŸ’','ğŸŠ','ğŸ‹','ğŸ­','ğŸ‡','ğŸ’','ğŸ­','ğŸŠ','ğŸ‹','ğŸ­','ğŸ’','ğŸ«','ğŸ­','ğŸŠ','ğŸ‹','ğŸ­','ğŸ’','ğŸ‡',
   'ğŸ­','ğŸŠ','ğŸ‹','ğŸ­','ğŸ’','ğŸ‡','ğŸ­','ğŸŠ','ğŸ‹','ğŸ­','ğŸ’','ğŸŠ','ğŸ­','ğŸ‹','ğŸ‡','ğŸ­','ğŸ’','ğŸŠ','ğŸ’¥','ğŸ­'],
  // Ğ‘Ğ°Ñ€Ğ°Ğ±Ğ°Ğ½ 6
  ['ğŸ¬','ğŸ­','ğŸ‡','ğŸŠ','ğŸ’','ğŸ‹','ğŸ¬','ğŸŠ','ğŸ’','ğŸ¬','ğŸ‹','ğŸ‡','ğŸ¬','ğŸ’','ğŸŠ','ğŸ¬','ğŸ‹','ğŸ’','ğŸ¬','ğŸ­',
   'ğŸŠ','ğŸ¬','ğŸ’','ğŸ‹','ğŸ¬','ğŸ‡','ğŸ’','ğŸ¬','ğŸŠ','ğŸ‹','ğŸ¬','ğŸ’','ğŸ­','ğŸ¬','ğŸŠ','ğŸ‹','ğŸ¬','ğŸ’','ğŸ‡','ğŸ¬',
   'ğŸŒŸ','ğŸ¬','ğŸ’','ğŸŠ','ğŸ‹','ğŸ¬','ğŸ‡','ğŸ’','ğŸ¬','ğŸŠ','ğŸ‹','ğŸ¬','ğŸ’','ğŸ­','ğŸ¬','ğŸŠ','ğŸ‹','ğŸ¬','ğŸ«','ğŸ’',
   'ğŸ¬','ğŸŠ','ğŸ‹','ğŸ¬','ğŸ’','ğŸ‡','ğŸ¬','ğŸ’','ğŸ’','ğŸ¬','ğŸŠ','ğŸ‹','ğŸ¬','ğŸ’','ğŸ‡','ğŸ¬','ğŸŠ','ğŸ’','ğŸ’¥','ğŸ¬'],
];

// Ğ¢Ğ°Ğ±Ğ»Ğ¸Ñ†Ğ° Ğ²Ñ‹Ğ¿Ğ»Ğ°Ñ‚: ÑĞ¸Ğ¼Ğ²Ğ¾Ğ» â†’ { minCount: multiplier }
const PAY_TABLE = {
  'ğŸ’': { 8:0.5,  10:0.8,  12:1,   15:2,   20:3   },
  'ğŸ‹': { 8:0.8,  10:1,    12:2,   15:3,   20:5   },
  'ğŸŠ': { 8:1,    10:1.5,  12:3,   15:5,   20:8   },
  'ğŸ‡': { 8:1.5,  10:2,    12:5,   15:8,   20:15  },
  'ğŸ«': { 8:2,    10:3,    12:7,   15:12,  20:30  },
  'ğŸ­': { 8:3,    10:5,    12:10,  15:20,  20:50  },
  'ğŸ¬': { 8:5,    10:8,    12:20,  15:40,  20:100 },
  'ğŸ’': { 8:10,   10:15,   12:40,  15:80,  20:200 },
};

// Wild Ğ¼ÑƒĞ»ÑŒÑ‚Ğ¸Ğ¿Ğ»Ğ¸ĞºĞ°Ñ‚Ğ¾Ñ€Ñ‹ (ÑĞ»ÑƒÑ‡Ğ°Ğ¹Ğ½Ñ‹Ğ¹ Ğ¿Ñ€Ğ¸ Ğ²Ñ‹Ğ¸Ğ³Ñ€Ñ‹ÑˆĞµ)
const WILD_MULTS = [2, 2, 2, 3, 3, 5];

let balance = 100;
let bet = 5;
let spinning = false;
let freeSpins = 0;
let history = [];
let grid = []; // [col][row] = symbol

// ==================== STARS ====================
function createStars() {
  const c = document.getElementById('stars');
  for (let i = 0; i < 50; i++) {
    const s = document.createElement('div');
    s.className = 'star';
    const sz = Math.random()*2.5+0.5;
    s.style.cssText = `width:${sz}px;height:${sz}px;left:${Math.random()*100}%;top:${Math.random()*100}%;--d:${(Math.random()*3+1).toFixed(1)}s;animation-delay:${(Math.random()*3).toFixed(1)}s`;
    c.appendChild(s);
  }
}

// ==================== GRID RENDERING ====================
function buildGrid() {
  const g = document.getElementById('grid');
  g.innerHTML = '';
  // 6 cols x 5 rows â€” CSS grid is column-major for us, we build row by row
  for (let row = 0; row < 5; row++) {
    for (let col = 0; col < 6; col++) {
      const cell = document.createElement('div');
      cell.className = 'cell';
      cell.id = `cell-${col}-${row}`;
      g.appendChild(cell);
    }
  }
}

async function renderGrid(symbols, winCells = [], wildMults = {}, animate = false) {
  for (let col = 0; col < 6; col++) {
    for (let row = 0; row < 5; row++) {
      const cell = document.getElementById(`cell-${col}-${row}`);
      const sym = symbols[col][row];
      cell.textContent = sym;
      cell.className = 'cell';
      const oldBadge = cell.querySelector('.mult-badge');
      if (oldBadge) oldBadge.remove();

      if (sym === WILD) {
        cell.classList.add('wild-cell');
        if (animate) {
          // Ğ’ÑĞ¿Ñ‹ÑˆĞºĞ° Ğ¿Ñ€Ğ¸ Ğ¿Ğ¾ÑĞ²Ğ»ĞµĞ½Ğ¸Ğ¸ Wild
          setTimeout(() => {
            cell.classList.add('wild-flash');
            setTimeout(() => cell.classList.remove('wild-flash'), 650);
            if (tg) tg.HapticFeedback.impactOccurred('medium');
          }, col * 80 + row * 40);
        }
      }
      if (sym === SCATTER) {
        cell.classList.add('scatter-cell');
        if (animate) {
          setTimeout(() => {
            cell.classList.add('scatter-flash');
            setTimeout(() => cell.classList.remove('scatter-flash'), 750);
          }, col * 80 + row * 40 + 100);
        }
      }
    }
  }
  // Mark winning cells
  winCells.forEach(([col, row]) => {
    const cell = document.getElementById(`cell-${col}-${row}`);
    if (cell) cell.classList.add('winning');
  });
}

function showScatterPopup(count, freeSpinsAwarded) {
  const el = document.createElement('div');
  el.className = 'scatter-count-badge';
  if (count === 0) {
    el.innerHTML = `ğŸ Buy Bonus!<br><span style="font-size:18px">+${freeSpinsAwarded} Free SpinÃ³w!</span>`;
  } else if (freeSpinsAwarded > 0) {
    el.innerHTML = `ğŸ’¥ ${count} Scattery!<br><span style="font-size:18px">+${freeSpinsAwarded} Free SpinÃ³w!</span>`;
  } else {
    el.innerHTML = `ğŸ’¥ Scatter!<br><span style="font-size:18px">+${count * 3} dodatkowych spinÃ³w!</span>`;
  }
  document.body.appendChild(el);
  setTimeout(() => el.remove(), 2100);
  if (tg) tg.HapticFeedback.notificationOccurred('success');
}

// ==================== SPIN MECHANICS ====================
function spinReelstrip(reelIdx) {
  const strip = REELSTRIPS[reelIdx];
  const pos = Math.floor(Math.random() * strip.length);
  const result = [];
  for (let i = 0; i < 5; i++) {
    result.push(strip[(pos + i) % strip.length]);
  }
  return result;
}

function generateGrid() {
  // grid[col][row]
  const g = [];
  for (let col = 0; col < 6; col++) {
    g.push(spinReelstrip(col));
  }
  return g;
}

function countSymbols(g) {
  const counts = {};
  const positions = {};
  for (let col = 0; col < 6; col++) {
    for (let row = 0; row < 5; row++) {
      const sym = g[col][row];
      if (sym === WILD || sym === SCATTER) continue;
      counts[sym] = (counts[sym] || 0) + 1;
      if (!positions[sym]) positions[sym] = [];
      positions[sym].push([col, row]);
    }
  }
  return { counts, positions };
}

function countWilds(g) {
  const wilds = [];
  const mults = {};
  for (let col = 0; col < 6; col++) {
    for (let row = 0; row < 5; row++) {
      if (g[col][row] === WILD) {
        wilds.push([col, row]);
        mults[`${col}-${row}`] = WILD_MULTS[Math.floor(Math.random() * WILD_MULTS.length)];
      }
    }
  }
  return { wilds, mults };
}

function countScatters(g) {
  const scatters = [];
  for (let col = 0; col < 6; col++) {
    for (let row = 0; row < 5; row++) {
      if (g[col][row] === SCATTER) scatters.push([col, row]);
    }
  }
  return scatters;
}

function getMultiplier(sym, count) {
  const table = PAY_TABLE[sym];
  if (!table) return 0;
  const thresholds = Object.keys(table).map(Number).sort((a,b) => b-a);
  for (const t of thresholds) {
    if (count >= t) return table[t];
  }
  return 0;
}

function calculateWin(g, bet, isFreeSpinMode = false) {
  const { counts, positions } = countSymbols(g);
  const { wilds, mults } = countWilds(g);
  const scatters = countScatters(g);

  let totalMult = 0;
  let winCells = [];
  let winDetails = [];

  // Wild Ğ·Ğ°Ğ¼ĞµĞ½ÑĞµÑ‚ Ğ»ÑĞ±Ğ¾Ğ¹ ÑĞ¸Ğ¼Ğ²Ğ¾Ğ» â€” Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ»ÑĞµĞ¼ ĞµĞ³Ğ¾ ÑÑ‡Ñ‘Ñ‚ Ğº ĞºĞ°Ğ¶Ğ´Ğ¾Ğ¼Ñƒ ÑĞ¸Ğ¼Ğ²Ğ¾Ğ»Ñƒ
  const wildBonusMult = wilds.length > 0 ? Math.max(...wilds.map(([c,r]) => mults[`${c}-${r}`] || 2)) : 1;

  for (const [sym, count] of Object.entries(counts)) {
    const effectiveCount = count + wilds.length; // Wilds Ğ·Ğ°Ğ¼ĞµÑ‰Ğ°ÑÑ‚
    const mult = getMultiplier(sym, effectiveCount);
    if (mult > 0) {
      const finalMult = mult * (wilds.length > 0 ? wildBonusMult : 1);
      totalMult += finalMult;
      winCells.push(...positions[sym]);
      if (wilds.length > 0) winCells.push(...wilds);
      winDetails.push({ sym, count: effectiveCount, mult: finalMult });
    }
  }

  // Scatter Ğ»Ğ¾Ğ³Ğ¸ĞºĞ° â€” Ğ¢ĞĞ›Ğ¬ĞšĞ Ğ² Ğ±Ğ°Ğ·Ğ¾Ğ²Ğ¾Ğ¹ Ğ¸Ğ³Ñ€Ğµ, Ğ½Ğ° Ñ„Ñ€Ğ¸ÑĞ¿Ğ¸Ğ½Ğ°Ñ… scatter Ğ½Ğµ Ğ´Ğ°Ñ‘Ñ‚ Ğ´Ğ¾Ğ¿.ÑĞ¿Ğ¸Ğ½Ñ‹
  let newFreeSpins = 0;
  let scatterBonus = 0;

  if (!isFreeSpinMode) {
    if (scatters.length >= 5)       { newFreeSpins = 15; winCells.push(...scatters); }
    else if (scatters.length === 4) { newFreeSpins = 10; winCells.push(...scatters); }
    else if (scatters.length === 3) { newFreeSpins = 5;  winCells.push(...scatters); }
    // 1-2 scatter â€” Ğ¿Ñ€Ğ¾ÑÑ‚Ğ¾ Ğ¿Ğ¾Ğ´ÑĞ²ĞµÑ‡Ğ¸Ğ²Ğ°ĞµĞ¼, Ğ½Ğ¸Ñ‡ĞµĞ³Ğ¾ Ğ½Ğµ Ğ´Ğ°Ñ‘Ğ¼
  }
  // ĞĞ° Ñ„Ñ€Ğ¸ÑĞ¿Ğ¸Ğ½Ğ°Ñ… scatter Ğ²Ğ¾Ğ¾Ğ±Ñ‰Ğµ Ğ½Ğ¸Ñ‡ĞµĞ³Ğ¾ Ğ½Ğµ Ñ‚Ñ€Ğ¸Ğ³Ğ³ĞµÑ€Ğ¸Ñ‚ â€” Ğ¸Ğ½Ğ°Ñ‡Ğµ Ğ±ĞµÑĞºĞ¾Ğ½ĞµÑ‡Ğ½Ñ‹Ğ¹ Ñ†Ğ¸ĞºĞ»

  const winnings = Math.round(totalMult * bet);

  return { winnings, totalMult, winCells, winDetails, newFreeSpins, scatterBonus, scatterCount: scatters.length, mults, wilds };
}

// ==================== TURBO ====================
let turboMode = false;

function toggleTurbo() {
  turboMode = !turboMode;
  const btn = document.getElementById('turboBtn');
  btn.classList.toggle('active', turboMode);
  if (tg) tg.HapticFeedback.impactOccurred('light');
}

// ==================== ANIMATION ====================
const ALL_SYMS = ['ğŸ’','ğŸ‹','ğŸŠ','ğŸ‡','ğŸ«','ğŸ­','ğŸ¬','ğŸ’','ğŸŒŸ','ğŸ’¥'];

function randSym() { return ALL_SYMS[Math.floor(Math.random() * ALL_SYMS.length)]; }

// ĞšÑ€ÑƒÑ‚Ğ¸Ñ‚ Ğ¾Ğ´Ğ¸Ğ½ ÑÑ‚Ğ¾Ğ»Ğ±ĞµÑ† Ñ Ğ½ÑƒĞ¶Ğ½Ğ¾Ğ¹ ÑĞºĞ¾Ñ€Ğ¾ÑÑ‚ÑŒÑ, Ğ¿Ğ¾Ñ‚Ğ¾Ğ¼ Ğ¾ÑÑ‚Ğ°Ğ½Ğ°Ğ²Ğ»Ğ¸Ğ²Ğ°ĞµÑ‚
async function spinColumn(col, finalSyms, spinDuration, stopDelay) {
  await sleep(stopDelay);

  const cells = [];
  for (let row = 0; row < 5; row++) {
    cells.push(document.getElementById(`cell-${col}-${row}`));
  }

  const interval = turboMode ? 50 : 80;
  let elapsed = 0;

  while (elapsed < spinDuration) {
    cells.forEach(c => {
      c.textContent = randSym();
      c.className = 'cell spinning';
    });
    await sleep(interval);
    elapsed += interval;
  }

  // Bounce Ğ¾ÑÑ‚Ğ°Ğ½Ğ¾Ğ²ĞºĞ°
  cells.forEach((c, row) => {
    const sym = finalSyms[row];
    c.textContent = sym;
    c.className = 'cell';
    if (sym === WILD) c.classList.add('wild-cell');
    if (sym === SCATTER) c.classList.add('scatter-cell');
  });

  // Bounce ÑÑ„Ñ„ĞµĞºÑ‚ â€” Ñ‡ĞµÑ€ĞµĞ· CSS
  const colCells = document.querySelectorAll(`[id^="cell-${col}-"]`);
  colCells.forEach(c => {
    c.style.animation = 'colBounce 0.25s cubic-bezier(0.22,1,0.36,1)';
    setTimeout(() => { c.style.animation = ''; }, 300);
  });

  if (tg && !turboMode) tg.HapticFeedback.impactOccurred('light');
}

async function animateSpinning(finalGrid) {
  // Ğ”ĞµÑ„Ğ¾Ğ»Ñ‚: ĞºĞ°Ğ¶Ğ´Ñ‹Ğ¹ ÑÑ‚Ğ¾Ğ»Ğ±ĞµÑ† ĞºÑ€ÑƒÑ‚Ğ¸Ñ‚ÑÑ Ğ¸ Ğ¾ÑÑ‚Ğ°Ğ½Ğ°Ğ²Ğ»Ğ¸Ğ²Ğ°ĞµÑ‚ÑÑ Ñ Ğ·Ğ°Ğ´ĞµÑ€Ğ¶ĞºĞ¾Ğ¹
  // Turbo: Ğ²ÑÑ‘ Ğ±Ñ‹ÑÑ‚Ñ€Ğ¾ Ğ¿Ğ¾Ñ‡Ñ‚Ğ¸ Ğ¾Ğ´Ğ½Ğ¾Ğ²Ñ€ĞµĞ¼ĞµĞ½Ğ½Ğ¾
  const baseSpin  = turboMode ? 300  : 1800; // Ğ±Ğ°Ğ·Ğ¾Ğ²Ğ¾Ğµ Ğ²Ñ€ĞµĞ¼Ñ ĞºÑ€ÑƒÑ‡ĞµĞ½Ğ¸Ñ
  const stopGap   = turboMode ? 60   : 280;  // Ğ·Ğ°Ğ´ĞµÑ€Ğ¶ĞºĞ° Ğ¼ĞµĞ¶Ğ´Ñƒ ÑÑ‚Ğ¾Ğ»Ğ±Ñ†Ğ°Ğ¼Ğ¸

  const promises = [];
  for (let col = 0; col < 6; col++) {
    const spinDur  = baseSpin + (turboMode ? 0 : col * 100); // ĞºĞ°Ğ¶Ğ´Ñ‹Ğ¹ ÑĞ»ĞµĞ´ÑƒÑÑ‰Ğ¸Ğ¹ Ñ‡ÑƒÑ‚ÑŒ Ğ´Ğ¾Ğ»ÑŒÑˆĞµ
    const delay    = col * stopGap;
    promises.push(spinColumn(col, finalGrid[col], spinDur, delay));
  }
  await Promise.all(promises);
}

function sleep(ms) { return new Promise(r => setTimeout(r, ms)); }

// ==================== MAIN SPIN ====================
async function spin() {
  if (spinning) return;

  const isFreeSpinMode = freeSpins > 0;

  if (!isFreeSpinMode && balance < bet) {
    showResult('NiewystarczajÄ…ce Å¼etony! Kup wiÄ™cej ğŸ‘‡', 'lose');
    if (tg) tg.HapticFeedback.notificationOccurred('error');
    return;
  }

  spinning = true;
  const btn = document.getElementById('spinBtn');
  btn.disabled = true;
  btn.classList.remove('go');
  setResult('', '');

  if (!isFreeSpinMode) {
    balance -= bet;
    updateBalance();
  } else {
    freeSpins--;
    updateFsBanner();
  }

  // Generate result BEFORE animation
  grid = generateGrid();
  const result = calculateWin(grid, bet, isFreeSpinMode);

  // Animate columns stopping
  await animateSpinning(grid);

  // Animate Wild/Scatter appearances
  const hasSpecials = result.wilds.length > 0 || result.scatterCount > 0;
  await renderGrid(grid, result.winCells, result.mults, hasSpecials);

  // Wait for flash animations if specials present
  if (hasSpecials && !turboMode) await sleep(400);

  // Show scatter popup
  if (result.scatterCount >= 3 && result.newFreeSpins > 0) {
    showScatterPopup(result.scatterCount, result.newFreeSpins);
    await sleep(turboMode ? 400 : 1800);
  } else if (result.scatterBonus > 0) {
    showScatterPopup(result.scatterCount, 0);
    await sleep(turboMode ? 300 : 1500);
  }

  // Update balance
  if (result.winnings > 0) balance += result.winnings;

  // Free spins handling
  if (result.newFreeSpins > 0) {
    freeSpins += result.newFreeSpins;
    updateFsBanner();
  }
  if (result.scatterBonus > 0) {
    freeSpins += result.scatterBonus;
    updateFsBanner();
  }

  updateBalance();
  await recordSpin(grid, result.winnings, isFreeSpinMode ? 0 : bet);

  // Show result text
  if (result.scatterBonus > 0 && result.winnings === 0) {
    showResult(`ğŸ’¥ +${result.scatterBonus} dodatkowych spinÃ³w!`, 'fs');
  } else if (result.newFreeSpins > 0 && result.winnings === 0) {
    showResult(`ğŸ’¥ ${result.scatterCount} Scattery! +${result.newFreeSpins} Free SpinÃ³w!`, 'fs');
  } else if (result.winnings > 0 && result.newFreeSpins > 0) {
    showResult(`ğŸ‰ +${result.winnings} Å¼et. + ${result.newFreeSpins} FS!`, 'win');
    if (tg) tg.HapticFeedback.notificationOccurred('success');
    confetti(true);
  } else if (result.winnings > 0) {
    const multStr = result.totalMult >= 2 ? ` Ã—${result.totalMult.toFixed(1)}` : '';
    showResult(`ğŸ‰ +${result.winnings} Å¼et.${multStr}`, 'win');
    if (tg) tg.HapticFeedback.notificationOccurred('success');
    if (result.winnings >= bet * 5) {
      showWinOverlay(result.winnings, result.totalMult);
      confetti(result.winnings >= bet * 20);
    }
  } else {
    showResult('ğŸ˜” Brak wygranej', 'lose');
    if (tg) tg.HapticFeedback.impactOccurred('light');
  }

  const topSym = result.winDetails.length > 0 ? result.winDetails[0].sym
               : result.scatterCount > 0 ? SCATTER : 'â€”';
  addHistory(topSym, result.winnings, isFreeSpinMode ? 0 : bet, result.newFreeSpins > 0 || result.scatterBonus > 0);

  btn.disabled = false;
  btn.classList.add('go');
  spinning = false;

  if (freeSpins > 0) {
    await sleep(turboMode ? 400 : 1000);
    spin();
  }
}

// ==================== UI ====================
const BB_MULTIPLIER = 100; // Buy Bonus = 100x ÑÑ‚Ğ°Ğ²ĞºĞ¸ (ĞºĞ°Ğº Sweet Bonanza)

function selectBet(val) {
  bet = val;
  document.querySelectorAll('.bet-btn').forEach(b => b.classList.toggle('active', parseInt(b.dataset.bet) === val));
  updateBBPrice();
}

function updateBBPrice() {
  const price = bet * BB_MULTIPLIER;
  document.getElementById('bbPrice').textContent = `${price} ğŸª™`;
  const btn = document.getElementById('buyBonusBtn');
  btn.disabled = spinning || freeSpins > 0 || balance < price;
}

function updateBalance() {
  document.getElementById('balVal').textContent = balance;
  updateBBPrice();
}

// ==================== BUY BONUS ====================
function openBuyBonus() {
  if (spinning || freeSpins > 0) return;
  const price = bet * BB_MULTIPLIER;
  document.getElementById('bbModalPrice').textContent = price;
  document.getElementById('bbModalBalance').textContent = balance;
  const confirmBtn = document.getElementById('bbConfirmBtn');
  confirmBtn.disabled = balance < price;
  confirmBtn.textContent = balance < price ? 'âŒ Za maÅ‚o Å¼etonÃ³w' : 'ğŸ° Kup teraz!';
  document.getElementById('bbModal').classList.add('show');
  if (tg) tg.HapticFeedback.impactOccurred('medium');
}

function closeBuyBonus() {
  document.getElementById('bbModal').classList.remove('show');
}

async function confirmBuyBonus() {
  const price = bet * BB_MULTIPLIER;
  if (balance < price) return;

  closeBuyBonus();

  balance -= price;
  updateBalance();

  // Splash ÑÑ„Ñ„ĞµĞºÑ‚
  const splash = document.createElement('div');
  splash.className = 'bb-splash';
  document.body.appendChild(splash);
  setTimeout(() => splash.remove(), 1300);

  // Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ÑĞµĞ¼ Ñ„Ñ€Ğ¸ÑĞ¿Ğ¸Ğ½Ñ‹
  freeSpins += 10;
  updateFsBanner();

  if (tg) tg.HapticFeedback.notificationOccurred('success');

  // ĞŸĞ¾ĞºĞ°Ğ·Ñ‹Ğ²Ğ°ĞµĞ¼ popup
  showScatterPopup(0, 10);
  await sleep(1800);

  // Ğ—Ğ°Ğ¿Ğ¸ÑÑ‹Ğ²Ğ°ĞµĞ¼ Ğ² API (ÑÑ‚Ğ°Ğ²ĞºĞ° = Ñ†ĞµĞ½Ğ° Ğ±Ğ¾Ğ½ÑƒÑĞ°, Ğ²Ñ‹Ğ¸Ğ³Ñ€Ñ‹Ñˆ = 0 Ğ¿Ğ¾ĞºĞ°)
  await recordSpin([], 0, price);

  // Ğ—Ğ°Ğ¿ÑƒÑĞºĞ°ĞµĞ¼ Ñ„Ñ€Ğ¸ÑĞ¿Ğ¸Ğ½Ñ‹
  spin();
}

function updateFsBanner() {
  const banner = document.getElementById('fsBanner');
  document.getElementById('fsCount').textContent = freeSpins;
  banner.classList.toggle('active', freeSpins > 0);
}

function setResult(text, cls) {
  const el = document.getElementById('resultText');
  el.className = 'result-text';
  el.textContent = text;
}

function showResult(text, cls) {
  const el = document.getElementById('resultText');
  el.className = 'result-text';
  el.textContent = text;
  void el.offsetWidth;
  setTimeout(() => { el.classList.add('show', cls); }, 30);
}

function showWinOverlay(amount, mult) {
  const ov = document.getElementById('winOverlay');
  document.getElementById('winAmount').textContent = `+${amount} Å¼et.`;
  document.getElementById('winMult').textContent = mult >= 2 ? `MnoÅ¼nik Ã—${mult.toFixed(1)}` : '';
  ov.classList.add('show');
  setTimeout(() => ov.classList.remove('show'), 2500);
}

function addHistory(sym, winnings, betAmt, hasFs) {
  history.unshift({ sym, winnings, bet: betAmt, hasFs });
  if (history.length > 6) history.pop();
  const list = document.getElementById('histList');
  list.innerHTML = history.map(h => {
    const net = h.winnings - h.bet;
    let cls, text;
    if (h.hasFs && h.winnings === 0) { cls='fs'; text='FS!'; }
    else if (h.winnings > h.bet) { cls='win'; text=`+${net}`; }
    else if (h.winnings === h.bet) { cls='push'; text='Â±0'; }
    else { cls='lose'; text=`-${h.bet || '0'}`; }
    return `<div class="h-item">
      <span class="h-syms">${h.sym} Ã—${h.bet || 'FS'}</span>
      <span class="h-res ${cls}">${text} Å¼et.</span>
    </div>`;
  }).join('');
}

function confetti(big=false) {
  const n = big ? 100 : 50;
  const colors = ['#ffd700','#ff4da6','#00f5d4','#ff9500','#a855f7','#fff','#00e676'];
  for (let i=0; i<n; i++) {
    setTimeout(() => {
      const el = document.createElement('div');
      el.className = 'confetti';
      const sz = Math.random()*10+4;
      el.style.cssText = `left:${Math.random()*100}vw;top:-10px;background:${colors[Math.floor(Math.random()*colors.length)]};width:${sz}px;height:${sz}px;--dur:${(Math.random()*2+1.5).toFixed(1)}s;border-radius:${Math.random()>0.5?'50%':'2px'}`;
      document.body.appendChild(el);
      setTimeout(() => el.remove(), 4000);
    }, i*20);
  }
}

// ==================== API ====================
// API_BASE Ñ‡Ğ¸Ñ‚Ğ°ĞµÑ‚ÑÑ Ğ¸Ğ· Ğ¼ĞµÑ‚Ğ°-Ñ‚ĞµĞ³Ğ° â€” Ñ‚Ğ°Ğº Ğ»ĞµĞ³ĞºĞ¾ Ğ¼ĞµĞ½ÑÑ‚ÑŒ Ğ±ĞµĞ· Ñ€ĞµĞ´Ğ°ĞºÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ ĞºĞ¾Ğ´Ğ°
const API_BASE = document.querySelector('meta[name="api-base"]')?.content || '';
const DEV_MODE = !API_BASE || !initDataRaw;

if (DEV_MODE) {
  console.warn(
    '%c[Lucky Bonanza] DEV MODE\n' +
    'Ğ‘Ğ°Ğ»Ğ°Ğ½Ñ Ğ½Ğµ ÑĞ¸Ğ½Ñ…Ñ€Ğ¾Ğ½Ğ¸Ğ·Ğ¸Ñ€ÑƒĞµÑ‚ÑÑ Ñ Ğ±Ğ¾Ñ‚Ğ¾Ğ¼.\n' +
    'Ğ§Ñ‚Ğ¾Ğ±Ñ‹ Ğ¿Ğ¾Ğ´ĞºĞ»ÑÑ‡Ğ¸Ñ‚ÑŒ Ğ±Ğ¾Ñ‚Ğ°:\n' +
    '1. pip install pyngrok\n' +
    '2. ngrok http 8081\n' +
    '3. Ğ¡ĞºĞ¾Ğ¿Ğ¸Ñ€ÑƒĞ¹ https://xxxx.ngrok-free.app Ğ² Ğ¼ĞµÑ‚Ğ°-Ñ‚ĞµĞ³ api-base Ğ² index.html\n' +
    '4. ĞŸĞµÑ€ĞµĞ·Ğ°Ğ³Ñ€ÑƒĞ·Ğ¸ GitHub Pages',
    'color:orange;font-size:13px'
  );
}

async function fetchBalance() {
  if (DEV_MODE) {
    document.getElementById('balVal').textContent = balance + ' (DEV)';
    return;
  }
  try {
    const res = await fetch(`${API_BASE}/api/balance?init_data=${encodeURIComponent(initDataRaw)}`, {
      headers: { 'ngrok-skip-browser-warning': '1' },
      signal: AbortSignal.timeout(5000)
    });
    const data = await res.json();
    if (data.ok) {
      balance = data.balance;
      updateBalance();
    } else {
      console.error('Balance error:', data.error);
    }
  } catch(e) {
    console.warn('Balance fetch failed:', e.message);
    showResult('âš ï¸ Brak poÅ‚Ä…czenia z serwerem', 'lose');
  }
}

async function recordSpin(g, winnings, betAmt) {
  if (DEV_MODE) {
    return true;
  }
  try {
    const res = await fetch(`${API_BASE}/api/spin`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'ngrok-skip-browser-warning': '1'
      },
      body: JSON.stringify({
        init_data: initDataRaw,
        bet: betAmt,
        winnings: winnings,
        reels: Array.isArray(g) && g.length && Array.isArray(g[0]) ? g.flat() : g
      }),
      signal: AbortSignal.timeout(8000)
    });
    const data = await res.json();
    if (data.ok) {
      balance = data.balance;
      updateBalance();
      return true;
    } else if (data.error === 'Insufficient balance') {
      balance = data.balance;
      updateBalance();
      return false;
    }
  } catch(e) {
    console.warn('Spin record failed:', e.message);
  }
  return true;
}

// ==================== INIT ====================
createStars();
buildGrid();
// Init grid with random symbols
grid = generateGrid();
renderGrid(grid);
updateBalance();
fetchBalance();
 const tg = window.Telegram.WebApp;
    const urlParams = new URLSearchParams(window.location.search);
    const API_URL = urlParams.get('api'); 

    async function getBalanceFromBot() {
        if (!API_URL) {
            console.log("API_URL Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½ Ğ² ÑÑÑ‹Ğ»ĞºĞµ");
            return;
        }

        try {
            const response = await fetch(`${API_URL}/api/balance?init_data=${encodeURIComponent(tg.initData)}`);
            const data = await response.json();

            if (data.ok) {
                console.log("Ğ‘Ğ°Ğ»Ğ°Ğ½Ñ Ğ¿Ğ¾Ğ»ÑƒÑ‡ĞµĞ½:", data.balance);
                
                // 1. ĞĞ±Ğ½Ğ¾Ğ²Ğ»ÑĞµĞ¼ Ñ†Ğ¸Ñ„Ñ€Ñƒ Ğ½Ğ° ÑĞºÑ€Ğ°Ğ½Ğµ
                // Ğ£Ğ±ĞµĞ´Ğ¸ÑÑŒ, Ñ‡Ñ‚Ğ¾ Ñƒ Ñ‚ĞµĞ±Ñ Ğ² HTML ĞµÑÑ‚ÑŒ ÑĞ»ĞµĞ¼ĞµĞ½Ñ‚ Ñ id="balance-count" Ğ¸Ğ»Ğ¸ "balance"
                const balanceElement = document.getElementById('balance-count'); 
                if (balanceElement) {
                    balanceElement.innerText = data.balance;
                }

                // 2. Ğ’ĞĞ–ĞĞ: ĞĞ±Ğ½Ğ¾Ğ²Ğ¸ Ğ²Ğ½ÑƒÑ‚Ñ€ĞµĞ½Ğ½ÑÑ Ğ¿ĞµÑ€ĞµĞ¼ĞµĞ½Ğ½ÑƒÑ Ğ±Ğ°Ğ»Ğ°Ğ½ÑĞ° Ğ² ÑĞ°Ğ¼Ğ¾Ğ¹ Ğ¸Ğ³Ñ€Ğµ
                // Ğ’ Ñ€Ğ°Ğ·Ğ½Ñ‹Ñ… Ğ¸Ğ³Ñ€Ğ°Ñ… Ğ¾Ğ½Ğ° Ğ½Ğ°Ğ·Ñ‹Ğ²Ğ°ĞµÑ‚ÑÑ Ğ¿Ğ¾-Ñ€Ğ°Ğ·Ğ½Ğ¾Ğ¼Ñƒ, Ğ½Ğ°Ğ¿Ñ€Ğ¸Ğ¼ĞµÑ€ 'balance' Ğ¸Ğ»Ğ¸ 'currentBalance'
                balance = data.balance; 
            }
        } catch (e) {
            console.error("ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ñ€Ğ¸ Ğ¿Ğ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ğ¸ Ğ±Ğ°Ğ»Ğ°Ğ½ÑĞ°:", e);
        }
    }

    // Ğ—Ğ°Ğ¿ÑƒÑĞºĞ°ĞµĞ¼ Ğ¿Ğ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ğµ Ğ±Ğ°Ğ»Ğ°Ğ½ÑĞ°
    getBalanceFromBot();
    // ----------------------

</script>
</body>
</html>
