<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Lucky Slots</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<style>
@import url('https://fonts.googleapis.com/css2?family=Fredoka+One&family=Nunito:wght@400;700;900&display=swap');
:root { --bg1: #0d001f; --gold: #ffd700; --pink: #ff4da6; --win: #00e676; --deposit-green: #00e676; }
*, *::before, *::after { box-sizing: border-box; }
body { background: radial-gradient(ellipse at 50% 0%, #2d0060, var(--bg1) 65%); min-height: 100vh; font-family: 'Nunito', sans-serif; color: #fff; user-select: none; margin:0; padding:0; overflow-x: hidden; }
.wrap { max-width:440px; margin:0 auto; padding:10px; display:flex; flex-direction:column; gap:10px; }
.header { display:flex; justify-content:space-between; align-items:center; }
.logo { font-family:'Fredoka One'; font-size:22px; background:linear-gradient(135deg,var(--gold),var(--pink)); -webkit-background-clip:text; -webkit-text-fill-color:transparent; }
.balance-box { background:rgba(255,255,255,0.1); border:1px solid var(--gold); border-radius:20px; padding:5px 12px; font-family:'Fredoka One'; color:var(--gold); }
.balance-box.low { border-color: var(--deposit-green); color: var(--deposit-green); animation: pulse-green 2s infinite; }
@keyframes pulse-green {
    0%, 100% { box-shadow: 0 0 0 0 rgba(0,230,118,0.3); }
    50% { box-shadow: 0 0 12px 4px rgba(0,230,118,0.25); }
}
.grid-outer { background:rgba(0,0,0,0.5); border:2px solid rgba(255,215,0,0.2); border-radius:20px; padding:8px; }
.grid { display:grid; grid-template-columns:repeat(6, 1fr); gap:3px; }
.cell { width:100%; aspect-ratio:1; display:flex; align-items:center; justify-content:center; font-size:24px; border-radius:8px; background:rgba(255,255,255,0.05); transition: transform 0.2s, background 0.2s; }
.cell.win-cell { background:rgba(255,215,0,0.25); transform:scale(1.1); }
.controls { display:flex; gap:8px; align-items:center; }
.bet-group { flex:1; display:flex; gap:4px; }
.bet-btn { flex:1; padding:10px 0; border-radius:10px; border:2px solid rgba(255,215,0,0.2); background:rgba(255,255,255,0.05); color:var(--gold); font-family:'Fredoka One'; cursor:pointer; font-size:14px; transition: all 0.2s; }
.bet-btn.active { border-color:var(--gold); background:rgba(255,215,0,0.2); }

/* –ö–Ω–æ–ø–∫–∞ SPIN / DEPOSIT */
.spin-btn { width:110px; height:75px; border-radius:18px; border:none; color:#fff; font-family:'Fredoka One'; cursor:pointer; font-size:15px; transition: all 0.3s ease; position: relative; overflow: hidden; }
.spin-btn.mode-spin { background:linear-gradient(135deg,#ff4da6,#ff9500); }
.spin-btn.mode-deposit { background:linear-gradient(135deg, #00e676, #00c853); box-shadow: 0 0 20px rgba(0,230,118,0.4); }
.spin-btn.mode-deposit:active { transform: scale(0.95); }
.spin-btn.mode-loading { background:rgba(255,255,255,0.1); cursor:wait; }
.spin-btn:disabled { opacity:0.5; cursor:not-allowed; }

.buy-bonus-btn { width:100%; padding:12px; border-radius:14px; border:2px solid var(--pink); background:rgba(255,255,255,0.05); color:#fff; display:flex; justify-content:space-between; align-items:center; cursor:pointer; font-size:14px; }
.history-wrap { background:rgba(255,255,255,0.03); border-radius:16px; padding:12px; min-height:60px; }
.h-item { display:flex; justify-content:space-between; font-size:12px; padding:4px 0; border-bottom:1px solid rgba(255,255,255,0.05); }
.paytable { display:grid; grid-template-columns:repeat(4,1fr); gap:5px; background:rgba(255,255,255,0.03); padding:10px; border-radius:16px; }
.pt-item { text-align:center; font-size:8px; background:rgba(255,255,255,0.05); padding:5px; border-radius:8px; }
.error-banner { background:rgba(255,77,77,0.15); border:1px solid rgba(255,77,77,0.3); border-radius:10px; padding:8px 12px; text-align:center; font-size:12px; display:none; color:#ff6b6b; }
.section-title { font-size:10px; opacity:0.4; margin-top:10px; }
</style>
</head>
<body>
<div class="wrap">
    <div class="header">
        <div class="logo">üç≠ Lucky Bonanza</div>
        <div class="balance-box" id="balanceBox">ü™ô <span id="balVal">...</span></div>
    </div>

    <div id="errorBanner" class="error-banner"></div>

    <div class="grid-outer"><div class="grid" id="grid"></div></div>
    <div id="resultText" style="text-align:center; height:30px; font-family:'Fredoka One';"></div>

    <div class="controls">
        <div class="bet-group">
            <button class="bet-btn active" onclick="selectBet(5)">5</button>
            <button class="bet-btn" onclick="selectBet(10)">10</button>
            <button class="bet-btn" onclick="selectBet(25)">25</button>
            <button class="bet-btn" onclick="selectBet(50)">50</button>
        </div>
        <button class="spin-btn mode-loading" id="spinBtn" onclick="handleMainAction()">
            <span id="spinBtnText">...</span>
        </button>
    </div>

    <button class="buy-bonus-btn" onclick="openBuyBonus()">
        <div style="text-align:left">
            <div id="bbTitle" style="font-family:'Fredoka One';">BUY BONUS</div>
            <div id="bbDesc" style="font-size:10px; opacity:0.6;">10 free spins</div>
        </div>
        <div id="bbPrice" style="font-family:'Fredoka One'; color:var(--pink);">500 ü™ô</div>
    </button>

    <div id="histTitle" class="section-title">OSTATNIE SPINY</div>
    <div class="history-wrap" id="histList"></div>
    <div id="ptTitle" class="section-title">TABELA WYP≈Å–ê–¢</div>
    <div class="paytable" id="pt"></div>
</div>

<script>
// ==================== INIT ====================
const tg = window.Telegram.WebApp;
tg.ready();
tg.expand();

const urlParams = new URLSearchParams(window.location.search);
const API_URL = urlParams.get('api') || "https://lucky-slots-production.up.railway.app";
const BOT_NAME = urlParams.get('bot') || "testplcas_bot";
const LANG = urlParams.get('lang') || 'pl';

const LOCALES = {
    pl: { spin: "ZAKRƒòƒÜ", deposit: "DEPOZYT", bbTitle: "BUY BONUS", bbDesc: "10 darmowych spin√≥w", hist: "OSTATNIE SPINY", pt: "TABELA WYP≈ÅAT", win: "WYGRANA", lose: "Brak wygranej", noMoney: "Do≈Çaduj konto!", error: "B≈ÇƒÖd po≈ÇƒÖczenia", retry: "Pon√≥w" },
    ua: { spin: "–ì–†–ê–¢–ò", deposit: "–î–ï–ü–û–ó–ò–¢", bbTitle: "–ö–£–ü–ò–¢–ò –ë–û–ù–£–°", bbDesc: "10 –±–µ–∑–∫–æ—à—Ç–æ–≤–Ω–∏—Ö —Å–ø—ñ–Ω—ñ–≤", hist: "–û–°–¢–ê–ù–ù–Ü –°–ü–Ü–ù–ò", pt: "–¢–ê–ë–õ–ò–¶–Ø –í–ò–ü–õ–ê–¢", win: "–í–ò–ì–†–ê–®", lose: "–ë–µ–∑ –≤–∏–≥—Ä–∞—à—É", noMoney: "–ü–æ–ø–æ–≤–Ω—ñ—Ç—å —Ä–∞—Ö—É–Ω–æ–∫!", error: "–ü–æ–º–∏–ª–∫–∞ –∑'—î–¥–Ω–∞–Ω–Ω—è", retry: "–ü–æ–≤—Ç–æ—Ä–∏—Ç–∏" },
    ru: { spin: "–ò–ì–†–ê–¢–¨", deposit: "–î–ï–ü–û–ó–ò–¢", bbTitle: "–ö–£–ü–ò–¢–¨ –ë–û–ù–£–°", bbDesc: "10 –±–µ—Å–ø–ª–∞—Ç–Ω—ã—Ö —Å–ø–∏–Ω–æ–≤", hist: "–ü–û–°–õ–ï–î–ù–ò–ï –°–ü–ò–ù–´", pt: "–¢–ê–ë–õ–ò–¶–ê –í–´–ü–õ–ê–¢", win: "–í–´–ò–ì–†–´–®", lose: "–ù–µ—Ç –≤—ã–∏–≥—Ä—ã—à–∞", noMoney: "–ü–æ–ø–æ–ª–Ω–∏—Ç–µ —Å—á–µ—Ç!", error: "–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è", retry: "–ü–æ–≤—Ç–æ—Ä–∏—Ç—å" },
    en: { spin: "SPIN", deposit: "DEPOSIT", bbTitle: "BUY BONUS", bbDesc: "10 free spins", hist: "LAST SPINS", pt: "PAYTABLE", win: "WIN", lose: "No win", noMoney: "Deposit coins!", error: "Connection error", retry: "Retry" }
};

const T = LOCALES[LANG] || LOCALES.pl;
const SYMS = ['üçí','üçã','üçä','üçá','üç´','üç≠','üç¨','üíé'];
const MIN_BET = 5;

let balance = null;  // null = –µ—â—ë –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω
let bet = 5;
let spinning = false;
let balanceRetries = 0;
const MAX_BALANCE_RETRIES = 5;

// ==================== UI ====================
function updateUI() {
    const balEl = document.getElementById('balVal');
    const btn = document.getElementById('spinBtn');
    const btnText = document.getElementById('spinBtnText');
    const balBox = document.getElementById('balanceBox');

    // –ë–∞–ª–∞–Ω—Å
    if (balance === null) {
        balEl.innerText = '...';
    } else {
        balEl.innerText = balance;
    }

    // –†–µ–∂–∏–º –∫–Ω–æ–ø–∫–∏
    btn.className = 'spin-btn';  // —Å–±—Ä–æ—Å

    if (balance === null) {
        // –ó–∞–≥—Ä—É–∑–∫–∞
        btn.classList.add('mode-loading');
        btnText.innerText = '...';
        btn.disabled = true;
    } else if (balance < bet) {
        // –î–ï–ü–û–ó–ò–¢ ‚Äî –∑–µ–ª—ë–Ω–∞—è –∫–Ω–æ–ø–∫–∞, –ù–ï disabled!
        btn.classList.add('mode-deposit');
        btnText.innerText = T.deposit;
        btn.disabled = false;
        balBox.classList.add('low');
    } else {
        // –ú–æ–∂–Ω–æ –∏–≥—Ä–∞—Ç—å
        btn.classList.add('mode-spin');
        btnText.innerText = T.spin;
        btn.disabled = false;
        balBox.classList.remove('low');
    }
}

function showError(msg) {
    const banner = document.getElementById('errorBanner');
    banner.innerText = msg || T.error;
    banner.style.display = 'block';
    setTimeout(() => { banner.style.display = 'none'; }, 4000);
}

// ==================== BALANCE FETCH ====================
async function fetchBalance() {
    const initData = tg.initData || '';

    // –î–µ–±–∞–≥: –ª–æ–≥–∏—Ä—É–µ–º —á—Ç–æ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º
    console.log('[Balance] initData length:', initData.length);
    console.log('[Balance] initData preview:', initData.substring(0, 120));
    console.log('[Balance] API_URL:', API_URL);

    if (!initData) {
        console.warn('[Balance] tg.initData is EMPTY! Telegram WebApp may not be initialized.');
    }

    try {
        const url = `${API_URL}/api/balance?init_data=${encodeURIComponent(initData)}`;
        console.log('[Balance] Fetching:', url.substring(0, 150));

        const r = await fetch(url);
        const d = await r.json();

        console.log('[Balance] Response:', JSON.stringify(d));

        if (d.ok) {
            balance = d.balance;
            balanceRetries = 0;
            updateUI();
            return;
        }

        console.error('[Balance] Server returned ok=false:', d.error);
    } catch(e) {
        console.error('[Balance] Fetch error:', e);
    }

    // Retry —Å —ç–∫—Å–ø–æ–Ω–µ–Ω—Ü–∏–∞–ª—å–Ω–æ–π –∑–∞–¥–µ—Ä–∂–∫–æ–π
    balanceRetries++;
    if (balanceRetries <= MAX_BALANCE_RETRIES) {
        const delay = Math.min(1000 * Math.pow(2, balanceRetries - 1), 10000);
        console.log(`[Balance] Retry ${balanceRetries}/${MAX_BALANCE_RETRIES} in ${delay}ms`);
        setTimeout(fetchBalance, delay);
    } else {
        console.error('[Balance] Max retries reached');
        showError(T.error);
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –¥–µ–ø–æ–∑–∏—Ç–∞ –∫–∞–∫ fallback
        balance = 0;
        updateUI();
    }
}

// ==================== MAIN ACTION ====================
function handleMainAction() {
    if (balance === null) return;

    if (balance < bet) {
        // –ü–µ—Ä–µ—Ö–æ–¥–∏–º –≤ –±–æ—Ç–∞ –Ω–∞ –±–ª–æ–∫ –¥–µ–ø–æ–∑–∏—Ç–∞
        console.log('[Deposit] Opening deposit in bot:', BOT_NAME);
        tg.openTelegramLink(`https://t.me/${BOT_NAME}?start=deposit`);
        tg.close();
        return;
    }

    spin();
}

function selectBet(v) {
    if (spinning) return;
    bet = v;
    document.querySelectorAll('.bet-btn').forEach(b =>
        b.classList.toggle('active', parseInt(b.innerText) === v)
    );
    document.getElementById('bbPrice').innerText = (v * 100) + " ü™ô";
    updateUI();
}

// ==================== SPIN (SERVER-SIDE) ====================
async function spin() {
    if (spinning || balance === null || balance < bet) return;

    spinning = true;
    const btn = document.getElementById('spinBtn');
    btn.disabled = true;
    document.getElementById('resultText').innerHTML = '';

    // –£–±–∏—Ä–∞–µ–º –ø–æ–¥—Å–≤–µ—Ç–∫—É
    document.querySelectorAll('.cell.win-cell').forEach(c => c.classList.remove('win-cell'));

    // –ê–Ω–∏–º–∞—Ü–∏—è –ø–æ–∫–∞ –∂–¥—ë–º —Å–µ—Ä–≤–µ—Ä
    const cells = document.querySelectorAll('.cell');
    const animInterval = setInterval(() => {
        cells.forEach(c => c.innerText = SYMS[Math.floor(Math.random() * SYMS.length)]);
    }, 80);

    try {
        const r = await fetch(`${API_URL}/api/spin`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ init_data: tg.initData, bet: bet })
        });
        const d = await r.json();
        clearInterval(animInterval);

        if (!d.ok) {
            if (d.error === 'insufficient_funds') {
                // –û–±–Ω–æ–≤–ª—è–µ–º –±–∞–ª–∞–Ω—Å —Å —Å–µ—Ä–≤–µ—Ä–∞
                if (d.balance !== undefined) balance = d.balance;
                showError(T.noMoney);
            } else {
                showError(T.error);
                fetchBalance();
            }
            spinning = false;
            btn.disabled = false;
            updateUI();
            return;
        }

        // –°–µ—Ä–≤–µ—Ä –≤–µ—Ä–Ω—É–ª —Å–µ—Ç–∫—É –∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç
        const serverGrid = d.grid;
        const winnings = d.winnings;
        balance = d.balance;

        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–µ—Ä–≤–µ—Ä–Ω—É—é —Å–µ—Ç–∫—É
        serverGrid.forEach((s, i) => cells[i].innerText = s);

        // –ü–æ–¥—Å–≤–µ—á–∏–≤–∞–µ–º –≤—ã–∏–≥—Ä—ã—à–Ω—ã–µ
        if (winnings > 0) {
            const counts = {};
            serverGrid.forEach(s => counts[s] = (counts[s] || 0) + 1);
            const winSyms = new Set();
            for (const [s, c] of Object.entries(counts)) {
                if (c >= 8) winSyms.add(s);
            }
            cells.forEach(c => {
                if (winSyms.has(c.innerText)) c.classList.add('win-cell');
            });
        }

        document.getElementById('resultText').innerHTML = winnings > 0
            ? `<span style="color:var(--win)">${T.win}: +${winnings} ü™ô</span>`
            : `<span style="color:rgba(255,255,255,0.4)">${T.lose}</span>`;

        addHistory(winnings);
        updateUI();

    } catch(e) {
        clearInterval(animInterval);
        console.error('[Spin] Error:', e);
        showError(T.error);
        fetchBalance();
    }

    spinning = false;
    btn.disabled = false;
}

// ==================== HISTORY ====================
function addHistory(win) {
    const list = document.getElementById('histList');
    const div = document.createElement('div');
    div.className = 'h-item';
    const sign = win > 0 ? '+' : '-';
    const val = win > 0 ? win : bet;
    const color = win > 0 ? 'var(--win)' : '#ff6b6b';
    div.innerHTML = `<span>üé∞ Spin (${bet})</span><span style="color:${color}">${sign}${val}</span>`;
    list.prepend(div);
    if (list.children.length > 10) list.lastChild.remove();
}

// ==================== BUY BONUS ====================
function openBuyBonus() {
    if (balance === null || balance < bet * 100) {
        tg.showAlert(T.noMoney);
        return;
    }
    tg.showAlert("Coming soon!");
}

// ==================== INIT ====================
function init() {
    // –°–µ—Ç–∫–∞
    const g = document.getElementById('grid');
    for (let i = 0; i < 30; i++) {
        const c = document.createElement('div');
        c.className = 'cell';
        c.innerText = SYMS[Math.floor(Math.random() * SYMS.length)];
        g.appendChild(c);
    }

    // Paytable
    const pt = document.getElementById('pt');
    SYMS.forEach(s => {
        const item = document.createElement('div');
        item.className = 'pt-item';
        item.innerHTML = `<div style="font-size:16px">${s}</div>8+ x1.5<br>12+ x5`;
        pt.appendChild(item);
    });

    // –õ–æ–∫–∞–ª–∏–∑–∞—Ü–∏—è —Å—Ç–∞—Ç–∏—á–Ω—ã—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤
    document.getElementById('bbTitle').innerText = T.bbTitle;
    document.getElementById('bbDesc').innerText = T.bbDesc;
    document.getElementById('histTitle').innerText = T.hist;
    document.getElementById('ptTitle').innerText = T.pt;

    updateUI();

    // –ó–∞–≥—Ä—É–∂–∞–µ–º –±–∞–ª–∞–Ω—Å (—Å –Ω–µ–±–æ–ª—å—à–æ–π –∑–∞–¥–µ—Ä–∂–∫–æ–π —á—Ç–æ–±—ã tg.initData —Ç–æ—á–Ω–æ –±—ã–ª –≥–æ—Ç–æ–≤)
    setTimeout(fetchBalance, 300);
}

init();
</script>
</body>
</html>
