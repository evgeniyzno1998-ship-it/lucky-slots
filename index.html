<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>RubyBet</title>
    <script src="https://telegram.org/js/telegram-web-app.js?v=2.1.4"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@solana/web3.js@1.87.0/lib/index.iife.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tweetnacl/1.0.3/nacl-fast.min.js"></script>
    <script src="casino_math.js?v=2.1.4"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        charcoal: '#121212',
                        surface: '#1E1E1E',
                        surface2: '#2A2A2A',
                        ruby: '#E31E24',
                        'ruby-dark': '#B91820',
                    },
                    boxShadow: {
                        'ruby': '0 0 20px rgba(227,30,36,0.4)',
                    }
                }
            }
        }
    </script>
    <link
        href="https://fonts.googleapis.com/css2?family=Montserrat:wght@500;600;700;800;900&family=Inter:wght@400;500;600;700&display=swap"
        rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap"
        rel="stylesheet">
    <style>
        :root {
            --bg: #121212;
            --surface: #1E1E1E;
            --surface2: #2A2A2A;
            --surface3: #333;
            --red: #E31E24;
            --red-dark: #B91820;
            --red-glow: rgba(227, 30, 36, 0.4);
            --text: #F5F5F5;
            --dim: #9CA3AF;
            --dim2: #6B7280;
            --border: #333;
            --green: #22C55E;
            --green-dim: #166534;
            --gold: #FFD700;
            --blue: #3B82F6;
            --radius: 12px;
            --radius-lg: 16px;
            --radius-xl: 20px;
            --nav-h: 68px;
            --header-h: 56px;
            --tg-safe-top: 0px;
            /* Phase 3 Redesign Colors */
            --ruby-red: #e62e3d;
            --bg-darker: #0d0f12;
            --surface-darker: #15171b;
            --surface-hover: #1a1c22;
        }

        @keyframes pulse {
            0% {
                opacity: 0.6;
            }

            50% {
                opacity: 0.3;
            }

            100% {
                opacity: 0.6;
            }
        }

        .hide-scrollbar::-webkit-scrollbar {
            display: none;
        }

        .hide-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            -webkit-tap-highlight-color: transparent
        }

        body {
            background: var(--bg);
            color: var(--text);
            font-family: 'Inter', sans-serif;
            min-height: 100vh;
            overflow-x: hidden;
            padding-bottom: calc(var(--nav-h) + 12px);
            overscroll-behavior: none;
        }

        ::-webkit-scrollbar {
            width: 3px
        }

        ::-webkit-scrollbar-track {
            background: transparent
        }

        ::-webkit-scrollbar-thumb {
            background: #333;
            border-radius: 3px
        }

        h1,
        h2,
        h3,
        .font-display {
            font-family: 'Montserrat', sans-serif
        }

        ::selection {
            background: var(--red);
            color: #fff
        }

        /* === FORTUNE WHEEL === */
        .wh-bulb {
            position: absolute;
            width: 6px;
            height: 6px;
            background: #fff;
            border-radius: 50%;
            box-shadow: 0 0 8px #fff, 0 0 15px #e31c23;
            z-index: 10
        }

        .wh-seg {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            z-index: 10
        }

        .wh-seg-inner {
            position: absolute;
            left: -40px;
            top: -125px;
            width: 80px;
            height: 80px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center
        }

        .wh-seg-label {
            font-family: 'Montserrat', sans-serif;
            font-size: 11px;
            font-weight: 900;
            color: #fff;
            text-transform: uppercase;
            letter-spacing: 1px;
            text-shadow: 0 1px 3px rgba(0, 0, 0, .6);
            margin-top: 2px
        }

        @keyframes wheel-glow {

            0%,
            100% {
                box-shadow: 0 0 8px #fff, 0 0 15px #e31c23
            }

            50% {
                box-shadow: 0 0 12px #fff, 0 0 25px #e31c23, 0 0 35px rgba(227, 28, 35, .4)
            }
        }

        /* === PLINKO REDESIGN === */
        .glass-orb {
            background: radial-gradient(circle at 30% 30%, rgba(228, 33, 39, 0.6), rgba(139, 0, 0, 0.9));
            box-shadow: 0 10px 30px rgba(228, 33, 39, 0.4), inset 0 0 20px rgba(255, 255, 255, 0.2);
        }

        .star-pulse {
            text-shadow: 0 0 15px rgba(255, 215, 0, 0.6), 0 0 5px rgba(228, 33, 39, 0.8);
        }

        .wh-bulb {
            animation: wheel-glow 1.5s ease-in-out infinite alternate
        }

        /* Phase 3 Live Drops & Neon */
        .neon-glow {
            box-shadow: 0 0 20px rgba(233, 30, 63, 0.4);
        }

        @keyframes pulse-ring {
            0% {
                transform: scale(0.95);
                box-shadow: 0 0 0 0 rgba(233, 30, 63, 0.7);
            }

            70% {
                transform: scale(1);
                box-shadow: 0 0 0 10px rgba(233, 30, 63, 0);
            }

            100% {
                transform: scale(0.95);
                box-shadow: 0 0 0 0 rgba(233, 30, 63, 0);
            }
        }

        .animate-pulse-ring {
            animation: pulse-ring 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }

        .glass-panel {
            background: rgba(20, 20, 20, 0.6);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.06);
        }

        .glass-card {
            background: linear-gradient(180deg, rgba(255, 255, 255, 0.07) 0%, rgba(255, 255, 255, 0.03) 100%);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
        }

        .glass-item {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.04);
            transition: all 0.3s ease;
        }

        .glass-item:active {
            background: rgba(255, 255, 255, 0.06);
            transform: scale(0.98);
        }

        .btn-primary {
            background: linear-gradient(92deg, #E31C23 0%, #B91C23 100%);
            box-shadow: 0 4px 15px rgba(227, 28, 35, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.2s ease;
        }

        .btn-primary:active {
            transform: scale(0.96);
            opacity: 0.9;
        }

        .glass-panel {
            background: rgba(20, 20, 20, 0.6);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.06);
        }

        .glass-card {
            background: linear-gradient(180deg, rgba(255, 255, 255, 0.07) 0%, rgba(255, 255, 255, 0.03) 100%);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
        }

        .glass-item {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.04);
            transition: all 0.3s ease;
        }

        .glass-item:active {
            background: rgba(255, 255, 255, 0.06);
            transform: scale(0.98);
        }

        .btn-primary {
            background: linear-gradient(92deg, #E31C23 0%, #B91C23 100%);
            box-shadow: 0 4px 15px rgba(227, 28, 35, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.2s ease;
        }

        .btn-primary:active {
            transform: scale(0.96);
            opacity: 0.9;
        }

        /* Phase 3 Bonus Activation */
        .modal-gradient {
            background: radial-gradient(circle at top, rgba(230, 46, 61, 0.15) 0%, rgba(13, 15, 18, 1) 70%);
        }

        .confetti-piece {
            position: absolute;
            width: 8px;
            height: 8px;
            background: #e62e3d;
            top: -20px;
            opacity: 0;
            animation: fall 3s infinite;
        }

        @keyframes fall {
            0% {
                transform: translateY(0) rotate(0deg);
                opacity: 1;
            }

            100% {
                transform: translateY(400px) rotate(720deg);
                opacity: 0;
            }
        }

        .success-glow {
            box-shadow: 0 0 40px rgba(230, 46, 61, 0.3);
        }

        /* === LIVE DROPS === */
        .live-drops-section {
            padding: 0 16px;
            margin-bottom: 16px
        }

        .live-drops-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 10px
        }

        .live-drops-dot {
            width: 8px;
            height: 8px;
            background: #e31c23;
            border-radius: 50%;
            box-shadow: 0 0 6px #e31c23;
            animation: pulse-dot 2s infinite
        }

        .live-drops-title {
            font-family: 'Montserrat', sans-serif;
            font-size: 12px;
            font-weight: 800;
            text-transform: uppercase;
            letter-spacing: 1.5px;
            color: var(--dim)
        }

        .live-drops-scroll {
            display: flex;
            gap: 10px;
            overflow-x: auto;
            -ms-overflow-style: none;
            scrollbar-width: none;
            padding-bottom: 4px
        }

        .live-drops-scroll::-webkit-scrollbar {
            display: none
        }

        .live-drop-card {
            flex: 0 0 240px !important;
            width: 240px !important;
            min-width: 240px !important;
            padding: 14px;
            background: linear-gradient(to right, #1A1A1A, #0F0F0F);
            border: 1px solid rgba(255, 255, 255, 0.05);
            border-radius: 16px;
            position: relative;
            overflow: hidden;
            cursor: pointer;
            transition: transform 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .live-drop-card::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 2px;
            background: rgba(227, 30, 36, .3)
        }

        .live-drop-card.big::after {
            height: 2px;
            background: var(--red);
            box-shadow: 0 0 10px rgba(227, 28, 35, .5)
        }

        .live-drop-user {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 6px
        }

        .live-drop-avatar {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: var(--surface2);
            border: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            font-weight: 700;
            color: var(--dim);
            overflow: hidden
        }

        .live-drop-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover
        }

        .live-drop-name {
            font-size: 12px;
            font-weight: 600;
            color: var(--dim);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 90px
        }

        .live-drop-amount {
            font-family: 'Montserrat', sans-serif;
            font-size: 14px;
            font-weight: 800;
            color: var(--red)
        }

        .live-drop-game {
            font-size: 10px;
            color: var(--dim2);
            margin-top: 2px
        }

        /* === SCREENS === */
        .screen {
            display: none;
            opacity: 0;
            transition: opacity .15s ease
        }

        .screen.active {
            display: block;
            opacity: 1
        }

        /* === HEADER === */
        .header {
            position: sticky;
            top: 0;
            z-index: 50;
            background: var(--bg);
            border-bottom: 1px solid rgba(255, 255, 255, .05);
            padding: 10px 16px;
            padding-top: calc(env(safe-area-inset-top) + var(--tg-safe-top, 0px) + 10px);
            display: flex;
            align-items: center;
            justify-content: space-between;
            min-height: var(--header-h);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
        }

        .popup-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            z-index: 100;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .popup-card {
            width: 100%;
            max-width: 360px;
            background: #0D0F12;
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 24px;
            padding: 24px;
            position: relative;
            box-shadow: 0 24px 64px rgba(0, 0, 0, 0.6);
            transform: scale(0.9);
            opacity: 0;
            transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        .popup-overlay.show {
            display: flex;
        }

        .popup-overlay.show .popup-card {
            transform: scale(1);
            opacity: 1;
        }

        .quick-amt-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(70px, 1fr));
            gap: 8px;
            margin: 12px 0;
        }

        .quick-amt-btn {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 10px;
            font-size: 13px;
            font-weight: 700;
            color: #fff;
            text-align: center;
            transition: all 0.2s;
        }

        .quick-amt-btn:active {
            background: rgba(255, 255, 255, 0.08);
            border-color: rgba(255, 255, 255, 0.1);
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 6px
        }

        .logo-icon {
            width: 32px;
            height: 32px;
            background: var(--red);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 0 12px var(--red-glow)
        }

        .logo-icon .material-symbols-outlined {
            color: #fff;
            font-size: 18px
        }

        .logo-text {
            font-family: 'Montserrat', sans-serif;
            font-weight: 800;
            font-size: 18px;
            letter-spacing: .5px;
            color: #fff
        }

        .logo-text span {
            color: var(--red)
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 8px
        }

        .header-bal {
            display: flex;
            align-items: center;
            gap: 6px;
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 20px;
            padding: 5px 12px 5px 8px;
            font-weight: 600;
            font-size: 13px;
            color: #fff;
            cursor: pointer
        }

        .header-bal .amt {
            color: var(--red);
            font-weight: 700;
            font-family: 'Montserrat', sans-serif;
            font-size: 11px;
            margin-left: 2px
        }

        .header-notif {
            position: relative;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: var(--surface);
            border: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer
        }

        .header-notif .material-symbols-outlined {
            font-size: 18px;
            color: var(--dim)
        }

        .header-notif .dot {
            position: absolute;
            top: 6px;
            right: 6px;
            width: 7px;
            height: 7px;
            background: var(--red);
            border-radius: 50%;
            box-shadow: 0 0 6px var(--red)
        }

        /* === PROVIDERS BOTTOM SHEET === */
        .providers-sheet-overlay {
            display: none;
            position: fixed;
            inset: 0;
            z-index: 300;
            background: rgba(0,0,0,.6);
            backdrop-filter: blur(4px);
            align-items: flex-end;
        }
        .providers-sheet-overlay.open { display: flex; }
        .providers-sheet {
            width: 100%;
            background: var(--surface);
            border-radius: 20px 20px 0 0;
            padding: 0 0 calc(var(--nav-h) + 16px);
            max-height: 75vh;
            overflow-y: auto;
        }
        .providers-sheet-handle {
            width: 36px; height: 4px;
            background: rgba(255,255,255,.2);
            border-radius: 2px;
            margin: 12px auto 16px;
        }
        .providers-sheet-title {
            font-family: 'Montserrat', sans-serif;
            font-weight: 800;
            font-size: 15px;
            padding: 0 16px 12px;
            border-bottom: 1px solid var(--border);
            margin-bottom: 12px;
        }
        .providers-sheet-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            padding: 0 16px;
        }
        .ps-pill {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 10px 8px;
            border-radius: 10px;
            background: var(--bg);
            border: 1px solid var(--border);
            font-size: 12px;
            font-weight: 600;
            color: var(--dim2);
            cursor: pointer;
            text-align: center;
            transition: all .15s;
        }
        .ps-pill.active {
            background: var(--red);
            border-color: var(--red);
            color: #fff;
        }

        /* === JETTON-STYLE SEARCH+CATEGORIES ROW === */
        .jt-filter-row {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 0 16px 12px;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none;
        }
        .jt-filter-row::-webkit-scrollbar { display: none; }
        .jt-search-btn {
            flex-shrink: 0;
            width: 40px;
            height: 40px;
            border-radius: 12px;
            background: var(--surface);
            border: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }
        .jt-search-btn .material-symbols-outlined {
            font-size: 20px;
            color: var(--dim);
        }
        .jt-cat-pill {
            flex-shrink: 0;
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 0 14px;
            height: 40px;
            border-radius: 12px;
            background: var(--surface);
            border: 1px solid var(--border);
            font-size: 13px;
            font-weight: 600;
            color: var(--dim2);
            cursor: pointer;
            white-space: nowrap;
            transition: all .2s;
        }
        .jt-cat-pill.active {
            background: var(--red);
            border-color: var(--red);
            color: #fff;
        }
        .jt-cat-pill .material-symbols-outlined {
            font-size: 16px;
        }

        /* === HEADER PLUS BUTTON === */
        .header-plus-btn {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: var(--red);
            border: none;
            color: #fff;
            font-size: 20px;
            font-weight: 700;
            line-height: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 0 0 0 rgba(227,30,36,.7);
            animation: pulse-red 1.6s ease-in-out infinite;
            flex-shrink: 0;
        }
        @keyframes pulse-red {
            0%   { box-shadow: 0 0 0 0 rgba(227,30,36,.7); }
            60%  { box-shadow: 0 0 0 8px rgba(227,30,36,0); }
            100% { box-shadow: 0 0 0 0 rgba(227,30,36,0); }
        }

        /* === BOTTOM NAV === */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: var(--nav-h);
            background: rgba(18, 18, 20, 0.88);
            backdrop-filter: blur(24px);
            -webkit-backdrop-filter: blur(24px);
            border-top: 1px solid rgba(255, 255, 255, .08);
            border-radius: 20px 20px 0 0;
            display: flex;
            z-index: 100;
            padding-bottom: env(safe-area-inset-bottom);
            box-shadow: 0 -8px 40px rgba(0, 0, 0, .55), 0 -1px 0 rgba(255,255,255,.04);
            overflow: visible;
        }
        /* Center Wheel nav button (JetTon style) */
        .nav-wheel-btn {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            position: relative;
            cursor: pointer;
        }
        .nav-wheel-circle {
            position: absolute;
            top: -26px;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(145deg, #FF1744, #C0142A);
            border: 3px solid rgba(18,18,20,.88);
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 0 24px rgba(227,30,36,.7), 0 6px 16px rgba(0,0,0,.6);
            animation: pulse-red 1.8s ease-in-out infinite;
            font-size: 28px;
            line-height: 1;
        }
        .nav-wheel-label {
            margin-top: 16px;
            font-size: 9px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: .8px;
            font-family: 'Montserrat', sans-serif;
            color: var(--red);
        }

        .nav-item {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 3px;
            cursor: pointer;
            color: var(--dim);
            transition: color .2s;
            position: relative
        }

        .nav-item.active {
            color: var(--red)
        }

        .nav-item .material-symbols-outlined {
            font-size: 22px;
            transition: all .2s
        }

        .nav-item.active .material-symbols-outlined {
            filter: drop-shadow(0 0 6px var(--red-glow))
        }

        .nav-item .nav-label {
            font-size: 10px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: .5px
        }

        .nav-item .nav-label {
            font-size: 9px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: .8px;
            font-family: 'Montserrat', sans-serif
        }

        /* === SHARED UI === */
        .section {
            padding: 0 16px;
            margin-bottom: 20px
        }

        .section-head {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px
        }

        .section-title {
            font-family: 'Montserrat', sans-serif;
            font-size: 11px;
            font-weight: 800;
            text-transform: uppercase;
            letter-spacing: 1.5px;
            color: var(--dim)
        }

        .section-more {
            font-size: 11px;
            font-weight: 700;
            color: var(--red);
            cursor: pointer;
            text-transform: uppercase;
            letter-spacing: .5px
        }

        .card {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: var(--radius-lg);
            overflow: hidden
        }

        .btn-primary {
            width: 100%;
            height: 48px;
            border-radius: var(--radius);
            border: none;
            background: var(--red);
            color: #fff;
            font-family: 'Montserrat', sans-serif;
            font-weight: 700;
            font-size: 14px;
            letter-spacing: .5px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            box-shadow: 0 4px 16px var(--red-glow);
            transition: all .15s;
            text-transform: uppercase
        }

        .btn-primary:active {
            transform: scale(.97);
            filter: brightness(.9)
        }

        .btn-outline {
            width: 100%;
            height: 48px;
            border-radius: var(--radius);
            border: 1.5px solid var(--red);
            background: transparent;
            color: var(--red);
            font-family: 'Montserrat', sans-serif;
            font-weight: 700;
            font-size: 14px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: all .15s;
            text-transform: uppercase
        }

        .btn-outline:active {
            background: rgba(227, 30, 36, .08);
            transform: scale(.97)
        }

        .pill-row {
            display: flex;
            gap: 8px;
            overflow-x: auto;
            padding: 0 16px 12px;
            -ms-overflow-style: none;
            scrollbar-width: none
        }

        .pill-row::-webkit-scrollbar {
            display: none
        }

        .pill {
            height: 34px;
            padding: 0 16px;
            border-radius: 17px;
            border: 1px solid var(--border);
            background: var(--surface);
            color: var(--dim);
            font-size: 12px;
            font-weight: 600;
            white-space: nowrap;
            cursor: pointer;
            display: flex;
            align-items: center;
            transition: all .15s;
            flex-shrink: 0
        }

        .pill.active {
            background: var(--red);
            color: #fff;
            border-color: var(--red);
            box-shadow: 0 2px 10px var(--red-glow)
        }

        .pill:active {
            transform: scale(.95)
        }

        .divider {
            height: 1px;
            background: var(--border);
            margin: 0 16px
        }

        /* ======================== */
        /* === LOBBY SCREEN === */
        /* ======================== */
        .lobby-search {
            margin: 12px 16px;
            display: flex;
            align-items: center;
            gap: 10px;
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 10px 14px;
            cursor: pointer
        }

        .lobby-search .material-symbols-outlined {
            color: var(--dim);
            font-size: 20px
        }

        .lobby-search span {
            color: var(--dim2);
            font-size: 13px;
            font-weight: 500
        }

        /* Hero Banner */
        .hero-banner {
            margin: 0 16px 16px;
            border-radius: var(--radius-xl);
            background: linear-gradient(135deg, #1a0000, #3a0a0a 50%, #0a0000);
            border: 1.5px solid rgba(227, 30, 36, .3);
            padding: 24px 20px;
            position: relative;
            overflow: hidden;
            min-height: 140px;
            box-shadow: 0 0 20px rgba(227, 30, 36, .1)
        }

        .hero-banner::after {
            content: '';
            position: absolute;
            top: -50%;
            right: -20%;
            width: 200px;
            height: 200px;
            background: radial-gradient(circle, rgba(227, 30, 36, .15), transparent 70%);
            border-radius: 50%
        }

        .hero-tag {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            font-size: 10px;
            font-weight: 800;
            text-transform: uppercase;
            color: #fff;
            background: var(--red);
            padding: 3px 8px;
            border-radius: 4px;
            margin-bottom: 10px;
            letter-spacing: 1px
        }

        .hero-tag .material-symbols-outlined {
            font-size: 12px
        }

        .hero-title {
            font-family: 'Montserrat', sans-serif;
            font-size: 28px;
            font-weight: 900;
            line-height: 1.15;
            margin-bottom: 4px;
            letter-spacing: -.5px
        }

        .hero-title .accent {
            color: var(--red);
            text-shadow: 0 0 20px var(--red-glow)
        }

        .hero-sub {
            font-size: 12px;
            color: var(--dim);
            margin-bottom: 16px
        }

        .hero-actions {
            display: flex;
            gap: 10px;
            position: relative;
            z-index: 1
        }

        .hero-actions .hero-btn {
            height: 38px;
            padding: 0 20px;
            border-radius: 10px;
            border: none;
            font-family: 'Montserrat', sans-serif;
            font-weight: 700;
            font-size: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: all .15s;
            text-transform: uppercase;
            letter-spacing: .5px
        }

        .hero-actions .hero-btn:active {
            transform: scale(.95)
        }

        .hero-btn.filled {
            background: var(--red);
            color: #fff;
            box-shadow: 0 2px 12px var(--red-glow)
        }

        .hero-btn.ghost {
            background: rgba(255, 255, 255, .08);
            color: #fff;
            border: 1px solid rgba(255, 255, 255, .12)
        }

        /* Wheel Banner */
        .wheel-banner {
            margin: 0 16px 16px;
            border-radius: var(--radius-lg);
            background: linear-gradient(135deg, #1a0a0a, #2a0a0a);
            border: 1px solid rgba(227, 30, 36, .25);
            padding: 14px 16px;
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
            transition: transform .15s;
            box-shadow: 0 0 15px rgba(227, 30, 36, .08)
        }

        .wheel-banner:active {
            transform: scale(.97)
        }

        .wheel-icon {
            font-size: 32px;
            animation: wrot 3s linear infinite
        }

        @keyframes wrot {
            0% {
                transform: rotate(0)
            }

            100% {
                transform: rotate(360deg)
            }
        }

        .wheel-banner.done {
            opacity: .5
        }

        .wheel-banner.done .wheel-icon {
            animation: none
        }

        .wheel-info h3 {
            font-size: 13px;
            font-weight: 700;
            color: #fff;
            font-family: 'Montserrat', sans-serif
        }

        .wheel-info p {
            font-size: 11px;
            color: var(--dim)
        }

        /* VIP Progress */
        .vip-strip {
            margin: 0 16px 16px;
            display: flex;
            align-items: center;
            gap: 12px
        }

        .vip-strip-info {
            flex: 1
        }

        .vip-strip-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 6px
        }

        .vip-strip-name {
            font-size: 10px;
            font-weight: 800;
            text-transform: uppercase;
            letter-spacing: 1.5px;
            color: var(--dim);
            font-family: 'Montserrat', sans-serif
        }

        .vip-strip-pct {
            font-size: 10px;
            font-weight: 700;
            color: var(--red)
        }

        .vip-bar {
            height: 6px;
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 3px;
            overflow: hidden
        }

        .vip-bar-fill {
            height: 100%;
            background: var(--red);
            border-radius: 3px;
            transition: width .6s;
            box-shadow: 0 0 8px var(--red-glow)
        }

        /* Categories */
        .cat-row {
            display: flex;
            gap: 12px;
            padding: 0 16px;
            margin-bottom: 20px;
            overflow-x: auto;
            -ms-overflow-style: none;
            scrollbar-width: none
        }

        .cat-row::-webkit-scrollbar {
            display: none
        }

        .cat-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 6px;
            cursor: pointer;
            flex-shrink: 0
        }

        .cat-icon {
            width: 56px;
            height: 56px;
            border-radius: var(--radius);
            background: var(--surface);
            border: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all .15s
        }

        .cat-icon .material-symbols-outlined {
            font-size: 24px;
            color: var(--red)
        }

        .cat-item:active .cat-icon {
            border-color: var(--red);
            background: rgba(227, 30, 36, .08)
        }

        .cat-label {
            font-size: 10px;
            font-weight: 600;
            color: var(--dim);
            text-transform: uppercase;
            letter-spacing: .5px
        }

        /* Game Grid */
        .game-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            padding: 0 16px;
            margin-bottom: 20px
        }

        /* === SEARCH OVERLAY === */
        .search-overlay {
            position: fixed;
            top: var(--header-h);
            bottom: 0;
            left: 0;
            right: 0;
            z-index: 250;
            background: var(--bg);
            display: none;
            flex-direction: column
        }

        .search-overlay.open {
            display: flex
        }

        .search-header {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px 16px;
            border-bottom: 1px solid var(--border)
        }

        .search-input {
            flex: 1;
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 10px 14px;
            color: #fff;
            font-size: 14px;
            outline: none;
            font-family: Inter, sans-serif
        }

        .search-input:focus {
            border-color: var(--red)
        }

        .search-input::placeholder {
            color: var(--dim2)
        }

        .search-results {
            flex: 1;
            overflow-y: auto;
            padding: 12px 16px
        }

        .search-result-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            margin-bottom: 8px;
            cursor: pointer;
            transition: all .15s
        }

        .search-result-item:active {
            transform: scale(.98);
            border-color: var(--red)
        }

        .search-result-icon {
            width: 44px;
            height: 44px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px
        }

        .search-result-name {
            font-size: 13px;
            font-weight: 700;
            color: #fff
        }

        .search-result-tag {
            font-size: 10px;
            color: var(--dim);
            text-transform: uppercase;
            font-weight: 600;
            letter-spacing: .5px
        }

        .search-empty {
            text-align: center;
            padding: 60px 0;
            color: var(--dim2);
            font-size: 13px
        }

        /* === TOP WINNINGS LEADERBOARD === */
        .top-wins-section {
            margin: 0 16px 20px
        }

        .top-wins-tabs {
            display: flex;
            gap: 0;
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            overflow: hidden;
            margin-bottom: 12px
        }

        .tw-tab {
            flex: 1;
            padding: 8px 0;
            text-align: center;
            font-size: 10px;
            font-weight: 800;
            text-transform: uppercase;
            letter-spacing: .8px;
            color: var(--dim);
            cursor: pointer;
            transition: all .15s;
            border-right: 1px solid var(--border)
        }

        .tw-tab:last-child {
            border-right: none
        }

        .tw-tab.active {
            background: rgba(227, 30, 36, .08);
            color: var(--red)
        }

        .tw-row {
            display: flex;
            align-items: center;
            padding: 10px 12px;
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            margin-bottom: 6px;
            gap: 10px
        }

        .tw-rank {
            width: 24px;
            font-family: 'Montserrat', sans-serif;
            font-size: 14px;
            font-weight: 900;
            color: var(--dim)
        }

        .tw-rank.gold {
            color: #FFD700
        }

        .tw-rank.silver {
            color: #C0C0C0
        }

        .tw-rank.bronze {
            color: #CD7F32
        }

        .tw-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: 700;
            color: #fff
        }

        .tw-info {
            flex: 1
        }

        .tw-name {
            font-size: 12px;
            font-weight: 700;
            color: #fff
        }

        .tw-game {
            font-size: 10px;
            color: var(--dim)
        }

        .tw-amount {
            text-align: right
        }

        .tw-val {
            font-family: 'Montserrat', sans-serif;
            font-size: 13px;
            font-weight: 800;
            color: var(--green)
        }

        .tw-mult {
            font-size: 10px;
            color: var(--dim)
        }

        /* === PROVIDERS SECTION === */
        .providers-row {
            display: flex;
            gap: 8px;
            padding: 0 16px;
            overflow-x: auto;
            margin-bottom: 20px;
            -ms-overflow-style: none;
            scrollbar-width: none
        }

        .providers-row::-webkit-scrollbar {
            display: none
        }

        .provider-pill {
            flex-shrink: 0;
            padding: 8px 16px;
            border-radius: 20px;
            background: var(--surface);
            border: 1px solid var(--border);
            font-size: 11px;
            font-weight: 700;
            color: var(--dim);
            cursor: pointer;
            transition: all .15s;
            text-transform: uppercase;
            letter-spacing: .3px;
            white-space: nowrap
        }

        .provider-pill.active,
        .provider-pill:active {
            background: rgba(227, 30, 36, .08);
            border-color: var(--red);
            color: var(--red)
        }

        /* === FAVORITES HEART === */
        .fav-btn {
            position: absolute;
            top: 8px;
            right: 8px;
            z-index: 10;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: rgba(0, 0, 0, .5);
            backdrop-filter: blur(4px);
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all .15s
        }

        .fav-btn .material-symbols-outlined {
            font-size: 16px;
            color: var(--dim);
            transition: all .15s
        }

        .fav-btn.liked .material-symbols-outlined {
            color: var(--red);
            font-variation-settings: 'FILL' 1
        }

        /* === NAV BADGE === */
        .nav-badge {
            position: absolute;
            top: 2px;
            right: 50%;
            transform: translateX(calc(50% + 10px));
            min-width: 16px;
            height: 16px;
            border-radius: 8px;
            background: var(--red);
            color: #fff;
            font-size: 9px;
            font-weight: 800;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0 4px;
            box-shadow: 0 0 6px var(--red-glow)
        }

        .game-tile {
            border-radius: var(--radius-lg);
            overflow: hidden;
            background: var(--surface);
            border: 1px solid var(--border);
            cursor: pointer;
            transition: all .15s;
            position: relative
        }

        .game-tile:active {
            transform: scale(.96)
        }

        .game-tile-img {
            width: 100%;
            aspect-ratio: 4/3;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 42px;
            position: relative
        }

        .game-tile-img .badge {
            position: absolute;
            top: 8px;
            right: 8px;
            font-size: 9px;
            font-weight: 800;
            text-transform: uppercase;
            padding: 2px 8px;
            border-radius: 4px;
            letter-spacing: .5px
        }

        .badge.hot {
            background: var(--red);
            color: #fff
        }

        .badge.new {
            background: var(--green);
            color: #fff
        }

        .badge.soon {
            background: var(--surface2);
            color: var(--dim)
        }

        .game-tile-info {
            padding: 10px 12px
        }

        .game-tile-name {
            font-family: 'Montserrat', sans-serif;
            font-size: 12px;
            font-weight: 800;
            text-transform: uppercase;
            letter-spacing: .3px
        }

        .game-tile-tag {
            font-size: 10px;
            color: var(--dim);
            font-weight: 500;
            margin-top: 2px
        }

        /* ======================== */
        /* === GAME SCREEN === */
        /* ======================== */
        .game-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 16px
        }

        .game-back {
            display: flex;
            align-items: center;
            gap: 4px;
            cursor: pointer;
            color: var(--dim);
            font-size: 13px;
            font-weight: 600
        }

        .game-back .material-symbols-outlined {
            font-size: 20px
        }

        .game-title-bar {
            font-family: 'Montserrat', sans-serif;
            font-weight: 800;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: .5px
        }

        .game-bal {
            display: flex;
            align-items: center;
            gap: 4px;
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 20px;
            padding: 4px 12px;
            font-weight: 700;
            font-size: 13px
        }

        .game-bal .material-symbols-outlined {
            font-size: 14px;
            color: var(--red)
        }

        /* Jackpot display */
        .jackpot-display {
            text-align: center;
            padding: 8px 0 4px
        }

        .jackpot-label {
            font-size: 9px;
            font-weight: 800;
            text-transform: uppercase;
            letter-spacing: 2px;
            color: var(--red)
        }

        .jackpot-amount {
            font-family: 'Montserrat', sans-serif;
            font-size: 28px;
            font-weight: 900;
            color: #fff;
            letter-spacing: -1px
        }

        .jackpot-amount span {
            color: var(--dim);
            font-size: 16px;
            font-weight: 600;
            margin-left: 4px
        }

        /* Grid */
        .grid-frame {
            margin: 0 10px;
            background: rgba(0, 0, 0, .4);
            border: 2px solid rgba(227, 30, 36, .15);
            border-radius: var(--radius-lg);
            padding: 6px;
            position: relative;
            overflow: hidden
        }

        .grid-frame.bonus-mode {
            border-color: var(--red);
            box-shadow: 0 0 30px var(--red-glow)
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 3px
        }

        .cell {
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 22px;
            border-radius: 8px;
            background: rgba(255, 255, 255, .03);
            transition: all .2s
        }

        .cell.win {
            background: rgba(227, 30, 36, .15);
            transform: scale(1.08)
        }

        .cell.scatter {
            background: rgba(227, 30, 36, .2);
            animation: sc-p .5s infinite
        }

        .cell.bomb {
            background: rgba(255, 61, 0, .2);
            animation: bm-s .3s infinite
        }

        @keyframes sc-p {

            0%,
            100% {
                transform: scale(1)
            }

            50% {
                transform: scale(1.12)
            }
        }

        @keyframes bm-s {

            0%,
            100% {
                transform: rotate(0)
            }

            25% {
                transform: rotate(-2deg)
            }

            75% {
                transform: rotate(2deg)
            }
        }

        .game-result {
            text-align: center;
            height: 32px;
            font-weight: 800;
            font-size: 16px;
            padding: 6px 0;
            display: flex;
            align-items: center;
            justify-content: center
        }

        .game-result .win-text {
            color: var(--green);
            display: flex;
            align-items: center;
            gap: 4px
        }

        .game-result .lose-text {
            color: var(--dim)
        }

        .free-spin-badge {
            text-align: center;
            padding: 2px;
            font-size: 11px;
            color: var(--red);
            font-weight: 700
        }

        /* Controls â€” Stitch-style layout */
        .game-controls {
            display: flex;
            gap: 10px;
            align-items: center;
            justify-content: center;
            padding: 8px 10px 4px
        }

        .ctrl-side-btn {
            width: 56px;
            height: 56px;
            border-radius: var(--radius);
            border: none;
            background: var(--surface2);
            color: var(--dim);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 2px;
            cursor: pointer;
            font-family: 'Montserrat', sans-serif;
            font-size: 9px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: .5px;
            transition: all .15s
        }

        .ctrl-side-btn:active {
            transform: scale(.93);
            background: var(--surface3)
        }

        .ctrl-side-btn .material-symbols-outlined {
            font-size: 20px
        }

        .spin-btn {
            width: 90px;
            height: 70px;
            border-radius: var(--radius);
            border: none;
            font-family: 'Montserrat', sans-serif;
            font-weight: 900;
            cursor: pointer;
            font-size: 11px;
            transition: all .2s;
            text-transform: uppercase;
            letter-spacing: .5px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 2px;
            position: relative
        }

        .spin-btn .material-symbols-outlined {
            font-size: 28px
        }

        .spin-btn.m-spin {
            background: var(--red);
            color: #fff;
            box-shadow: 0 4px 20px var(--red-glow)
        }

        .spin-btn.m-deposit {
            background: var(--green);
            color: #fff;
            animation: glow-g 1.5s infinite
        }

        .spin-btn.m-load {
            background: var(--surface);
            color: var(--dim)
        }

        @keyframes glow-g {

            0%,
            100% {
                box-shadow: 0 0 8px rgba(34, 197, 94, .3)
            }

            50% {
                box-shadow: 0 0 20px rgba(34, 197, 94, .5)
            }
        }

        .spin-btn:disabled {
            opacity: .4;
            cursor: not-allowed
        }

        .spin-btn:active:not(:disabled) {
            transform: scale(.93)
        }

        /* Bet amount strip â€” [âˆ’] â€”â€”â€” 5.0 coins â€”â€”â€” [+] */
        .bet-strip {
            display: flex;
            align-items: center;
            margin: 4px 10px 0;
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            height: 48px;
            overflow: hidden
        }

        .bet-strip-btn {
            width: 54px;
            height: 100%;
            border: none;
            background: transparent;
            color: var(--dim);
            font-size: 22px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all .12s;
            font-family: 'Inter', sans-serif;
            flex-shrink: 0
        }

        .bet-strip-btn:active {
            background: rgba(255, 255, 255, .05);
            color: #fff
        }

        .bet-strip-val {
            flex: 1;
            text-align: center;
            font-family: 'Montserrat', sans-serif;
            font-weight: 800;
            font-size: 16px;
            color: #fff;
            letter-spacing: .3px;
            user-select: none
        }

        .bet-strip-val .bet-unit {
            color: var(--red);
            font-size: 12px;
            font-weight: 700;
            margin-left: 4px;
            text-transform: uppercase
        }

        .bet-strip-label {
            display: block;
            font-size: 9px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1.5px;
            color: var(--dim2);
            text-align: center;
            margin-top: 2px;
            padding: 0 10px
        }

        /* Buy bonus */
        .buy-bonus {
            width: calc(100% - 20px);
            margin: 6px 10px 0;
            padding: 12px 14px;
            border-radius: var(--radius);
            border: 1.5px solid rgba(227, 30, 36, .2);
            background: transparent;
            color: #fff;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            font-family: 'Inter', sans-serif;
            font-size: 13px;
            transition: all .15s
        }

        .buy-bonus:active {
            transform: scale(.97);
            background: rgba(227, 30, 36, .05)
        }

        .bb-left {
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 6px
        }

        .bb-right {
            font-weight: 800;
            color: var(--red)
        }

        /* Speed row (hidden inside AUTO now, but keep for turbo toggle) */
        .speed-row {
            display: none
        }

        /* ======================== */
        /* === BONUSES SCREEN === */
        /* ======================== */
        .bonus-featured {
            margin: 0 16px 16px;
            border-radius: var(--radius-xl);
            background: linear-gradient(180deg, rgba(227, 30, 36, .08), var(--surface) 60%);
            border: 1.5px solid rgba(227, 30, 36, .25);
            overflow: hidden;
            min-height: 200px;
            display: flex;
            flex-direction: column;
            justify-content: flex-end;
            position: relative;
            box-shadow: 0 0 16px rgba(227, 30, 36, .08)
        }

        .bonus-featured-content {
            padding: 20px;
            position: relative;
            z-index: 1
        }

        .bonus-featured .bf-tags {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px
        }

        .bf-tag {
            font-size: 9px;
            font-weight: 800;
            text-transform: uppercase;
            padding: 3px 8px;
            border-radius: 4px;
            letter-spacing: 1px;
            background: rgba(227, 30, 36, .15);
            color: var(--red);
            border: 1px solid rgba(227, 30, 36, .2)
        }

        .bf-timer {
            display: flex;
            align-items: center;
            gap: 4px;
            font-size: 10px;
            color: var(--dim);
            font-weight: 500
        }

        .bf-timer .material-symbols-outlined {
            font-size: 12px
        }

        .bf-title {
            font-family: 'Montserrat', sans-serif;
            font-size: 24px;
            font-weight: 900;
            color: #fff;
            margin-bottom: 4px;
            letter-spacing: -.3px
        }

        .bf-desc {
            font-size: 12px;
            color: var(--dim);
            line-height: 1.5;
            margin-bottom: 16px
        }

        .bf-bottom {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-top: 12px;
            border-top: 1px solid rgba(255, 255, 255, .06)
        }

        .bf-wager-label {
            font-size: 9px;
            text-transform: uppercase;
            font-weight: 800;
            color: var(--dim2);
            letter-spacing: 1px
        }

        .bf-wager-val {
            font-weight: 800;
            color: #fff;
            font-size: 14px
        }

        .bf-activate {
            height: 38px;
            padding: 0 20px;
            border-radius: 20px;
            border: none;
            background: var(--red);
            color: #fff;
            font-family: 'Montserrat', sans-serif;
            font-weight: 700;
            font-size: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            box-shadow: 0 2px 12px var(--red-glow);
            transition: all .15s;
            text-transform: uppercase
        }

        .bf-activate:active {
            transform: scale(.95)
        }

        .bf-activate .material-symbols-outlined {
            font-size: 16px
        }

        /* Bonus list card */
        .bonus-card {
            margin: 0 16px 12px;
            border-radius: var(--radius-lg);
            background: var(--surface);
            border: 1px solid var(--border);
            overflow: hidden;
            display: flex;
            transition: border-color .2s
        }

        .bonus-card:active {
            border-color: rgba(227, 30, 36, .3)
        }

        .bonus-card-img {
            width: 33%;
            min-height: 110px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 36px;
            position: relative
        }

        .bonus-card-img::after {
            content: '';
            position: absolute;
            right: 0;
            top: 0;
            bottom: 0;
            width: 30px;
            background: linear-gradient(90deg, transparent, var(--surface))
        }

        .bonus-card-body {
            flex: 1;
            padding: 14px 14px 14px 8px;
            display: flex;
            flex-direction: column;
            justify-content: center
        }

        .bonus-card-title {
            font-family: 'Montserrat', sans-serif;
            font-size: 15px;
            font-weight: 800;
            color: #fff;
            margin-bottom: 4px
        }

        .bonus-card-desc {
            font-size: 11px;
            color: var(--dim);
            line-height: 1.4;
            margin-bottom: 10px
        }

        .bonus-card-btn {
            height: 32px;
            padding: 0 16px;
            border-radius: 16px;
            border: 1.5px solid var(--red);
            background: transparent;
            color: var(--red);
            font-family: 'Montserrat', sans-serif;
            font-weight: 700;
            font-size: 11px;
            cursor: pointer;
            transition: all .15s;
            text-transform: uppercase;
            align-self: flex-start
        }

        .bonus-card-btn:active {
            background: rgba(227, 30, 36, .08)
        }

        /* Locked bonus */
        .bonus-locked {
            margin: 0 16px 12px;
            border-radius: var(--radius-lg);
            background: var(--surface);
            border: 1px solid var(--border);
            overflow: hidden;
            display: flex;
            opacity: .5
        }

        .bonus-locked .lock-icon {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(0, 0, 0, .6);
            border-radius: 50%;
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center
        }

        /* Bonus Segments */
        .bonus-seg {
            background: transparent;
            color: var(--dim)
        }

        .bonus-seg.active {
            background: var(--surface2);
            color: #fff;
            border: 1px solid rgba(255, 255, 255, .08) !important;
            box-shadow: 0 2px 8px rgba(0, 0, 0, .3)
        }

        /* Glass Bonus Card */
        .glass-card {
            background: linear-gradient(135deg, var(--surface) 0%, var(--surface2) 100%);
            border: 1px solid rgba(227, 30, 36, .3);
            border-radius: 14px;
            padding: 20px;
            position: relative;
            overflow: hidden
        }

        .glass-card .gc-bg-icon {
            position: absolute;
            top: 0;
            right: 0;
            padding: 16px;
            opacity: .07
        }

        .glass-card .gc-bg-icon .material-symbols-outlined {
            font-size: 56px;
            color: var(--red)
        }

        .gc-title {
            font-family: 'Montserrat', sans-serif;
            font-size: 18px;
            font-weight: 800;
            color: #fff;
            margin-bottom: 4px;
            position: relative;
            z-index: 1
        }

        .gc-desc {
            font-size: 12px;
            color: var(--dim);
            line-height: 1.4;
            margin-bottom: 14px;
            position: relative;
            z-index: 1
        }

        .gc-progress {
            margin-bottom: 16px;
            position: relative;
            z-index: 1
        }

        .gc-progress-header {
            display: flex;
            justify-content: space-between;
            font-size: 10px;
            font-weight: 800;
            text-transform: uppercase;
            letter-spacing: .8px;
            margin-bottom: 6px
        }

        .gc-progress-header .label {
            color: var(--red)
        }

        .gc-progress-header .val {
            color: #fff
        }

        .gc-progress-bar {
            width: 100%;
            height: 5px;
            background: rgba(227, 30, 36, .15);
            border-radius: 3px;
            overflow: hidden
        }

        .gc-progress-fill {
            height: 100%;
            background: var(--red);
            border-radius: 3px;
            transition: width .5s
        }

        .gc-btn-primary {
            width: 100%;
            height: 42px;
            border: none;
            border-radius: 8px;
            background: var(--red);
            color: #fff;
            font-family: 'Montserrat', sans-serif;
            font-weight: 800;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 1.5px;
            cursor: pointer;
            transition: all .15s;
            position: relative;
            z-index: 1
        }

        .gc-btn-primary:active {
            transform: scale(.97);
            opacity: .9
        }

        .gc-btn-outline {
            width: 100%;
            height: 42px;
            border: 1.5px solid rgba(227, 30, 36, .4);
            border-radius: 8px;
            background: rgba(227, 30, 36, .06);
            color: var(--red);
            font-family: 'Montserrat', sans-serif;
            font-weight: 800;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 1.5px;
            cursor: pointer;
            transition: all .15s;
            position: relative;
            z-index: 1
        }

        .gc-btn-outline:active {
            transform: scale(.97);
            background: rgba(227, 30, 36, .12)
        }

        .gc-timer {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 12px;
            background: rgba(0, 0, 0, .3);
            border: 1px solid var(--border);
            border-radius: 8px;
            margin-bottom: 16px;
            position: relative;
            z-index: 1
        }

        .gc-timer .material-symbols-outlined {
            color: var(--red);
            font-size: 20px
        }

        .gc-timer-label {
            font-size: 9px;
            text-transform: uppercase;
            font-weight: 800;
            color: var(--dim2);
            letter-spacing: 1px;
            line-height: 1
        }

        .gc-timer-val {
            font-size: 12px;
            font-weight: 800;
            color: #fff;
            text-transform: uppercase;
            letter-spacing: 2px
        }

        .gc-vip-tag {
            padding: 3px 8px;
            font-size: 9px;
            font-weight: 900;
            text-transform: uppercase;
            letter-spacing: .5px;
            background: rgba(227, 30, 36, .15);
            color: var(--red);
            border: 1px solid rgba(227, 30, 36, .25);
            border-radius: 4px
        }

        /* History Item */
        .history-item {
            background: rgba(255, 255, 255, .03);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 14px;
            transition: all .15s
        }

        .history-item.expired {
            opacity: .6
        }

        .hi-top {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 12px
        }

        .hi-icon {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0
        }

        .hi-icon.active {
            background: rgba(227, 30, 36, .08);
            border: 1px solid rgba(227, 30, 36, .15)
        }

        .hi-icon.inactive {
            background: var(--surface2);
            border: 1px solid var(--border)
        }

        .hi-info {
            flex: 1;
            margin-left: 10px
        }

        .hi-title {
            font-family: 'Montserrat', sans-serif;
            font-size: 13px;
            font-weight: 800;
            color: #fff;
            letter-spacing: .3px
        }

        .hi-date {
            font-size: 10px;
            color: var(--dim2);
            margin-top: 2px
        }

        .hi-amount {
            text-align: right
        }

        .hi-val {
            font-size: 13px;
            font-weight: 800;
            color: #fff
        }

        .hi-val-label {
            font-size: 9px;
            font-weight: 800;
            text-transform: uppercase;
            color: var(--dim2)
        }

        .hi-bottom {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding-top: 10px;
            border-top: 1px solid var(--border)
        }

        .hi-status {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 11px;
            font-weight: 600;
            color: var(--dim)
        }

        .hi-status .material-symbols-outlined {
            font-size: 16px
        }

        .hi-status.completed .material-symbols-outlined {
            color: var(--red)
        }

        .hi-status.completed {
            color: var(--text)
        }

        .hi-badge {
            font-size: 9px;
            font-weight: 800;
            padding: 4px 8px;
            border-radius: 4px;
            background: rgba(255, 255, 255, .04);
            border: 1px solid rgba(255, 255, 255, .08);
            color: var(--dim2);
            text-transform: uppercase;
            letter-spacing: .5px
        }

        .bonus-locked .lock-icon .material-symbols-outlined {
            font-size: 14px;
            color: var(--dim)
        }

        .bonus-locked-body {
            flex: 1;
            padding: 14px;
            position: relative
        }

        .bonus-locked .bl-title {
            font-family: 'Montserrat', sans-serif;
            font-size: 14px;
            font-weight: 800;
            color: var(--dim)
        }

        .bonus-locked .bl-desc {
            font-size: 10px;
            color: var(--dim2);
            margin-bottom: 8px
        }

        .bl-progress {
            height: 4px;
            background: var(--surface2);
            border-radius: 2px;
            overflow: hidden
        }

        .bl-progress-fill {
            height: 100%;
            background: var(--dim);
            border-radius: 2px
        }

        .bl-progress-label {
            font-size: 9px;
            color: var(--dim2);
            text-align: right;
            margin-top: 3px
        }

        /* ======================== */
        /* === WALLET SCREEN === */
        /* ======================== */
        .wallet-balance {
            text-align: center;
            padding: 24px 16px 16px
        }

        .wallet-balance-label {
            font-size: 10px;
            font-weight: 800;
            text-transform: uppercase;
            letter-spacing: 2px;
            color: var(--dim);
            font-family: 'Montserrat', sans-serif;
            margin-bottom: 4px
        }

        .wallet-balance-amount {
            display: flex;
            align-items: baseline;
            justify-content: center;
            gap: 8px
        }

        .wallet-balance-amount h1 {
            font-family: 'Montserrat', sans-serif;
            font-size: 48px;
            font-weight: 900;
            color: #fff;
            letter-spacing: -2px
        }

        .wallet-balance-amount .unit {
            font-family: 'Montserrat', sans-serif;
            font-size: 22px;
            font-weight: 700;
            color: var(--red)
        }

        .wallet-balance-usd {
            font-size: 13px;
            color: var(--dim);
            margin-top: 2px
        }

        .wallet-actions {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            padding: 0 16px;
            margin-bottom: 16px
        }

        .wallet-actions .btn-primary {
            height: 50px;
            font-size: 13px
        }

        .wallet-actions .btn-outline {
            height: 50px;
            font-size: 13px
        }

        .wallet-history-btn {
            margin: 0 16px 16px;
            height: 44px;
            border-radius: var(--radius);
            border: 1px solid var(--border);
            background: var(--surface);
            color: var(--dim);
            font-family: 'Inter', sans-serif;
            font-weight: 500;
            font-size: 13px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: all .15s;
            width: calc(100% - 32px)
        }

        .wallet-history-btn:active {
            background: var(--surface2)
        }

        .wallet-history-btn .material-symbols-outlined {
            font-size: 18px
        }

        .wallet-assets {
            padding: 0 16px;
            margin-bottom: 16px
        }

        .wallet-assets-label {
            font-size: 10px;
            font-weight: 800;
            text-transform: uppercase;
            letter-spacing: 1.5px;
            color: var(--dim);
            font-family: 'Montserrat', sans-serif;
            margin-bottom: 10px
        }

        .asset-row {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px
        }

        .asset-btn {
            height: 42px;
            border-radius: var(--radius);
            border: 1px solid var(--border);
            background: var(--surface);
            color: var(--dim);
            font-family: 'Montserrat', sans-serif;
            font-weight: 600;
            font-size: 13px;
            cursor: pointer;
            transition: all .15s
        }

        .asset-btn.active {
            border: 2px solid var(--red);
            color: #fff;
            background: rgba(227, 30, 36, .06);
            box-shadow: 0 0 8px var(--red-glow)
        }

        /* Deposit info card */
        .deposit-card {
            margin: 0 16px 16px;
            padding: 20px;
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: var(--radius-xl)
        }

        .deposit-card .dc-network {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: rgba(0, 0, 0, .3);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 10px 12px;
            margin-bottom: 16px
        }

        .dc-network-left {
            display: flex;
            align-items: center;
            gap: 8px
        }

        .dc-network .dc-dot {
            width: 8px;
            height: 8px;
            background: var(--red);
            border-radius: 50%;
            box-shadow: 0 0 6px var(--red);
            animation: pulse-dot 2s infinite
        }

        @keyframes pulse-dot {

            0%,
            100% {
                opacity: 1
            }

            50% {
                opacity: .5
            }
        }

        .dc-network .dc-name {
            font-size: 13px;
            font-weight: 600
        }

        .dc-network .dc-status {
            font-size: 9px;
            font-weight: 800;
            text-transform: uppercase;
            color: var(--red);
            letter-spacing: 1px;
            border: 1px solid rgba(227, 30, 36, .2);
            background: rgba(227, 30, 36, .05);
            padding: 2px 8px;
            border-radius: 4px
        }

        .dc-info {
            text-align: center;
            padding: 8px 0;
            font-size: 12px;
            color: var(--dim);
            margin-bottom: 12px
        }

        .dc-info span {
            color: #fff;
            font-weight: 700
        }

        .dc-address-box {
            display: flex;
            align-items: center;
            gap: 6px;
            background: rgba(0, 0, 0, .3);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 6px 6px 6px 14px
        }

        .dc-address {
            flex: 1;
            font-family: monospace;
            font-size: 11px;
            color: var(--dim);
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap
        }

        .dc-copy {
            width: 36px;
            height: 36px;
            border-radius: 8px;
            border: none;
            background: var(--surface2);
            color: var(--dim);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all .15s
        }

        .dc-copy:active {
            background: var(--red);
            color: #fff
        }

        .dc-copy .material-symbols-outlined {
            font-size: 16px
        }

        .dc-note {
            display: flex;
            align-items: flex-start;
            gap: 8px;
            background: rgba(227, 30, 36, .04);
            border: 1px solid rgba(227, 30, 36, .12);
            border-radius: var(--radius);
            padding: 12px;
            margin-top: 12px
        }

        .dc-note .material-symbols-outlined {
            font-size: 16px;
            color: var(--red);
            margin-top: 1px;
            flex-shrink: 0
        }

        .dc-note p {
            font-size: 11px;
            color: var(--dim);
            line-height: 1.5
        }

        .dc-note p span {
            color: var(--red);
            font-weight: 700
        }

        /* ======================== */
        /* === REFERRAL SCREEN === */
        /* ======================== */
        .ref-hero {
            margin: 16px;
            border-radius: var(--radius-xl);
            background: var(--surface);
            border: 1px solid var(--border);
            padding: 28px 20px;
            text-align: center;
            position: relative;
            overflow: hidden
        }

        .ref-hero::before {
            content: '';
            position: absolute;
            top: -60px;
            right: -40px;
            width: 180px;
            height: 180px;
            background: radial-gradient(circle, rgba(227, 30, 36, .12), transparent 70%);
            border-radius: 50%
        }

        .ref-hero::after {
            content: '';
            position: absolute;
            bottom: -40px;
            left: -40px;
            width: 150px;
            height: 150px;
            background: radial-gradient(circle, rgba(227, 30, 36, .08), transparent 70%);
            border-radius: 50%
        }

        .ref-hero-icon {
            margin-bottom: 12px;
            position: relative;
            z-index: 1;
            display: flex;
            align-items: center;
            justify-content: center
        }

        .ref-hero h1 {
            font-family: 'Montserrat', sans-serif;
            font-size: 26px;
            font-weight: 900;
            margin-bottom: 6px;
            position: relative;
            z-index: 1;
            letter-spacing: -.5px
        }

        .ref-hero h1 span {
            color: var(--red)
        }

        .ref-hero p {
            font-size: 13px;
            color: var(--dim);
            line-height: 1.5;
            position: relative;
            z-index: 1
        }

        .ref-hero p b {
            color: #fff
        }

        .ref-link-card {
            margin: 0 16px 16px;
            padding: 2px;
            border-radius: var(--radius-lg);
            background: linear-gradient(90deg, rgba(227, 30, 36, .3), var(--red), rgba(227, 30, 36, .3));
            box-shadow: 0 0 12px rgba(227, 30, 36, .15)
        }

        .ref-link-inner {
            background: var(--surface);
            border-radius: calc(var(--radius-lg) - 2px);
            padding: 16px
        }

        .ref-link-label {
            text-align: center;
            font-size: 10px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1.5px;
            color: var(--dim);
            margin-bottom: 12px
        }

        .ref-link-box {
            display: flex;
            align-items: center;
            gap: 6px;
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 4px 4px 4px 12px
        }

        .ref-link-box .ref-url {
            flex: 1;
            font-size: 12px;
            font-weight: 500;
            color: var(--dim);
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap
        }

        .ref-link-box .ref-copy {
            height: 38px;
            padding: 0 16px;
            border-radius: 8px;
            border: none;
            background: var(--red);
            color: #fff;
            font-family: 'Montserrat', sans-serif;
            font-weight: 700;
            font-size: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: all .15s
        }

        .ref-link-box .ref-copy:active {
            transform: scale(.95)
        }

        .ref-link-box .ref-copy .material-symbols-outlined {
            font-size: 16px
        }

        .ref-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            padding: 0 16px;
            margin-bottom: 16px
        }

        .ref-stat-card {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: var(--radius-lg);
            padding: 16px;
            display: flex;
            flex-direction: column;
            gap: 8px;
            transition: border-color .2s
        }

        .ref-stat-card:hover {
            border-color: rgba(227, 30, 36, .2)
        }

        .ref-stat-top {
            display: flex;
            justify-content: space-between;
            align-items: center
        }

        .ref-stat-icon {
            width: 36px;
            height: 36px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center
        }

        .ref-stat-icon .material-symbols-outlined {
            font-size: 18px
        }

        .ref-stat-icon.people {
            background: rgba(227, 30, 36, .08);
            color: var(--red)
        }

        .ref-stat-icon.money {
            background: rgba(59, 130, 246, .08);
            color: var(--blue)
        }

        .ref-stat-badge {
            font-size: 10px;
            font-weight: 700;
            color: var(--green);
            background: rgba(34, 197, 94, .08);
            padding: 2px 8px;
            border-radius: 10px
        }

        .ref-stat-label {
            font-size: 10px;
            font-weight: 600;
            color: var(--dim)
        }

        .ref-stat-val {
            font-family: 'Montserrat', sans-serif;
            font-size: 24px;
            font-weight: 900;
            color: #fff
        }

        .ref-how {
            margin: 0 16px 16px
        }

        .ref-how-title {
            font-family: 'Montserrat', sans-serif;
            font-size: 15px;
            font-weight: 800;
            margin-bottom: 12px
        }

        .ref-steps {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: var(--radius-lg);
            padding: 20px
        }

        .ref-step {
            display: flex;
            gap: 14px;
            margin-bottom: 20px
        }

        .ref-step:last-child {
            margin-bottom: 0
        }

        .ref-step-line {
            display: flex;
            flex-direction: column;
            align-items: center
        }

        .ref-step-num {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: var(--surface2);
            border: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: 'Montserrat', sans-serif;
            font-size: 12px;
            font-weight: 800;
            color: var(--red);
            flex-shrink: 0
        }

        .ref-step:last-child .ref-step-num {
            background: var(--red);
            color: #fff;
            border: none;
            box-shadow: 0 0 10px var(--red-glow)
        }

        .ref-step-connector {
            width: 1px;
            flex: 1;
            background: var(--border);
            margin: 4px 0
        }

        .ref-step-content h3 {
            font-size: 13px;
            font-weight: 700;
            color: #fff;
            margin-bottom: 2px
        }

        .ref-step-content p {
            font-size: 11px;
            color: var(--dim);
            line-height: 1.5
        }

        .ref-share-btn {
            position: fixed;
            bottom: calc(var(--nav-h) + 16px);
            left: 50%;
            transform: translateX(-50%);
            height: 46px;
            padding: 0 28px;
            border-radius: 23px;
            border: none;
            background: #fff;
            color: var(--red);
            font-family: 'Montserrat', sans-serif;
            font-weight: 800;
            font-size: 13px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 8px 30px rgba(0, 0, 0, .5);
            z-index: 40;
            transition: all .15s
        }

        .ref-share-btn:active {
            transform: translateX(-50%) scale(.95)
        }

        .ref-share-btn .material-symbols-outlined {
            font-size: 18px
        }

        /* ======================== */
        /* === PROFILE SCREEN === */
        /* ======================== */
        .prof-header {
            text-align: center;
            padding: 24px 16px 16px
        }

        .prof-avatar {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            padding: 3px;
            background: var(--red);
            box-shadow: 0 0 16px var(--red-glow);
            margin: 0 auto 12px;
            display: flex;
            align-items: center;
            justify-content: center
        }

        .prof-avatar-inner {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            background: var(--surface);
            border: 2px solid var(--bg);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 32px;
            overflow: hidden
        }

        .prof-name {
            font-family: 'Montserrat', sans-serif;
            font-size: 22px;
            font-weight: 700;
            color: #fff;
            margin-bottom: 4px;
            letter-spacing: -.3px
        }

        .prof-meta {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin-bottom: 16px
        }

        .prof-id {
            font-size: 11px;
            color: var(--dim);
            font-family: monospace;
            letter-spacing: .5px
        }

        .prof-vip-badge {
            display: flex;
            align-items: center;
            gap: 4px;
            font-size: 11px;
            color: var(--red);
            font-weight: 700
        }

        .prof-vip-badge .material-symbols-outlined {
            font-size: 14px
        }

        .prof-level {
            padding: 0 16px;
            margin-bottom: 20px
        }

        .prof-level-top {
            display: flex;
            justify-content: space-between;
            margin-bottom: 6px
        }

        .prof-level-name {
            font-size: 10px;
            font-weight: 800;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--dim);
            font-family: 'Montserrat', sans-serif
        }

        .prof-level-val {
            font-size: 11px;
            font-weight: 600;
            color: var(--red)
        }

        .prof-level .vip-bar {
            margin-bottom: 4px
        }

        .prof-level-xp {
            display: flex;
            justify-content: space-between;
            font-size: 9px;
            color: var(--dim2)
        }

        .prof-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 0;
            margin: 0 16px 16px;
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: var(--radius-lg);
            overflow: hidden
        }

        .prof-stat {
            padding: 14px;
            text-align: center;
            border-right: 1px solid var(--border)
        }

        .prof-stat:last-child {
            border-right: none
        }

        .prof-stat-label {
            font-size: 9px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--dim);
            margin-bottom: 4px
        }

        .prof-stat-val {
            font-family: 'Montserrat', sans-serif;
            font-size: 18px;
            font-weight: 800;
            color: #fff
        }

        .prof-referral-btn {
            margin: 0 16px 12px;
            padding: 14px 16px;
            background: var(--surface);
            border: 1.5px solid rgba(227, 30, 36, .25);
            border-radius: var(--radius-lg);
            display: flex;
            align-items: center;
            justify-content: space-between;
            cursor: pointer;
            transition: all .15s;
            box-shadow: 0 0 8px rgba(227, 30, 36, .05)
        }

        .prof-referral-btn:active {
            background: rgba(227, 30, 36, .04)
        }

        .prof-ref-left {
            display: flex;
            align-items: center;
            gap: 12px
        }

        .prof-ref-icon {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: rgba(227, 30, 36, .08);
            border: 1px solid rgba(227, 30, 36, .15);
            display: flex;
            align-items: center;
            justify-content: center
        }

        .prof-ref-icon .material-symbols-outlined {
            font-size: 18px;
            color: var(--red)
        }

        .prof-ref-text h3 {
            font-size: 13px;
            font-weight: 700;
            color: #fff
        }

        .prof-ref-text p {
            font-size: 10px;
            color: var(--dim)
        }

        .prof-referral-btn .material-symbols-outlined {
            color: var(--red);
            font-size: 18px;
            transition: transform .15s
        }

        .prof-referral-btn:active .material-symbols-outlined:last-child {
            transform: translateX(2px)
        }

        .prof-menu {
            margin: 0 16px 16px;
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: var(--radius-lg);
            overflow: hidden
        }

        .prof-menu-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 14px 16px;
            border-bottom: 1px solid var(--border);
            cursor: pointer;
            transition: background .15s
        }

        .prof-menu-item:last-child {
            border-bottom: none
        }

        .prof-menu-item:active {
            background: var(--surface2)
        }

        .prof-menu-left {
            display: flex;
            align-items: center;
            gap: 12px
        }

        .prof-menu-left .material-symbols-outlined {
            font-size: 20px;
            color: var(--red)
        }

        .prof-menu-left span:last-child {
            font-size: 13px;
            font-weight: 500
        }

        .prof-menu-item .material-symbols-outlined:last-child {
            font-size: 18px;
            color: var(--dim2)
        }

        .prof-signout {
            display: block;
            margin: 0 auto;
            padding: 12px 24px;
            border: none;
            background: none;
            color: var(--dim);
            font-family: 'Montserrat', sans-serif;
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 2px;
            cursor: pointer;
            transition: color .15s
        }

        .prof-signout:active {
            color: var(--red)
        }

        /* ======================== */
        /* === OVERLAYS === */
        /* ======================== */
        .bonus-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, .92);
            z-index: 200;
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 12px;
            padding: 20px
        }

        .bonus-overlay.show {
            display: flex
        }

        .bo-title {
            font-family: 'Montserrat', sans-serif;
            font-size: 22px;
            font-weight: 900;
            color: var(--red);
            text-shadow: 0 0 20px var(--red-glow);
            animation: bo-pop .5s ease-out
        }

        @keyframes bo-pop {
            0% {
                transform: scale(0)
            }

            60% {
                transform: scale(1.2)
            }

            100% {
                transform: scale(1)
            }
        }

        .bo-info {
            display: flex;
            gap: 16px
        }

        .bo-info-item {
            text-align: center;
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 8px 16px
        }

        .bo-info-item .label {
            font-size: 10px;
            color: var(--dim)
        }

        .bo-info-item .val {
            font-family: 'Montserrat', sans-serif;
            font-size: 18px;
            font-weight: 900;
            color: var(--gold)
        }

        .bo-grid-wrap {
            width: 100%;
            max-width: 380px;
            background: rgba(0, 0, 0, .5);
            border: 2px solid var(--red);
            border-radius: var(--radius-lg);
            padding: 6px
        }

        .bo-grid {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 3px
        }

        .bo-result {
            font-weight: 800;
            font-size: 18px;
            color: var(--green);
            text-align: center;
            min-height: 24px
        }

        .bo-total {
            font-family: 'Montserrat', sans-serif;
            font-size: 28px;
            font-weight: 900;
            color: var(--gold);
            text-align: center
        }

        .bo-close {
            padding: 12px 36px;
            border-radius: var(--radius);
            border: none;
            background: var(--red);
            color: #fff;
            font-family: 'Montserrat', sans-serif;
            font-weight: 900;
            font-size: 15px;
            cursor: pointer;
            display: none;
            box-shadow: 0 4px 16px var(--red-glow)
        }

        /* Wheel overlay */
        .wheel-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, .92);
            z-index: 200;
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 20px;
            padding: 20px
        }

        .wheel-overlay.show {
            display: flex
        }

        .wo-title {
            font-family: 'Montserrat', sans-serif;
            font-size: 20px;
            font-weight: 900;
            color: var(--green)
        }

        .wheel-container {
            position: relative;
            width: 260px;
            height: 260px;
            margin: 0 auto
        }

        .wheel-canvas {
            width: 260px;
            height: 260px;
            border-radius: 50%;
            transition: transform 4s cubic-bezier(.17, .67, .05, .99)
        }

        .wheel-pointer {
            position: absolute;
            top: -8px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 28px;
            z-index: 10;
            filter: drop-shadow(0 2px 4px rgba(0, 0, 0, .5))
        }

        .wheel-center {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 44px;
            height: 44px;
            border-radius: 50%;
            background: var(--red);
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: 'Montserrat', sans-serif;
            font-weight: 900;
            font-size: 14px;
            color: #fff;
            box-shadow: 0 0 20px var(--red-glow);
            z-index: 5
        }

        .wo-prize {
            font-family: 'Montserrat', sans-serif;
            font-size: 28px;
            font-weight: 900;
            color: var(--red);
            min-height: 40px
        }

        .wo-btn {
            padding: 14px 40px;
            border-radius: var(--radius);
            border: none;
            background: var(--green);
            color: #fff;
            font-family: 'Montserrat', sans-serif;
            font-weight: 900;
            font-size: 16px;
            cursor: pointer
        }

        /* Toast */
        .toast {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0);
            background: var(--surface);
            border: 1.5px solid var(--red);
            border-radius: var(--radius-xl);
            padding: 24px 28px;
            text-align: center;
            z-index: 500;
            transition: transform .25s cubic-bezier(.34, 1.56, .64, 1);
            max-width: 300px;
            width: 85%
        }

        .toast.show {
            transform: translate(-50%, -50%) scale(1)
        }

        .toast-icon {
            font-size: 40px;
            margin-bottom: 8px
        }

        .toast-text {
            font-size: 14px;
            font-weight: 700;
            margin-bottom: 14px;
            line-height: 1.4
        }

        .toast-btns {
            display: flex;
            gap: 8px
        }

        .toast-btn {
            flex: 1;
            padding: 10px;
            border-radius: var(--radius);
            border: none;
            font-family: 'Montserrat', sans-serif;
            font-weight: 800;
            font-size: 13px;
            cursor: pointer;
            transition: transform .1s
        }

        .toast-btn:active {
            transform: scale(.95)
        }

        .toast-btn.primary {
            background: var(--red);
            color: #fff;
            box-shadow: 0 2px 10px var(--red-glow)
        }

        .toast-btn.secondary {
            background: var(--surface2);
            color: var(--dim)
        }

        .bomb-pop {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-weight: 900;
            font-size: 44px;
            color: var(--red);
            z-index: 300;
            pointer-events: none;
            animation: bp .7s ease-out forwards
        }

        @keyframes bp {
            0% {
                transform: translate(-50%, -50%) scale(0);
                opacity: 1
            }

            50% {
                transform: translate(-50%, -50%) scale(1.4);
                opacity: 1
            }

            100% {
                transform: translate(-50%, -60%) scale(1);
                opacity: 0
            }
        }

        /* === CRASH GAME === */
        #scrCrash {
            display: none;
            opacity: 0;
            flex-direction: column;
            height: 100vh;
            overflow: hidden;
            background: var(--bg);
            transition: opacity 0.15s ease;
        }

        #scrCrash.active {
            display: flex;
            opacity: 1;
        }

        .crash-graph-container {
            flex: 1;
            position: relative;
            background: radial-gradient(circle at center, rgba(34, 197, 94, 0.1), transparent);
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }

        .crash-canvas {
            width: 100%;
            height: 100%;
            position: absolute;
            inset: 0;
            z-index: 1;
        }

        .crash-value-display {
            position: relative;
            z-index: 2;
            text-align: center;
        }

        .crash-mult {
            font-family: 'Montserrat', sans-serif;
            font-size: 56px;
            font-weight: 900;
            color: #fff;
            text-shadow: 0 0 20px rgba(255, 255, 255, 0.2);
            line-height: 1;
        }

        .crash-mult.crashed {
            color: var(--red);
            text-shadow: 0 0 20px var(--red-glow);
        }

        .crash-mult.active {
            color: var(--green);
            text-shadow: 0 0 20px rgba(34, 197, 94, 0.4);
        }

        .crash-profit {
            font-size: 16px;
            color: var(--green);
            font-weight: 700;
            margin-top: 8px;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .crash-profit.show {
            opacity: 1;
        }

        .crash-history {
            height: 36px;
            background: var(--surface);
            display: flex;
            align-items: center;
            padding: 0 16px;
            gap: 8px;
            overflow-x: auto;
            border-bottom: 1px solid var(--border);
        }

        .crash-history::-webkit-scrollbar {
            display: none;
        }

        .ch-pill {
            padding: 4px 10px;
            border-radius: 12px;
            background: var(--surface2);
            font-size: 11px;
            font-weight: 700;
            white-space: nowrap;
        }

        .ch-pill.high {
            color: var(--green);
            background: rgba(34, 197, 94, 0.1);
        }

        .ch-pill.low {
            color: var(--red);
            background: rgba(227, 30, 36, 0.1);
        }

        .crash-controls {
            padding: 16px;
            background: var(--surface);
            padding-bottom: calc(env(safe-area-inset-bottom) + 16px);
        }

        .crash-bet-inputs {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-bottom: 16px;
        }

        .cb-box {
            background: var(--surface2);
            border-radius: var(--radius);
            padding: 12px;
            border: 1px solid var(--border);
        }

        .cb-label {
            font-size: 10px;
            color: var(--dim);
            text-transform: uppercase;
            font-weight: 700;
            margin-bottom: 6px;
        }

        .cb-input-row {
            display: flex;
            align-items: center;
        }

        .cb-input {
            flex: 1;
            background: transparent;
            border: none;
            color: #fff;
            font-family: 'Montserrat', sans-serif;
            font-weight: 800;
            font-size: 16px;
            width: 100%;
            outline: none;
        }

        .cb-btn {
            background: var(--surface3);
            color: var(--text);
            border: none;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 700;
            margin-left: 4px;
            cursor: pointer;
        }

        .crash-action-btn {
            width: 100%;
            height: 56px;
            border-radius: var(--radius-lg);
            border: none;
            font-family: 'Montserrat', sans-serif;
            font-size: 18px;
            font-weight: 900;
            color: #fff;
            text-transform: uppercase;
            cursor: pointer;
            transition: all 0.15s;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            line-height: 1.2;
        }

        .crash-action-btn.bet {
            background: var(--green);
            box-shadow: 0 4px 15px rgba(34, 197, 94, 0.3);
        }

        .crash-action-btn.cashout {
            background: var(--gold);
            color: #000;
            box-shadow: 0 4px 15px rgba(255, 215, 0, 0.3);
        }

        .crash-action-btn.wait {
            background: var(--surface3);
            color: var(--dim);
            pointer-events: none;
        }

        .crash-action-btn.cancel {
            background: var(--red);
            box-shadow: 0 4px 15px rgba(227, 30, 36, 0.3);
        }

        .crash-action-sub {
            font-size: 11px;
            font-weight: 600;
            opacity: 0.8;
            font-family: 'Inter', sans-serif;
        }

        /* === NEW RUBY SLOT DESIGN === */
        .glass-panel {
            background: rgba(20, 20, 20, 0.7);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.5);
        }

        .glass-btn {
            background: linear-gradient(145deg, rgba(255, 255, 255, 0.05), rgba(255, 255, 255, 0.01));
            border: 1px solid rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(4px);
            box-shadow: 4px 4px 10px rgba(0, 0, 0, 0.3), -4px -4px 10px rgba(255, 255, 255, 0.02);
        }

        .slot-frame {
            background: linear-gradient(160deg, #2a0a10 0%, #0D0D0D 50%, #2a0a10 100%);
            border-radius: 16px;
            padding: 4px;
            position: relative;
            box-shadow: 0 0 40px rgba(192, 20, 42, 0.15), inset 0 0 20px rgba(0, 0, 0, 0.8);
            border: 1px solid rgba(192, 20, 42, 0.3);
        }

        .slot-frame::before {
            content: '';
            position: absolute;
            inset: -2px;
            border-radius: 18px;
            padding: 2px;
            background: linear-gradient(45deg, #C0142A, transparent, #FFD700, transparent, #C0142A);
            mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
            -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
            mask-composite: exclude;
            -webkit-mask-composite: xor;
            mask-composite: exclude;
            opacity: 0.5;
            pointer-events: none;
        }

        .grid-cell-separator {
            position: absolute;
            background: rgba(192, 20, 42, 0.2);
            z-index: 1;
        }

        .symbol-tile {
            background: radial-gradient(circle at center, rgba(40, 40, 40, 0.8) 0%, rgba(15, 15, 15, 0.95) 100%);
            border: 1px solid rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: inset 0 0 10px rgba(0, 0, 0, 0.8);
            transform-style: preserve-3d;
            transition: transform 0.2s cubic-bezier(0.34, 1.56, 0.64, 1), filter 0.2s ease;
        }

        .symbol-tile svg {
            filter: drop-shadow(0 4px 6px rgba(0, 0, 0, 0.5));
            transform: translateZ(10px);
        }

        /* â”€â”€ REEL SPIN: tiles in a spinning column stream downward â”€â”€ */
        @keyframes reel-scroll {
            0% {
                transform: translateY(0);
                filter: blur(0);
                opacity: 1;
            }

            15% {
                transform: translateY(18px);
                filter: blur(4px);
                opacity: 0.6;
            }

            50% {
                transform: translateY(-6px);
                filter: blur(8px);
                opacity: 0.3;
            }

            85% {
                transform: translateY(14px);
                filter: blur(4px);
                opacity: 0.6;
            }

            100% {
                transform: translateY(0);
                filter: blur(0);
                opacity: 1;
            }
        }

        .spinning-column .symbol-tile {
            animation: reel-scroll 0.14s linear infinite;
            will-change: transform, filter;
        }

        /* â”€â”€ REEL LAND: symbol drops in from top with elastic overshoot â”€â”€ */
        @keyframes reel-land {
            0% {
                transform: translateY(-110%) scaleY(1.15);
                filter: blur(6px);
                opacity: 0;
            }

            55% {
                transform: translateY(8%) scaleY(0.92);
                filter: blur(1px);
                opacity: 1;
            }

            75% {
                transform: translateY(-4%) scaleY(1.05);
                filter: blur(0);
                opacity: 1;
            }

            88% {
                transform: translateY(2%) scaleY(0.98);
            }

            100% {
                transform: translateY(0) scaleY(1);
                filter: blur(0);
                opacity: 1;
            }
        }

        .reel-land {
            animation: reel-land 0.48s cubic-bezier(0.22, 1, 0.36, 1) both !important;
            will-change: transform, filter;
        }

        @keyframes bounce-in {
            0% {
                transform: translateY(-100%) scale(0.8);
                opacity: 0;
            }

            60% {
                transform: translateY(10%) scale(1.05);
                opacity: 1;
            }

            80% {
                transform: translateY(-5%) scale(0.95);
            }

            100% {
                transform: translateY(0) scale(1);
            }
        }

        .bounce-in {
            animation: bounce-in 0.5s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
        }

        @keyframes win-pulse {
            0% {
                transform: scale(1);
                box-shadow: 0 0 0 rgba(255, 215, 0, 0);
            }

            50% {
                transform: scale(1.1);
                box-shadow: 0 0 20px rgba(255, 215, 0, 0.6), inset 0 0 10px rgba(255, 215, 0, 0.4);
                border-color: #FFD700;
            }

            100% {
                transform: scale(1);
                box-shadow: 0 0 0 rgba(255, 215, 0, 0);
            }
        }

        .winning-tile {
            animation: win-pulse 1.5s infinite;
            z-index: 10;
            background: radial-gradient(circle at center, rgba(60, 50, 20, 0.9) 0%, rgba(15, 15, 15, 0.95) 100%);
        }

        .spin-btn-outer {
            background: linear-gradient(to bottom, #2a050b, #1a0205);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.5), 0 0 0 4px #2a050b;
        }

        .spin-btn-inner {
            background: linear-gradient(135deg, #E91E3F 0%, #990a1f 50%, #700515 100%);
            box-shadow: inset 0 2px 10px rgba(255, 255, 255, 0.3), inset 0 -5px 15px rgba(0, 0, 0, 0.5);
            position: relative;
            overflow: hidden;
        }

        .spin-btn-inner::after {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(to right, transparent, rgba(255, 255, 255, 0.4), transparent);
            transform: rotate(45deg) translateX(-100%);
            animation: shimmer-btn 3s infinite;
        }

        @keyframes shimmer-btn {
            0% {
                transform: rotate(45deg) translateX(-100%);
            }

            20% {
                transform: rotate(45deg) translateX(100%);
            }

            100% {
                transform: rotate(45deg) translateX(100%);
            }
        }

        .spin-ring {
            border: 2px solid transparent;
            border-top: 2px solid #FFD700;
            border-right: 2px solid rgba(192, 20, 42, 0.5);
            border-radius: 50%;
            animation: spin-ring 2s linear infinite;
        }

        @keyframes spin-ring {
            from {
                transform: rotate(0deg);
            }

            to {
                transform: rotate(360deg);
            }
        }

        .multiplier-bubble {
            background: #1a1a1a;
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s ease;
        }

        .multiplier-bubble.active {
            transform: scale(1.15);
            box-shadow: 0 0 15px currentColor;
            border-color: currentColor;
            color: white;
            font-weight: 800;
        }

        .svg-defs {
            position: absolute;
            width: 0;
            height: 0;
        }

        #big-win-overlay {
            background: radial-gradient(circle, rgba(0, 0, 0, 0.6) 0%, rgba(0, 0, 0, 0.9) 100%);
            backdrop-filter: blur(5px);
            perspective: 1000px;
        }

        .big-win-text {
            font-size: 4rem;
            font-weight: 900;
            background: linear-gradient(to bottom, #FFD700, #FDB931, #C0142A);
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            text-shadow: 0 10px 20px rgba(0, 0, 0, 0.5);
            transform: rotateX(20deg);
            animation: big-win-pop 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
        }

        @keyframes big-win-pop {
            0% {
                transform: rotateX(20deg) scale(0);
                opacity: 0;
            }

            100% {
                transform: rotateX(0deg) scale(1);
                opacity: 1;
            }
        }

        .sparkle {
            position: absolute;
            width: 4px;
            height: 4px;
            background: #FFD700;
            border-radius: 50%;
            pointer-events: none;
            animation: sparkle-anim 1s forwards;
        }

        @keyframes sparkle-anim {
            0% {
                transform: translate(0, 0) scale(1);
                opacity: 1;
            }

            100% {
                transform: translate(var(--tx), var(--ty)) scale(0);
                opacity: 0;
            }
        }

        /* === MODALS & OVERLAYS === */
        /* Big Win */
        .big-win-overlay {
            background: radial-gradient(circle at center, rgba(40, 5, 10, 0.95) 0%, rgba(13, 13, 13, 0.98) 100%);
            perspective: 1200px;
        }

        .gold-glow {
            text-shadow: 0 0 20px rgba(255, 215, 0, 0.6), 0 0 40px rgba(255, 215, 0, 0.3);
        }

        .big-win-title {
            font-size: 4.5rem;
            font-weight: 900;
            background: linear-gradient(to bottom, #FFF7CC 0%, #FFD700 40%, #B38F00 70%, #C0142A 100%);
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            filter: drop-shadow(0 10px 15px rgba(0, 0, 0, 0.8));
            animation: title-entrance 0.8s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
            letter-spacing: -0.02em;
        }

        @keyframes title-entrance {
            0% {
                transform: scale(0.5) rotateX(45deg);
                opacity: 0;
            }

            100% {
                transform: scale(1) rotateX(0deg);
                opacity: 1;
            }
        }

        .amount-display {
            animation: pulse-amount 2s infinite ease-in-out;
        }

        @keyframes pulse-amount {

            0%,
            100% {
                transform: scale(1);
                filter: brightness(1);
            }

            50% {
                transform: scale(1.05);
                filter: brightness(1.3);
            }
        }

        .collect-btn {
            background: linear-gradient(135deg, #E91E3F 0%, #990a1f 100%);
            box-shadow: 0 0 30px rgba(233, 30, 63, 0.4), inset 0 2px 10px rgba(255, 255, 255, 0.3);
            animation: pulse-button 1.5s infinite;
        }

        @keyframes pulse-button {
            0% {
                box-shadow: 0 0 20px rgba(233, 30, 63, 0.4);
            }

            50% {
                box-shadow: 0 0 45px rgba(233, 30, 63, 0.7);
                transform: scale(1.02);
            }

            100% {
                box-shadow: 0 0 20px rgba(233, 30, 63, 0.4);
            }
        }

        .confetti {
            position: absolute;
            width: 8px;
            height: 12px;
            opacity: 0.8;
            animation: fall linear infinite;
        }

        @keyframes fall {
            0% {
                transform: translateY(-100px) rotate(0deg);
            }

            100% {
                transform: translateY(100vh) rotate(720deg);
            }
        }

        .combination-row {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.08);
            backdrop-filter: blur(4px);
        }

        .light-ray {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 200%;
            height: 100px;
            background: linear-gradient(to right, transparent, rgba(255, 215, 0, 0.1), transparent);
            transform-origin: center;
            animation: rotate-ray 10s linear infinite;
            pointer-events: none;
        }

        @keyframes rotate-ray {
            from {
                transform: translate(-50%, -50%) rotate(0deg);
            }

            to {
                transform: translate(-50%, -50%) rotate(360deg);
            }
        }

        .symbol-mini {
            filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.5));
        }

        /* Autospin Modal */
        .modal-overlay {
            background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(8px);
            transition: opacity 0.3s ease;
        }

        .modal-content {
            background: linear-gradient(180deg, #1A1A1A 0%, #0D0D0D 100%);
            border-top: 2px solid #C0142A;
            box-shadow: 0 -10px 40px rgba(192, 20, 42, 0.2);
            transform: translateY(100%);
            transition: transform 0.4s cubic-bezier(0.16, 1, 0.3, 1);
        }

        .modal-content.active {
            transform: translateY(0);
        }

        .option-chip {
            background: #151515;
            border: 1px solid rgba(255, 255, 255, 0.05);
            transition: all 0.2s ease;
        }

        .option-chip.selected {
            background: linear-gradient(135deg, #C0142A 0%, #800d1c 100%);
            border-color: #FFD700;
            color: white;
            box-shadow: 0 0 15px rgba(192, 20, 42, 0.4);
        }

        .start-autospin-btn {
            background: linear-gradient(to right, #FFD700, #FDB931);
            color: #000;
            font-weight: 900;
            letter-spacing: 0.05em;
            text-shadow: 0 1px 1px rgba(255, 255, 255, 0.3);
            box-shadow: 0 4px 15px rgba(253, 185, 49, 0.3);
        }

        /* Paytable */
        .symbol-card {
            background: linear-gradient(160deg, rgba(255, 255, 255, 0.07) 0%, rgba(255, 255, 255, 0.02) 100%);
            border: 1px solid rgba(255, 255, 255, 0.10);
            border-radius: 18px;
            padding: 14px 10px 12px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 6px;
            transition: all 0.3s cubic-bezier(0.22, 1, 0.36, 1);
            position: relative;
            overflow: hidden;
        }

        .symbol-card::before {
            content: '';
            position: absolute;
            inset: 0;
            border-radius: 18px;
            background: radial-gradient(ellipse at 40% 30%, rgba(255, 215, 0, 0.08) 0%, transparent 70%);
            opacity: 0;
            transition: opacity 0.3s;
        }

        .symbol-card:hover::before {
            opacity: 1;
        }

        .symbol-card:hover {
            border-color: rgba(255, 215, 0, 0.35);
            transform: translateY(-3px) scale(1.03);
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.4), 0 0 0 1px rgba(255, 215, 0, 0.15);
        }

        .symbol-card:active {
            transform: scale(0.98);
        }

        .ruby-glow {
            box-shadow: 0 0 15px rgba(192, 20, 42, 0.2);
            border-color: rgba(192, 20, 42, 0.3);
        }

        .star-glow {
            box-shadow: 0 0 15px rgba(255, 215, 0, 0.2);
            border-color: rgba(255, 215, 0, 0.3);
        }

        .diamond-glow {
            box-shadow: 0 0 15px rgba(77, 208, 225, 0.2);
            border-color: rgba(77, 208, 225, 0.3);
        }

        .heart-glow {
            box-shadow: 0 0 15px rgba(255, 0, 47, 0.2);
            border-color: rgba(255, 0, 47, 0.3);
        }

        .grape-glow {
            box-shadow: 0 0 15px rgba(123, 31, 162, 0.2);
            border-color: rgba(123, 31, 162, 0.3);
        }

        .apple-glow {
            box-shadow: 0 0 15px rgba(192, 20, 42, 0.15);
            border-color: rgba(192, 20, 42, 0.2);
        }

        .peach-glow {
            box-shadow: 0 0 15px rgba(255, 112, 67, 0.2);
            border-color: rgba(255, 112, 67, 0.3);
        }

        .lolly-glow {
            box-shadow: 0 0 15px rgba(236, 64, 122, 0.2);
            border-color: rgba(236, 64, 122, 0.3);
        }

        .multiplier-grid div:nth-child(odd) {
            color: #888;
            font-weight: 500;
            text-align: left;
        }

        .multiplier-grid div:nth-child(even) {
            color: #FFD700;
            font-weight: 800;
            text-align: right;
        }

        .info-header {
            background: linear-gradient(to bottom, #1a0508, #0D0D0D);
            border-bottom: 1px solid rgba(192, 20, 42, 0.2);
        }
    </style>
</head>

<body>
    <!-- Auth Fallback Overlay -->
    <div id="authFallback"
        style="display:none;position:fixed;inset:0;background:var(--bg);z-index:9999;flex-direction:column;align-items:center;justify-content:center;padding:40px;text-align:center">
        <div
            style="width:80px;height:80px;border-radius:50%;background:rgba(227,30,36,0.1);display:flex;align-items:center;justify-content:center;margin-bottom:24px">
            <span class="material-symbols-outlined" style="font-size:40px;color:var(--red)">cloud_off</span>
        </div>
        <h2 style="font-family:Montserrat,sans-serif;font-weight:900;font-size:24px;margin-bottom:12px">CONNECTION ERROR
        </h2>
        <p id="authErrorMsg" style="color:var(--dim);font-size:14px;line-height:1.5;margin-bottom:32px">We couldn't
            verify your Telegram session. Please try restarting the app.</p>
        <button onclick="window.location.reload()"
            style="background:var(--red);color:white;border:none;padding:14px 32px;border-radius:12px;font-weight:800;font-size:14px;cursor:pointer">RETRY
            CONNECTION</button>
    </div>
    <!-- Global SVG Gradients for Slots -->
    <svg class="svg-defs">
        <defs>
            <linearGradient id="rubyGrad" x1="0%" y1="0%" x2="100%" y2="100%">
                <stop offset="0%" stop-color="#ff4d6d"></stop>
                <stop offset="50%" stop-color="#C0142A"></stop>
                <stop offset="100%" stop-color="#59000d"></stop>
            </linearGradient>
            <linearGradient id="goldGrad" x1="0%" y1="0%" x2="100%" y2="100%">
                <stop offset="0%" stop-color="#FFF7CC"></stop>
                <stop offset="40%" stop-color="#FFD700"></stop>
                <stop offset="100%" stop-color="#B38F00"></stop>
            </linearGradient>
            <linearGradient id="diamondGrad" x1="0%" y1="0%" x2="100%" y2="100%">
                <stop offset="0%" stop-color="#E0F7FA"></stop>
                <stop offset="50%" stop-color="#4DD0E1"></stop>
                <stop offset="100%" stop-color="#006064"></stop>
            </linearGradient>
            <radialGradient id="grapeGrad" cx="30%" cy="30%" r="70%">
                <stop offset="0%" stop-color="#E1BEE7"></stop>
                <stop offset="100%" stop-color="#7B1FA2"></stop>
            </radialGradient>
            <linearGradient id="peachGrad" x1="0%" y1="0%" x2="100%" y2="100%">
                <stop offset="0%" stop-color="#FFCCBC"></stop>
                <stop offset="100%" stop-color="#FF7043"></stop>
            </linearGradient>
            <linearGradient id="heartGrad" x1="0%" y1="0%" x2="0%" y2="100%">
                <stop offset="0%" stop-color="#ff9a9e"></stop>
                <stop offset="49%" stop-color="#ff002f"></stop>
                <stop offset="50%" stop-color="#b3001e"></stop>
                <stop offset="100%" stop-color="#59000d"></stop>
            </linearGradient>
            <radialGradient id="lollyGrad" cx="50%" cy="50%" r="50%">
                <stop offset="40%" stop-color="#F48FB1"></stop>
                <stop offset="100%" stop-color="#EC407A"></stop>
            </radialGradient>
        </defs>
    </svg>

    <!-- ===== HEADER (shared) ===== -->
    <div class="header" id="mainHeader">
        <div class="logo" onclick="nav('lobby')" style="cursor:pointer">
            <div class="logo-icon"><span class="material-symbols-outlined">diamond</span></div>
            <div class="logo-text">RUBY<span>BET</span></div>
        </div>
        <div class="header-right">
            <div class="header-bal" onclick="openBalancePopup()"
                style="display:flex;align-items:center;gap:6px">
                <div id="headerBalCrypto"
                    style="display:flex;align-items:center;gap:4px;padding:6px 10px;border-radius:10px;cursor:pointer;transition:all .2s"
                    class="bal-active">
                    <span style="font-size:14px">ðŸ’µ</span>
                    <span id="headerBal" style="font-weight:800;font-size:14px;letter-spacing:-0.5px"></span>
                </div>
            </div>
            <button class="header-plus-btn" onclick="nav('wallet')" title="Deposit">+</button>
            <div class="header-notif" onclick="openNotifPopup()"><span
                    class="material-symbols-outlined">notifications</span>
                <div class="dot" id="notifDot" style="display:none"></div>
            </div>
        </div>
    </div>

    <!-- New Wallet Modal (JetTon Style) -->
    <div id="walletModal"
        style="display:none;position:fixed;inset:0;z-index:200;background:#0F1014;flex-direction:column;overflow:hidden">
        <!-- Modal Header -->
        <div
            style="display:flex;align-items:center;justify-content:space-between;padding:16px;border-bottom:1px solid rgba(255,255,255,0.05)">
            <button onclick="AppState.update({ui:{walletOpen:false}})"
                style="width:40px;height:40px;display:flex;align-items:center;justify-content:center;border-radius:12px;background:rgba(255,255,255,0.05);color:#9ca3af;border:none;cursor:pointer">
                <span class="material-symbols-outlined">close</span>
            </button>
            <h2 style="font-family:Montserrat,sans-serif;font-weight:900;font-size:18px;letter-spacing:-0.5px;margin:0">
                CASHIER</h2>
            <div style="width:40px"></div>
        </div>

        <!-- Tab Navigation -->
        <div style="display:flex;padding:4px;margin:16px;background:rgba(255,255,255,0.05);border-radius:16px">
            <button onclick="AppState.update({ui:{activeTab:'deposit'}})" id="tabDeposit"
                style="flex:1;padding:12px;border:none;border-radius:12px;font-family:Montserrat,sans-serif;font-weight:800;font-size:13px;cursor:pointer;transition:all 0.2s;background:var(--red);color:white">DEPOSIT</button>
            <button onclick="AppState.update({ui:{activeTab:'withdraw'}})" id="tabWithdraw"
                style="flex:1;padding:12px;border:none;border-radius:12px;font-family:Montserrat,sans-serif;font-weight:800;font-size:13px;cursor:pointer;transition:all 0.2s;background:transparent;color:#6b7280">WITHDRAW</button>
        </div>

        <!-- Content Area -->
        <div id="walletContent" style="flex:1;overflow-y:auto;padding:0 16px 40px">
            <!-- Dynamic Content -->
        </div>
    </div>

    <!-- Notifications Popup -->
    <div id="notifPopup" style="display:none;position:fixed;top:0;left:0;right:0;bottom:0;z-index:200">
        <div id="notifPopupBg" style="position:absolute;inset:0;background:rgba(0,0,0,.5);backdrop-filter:blur(4px)"
            onclick="closeNotifPopup()"></div>
        <div id="notifPopupCard"
            style="position:absolute;top:var(--header-h);right:12px;width:300px;max-height:400px;overflow-y:auto;background:var(--surface);border:1px solid var(--border);border-radius:var(--radius-xl);padding:16px;box-shadow:0 16px 48px rgba(0,0,0,.6);transform:translateY(-8px) scale(.95);opacity:0;transition:all .2s cubic-bezier(.34,1.56,.64,1)">
            <div
                style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;border-bottom:1px solid var(--border);padding-bottom:12px">
                <div style="font-family:'Montserrat',sans-serif;font-weight:800;font-size:16px">Notifications</div>
                <button onclick="readAllNotifs()"
                    style="font-size:11px;color:var(--red);background:rgba(227,30,36,.1);padding:4px 8px;border-radius:12px;font-weight:700">Mark
                    all read</button>
            </div>
            <div id="notifList" style="display:flex;flex-direction:column;gap:12px">
                <!-- Data goes here -->
            </div>
        </div>
    </div>

    <!-- Balance / Currency Popup -->
    <div id="balPopup" style="display:none;position:fixed;top:0;left:0;right:0;bottom:0;z-index:200">
        <div id="balPopupBg" style="position:absolute;inset:0;background:rgba(0,0,0,.5);backdrop-filter:blur(4px)"
            onclick="closeBalancePopup()"></div>
        <div id="balPopupCard"
            style="position:absolute;top:var(--header-h);right:12px;width:300px;background:var(--surface);border:1px solid var(--border);border-radius:var(--radius-xl);padding:16px;box-shadow:0 16px 48px rgba(0,0,0,.6);transform:translateY(-8px) scale(.95);opacity:0;transition:all .2s cubic-bezier(.34,1.56,.64,1)">

            <!-- Both balances side by side -->
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:14px">
                <div onclick="switchActiveWallet('usdt');closeBalancePopup()"
                    style="padding:12px;background:rgba(34,197,94,.05);border:1.5px solid rgba(34,197,94,.2);border-radius:var(--radius);cursor:pointer;text-align:center;transition:all .15s"
                    id="bpUsdtCard">
                    <div style="font-size:20px;margin-bottom:4px">ðŸ’µ</div>
                    <div
                        style="font-size:9px;font-weight:800;text-transform:uppercase;letter-spacing:1px;color:var(--dim);margin-bottom:2px">
                        CRYPTO</div>
                    <div style="font-family:'Montserrat',sans-serif;font-size:18px;font-weight:900;color:#fff"
                        id="bpUsdtVal">$0.00</div>
                </div>
                <div onclick="switchActiveWallet('stars');closeBalancePopup()"
                    style="padding:12px;background:rgba(255,215,0,.03);border:1.5px solid rgba(255,215,0,.15);border-radius:var(--radius);cursor:pointer;text-align:center;transition:all .15s"
                    id="bpStarsCard">
                    <div style="font-size:20px;margin-bottom:4px">â­</div>
                    <div
                        style="font-size:9px;font-weight:800;text-transform:uppercase;letter-spacing:1px;color:var(--dim);margin-bottom:2px">
                        STARS</div>
                    <div style="font-family:'Montserrat',sans-serif;font-size:18px;font-weight:900;color:#FFD700"
                        id="bpStarsVal">0</div>
                </div>
            </div>

            <!-- Crypto Bonus badge -->
            <div
                style="display:flex;align-items:center;gap:8px;padding:8px 12px;background:rgba(34,197,94,.06);border:1px solid rgba(34,197,94,.15);border-radius:var(--radius);margin-bottom:12px">
                <span style="font-size:16px">ðŸ”¥</span>
                <div style="flex:1">
                    <div style="font-size:11px;font-weight:700;color:var(--green)">+7% Crypto Bonus</div>
                    <div style="font-size:9px;color:var(--dim)">On every CryptoBot deposit</div>
                </div>
                <div
                    style="font-size:9px;font-weight:800;color:var(--dim);background:var(--surface2);padding:2px 6px;border-radius:4px">
                    x3 WAGER</div>
            </div>

            <!-- Currency selector (USDT mode) -->
            <div id="bpCurrencies" style="display:grid;grid-template-columns:repeat(3,1fr);gap:6px;margin-bottom:12px">
                <button class="pill" data-cur="USD" onclick="setCurrencyPopup('USD')"
                    style="justify-content:center;height:30px;font-size:10px">$ USD</button>
                <button class="pill" data-cur="EUR" onclick="setCurrencyPopup('EUR')"
                    style="justify-content:center;height:30px;font-size:10px">â‚¬ EUR</button>
                <button class="pill" data-cur="UAH" onclick="setCurrencyPopup('UAH')"
                    style="justify-content:center;height:30px;font-size:10px">â‚´ UAH</button>
            </div>

            <!-- Quick actions -->
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
                <button class="btn-primary" onclick="closeBalancePopup();nav('wallet')"
                    style="height:38px;font-size:11px;border-radius:10px">
                    <span class="material-symbols-outlined" style="font-size:14px">arrow_downward</span> DEPOSIT
                </button>
                <button class="btn-outline"
                    onclick="closeBalancePopup();nav('wallet');setTimeout(function(){switchCashierTab('withdraw')},100)"
                    style="height:38px;font-size:11px;border-radius:10px;color:var(--dim)">
                    <span class="material-symbols-outlined" style="font-size:14px">arrow_upward</span> WITHDRAW
                </button>
            </div>

        </div>
    </div>

    <!-- PROVIDERS BOTTOM SHEET -->
    <div class="providers-sheet-overlay" id="providersSheetOverlay" onclick="closeProvidersSheet(event)">
        <div class="providers-sheet" onclick="event.stopPropagation()">
            <div class="providers-sheet-handle"></div>
            <div class="providers-sheet-title">PROVIDERS</div>
            <div class="providers-sheet-grid" id="providersSheetGrid"></div>
        </div>
    </div>

    <!-- ===== SEARCH OVERLAY ===== -->
    <div class="search-overlay" id="searchOverlay">
        <div class="search-header">
            <button onclick="closeSearch()"
                style="background:none;border:none;color:var(--dim);cursor:pointer;padding:4px"><span
                    class="material-symbols-outlined">arrow_back</span></button>
            <input type="text" class="search-input" id="searchInput" placeholder="Search games..."
                oninput="onSearchInput(this.value)">
            <button onclick="closeSearch(); document.getElementById('searchInput').value=''; onSearchInput('');"
                style="background:none;border:none;color:var(--dim);cursor:pointer;padding:4px"><span
                    class="material-symbols-outlined">close</span></button>
        </div>
        <div class="search-results" id="searchResults">
            <div class="search-empty"><span class="material-symbols-outlined"
                    style="font-size:48px;display:block;margin-bottom:8px">search</span>Type to search games</div>
        </div>
    </div>

    <!-- ===== SCREEN: LOBBY ===== -->
    <div class="screen active" id="scrLobby">

        <!-- HERO CAROUSEL -->
        <div class="hero-carousel"
            style="position:relative;overflow:hidden;border-radius:var(--radius-xl);margin:0 16px 12px;border:1px solid rgba(255,255,255,0.05)">
            <div class="hero-track" id="heroTrack"
                style="display:flex;transition:transform .5s cubic-bezier(.4,0,.2,1);">
            </div>
            <!-- Dots -->
            <div id="heroDots"
                style="position:absolute;bottom:10px;left:50%;transform:translateX(-50%);display:flex;gap:6px;z-index:5">
            </div>
        </div>

        <div class="wheel-banner" id="wheelBanner" onclick="openWheel()"
            style="display:none;align-items:center;justify-content:space-between">
            <div style="display:flex;align-items:center;gap:12px">
                <div class="wheel-icon">ðŸŽ¡</div>
                <div class="wheel-info">
                    <h3
                        style="font-family:'Montserrat',sans-serif;font-size:14px;font-weight:800;text-transform:uppercase;letter-spacing:.5px;margin:0">
                        DAILY BONUS WHEEL</h3>
                    <p id="wheelSub" style="font-size:11px;color:var(--dim);margin:2px 0 0">Spin for free every 24h</p>
                </div>
            </div>
            <div id="wheelSpinBtn"
                style="background:var(--red);color:#fff;padding:8px 16px;border-radius:20px;font-family:'Montserrat',sans-serif;font-size:12px;font-weight:800;text-transform:uppercase;letter-spacing:1px;box-shadow:0 2px 8px rgba(227,30,36,.4);cursor:pointer">
                SPIN</div>
            <div id="wheelLockTimer"
                style="display:none;font-family:monospace;font-size:16px;font-weight:700;color:var(--dim2);background:rgba(255,255,255,0.05);padding:6px 12px;border-radius:12px;border:1px solid rgba(255,255,255,0.05)">
                00:00:00</div>
        </div>

        <!-- Live Drops Ticker (Phase 3 Redesign) -->
        <div class="px-5 py-4 flex items-center gap-2 mb-2">
            <div class="w-2 h-2 rounded-full bg-[#E91E3F] animate-pulse shadow-[0_0_8px_#E91E3F]"></div>
            <h1 class="font-bold text-[12px] tracking-widest uppercase text-gray-400">LIVE DROPS</h1>
        </div>
        <div class="live-drops-scroll no-scrollbar px-4 mb-6" id="liveDropsScroll"
            style="display: flex; flex-direction: row; gap: 10px; overflow-x: auto; -webkit-overflow-scrolling: touch;">
            <!-- Rendered by JS -->
        </div>

        <!-- JETTON-STYLE: Search button + Category pills row -->
        <div class="jt-filter-row" id="jtFilterRow">
            <div class="jt-search-btn" onclick="openSearch()">
                <span class="material-symbols-outlined">search</span>
            </div>
            <!-- Pills rendered by buildCategories() into #catRow (hidden), mirrored here via JS -->
            <div class="jt-cat-pill active" data-cat="all" onclick="jtSelectCat('all',this)">
                <span class="material-symbols-outlined">apps</span> All Games
            </div>
            <div class="jt-cat-pill" data-cat="slots" onclick="jtSelectCat('slots',this)">
                <span class="material-symbols-outlined">casino</span> Slots
            </div>
            <div class="jt-cat-pill" data-cat="live" onclick="jtSelectCat('live',this)">
                <span class="material-symbols-outlined">live_tv</span> Live
            </div>
            <div class="jt-cat-pill" data-cat="crash" onclick="jtSelectCat('crash',this)">
                <span class="material-symbols-outlined">rocket_launch</span> Crash
            </div>
            <div class="jt-cat-pill" data-cat="table" onclick="jtSelectCat('table',this)">
                <span class="material-symbols-outlined">table_restaurant</span> Table
            </div>
            <div class="jt-cat-pill" onclick="openProvidersSheet()">
                <span class="material-symbols-outlined">sports_esports</span> Providers
            </div>
        </div>

        <!-- TOP WINNINGS LEADERBOARD -->
        <div class="section">
            <div class="section-head">
                <div class="section-title"><span class="material-symbols-outlined"
                        style="color:#FFD700;font-size:16px;margin-right:4px">emoji_events</span><span
                        id="secTopWins">TOP WINNINGS</span></div>
            </div>
            <div class="top-wins-section">
                <div class="top-wins-tabs">
                    <div class="tw-tab active" onclick="switchTopWins('day',this)" id="twDay">Day</div>
                    <div class="tw-tab" onclick="switchTopWins('week',this)" id="twWeek">Week</div>
                    <div class="tw-tab" onclick="switchTopWins('month',this)" id="twMonth">Month</div>
                    <div class="tw-tab" onclick="switchTopWins('all',this)" id="twAll">All Time</div>
                </div>
                <div id="topWinsList"></div>
            </div>
        </div>

        <!-- Hidden catRow for JS compatibility (buildCategories still populates it) -->
        <div style="display:none"><div class="cat-row" id="catRow"></div></div>

        <!-- GAME PROVIDERS (hidden inline, shown via popup) -->
        <div style="display:none"><div class="providers-row" id="providersRow"></div></div>

        <div class="section" style="margin-bottom:0">
            <div class="section-head">
                <div class="section-title"><span class="material-symbols-outlined"
                        style="color:var(--red);font-size:16px;margin-right:4px">local_fire_department</span><span
                        id="secTrend">TRENDING NOW</span></div>
            </div>
            <div id="gameGrid" class="grid grid-cols-2 gap-[12px] px-[16px] mb-[20px]"></div>
        </div>

        <div style="height:20px"></div>
    </div>

    <!-- ===== SCREEN: CRASH ===== -->
    <div class="screen" id="scrCrash">
        <div class="game-header">
            <div class="game-back" onclick="nav('lobby')"><span class="material-symbols-outlined">arrow_back</span>
            </div>
            <div class="game-title-bar" style="display:flex;align-items:center;gap:6px">CRASH <span class="badge"
                    style="background:rgba(227,30,36,0.1);color:var(--red);border:1px solid var(--red);font-size:9px;padding:2px 6px">PROVABLY
                    FAIR</span></div>
            <div class="game-bal"><span class="material-symbols-outlined">toll</span><span id="crashBal">0.00</span>
            </div>
        </div>

        <div class="crash-history" id="crashHistory">
            <div class="ch-pill low">1.00x</div>
            <div class="ch-pill high">2.45x</div>
            <div class="ch-pill high">10.20x</div>
            <div class="ch-pill low">1.12x</div>
        </div>

        <div class="crash-graph-container">
            <canvas class="crash-canvas" id="crashCanvas"></canvas>
            <div class="crash-value-display">
                <div class="crash-mult" id="crashMult">1.00x</div>
                <div class="crash-profit" id="crashProfit">Profit: +0.00 ðŸª™</div>
            </div>
        </div>

        <div class="crash-controls">
            <div class="crash-bet-inputs">
                <div class="cb-box">
                    <div class="cb-label">BET AMOUNT</div>
                    <div class="cb-input-row">
                        <input type="number" class="cb-input" id="crashBetAmount" value="10.00" step="0.5">
                        <button class="cb-btn"
                            onclick="document.getElementById('crashBetAmount').value=(parseFloat(document.getElementById('crashBetAmount').value)/2).toFixed(2)">1/2</button>
                        <button class="cb-btn"
                            onclick="document.getElementById('crashBetAmount').value=(parseFloat(document.getElementById('crashBetAmount').value)*2).toFixed(2)">2x</button>
                    </div>
                </div>
                <div class="cb-box">
                    <div class="cb-label">AUTO CASHOUT</div>
                    <div class="cb-input-row">
                        <input type="number" class="cb-input" id="crashAutoCashout" value="2.00" step="0.1">
                        <div style="font-family:'Montserrat',sans-serif;font-weight:800;color:var(--dim)">X</div>
                    </div>
                </div>
            </div>

            <button class="crash-action-btn bet" id="crashBtn" onclick="crashAction()">
                BET<br><span class="crash-action-sub">Next Round</span>
            </button>
        </div>
    </div>

    <!-- ===== SCREEN: GAME (Ruby Slots) ===== -->
    <div class="screen" id="scrGame">
        <div class="w-full h-full bg-[#0D0D0D] relative flex flex-col overflow-hidden" style="min-height: 100vh;">

            <div
                class="absolute top-[-20%] left-[-20%] w-[140%] h-[60%] bg-[#C0142A] blur-[120px] opacity-20 pointer-events-none rounded-full">
            </div>
            <div
                class="absolute bottom-[-10%] right-[-10%] w-[100%] h-[40%] bg-[#FFD700] blur-[100px] opacity-10 pointer-events-none rounded-full">
            </div>


            <div class="px-5 py-4 flex items-center justify-between z-30 relative pt-8 md:pt-6">
                <button
                    class="text-gray-400 hover:text-white transition-colors w-10 h-10 flex items-center justify-center rounded-full glass-btn"
                    onclick="nav('lobby')">
                    <span class="material-symbols-outlined text-xl">arrow_back</span>
                </button>

                <div class="flex flex-col items-center">
                    <h1 class="font-black text-lg tracking-wider text-white drop-shadow-[0_2px_4px_rgba(0,0,0,0.8)]">
                        SWEET RUBIES</h1>
                    <div class="flex items-center gap-1">
                        <span class="w-1.5 h-1.5 rounded-full bg-[#FFD700] animate-pulse"></span>
                        <span class="text-[10px] text-gray-400 font-bold tracking-widest uppercase">RubyBet
                            Exclusive</span>
                    </div>
                </div>

                <div class="glass-btn px-3 py-1.5 rounded-full flex items-center gap-2 border border-[#333]">
                    <div
                        class="w-4 h-4 rounded-full bg-gradient-to-br from-[#FFD700] to-[#B38F00] flex items-center justify-center shadow-[0_0_8px_#FFD700]">
                        <span class="material-symbols-outlined" style="font-size: 10px; color: #5c4a00;">star</span>
                    </div>
                    <span id="gameBal" class="font-bold text-sm text-[#FFD700] tabular-nums tracking-wide">0.00</span>
                </div>
            </div>


            <div class="flex-1 overflow-y-auto no-scrollbar relative flex flex-col z-10">

                <div class="px-4 pt-4 pb-2 space-y-3">
                    <div class="flex items-center justify-between gap-3">

                        <button
                            class="flex flex-col items-center justify-center bg-gradient-to-b from-[#2a0a10] to-[#1a0508] border border-[#C0142A] rounded-xl px-3 py-2 shadow-[0_0_15px_rgba(192,20,42,0.3)] active:scale-95 transition-all w-28 group relative overflow-hidden"
                            onclick="buyBonus()">
                            <div
                                class="absolute inset-0 bg-gradient-to-r from-transparent via-white/10 to-transparent translate-x-[-100%] group-hover:translate-x-[100%] transition-transform duration-700">
                            </div>
                            <span class="text-[9px] text-gray-300 font-bold uppercase tracking-wide">Buy Feature</span>
                            <div class="text-[#FFD700] font-black text-sm group-hover:scale-105 transition-transform drop-shadow-md"
                                id="bbPrice">100.00</div>
                        </button>


                        <div
                            class="flex-1 flex items-center justify-between glass-panel rounded-xl px-4 py-2 border border-white/5">
                            <div class="flex flex-col leading-tight">
                                <span class="text-[10px] font-bold text-gray-400 uppercase tracking-wide">Double</span>
                                <span
                                    class="text-[10px] font-extrabold text-white uppercase tracking-wider">Chance</span>
                            </div>
                            <label class="relative inline-flex items-center cursor-pointer group">
                                <input type="checkbox" class="sr-only peer" id="doubleChanceToggle"
                                    onchange="toggleDoubleChance()">
                                <div
                                    class="w-10 h-6 bg-[#1a1a1a] peer-focus:outline-none rounded-full peer shadow-inner border border-gray-700 peer-checked:bg-gradient-to-r peer-checked:from-[#FFD700] peer-checked:to-[#FDB931] transition-all">
                                </div>
                                <div
                                    class="absolute left-[2px] top-[2px] bg-white w-5 h-5 rounded-full shadow-md transition-all peer-checked:translate-x-full peer-checked:border-0 border border-gray-300">
                                </div>
                            </label>
                        </div>
                    </div>
                </div>


                <div class="flex-1 px-4 flex flex-col justify-center pb-2 relative z-10 min-h-[400px]">
                    <div class="absolute top-[-10px] left-1/2 -translate-x-1/2 z-20 opacity-0 transition-all duration-300 pointer-events-none scale-0"
                        id="tumble-badge">
                        <span
                            class="bg-gradient-to-r from-[#C0142A] to-[#E91E3F] text-white text-[11px] font-black px-4 py-1 rounded-full shadow-lg uppercase tracking-wider border border-white/20 ring-4 ring-black/50">
                            Tumble Win
                        </span>
                    </div>

                    <div class="slot-frame">
                        <div id="slot-grid"
                            class="w-full aspect-[6/5] bg-[#050505] rounded-xl p-1.5 grid grid-cols-6 grid-rows-5 gap-1.5 relative overflow-hidden">
                        </div>
                    </div>
                </div>
            </div>


            <div
                class="bg-[#0A0A0A] border-t border-white/5 pt-2 pb-24 relative z-20 flex flex-col items-center shadow-[0_-10px_30px_rgba(0,0,0,0.8)]">

                <div
                    class="w-[92%] glass-panel rounded-2xl p-2.5 flex justify-between items-center mb-5 relative group overflow-hidden">
                    <div class="flex flex-col px-2">
                        <span class="text-[9px] text-gray-500 font-bold uppercase tracking-[0.2em] mb-0.5">Win</span>
                        <span id="win-display"
                            class="text-2xl font-black text-[#FFD700] tabular-nums drop-shadow-[0_0_8px_rgba(255,215,0,0.3)]">0.00</span>
                    </div>

                    <div class="flex items-center gap-3 bg-[#000] p-1.5 rounded-xl border border-white/10 shadow-inner">
                        <button onclick="changeBet(-1)"
                            class="w-8 h-8 rounded-lg bg-[#1a1a1a] flex items-center justify-center text-white hover:bg-[#C0142A] active:scale-90 transition-colors">
                            <span class="material-symbols-outlined" style="font-size: 16px;">remove</span>
                        </button>
                        <div class="flex flex-col items-center min-w-[50px]">
                            <span class="text-[8px] text-gray-500 font-bold uppercase">Bet</span>
                            <span id="betDisplay" class="text-sm font-bold text-white tabular-nums">1.00</span>
                        </div>
                        <button onclick="changeBet(1)"
                            class="w-8 h-8 rounded-lg bg-[#1a1a1a] flex items-center justify-center text-white hover:bg-[#C0142A] active:scale-90 transition-colors">
                            <span class="material-symbols-outlined" style="font-size: 16px;">add</span>
                        </button>
                    </div>
                </div>


                <div class="w-full px-8 flex items-center justify-between gap-6">
                    <button
                        class="flex flex-col items-center gap-2 group active:scale-95 transition-transform opacity-80 hover:opacity-100"
                        onclick="openAutoModal()">
                        <div
                            class="w-12 h-12 rounded-full glass-btn flex items-center justify-center group-hover:border-white/30 transition-colors">
                            <span class="material-symbols-outlined text-gray-400 group-hover:text-white"
                                style="font-size: 24px;">cached</span>
                        </div>
                        <span class="text-[9px] font-bold text-gray-500 uppercase tracking-wide">Auto</span>
                    </button>

                    <button onclick="doSpin()" id="spinBtn"
                        class="relative w-[90px] h-[90px] rounded-full flex items-center justify-center hover:scale-105 active:scale-95 transition-all z-10 group cursor-pointer select-none -mt-4">
                        <div class="absolute inset-0 rounded-full spin-btn-outer"></div>
                        <div
                            class="absolute inset-[-4px] spin-ring opacity-0 group-hover:opacity-100 transition-opacity duration-500">
                        </div>
                        <div class="absolute inset-2 rounded-full spin-btn-inner flex items-center justify-center">
                            <svg width="40" height="40" viewBox="0 0 24 24" fill="none"
                                class="drop-shadow-[0_2px_4px_rgba(0,0,0,0.4)] group-hover:animate-pulse">
                                <path d="M13 2L3 14H12L11 22L21 10H12L13 2Z" fill="white" stroke="#ffcccc"
                                    stroke-width="0.5" stroke-linejoin="round"></path>
                            </svg>
                        </div>
                    </button>

                    <button
                        class="flex flex-col items-center gap-2 group active:scale-95 transition-transform opacity-80 hover:opacity-100"
                        onclick="toggleAutoSpeed()">
                        <div
                            class="w-12 h-12 rounded-full glass-btn flex items-center justify-center group-hover:border-white/30 transition-colors">
                            <span class="material-symbols-outlined text-gray-400" id="turboIcon"
                                style="font-size: 24px;">bolt</span>
                        </div>
                        <span class="text-[9px] font-bold text-gray-500 uppercase tracking-wide"
                            id="autoLabel">Turbo</span>
                    </button>
                </div>
            </div>
        </div>
        <div
            class="fixed bottom-4 left-1/2 -translate-x-1/2 w-[90%] md:w-[360px] glass-panel rounded-2xl py-3 px-6 flex justify-between items-center z-50 shadow-2xl">
            <button onclick="nav('lobby')"
                class="flex flex-col items-center gap-1 text-gray-500 hover:text-white transition-colors">
                <span class="material-symbols-outlined" style="font-size: 24px;">home</span>
            </button>
            <button onclick="togglePaytable(true)"
                class="flex flex-col items-center gap-1 text-gray-500 hover:text-white transition-colors">
                <span class="material-symbols-outlined" style="font-size: 24px;">emoji_events</span>
            </button>
            <div class="w-px h-8 bg-white/10"></div>
            <button onclick="openWheel()" class="flex flex-col items-center gap-1 text-[#E91E3F] relative">
                <div class="absolute inset-0 bg-[#E91E3F] blur-lg opacity-20"></div>
                <span class="material-symbols-outlined"
                    style="font-size: 32px; filter: drop-shadow(0 0 5px rgba(233,30,63,0.8));">sports_esports</span>
            </button>
            <div class="w-px h-8 bg-white/10"></div>
            <button onclick="nav('wallet')"
                class="flex flex-col items-center gap-1 text-gray-500 hover:text-white transition-colors">
                <span class="material-symbols-outlined" style="font-size: 24px;">account_balance_wallet</span>
            </button>
            <button onclick="nav('profile')"
                class="flex flex-col items-center gap-1 text-gray-500 hover:text-white transition-colors">
                <span class="material-symbols-outlined" style="font-size: 24px;">person</span>
            </button>
        </div>

        <!-- === PAYTABLE MODAL === -->
        <div id="paytable-modal" class="absolute inset-0 z-50 flex flex-col justify-end"
            style="opacity:0; pointer-events:none; transition:opacity 0.3s ease;">
            <div class="modal-overlay absolute inset-0" onclick="togglePaytable(false)"></div>
            <div class="modal-content w-full rounded-t-[32px] p-6 pb-12 relative z-10 flex flex-col max-h-[85vh]">
                <div class="w-12 h-1 bg-white/10 rounded-full mx-auto mb-6" onclick="togglePaytable(false)"></div>
                <div class="info-header px-1 py-4 flex items-center justify-between z-30 relative rounded-2xl mb-4">
                    <div class="flex flex-col">
                        <h1 class="font-black text-xl tracking-wider text-white">PAYTABLE</h1>
                        <div class="flex items-center gap-1">
                            <span class="w-1.5 h-1.5 rounded-full bg-[#C0142A]"></span>
                            <span class="text-[10px] text-gray-400 font-bold uppercase tracking-widest">Symbol
                                Values</span>
                        </div>
                    </div>
                    <button
                        class="w-10 h-10 flex items-center justify-center rounded-full glass-btn text-gray-400 hover:text-white transition-colors"
                        onclick="togglePaytable(false)">
                        <span class="material-symbols-outlined text-xl">close</span>
                    </button>
                </div>
                <!-- Card grids from paytable.html -->
                <div class="flex-1 overflow-y-auto no-scrollbar pb-10 space-y-4">
                    <div class="grid grid-cols-2 gap-4">
                        <!-- Lolly -->
                        <div class="symbol-card lolly-glow p-4 flex flex-col items-center">
                            <div class="mb-3">
                                <svg viewBox="0 0 64 64" width="48" height="48">
                                    <circle cx="32" cy="24" r="18" fill="url(#lollyGrad)" stroke="white"
                                        stroke-width="2"></circle>
                                    <path d="M32 42 L32 60" stroke="#eee" stroke-width="4" stroke-linecap="round">
                                    </path>
                                    <path d="M32 24 m-12 0 a 12 12 0 1 0 24 0 a 12 12 0 1 0 -24 0" fill="none"
                                        stroke="white" stroke-width="2" stroke-dasharray="4 4" opacity="0.5"></path>
                                </svg>
                            </div>
                            <span class="text-[10px] font-black text-white/40 uppercase mb-2">Lollipop</span>
                            <div class="multiplier-grid grid grid-cols-2 w-full text-[11px] gap-y-1">
                                <div>12+</div>
                                <div>x50</div>
                                <div>10-11</div>
                                <div>x25</div>
                                <div>8-9</div>
                                <div>x10</div>
                            </div>
                        </div>

                        <!-- Star -->
                        <div class="symbol-card star-glow p-4 flex flex-col items-center">
                            <div class="mb-3">
                                <svg viewBox="0 0 64 64" width="48" height="48">
                                    <path d="M32 4 L40 22 L60 22 L44 34 L50 54 L32 42 L14 54 L20 34 L4 22 L24 22 Z"
                                        fill="url(#goldGrad)" stroke="#B38F00" stroke-width="1"></path>
                                </svg>
                            </div>
                            <span class="text-[10px] font-black text-white/40 uppercase mb-2">Gold Star</span>
                            <div class="multiplier-grid grid grid-cols-2 w-full text-[11px] gap-y-1">
                                <div>12+</div>
                                <div>x25</div>
                                <div>10-11</div>
                                <div>x10</div>
                                <div>8-9</div>
                                <div>x2.5</div>
                            </div>
                        </div>

                        <!-- Heart -->
                        <div class="symbol-card heart-glow p-4 flex flex-col items-center">
                            <div class="mb-3">
                                <svg viewBox="0 0 64 64" width="48" height="48">
                                    <path
                                        d="M32 56 C 10 40 4 28 4 18 C 4 8 12 4 22 4 C 28 4 32 8 32 8 C 32 8 36 4 42 4 C 52 4 60 18 C 60 28 54 40 32 56 Z"
                                        fill="url(#heartGrad)" stroke="rgba(255,255,255,0.3)"></path>
                                </svg>
                            </div>
                            <span class="text-[10px] font-black text-white/40 uppercase mb-2">Heart Gem</span>
                            <div class="multiplier-grid grid grid-cols-2 w-full text-[11px] gap-y-1">
                                <div>12+</div>
                                <div>x15</div>
                                <div>10-11</div>
                                <div>x5</div>
                                <div>8-9</div>
                                <div>x1.5</div>
                            </div>
                        </div>

                        <!-- Ruby -->
                        <div class="symbol-card ruby-glow p-4 flex flex-col items-center">
                            <div class="mb-3">
                                <svg viewBox="0 0 64 64" width="48" height="48">
                                    <path d="M20 12 L44 12 L56 28 L32 58 L8 28 Z" fill="url(#rubyGrad)"
                                        stroke="rgba(255,255,255,0.3)" stroke-width="1"></path>
                                </svg>
                            </div>
                            <span class="text-[10px] font-black text-white/40 uppercase mb-2">Ruby Hex</span>
                            <div class="multiplier-grid grid grid-cols-2 w-full text-[11px] gap-y-1">
                                <div>12+</div>
                                <div>x12</div>
                                <div>10-11</div>
                                <div>x2</div>
                                <div>8-9</div>
                                <div>x1.2</div>
                            </div>
                        </div>

                        <!-- Diamond -->
                        <div class="symbol-card diamond-glow p-4 flex flex-col items-center">
                            <div class="mb-3">
                                <svg viewBox="0 0 64 64" width="48" height="48">
                                    <path d="M16 20 L48 20 L56 30 L32 54 L8 30 Z" fill="url(#diamondGrad)"
                                        stroke="rgba(255,255,255,0.5)" stroke-width="1"></path>
                                </svg>
                            </div>
                            <span class="text-[10px] font-black text-white/40 uppercase mb-2">Diamond</span>
                            <div class="multiplier-grid grid grid-cols-2 w-full text-[11px] gap-y-1">
                                <div>12+</div>
                                <div>x10</div>
                                <div>10-11</div>
                                <div>x1.5</div>
                                <div>8-9</div>
                                <div>x0.8</div>
                            </div>
                        </div>

                        <!-- Grapes -->
                        <div class="symbol-card grape-glow p-4 flex flex-col items-center">
                            <div class="mb-3">
                                <svg viewBox="0 0 64 64" width="48" height="48">
                                    <circle cx="32" cy="18" r="9" fill="url(#grapeGrad)"></circle>
                                    <circle cx="22" cy="30" r="9" fill="url(#grapeGrad)"></circle>
                                    <circle cx="42" cy="30" r="9" fill="url(#grapeGrad)"></circle>
                                    <circle cx="32" cy="42" r="9" fill="url(#grapeGrad)"></circle>
                                    <path d="M32 10 Q32 0 42 4" stroke="#8BC34A" stroke-width="3" fill="none"></path>
                                </svg>
                            </div>
                            <span class="text-[10px] font-black text-white/40 uppercase mb-2">Grapes</span>
                            <div class="multiplier-grid grid grid-cols-2 w-full text-[11px] gap-y-1">
                                <div>12+</div>
                                <div>x8</div>
                                <div>10-11</div>
                                <div>x1.2</div>
                                <div>8-9</div>
                                <div>x0.5</div>
                            </div>
                        </div>

                        <!-- Apple -->
                        <div class="symbol-card apple-glow p-4 flex flex-col items-center">
                            <div class="mb-3">
                                <svg viewBox="0 0 64 64" width="48" height="48">
                                    <path
                                        d="M32 56 C 20 56 10 46 10 32 C 10 18 20 14 26 14 C 32 16 32 16 38 14 C 44 14 54 18 54 32 C 54 46 44 56 32 56 Z"
                                        fill="url(#rubyGrad)"></path>
                                </svg>
                            </div>
                            <span class="text-[10px] font-black text-white/40 uppercase mb-2">Apple</span>
                            <div class="multiplier-grid grid grid-cols-2 w-full text-[11px] gap-y-1">
                                <div>12+</div>
                                <div>x5</div>
                                <div>10-11</div>
                                <div>x1</div>
                                <div>8-9</div>
                                <div>x0.4</div>
                            </div>
                        </div>

                        <!-- Peach -->
                        <div class="symbol-card peach-glow p-4 flex flex-col items-center">
                            <div class="mb-3">
                                <svg viewBox="0 0 64 64" width="48" height="48">
                                    <circle cx="32" cy="34" r="22" fill="url(#peachGrad)"></circle>
                                    <path d="M32 12 Q 36 2 44 6" fill="#43A047"></path>
                                </svg>
                            </div>
                            <span class="text-[10px] font-black text-white/40 uppercase mb-2">Peach</span>
                            <div class="multiplier-grid grid grid-cols-2 w-full text-[11px] gap-y-1">
                                <div>12+</div>
                                <div>x2</div>
                                <div>10-11</div>
                                <div>x0.8</div>
                                <div>8-9</div>
                                <div>x0.25</div>
                            </div>
                        </div>
                    </div>

                    <div class="glass-panel p-5 rounded-2xl border-white/5 space-y-3 mt-4">
                        <h3 class="text-xs font-black text-[#FFD700] uppercase tracking-widest">Game Rules</h3>
                        <p class="text-[11px] text-gray-400 leading-relaxed">
                            Symbols pay anywhere on the screen. The total number of the same symbol on the screen at the
                            end of a spin determines the value of the win.
                        </p>
                        <div class="pt-2 border-t border-white/5 flex items-center justify-between">
                            <span class="text-[10px] text-gray-500 font-bold uppercase">RTP</span>
                            <span class="text-[10px] text-white font-black">96.51%</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- === AUTO-SPIN MODAL === -->
        <div id="autospin-modal" class="absolute inset-0 z-50 flex flex-col justify-end"
            style="opacity:0; pointer-events:none; transition:opacity 0.3s ease;">
            <div class="modal-overlay absolute inset-0" onclick="toggleAutoModal(false)"></div>
            <div class="modal-content w-full rounded-t-[32px] p-6 pb-12 relative z-10">
                <div class="w-12 h-1 bg-white/10 rounded-full mx-auto mb-6" onclick="toggleAutoModal(false)"></div>
                <div class="flex items-center justify-between mb-8">
                    <h2 class="text-xl font-black text-white tracking-tight">AUTO-SPIN SETTINGS</h2>
                    <span class="material-symbols-outlined text-2xl text-[#C0142A]">sync</span>
                </div>
                <!-- Numbers -->
                <div class="mb-8">
                    <p class="text-[10px] font-black text-gray-500 uppercase tracking-[0.2em] mb-4">Number of Spins</p>
                    <div class="grid grid-cols-5 gap-2" id="autoSpinsGrid">
                        <button class="option-chip py-3 rounded-xl text-sm font-bold"
                            onclick="selectAutoChip(this, 10)">10</button>
                        <button class="option-chip py-3 rounded-xl text-sm font-bold selected"
                            onclick="selectAutoChip(this, 25)">25</button>
                        <button class="option-chip py-3 rounded-xl text-sm font-bold"
                            onclick="selectAutoChip(this, 50)">50</button>
                        <button class="option-chip py-3 rounded-xl text-sm font-bold"
                            onclick="selectAutoChip(this, 100)">100</button>
                        <button class="option-chip py-3 rounded-xl text-xs font-black"
                            onclick="selectAutoChip(this, 9999)"><span
                                class="material-symbols-outlined text-lg">all_inclusive</span></button>
                    </div>
                </div>

                <!-- Start btn -->
                <button
                    class="w-full start-autospin-btn py-5 rounded-2xl text-lg font-black uppercase flex items-center justify-center gap-3 active:scale-[0.98] transition-all"
                    onclick="startAutoSpinFlow()">
                    START AUTO-SPIN
                    <span class="material-symbols-outlined text-xl">play_arrow</span>
                </button>
            </div>
        </div>

        <!-- === BIG WIN OVERLAY === -->
        <div id="big-win-overlay"
            style="display:none; position:absolute; inset:0; z-index:100; flex-direction:column; align-items:center; justify-content:center; overflow:hidden;"
            class="big-win-overlay border-gray-900 rounded-[20px]">
            <div class="light-ray" style="animation-delay: 0s;"></div>
            <div class="light-ray" style="animation-delay: -5s;"></div>

            <div id="confetti-box" class="absolute inset-0 pointer-events-none"></div>

            <div class="mt-20 z-10 flex flex-col items-center">
                <div class="flex items-center gap-2 mb-2">
                    <div class="w-12 h-px bg-gradient-to-r from-transparent to-[#FFD700]"></div>
                    <span class="text-[#FFD700] font-black tracking-[0.3em] text-xs uppercase">Incredible</span>
                    <div class="w-12 h-px bg-gradient-to-l from-transparent to-[#FFD700]"></div>
                </div>
                <h1 class="big-win-title">BIG WIN</h1>
            </div>

            <div class="mt-8 z-10 text-center amount-display">
                <div class="text-[14px] font-bold text-gray-400 uppercase tracking-widest mb-1">Total Payout</div>
                <div
                    class="text-6xl font-black text-white gold-glow drop-shadow-2xl flex items-baseline justify-center gap-1">
                    <span class="text-4xl text-[#FFD700]">ðŸª™</span>
                    <span id="win-counter-big">0.00</span>
                </div>
            </div>

            <div class="w-[85%] mt-12 z-10 flex flex-col gap-3">
                <div class="text-[10px] font-black text-gray-500 uppercase tracking-widest ml-1">Winning Combinations
                </div>
                <div id="combo-list-big" class="flex flex-col gap-2 overflow-y-auto max-h-[150px] no-scrollbar">
                </div>
            </div>

            <div class="mt-auto mb-16 w-full px-10 z-10 pb-6">
                <button
                    class="collect-btn w-full py-5 rounded-2xl flex items-center justify-center gap-3 group active:scale-95 transition-transform"
                    onclick="closeBigWin()">
                    <span class="text-white font-black text-xl tracking-wider uppercase">Collect</span>
                    <span
                        class="material-symbols-outlined text-2xl text-white group-hover:rotate-12 transition-transform">check_circle</span>
                </button>
            </div>
        </div>
    </div>

    <!-- ===== SCREEN: BONUSES ===== -->
    <div class="screen" id="scrBonuses">
        <div style="padding:16px 16px 8px">
            <h2 style="font-family:'Montserrat',sans-serif;font-size:22px;font-weight:900" id="bonusTitle">Bonuses</h2>
        </div>

        <!-- Bonus Tabs -->
        <div
            style="display:flex;margin:0 16px 16px;background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);overflow:hidden">
            <div class="tw-tab active" id="tabBonusAvailable" onclick="switchBonusTab('available')"
                style="flex:1;padding:10px 0;text-align:center;font-size:11px;font-weight:800;text-transform:uppercase;letter-spacing:.5px;color:var(--dim);cursor:pointer;transition:all .15s;border-right:1px solid var(--border)">
                Available</div>
            <div class="tw-tab" id="tabBonusMy" onclick="switchBonusTab('my')"
                style="flex:1;padding:10px 0;text-align:center;font-size:11px;font-weight:800;text-transform:uppercase;letter-spacing:.5px;color:var(--dim);cursor:pointer;transition:all .15s">
                My Bonuses</div>
        </div>

        <div id="bonusAvailableSection">
            <!-- Floating Fortune Wheel Button (Phase 3) -->
            <button onclick="openWheel()"
                class="fixed bottom-24 right-5 w-14 h-14 bg-gradient-to-tr from-[#C0142A] to-[#FF0033] rounded-full flex items-center justify-center shadow-[0_0_25px_rgba(233,30,63,0.5)] hover:scale-110 active:scale-95 transition-all z-40 group animate-pulse-ring">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"
                    class="w-8 h-8 text-white transition-transform group-hover:rotate-90">
                    <path fill-rule="evenodd"
                        d="M12 3.75a.75.75 0 0 1 .75.75v6.75h6.75a.75.75 0 0 1 0 1.5h-6.75v6.75a.75.75 0 0 1-1.5 0v-6.75H4.5a.75.75 0 0 1 0-1.5h6.75V4.5a.75.75 0 0 1 .75-.75Z"
                        clip-rule="evenodd" />
                </svg>
            </button>
            <!-- Featured Promotion Banner (Relocated from Wallet) -->
            <div class="relative w-full rounded-2xl bg-gradient-to-br from-[#1a1c22] to-black overflow-hidden border border-gray-800/50 mb-6 mx-auto max-w-[calc(100%-32px)]"
                id="bonusPromoTop">
                <div
                    class="absolute inset-0 opacity-30 bg-[url('https://images.unsplash.com/photo-1596838132731-3301c3fd4317?q=80&w=1000&auto=format&fit=crop')] bg-cover bg-center">
                </div>
                <div class="absolute inset-0 bg-gradient-to-r from-black via-black/90 to-transparent"></div>
                <div class="relative p-6 z-10">
                    <span
                        class="inline-block bg-[#e62e3d] text-white text-[10px] font-bold px-2 py-0.5 rounded mb-3 tracking-wider uppercase">OFFER
                        OF THE DAY</span>
                    <div class="mb-4">
                        <h2 class="text-2xl font-black italic text-white mb-0 leading-none">100% MATCH</h2>
                        <h2 class="text-2xl font-black italic text-[#e62e3d] leading-none uppercase">UP TO $500</h2>
                    </div>
                    <button
                        class="w-full bg-[#e62e3d] hover:bg-red-700 text-white font-bold py-3 rounded-lg text-xs transition-colors uppercase tracking-wider shadow-lg shadow-red-900/20"
                        onclick="selectPayMethod('crypto')">
                        Claim Bonus
                    </button>
                </div>
            </div>
            <div class="pill-row" id="bonusPills"></div>
            <div id="promoList" style="padding-bottom:100px;"></div>
        </div>

        <div id="bonusMySection" style="display:none;padding:0 16px 100px;">
            <!-- Active balance card -->
            <div
                style="display:flex;align-items:center;gap:12px;margin-bottom:16px;padding:16px;background:var(--surface);border:1px solid var(--border);border-radius:var(--radius-lg)">
                <div
                    style="width:40px;height:40px;border-radius:10px;background:rgba(227,30,36,.1);display:flex;align-items:center;justify-content:center">
                    <span class="material-symbols-outlined" style="color:var(--red)">redeem</span>
                </div>
                <div>
                    <div
                        style="font-size:10px;color:var(--dim);text-transform:uppercase;letter-spacing:1px;font-weight:600;margin-bottom:2px">
                        Bonus Balance</div>
                    <div style="font-family:'Montserrat',sans-serif;font-size:18px;font-weight:800;color:#fff"
                        id="bonusBalAmount">$0.00</div>
                </div>
            </div>

            <div id="activeBonusList" style="display:flex;flex-direction:column;gap:10px;margin-bottom:24px"></div>

            <!-- History section -->
            <h3
                style="font-family:'Montserrat',sans-serif;font-size:14px;font-weight:800;color:#fff;margin-bottom:12px">
                History</h3>
            <div id="bonusHistoryList" style="display:flex;flex-direction:column;gap:8px"></div>
        </div>
    </div>

    <!-- ===== SCREEN: WALLET (CASHIER) - PHASE 3 REDESIGN ===== -->
    <div class="screen" id="scrWallet" style="padding-bottom: 0;">
        <div class="flex flex-col h-full bg-[#0d0f12] overflow-hidden">
            <!-- Redesigned Wallet Header (Unified with design-84c234ff) -->
            <div
                class="px-5 py-4 flex items-center justify-between sticky top-0 bg-[#0d0f12] z-20 border-b border-gray-800/50">
                <button class="text-gray-400 hover:text-white transition" onclick="nav('lobby')">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2"
                        stroke="currentColor" class="w-6 h-6">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M10.5 19.5L3 12m0 0l7.5-7.5M3 12h18">
                        </path>
                    </svg>
                </button>
                <h1 class="text-lg font-bold tracking-wide uppercase">CASHIER</h1>
                <div class="relative cursor-pointer" onclick="openSearch()">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"
                        class="w-6 h-6 text-gray-300 hover:text-white transition">
                        <path fill-rule="evenodd"
                            d="M5.25 9a6.75 6.75 0 0113.5 0v.75c0 2.123.8 4.057 2.118 5.52a.75.75 0 01-.297 1.206c-1.544.57-3.16.99-4.831 1.243a3.75 3.75 0 11-7.48 0 24.585 24.585 0 01-4.831-1.244.75.75 0 01-.298-1.205A8.217 8.217 0 005.25 9.75V9zm4.502 8.9a2.25 2.25 0 104.496 0 25.057 25.057 0 01-4.496 0z"
                            clip-rule="evenodd"></path>
                    </svg>
                    <span
                        class="absolute top-0 right-0 block h-2.5 w-2.5 rounded-full bg-red-600 ring-2 ring-[#0d0f12]"></span>
                </div>
            </div>

            <!-- Wallet Content -->
            <div class="flex-1 overflow-y-auto px-5 pb-24 hide-scrollbar">

                <!-- Unified Balance Display -->
                <div class="mb-6 mt-4">
                    <div
                        class="relative overflow-hidden p-5 rounded-2xl border border-gray-800 bg-gradient-to-br from-[#1a1c22] to-[#121418] flex items-center justify-between">
                        <div>
                            <div class="text-[10px] font-bold text-gray-500 uppercase tracking-widest mb-1">TOTAL
                                BALANCE</div>
                            <div class="text-2xl font-black text-white tracking-tight flex items-baseline gap-1"
                                id="wBalAmount">
                                0.00
                            </div>
                        </div>
                        <div class="text-4xl opacity-10 transform rotate-12">ðŸ’µ</div>
                    </div>
                </div>

                <div id="cashDeposit">
                    <!-- Payment Methods Section -->
                    <h3 class="text-[9px] font-bold text-gray-500 uppercase tracking-[0.2em] mb-4">Payment Methods</h3>
                    <div class="space-y-3 mb-6">
                        <!-- CryptoBot -->
                        <div class="flex items-center justify-between bg-[#15171b] p-4 rounded-xl border-l-[3px] border-[#e62e3d] relative overflow-hidden group hover:bg-[#1a1c22] transition-colors cursor-pointer"
                            onclick="selectPayMethod('crypto')" id="pmCrypto">
                            <div class="flex items-center gap-4 z-10">
                                <div
                                    class="w-10 h-10 rounded-lg bg-red-900/10 flex items-center justify-center border border-red-500/10">
                                    <span class="text-xl">ðŸ’Ž</span>
                                </div>
                                <div>
                                    <h3 class="font-bold text-white text-sm tracking-wide">CRYPTOBOT</h3>
                                    <p class="text-gray-500 text-[10px]">USDT, BTC, TON Â· Min $1.00</p>
                                </div>
                            </div>
                            <div
                                class="bg-[#e62e3d]/10 text-[#e62e3d] text-[9px] font-bold px-2 py-1 rounded border border-[#e62e3d]/20 uppercase tracking-widest">
                                +7%</div>
                        </div>

                        <!-- Telegram Stars -->
                        <div class="flex items-center justify-between bg-[#15171b] p-4 rounded-xl border-l-[3px] border-yellow-600 relative overflow-hidden group hover:bg-[#1a1c22] transition-colors cursor-pointer"
                            onclick="selectPayMethod('stars')" id="pmStars">
                            <div class="flex items-center gap-4 z-10">
                                <div
                                    class="w-10 h-10 rounded-lg bg-yellow-900/10 flex items-center justify-center border border-yellow-500/10">
                                    <span class="text-xl">â­</span>
                                </div>
                                <div>
                                    <h3 class="font-bold text-white text-sm tracking-wide uppercase">Telegram Stars</h3>
                                    <p class="text-gray-500 text-[10px]">Instant Â· In-app payment</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Deposit Amount Input Sections -->
                    <div id="depositCryptoSection">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-[9px] font-bold text-gray-500 uppercase tracking-[0.2em]">Enter Amount</h3>
                            <div
                                class="bg-green-500/10 border border-green-500/20 text-green-500 text-[9px] font-bold px-2 py-0.5 rounded flex items-center gap-1 uppercase tracking-widest">
                                <span class="w-1.5 h-1.5 rounded-full bg-green-500 animate-pulse"></span> Network: TRC20
                            </div>
                        </div>
                        <div style="position:relative;margin-bottom:8px">
                            <input type="number" id="depAmtCrypto" placeholder="0.00" oninput="updateMainDepBtn()"
                                style="width:100%;background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.08);border-radius:16px;padding:16px;color:#fff;font-size:24px;font-weight:900;text-align:center;font-family:monospace;transition:all 0.3s"
                                onfocus="this.style.borderColor='rgba(227,30,36,0.5)';this.style.boxShadow='0 0 15px rgba(227,30,36,0.2)'"
                                onblur="this.style.borderColor='rgba(255,255,255,0.08)';this.style.boxShadow='none'">
                            <div
                                style="position:absolute;right:16px;top:50%;transform:translateY(-50%);font-weight:800;color:var(--dim2);background:rgba(255,255,255,0.05);padding:4px 8px;border-radius:8px;font-size:12px">
                                USDT</div>
                        </div>
                        <div class="flex justify-between text-[10px] text-gray-400 mb-4 px-1">
                            <span>Min limit: <span class="text-white font-bold">1.00 USDT</span></span>
                            <span>Est. Fee: <span class="text-green-400 font-bold">Free</span></span>
                        </div>
                        <div class="grid grid-cols-4 gap-2 mb-6">
                            <button
                                class="bg-[#15171b] hover:bg-[#1a1c22] border border-gray-800/50 hover:border-red-500/30 text-white font-bold py-2.5 rounded-xl text-sm transition-all"
                                onclick="document.getElementById('depAmtCrypto').value='10';updateMainDepBtn()">$10</button>
                            <button
                                class="bg-[#15171b] hover:bg-[#1a1c22] border border-gray-800/50 hover:border-red-500/30 text-white font-bold py-2.5 rounded-xl text-sm transition-all"
                                onclick="document.getElementById('depAmtCrypto').value='50';updateMainDepBtn()">$50</button>
                            <button
                                class="bg-[#15171b] hover:bg-[#1a1c22] border border-gray-800/50 hover:border-red-500/30 text-white font-bold py-2.5 rounded-xl text-sm transition-all"
                                onclick="document.getElementById('depAmtCrypto').value='100';updateMainDepBtn()">$100</button>
                            <button
                                class="bg-[#15171b] hover:bg-[#1a1c22] border border-gray-800/50 hover:border-red-500/30 text-white font-bold py-2.5 rounded-xl text-sm transition-all text-[#e62e3d] flex flex-col items-center justify-center leading-none"
                                onclick="document.getElementById('depAmtCrypto').value='500';updateMainDepBtn()">
                                <span>Max</span>
                                <span class="text-[8px] font-normal text-gray-500 mt-0.5">$500</span>
                            </button>
                        </div>
                    </div>

                    <div id="depositStarsSection" class="hidden">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-[9px] font-bold text-gray-500 uppercase tracking-[0.2em]">Enter Amount</h3>
                            <div
                                class="bg-blue-500/10 border border-blue-500/20 text-blue-400 text-[9px] font-bold px-2 py-0.5 rounded flex items-center gap-1 uppercase tracking-widest">
                                <span class="material-symbols-outlined text-[10px]">bolt</span> Instant
                            </div>
                        </div>
                        <div style="position:relative;margin-bottom:8px">
                            <input type="number" id="depAmtStars" placeholder="0" oninput="updateMainDepBtn()"
                                style="width:100%;background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.08);border-radius:16px;padding:16px;color:#fff;font-size:24px;font-weight:900;text-align:center;font-family:monospace;transition:all 0.3s"
                                onfocus="this.style.borderColor='rgba(59,130,246,0.5)';this.style.boxShadow='0 0 15px rgba(59,130,246,0.2)'"
                                onblur="this.style.borderColor='rgba(255,255,255,0.08)';this.style.boxShadow='none'">
                            <div
                                style="position:absolute;right:16px;top:50%;transform:translateY(-50%);font-weight:800;color:var(--dim2);background:rgba(255,255,255,0.05);padding:4px 8px;border-radius:8px;font-size:12px flex items-center gap-1">
                                â­ STARS</div>
                        </div>
                        <div class="flex justify-between text-[10px] text-gray-400 mb-4 px-1">
                            <span>Min limit: <span class="text-white font-bold">50 Stars</span></span>
                            <span>Est. Fee: <span class="text-green-400 font-bold">Free</span></span>
                        </div>
                        <div class="grid grid-cols-4 gap-2 mb-6">
                            <button
                                class="bg-[#15171b] hover:bg-[#1a1c22] border border-gray-800/50 hover:border-blue-500/30 text-white font-bold py-2.5 rounded-xl text-sm transition-all"
                                onclick="document.getElementById('depAmtStars').value='150';updateMainDepBtn()">150</button>
                            <button
                                class="bg-[#15171b] hover:bg-[#1a1c22] border border-gray-800/50 hover:border-blue-500/30 text-white font-bold py-2.5 rounded-xl text-sm transition-all"
                                onclick="document.getElementById('depAmtStars').value='500';updateMainDepBtn()">500</button>
                            <button
                                class="bg-[#15171b] hover:bg-[#1a1c22] border border-gray-800/50 hover:border-blue-500/30 text-white font-bold py-2.5 rounded-xl text-sm transition-all"
                                onclick="document.getElementById('depAmtStars').value='1000';updateMainDepBtn()">1000</button>
                            <button
                                class="bg-[#15171b] hover:bg-[#1a1c22] border border-gray-800/50 hover:border-blue-500/30 text-white font-bold py-2.5 rounded-xl text-sm transition-all text-blue-400 flex flex-col items-center justify-center leading-none"
                                onclick="document.getElementById('depAmtStars').value='5000';updateMainDepBtn()">
                                <span>Max</span>
                                <span class="text-[8px] font-normal text-gray-500 mt-0.5">5000</span>
                            </button>
                        </div>
                        <div id="depositSolanaSection" class="hidden">
                            <div class="flex justify-between items-center mb-4">
                                <h3 class="text-[9px] font-bold text-gray-500 uppercase tracking-[0.2em]">Solana Deposit
                                </h3>
                                <div id="solanaNetworkBadge"
                                    class="bg-purple-500/10 border border-purple-500/20 text-purple-400 text-[9px] font-bold px-2 py-0.5 rounded flex items-center gap-1 uppercase tracking-widest">
                                    <span class="w-1.5 h-1.5 rounded-full bg-purple-500 animate-pulse"></span>
                                    Mainnet-Beta
                                </div>
                            </div>
                            <div class="bg-[#1a1c22] border border-gray-800/50 rounded-2xl p-4 mb-4">
                                <div class="flex items-center justify-between mb-2">
                                    <span class="text-[10px] text-gray-500 uppercase font-bold tracking-wider">Wallet
                                        Status</span>
                                    <span id="solanaStatus"
                                        class="text-[10px] font-black uppercase tracking-tighter text-gray-600">Disconnected</span>
                                </div>
                                <div id="solanaAddressBlock" class="hidden">
                                    <div class="text-[9px] text-gray-600 uppercase font-bold mb-1" id="solanaAddrLabel">
                                        Your Address</div>
                                    <div id="solanaPubKey"
                                        class="text-[11px] text-white font-mono break-all bg-black/20 p-2 rounded-lg border border-white/5">
                                    </div>
                                </div>
                            </div>
                            <div style="position:relative;margin-bottom:8px">
                                <input type="number" id="depAmtSolana" placeholder="0.00" oninput="updateMainDepBtn()"
                                    style="width:100%;background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.08);border-radius:16px;padding:16px;color:#fff;font-size:24px;font-weight:900;text-align:center;font-family:monospace;transition:all 0.3s"
                                    onfocus="this.style.borderColor='#14f195';this.style.boxShadow='0 0 15px rgba(20,241,149,0.2)'"
                                    onblur="this.style.borderColor='rgba(255,255,255,0.08)';this.style.boxShadow='none'">
                                <div
                                    style="position:absolute;right:16px;top:50%;transform:translateY(-50%);font-weight:800;color:#14f195;background:rgba(20,241,149,0.05);padding:4px 8px;border-radius:8px;font-size:12px">
                                    SOL</div>
                            </div>
                            <div class="flex justify-between text-[10px] text-gray-400 mb-6 px-1">
                                <span>Min limit: <span class="text-white font-bold">0.05 SOL</span></span>
                                <span>Est. Fee: <span class="text-green-400 font-bold">~0.000005 SOL</span></span>
                            </div>
                        </div>
                    </div>

                    <!-- Deposit Action Button -->
                    <button id="mainDepositBtn"
                        class="w-full bg-[#1a1c22] text-gray-500 font-bold py-4 rounded-xl text-sm transition-all uppercase tracking-widest mb-8 cursor-not-allowed"
                        onclick="confirmDepositDirect()">
                        Enter Amount
                    </button>

                    <!-- Transaction History Link -->
                    <button
                        class="w-full flex items-center justify-between p-4 bg-[#15171b] border border-gray-800/50 rounded-xl hover:bg-[#1a1c22] transition mb-4"
                        onclick="switchCashierTab('history')">
                        <div class="flex items-center gap-3">
                            <span class="material-symbols-outlined text-gray-400">history</span>
                            <span class="text-xs font-bold text-white uppercase tracking-wider">Transaction
                                History</span>
                        </div>
                        <span class="material-symbols-outlined text-gray-600">chevron_right</span>
                    </button>
                </div>

                <!-- Transaction History Container -->
                <div id="cashHistory" style="display:none;">
                    <div class="flex items-center gap-3 mb-6 cursor-pointer text-gray-400 hover:text-white transition"
                        onclick="switchCashierTab('deposit')">
                        <span class="material-symbols-outlined text-lg">arrow_back</span>
                        <span class="text-[10px] font-bold uppercase tracking-[0.2em]">Back to Deposit</span>
                    </div>
                    <div id="txHistoryList" class="flex flex-col gap-3 pb-8"></div>
                </div>

            </div>
        </div>
    </div>

    <!-- ===== SCREEN: REFERRAL ===== -->
    <div class="screen" id="scrReferral">
        <div class="ref-hero">
            <div class="ref-hero-icon"><img
                    src="https://lh3.googleusercontent.com/aida-public/AB6AXuCpCm-In3qaads4-907wOGoyxZRtNhNrOWD-U1kAC57uAA0oO3DnPwchxZ4EraGR6QuJgvoSYkYmuPig3Bi5g-ROCe5cnWc_zg4Jis0UHe8n3saeShVPK2gJ4DXrXcOK-M2IjhFYujSo3fc2HFsdKyGllktDw2yiUFcLx0VlGohAFPIZdJjzEn-_bw47k35CYqzdnl6tKITBGL_Jdj7BNOqIkQ5uK71RWcXAWNxEJtmUIMLeNmbVOuLBo45VWiYk9VAWFqJvWBhpeY"
                    alt="Coins"
                    style="width:100px;height:100px;object-fit:contain;filter:drop-shadow(0 8px 16px rgba(227,30,36,.3))">
            </div>
            <h1 id="refHeroTitle">Invite & <span>Earn</span></h1>
            <p id="refHeroDesc">Share your link and earn <b>10 coins</b> for every friend who plays.</p>
        </div>

        <div class="ref-link-card">
            <div class="ref-link-inner">
                <div class="ref-link-label" id="refLinkLabel">TAP COPY TO SHARE</div>
                <div class="ref-link-box">
                    <div class="ref-url" id="refUrl">https://t.me/bot?start=ref...</div>
                    <button class="ref-copy" onclick="copyRefLink()"><span
                            class="material-symbols-outlined">content_copy</span><span
                            id="refCopyText">Copy</span></button>
                </div>
            </div>
        </div>

        <div class="ref-stats">
            <div class="ref-stat-card">
                <div class="ref-stat-top">
                    <div class="ref-stat-icon people"><span class="material-symbols-outlined">group_add</span></div>
                    <div class="ref-stat-badge" id="refNewBadge"></div>
                </div>
                <div class="ref-stat-label" id="refTotalLabel">Total Referrals</div>
                <div class="ref-stat-val" id="refTotalVal">0</div>
            </div>
            <div class="ref-stat-card">
                <div class="ref-stat-top">
                    <div class="ref-stat-icon money"><span
                            class="material-symbols-outlined">account_balance_wallet</span></div>
                </div>
                <div class="ref-stat-label" id="refEarnedLabel">Earned Coins</div>
                <div class="ref-stat-val" id="refEarnedVal">0</div>
            </div>
        </div>

        <div class="ref-how">
            <div class="ref-how-title" id="refHowTitle">How it Works</div>
            <div class="ref-steps">
                <div class="ref-step">
                    <div class="ref-step-line">
                        <div class="ref-step-num">1</div>
                        <div class="ref-step-connector"></div>
                    </div>
                    <div class="ref-step-content">
                        <h3 id="refStep1T">Share with friends</h3>
                        <p id="refStep1D">Send your unique link via Telegram or social media.</p>
                    </div>
                </div>
                <div class="ref-step">
                    <div class="ref-step-line">
                        <div class="ref-step-num">2</div>
                        <div class="ref-step-connector"></div>
                    </div>
                    <div class="ref-step-content">
                        <h3 id="refStep2T">Friends start playing</h3>
                        <p id="refStep2D">When they register, you both get bonus coins.</p>
                    </div>
                </div>
                <div class="ref-step">
                    <div class="ref-step-line">
                        <div class="ref-step-num">3</div>
                    </div>
                    <div class="ref-step-content">
                        <h3 id="refStep3T">Earn Rewards</h3>
                        <p id="refStep3D">Get 10 coins for every friend who joins.</p>
                    </div>
                </div>
            </div>
        </div>

        <button class="ref-share-btn" onclick="shareRef()"><span class="material-symbols-outlined">ios_share</span><span
                id="refShareBtn">Share Link Now</span></button>
    </div>

    <!-- ===== SCREEN: PROFILE ===== -->
    <div class="screen" id="scrProfile">
        <div class="prof-header">
            <div class="prof-avatar">
                <div class="prof-avatar-inner" id="profAvatarInner"><img
                        src="https://lh3.googleusercontent.com/aida-public/AB6AXuDr3zsmMzZoKQBmXyKeYm7wjdUyCdTgqgmWcGFJrHZ1j04p23PyhyC-veLVchduXKVpILhD8OvgoBIY1kOdWCDOIZgRURbE4kJTa5KugjgI2XTZ2f-Atab5Y1nG3egXh_6wk1yFwzjlyBkkbJ3ID-hqkVSJfimD4Exhl70tk5RZYzwUAQXuY1t0RWIhqsrPPWPeni-TFGVUKHJ7X0JKR0ANZAZXV9wWgMeBNnOzlApLWWe8wo3HJ13XCqJvvsTxAsyt3XT5UdULBhM"
                        alt="Avatar" style="width:100%;height:100%;object-fit:cover"></div>
            </div>
            <div class="prof-name" id="profName">Player</div>
            <div class="prof-meta">
                <span class="prof-id" id="profId">ID: ...</span>
                <span style="width:1px;height:14px;background:var(--surface2)"></span>
                <span class="prof-vip-badge"><span class="material-symbols-outlined">stars</span><span
                        id="profVipBadge">VIP</span></span>
            </div>
        </div>

        <!-- VIP Tier Cards (static instant render, updated by loadProfile) -->
        <div id="vipCardsContainer"
            style="margin:20px 0;padding:0 16px;display:flex;gap:12px;overflow-x:auto;scroll-snap-type:x mandatory;scrollbar-width:none">
            <!-- Bronze (default active until API loads) -->
            <div style="flex-shrink:0;width:240px;scroll-snap-align:center;border-radius:16px;padding:20px;background:linear-gradient(135deg,#3d1f00,#1a0d00);border:2px solid #cd7f32;position:relative;overflow:hidden">
                <div style="font-size:28px;margin-bottom:8px">ðŸ¥‰</div>
                <div style="font-family:'Montserrat',sans-serif;font-size:18px;font-weight:900;color:#fff;margin-bottom:2px">Bronze</div>
                <div style="font-size:11px;color:rgba(255,255,255,.5)">0% Cashback Â· Basic access</div>
                <div style="margin-top:12px;background:rgba(255,255,255,.1);border-radius:4px;height:4px"><div id="vipBar0" style="height:100%;border-radius:4px;background:#cd7f32;width:0%"></div></div>
                <div id="vipPct0" style="font-size:10px;color:rgba(255,255,255,.4);margin-top:4px">0%</div>
            </div>
            <div style="flex-shrink:0;width:240px;scroll-snap-align:center;border-radius:16px;padding:20px;background:linear-gradient(135deg,#1a1a1a,#111);border:1px solid rgba(255,255,255,.05);opacity:.6">
                <div style="font-size:28px;margin-bottom:8px">ðŸ¥ˆ</div>
                <div style="font-family:'Montserrat',sans-serif;font-size:18px;font-weight:900;color:#fff;margin-bottom:2px">Silver</div>
                <div style="font-size:11px;color:rgba(255,255,255,.4)">3% Cashback Â· Weekly tournaments</div>
            </div>
            <div style="flex-shrink:0;width:240px;scroll-snap-align:center;border-radius:16px;padding:20px;background:linear-gradient(135deg,#1a1a1a,#111);border:1px solid rgba(255,255,255,.05);opacity:.6">
                <div style="font-size:28px;margin-bottom:8px">ðŸ¥‡</div>
                <div style="font-family:'Montserrat',sans-serif;font-size:18px;font-weight:900;color:#fff;margin-bottom:2px">Gold</div>
                <div style="font-size:11px;color:rgba(255,255,255,.4)">5% Cashback Â· Priority support</div>
            </div>
            <div style="flex-shrink:0;width:240px;scroll-snap-align:center;border-radius:16px;padding:20px;background:linear-gradient(135deg,#1a1a1a,#111);border:1px solid rgba(255,255,255,.05);opacity:.6">
                <div style="font-size:28px;margin-bottom:8px">ðŸ’Ž</div>
                <div style="font-family:'Montserrat',sans-serif;font-size:18px;font-weight:900;color:#fff;margin-bottom:2px">Platinum</div>
                <div style="font-size:11px;color:rgba(255,255,255,.4)">8% Cashback Â· Personal manager</div>
            </div>
            <div style="flex-shrink:0;width:240px;scroll-snap-align:center;border-radius:16px;padding:20px;background:linear-gradient(135deg,#1a1a1a,#111);border:1px solid rgba(255,255,255,.05);opacity:.6">
                <div style="font-size:28px;margin-bottom:8px">ðŸ‘‘</div>
                <div style="font-family:'Montserrat',sans-serif;font-size:18px;font-weight:900;color:#fff;margin-bottom:2px">Diamond</div>
                <div style="font-size:11px;color:rgba(255,255,255,.4)">10% Cashback Â· Exclusive events</div>
            </div>
        </div>

        <div class="prof-stats">
            <div class="prof-stat">
                <div class="prof-stat-label" id="stWinsL">WINS</div>
                <div class="prof-stat-val" id="stWins">0</div>
            </div>
            <div class="prof-stat">
                <div class="prof-stat-label" id="stLossesL">LOSSES</div>
                <div class="prof-stat-val" id="stLosses">0</div>
            </div>
            <div class="prof-stat">
                <div class="prof-stat-label" id="stTotalL">TOTAL</div>
                <div class="prof-stat-val" id="stTotal">0</div>
            </div>
        </div>

        <!-- BONUSES & PROMOTIONS compact block -->
        <div style="margin:0 16px 12px">
            <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:10px">
                <div style="font-family:'Montserrat',sans-serif;font-weight:800;font-size:13px;text-transform:uppercase;letter-spacing:.5px">ðŸŽ Bonuses & Promo</div>
                <div style="font-size:11px;color:var(--red);font-weight:700;cursor:pointer" onclick="nav('bonuses')">See All â†’</div>
            </div>
            <div style="display:flex;gap:8px;overflow-x:auto;scrollbar-width:none;-webkit-overflow-scrolling:touch;padding-bottom:4px">
                <div style="flex-shrink:0;width:140px;background:linear-gradient(135deg,#1a0a0a,#2a0a0a);border:1px solid rgba(227,30,36,.3);border-radius:12px;padding:12px;cursor:pointer" onclick="nav('wallet')">
                    <div style="font-size:20px;margin-bottom:6px">ðŸ’°</div>
                    <div style="font-family:'Montserrat',sans-serif;font-size:11px;font-weight:800;color:#fff;line-height:1.2">100% DEPOSIT<br>BONUS</div>
                    <div style="font-size:10px;color:var(--red);font-weight:700;margin-top:4px">Up to $500</div>
                </div>
                <div style="flex-shrink:0;width:140px;background:linear-gradient(135deg,#0a0a1a,#0a1a0a);border:1px solid rgba(56,239,125,.2);border-radius:12px;padding:12px;cursor:pointer" onclick="nav('bonuses')">
                    <div style="font-size:20px;margin-bottom:6px">ðŸŽ°</div>
                    <div style="font-family:'Montserrat',sans-serif;font-size:11px;font-weight:800;color:#fff;line-height:1.2">50 FREE<br>SPINS</div>
                    <div style="font-size:10px;color:#38ef7d;font-weight:700;margin-top:4px">No deposit</div>
                </div>
                <div style="flex-shrink:0;width:140px;background:linear-gradient(135deg,#0a0a1a,#1a0a1a);border:1px solid rgba(168,85,247,.2);border-radius:12px;padding:12px;cursor:pointer" onclick="nav('bonuses')">
                    <div style="font-size:20px;margin-bottom:6px">ðŸ”„</div>
                    <div style="font-family:'Montserrat',sans-serif;font-size:11px;font-weight:800;color:#fff;line-height:1.2">WEEKLY<br>CASHBACK</div>
                    <div style="font-size:10px;color:#a855f7;font-weight:700;margin-top:4px">Up to 20%</div>
                </div>
            </div>
        </div>

        <div class="prof-referral-btn" onclick="nav('referral')">
            <div class="prof-ref-left">
                <div class="prof-ref-icon"><span class="material-symbols-outlined">diversity_3</span></div>
                <div class="prof-ref-text">
                    <h3 id="profRefTitle">Referral Program</h3>
                    <p id="profRefSub">Invite friends & earn rewards</p>
                </div>
            </div>
            <span class="material-symbols-outlined">arrow_forward</span>
        </div>

        <div class="prof-menu">
            <div class="prof-menu-item" onclick="openLangSelector()">
                <div class="prof-menu-left"><span class="material-symbols-outlined">language</span><span
                        id="profLang">Language</span></div>
                <div style="display:flex;align-items:center;gap:4px"><span id="profLangCurrent"
                        style="font-size:12px;color:var(--dim)"></span><span
                        class="material-symbols-outlined">chevron_right</span></div>
            </div> <!-- closes Language item -->

            <div class="prof-menu-item" onclick="changeLang()">
                <div class="prof-menu-left"><span class="material-symbols-outlined">settings</span><span
                        id="profSettings">Settings</span></div><span
                    class="material-symbols-outlined">chevron_right</span>
            </div>
            <div class="prof-menu-item">
                <div class="prof-menu-left"><span class="material-symbols-outlined">security</span><span
                        id="profSecurity">Security</span></div><span
                    class="material-symbols-outlined">chevron_right</span>
            </div>
            <div class="prof-menu-item">
                <div class="prof-menu-left"><span class="material-symbols-outlined">headset_mic</span><span
                        id="profSupport">Support</span></div><span
                    class="material-symbols-outlined">chevron_right</span>
            </div>
        </div> <!-- closes prof-menu -->

        <!-- Language selector overlay -->
        <div id="langOverlay"
            style="display:none;position:fixed;inset:0;background:rgba(0,0,0,.8);z-index:300;align-items:flex-end;justify-content:center">
            <div
                style="background:var(--surface);border-top-left-radius:var(--radius-xl);border-top-right-radius:var(--radius-xl);width:100%;max-width:480px;padding:20px 16px 32px">
                <div style="width:40px;height:4px;background:var(--surface3);border-radius:2px;margin:0 auto 16px">
                </div>
                <h3 style="font-family:'Montserrat',sans-serif;font-size:16px;font-weight:800;margin-bottom:16px;text-align:center"
                    id="langTitle">Select Language</h3>
                <div style="display:flex;flex-direction:column;gap:6px" id="langList"></div>
            </div>
        </div>

        <button class="prof-signout" id="profSignout">Sign Out</button>
    </div> <!-- closes scrProfile -->

    <!-- ===== SCREEN: GAMES CATALOG ===== -->
    <div class="screen" id="scrGames">
        <div style="padding:16px">
            <div style="display:flex;align-items:center;gap:10px;margin-bottom:16px">
                <div style="flex:1;background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:10px 14px;display:flex;align-items:center;gap:8px;cursor:pointer"
                    onclick="openSearch()">
                    <span class="material-symbols-outlined" style="font-size:18px;color:var(--dim)">search</span>
                    <input type="text" id="gamesSearchInput" placeholder="Search games..."
                        oninput="filterGamesScreen(this.value)"
                        style="background:none;border:none;color:#fff;font-size:13px;width:100%;outline:none;font-family:Inter,sans-serif">
                </div>
            </div>
            <div class="cat-row" id="gamesCatRow"
                style="margin-bottom:16px;display:flex;gap:8px;overflow-x:auto;-webkit-overflow-scrolling:touch">
            </div>
            <div id="gamesGrid" class="grid grid-cols-2 gap-[12px]"></div>
        </div>
    </div>

    <!-- ===== SCREEN: PLINKO ===== -->
    <div class="screen" id="scrPlinko"
        style="position:fixed;top:var(--header-h);bottom:var(--nav-h);left:0;right:0;width:100%;z-index:20;background:var(--bg)">
        <div
            style="display:flex;flex-direction:column;height:100%;background:linear-gradient(180deg,#0a0a1a 0%,#120818 50%,#0a0a1a 100%);position:relative;overflow:hidden;padding-bottom:12px">
            <!-- Plinko Header -->
            <div style="display:flex;align-items:center;justify-content:space-between;padding:12px 16px;z-index:10">
                <div style="display:flex;align-items:center;gap:10px">
                    <div
                        style="width:40px;height:40px;border-radius:50%;background:linear-gradient(135deg,#e42127,#b91c1c);display:flex;align-items:center;justify-content:center">
                        <span class="material-symbols-outlined" style="color:#fff;font-size:20px">rocket_launch</span>
                    </div>
                    <div>
                        <div
                            style="font-family:Montserrat,sans-serif;font-size:14px;font-weight:900;letter-spacing:1px;text-transform:uppercase">
                            GALACTIC PLINKO</div>
                        <div
                            style="font-size:10px;color:var(--red);font-weight:700;letter-spacing:1.5px;text-transform:uppercase">
                            RUBYBET EXCLUSIVE</div>
                    </div>
                </div>
                <div style="display:flex;gap:8px">
                    <button onclick="openPlinkoLeaderboard()"
                        style="width:36px;height:36px;border-radius:50%;background:rgba(255,215,0,.1);border:1px solid rgba(255,215,0,.2);display:flex;align-items:center;justify-content:center;cursor:pointer">
                        <span class="material-symbols-outlined" style="font-size:18px;color:#FFD700">emoji_events</span>
                    </button>
                    <button onclick="openPlinkoRules()"
                        style="width:36px;height:36px;border-radius:50%;background:rgba(227,30,36,.1);border:1px solid rgba(227,30,36,.2);display:flex;align-items:center;justify-content:center;cursor:pointer">
                        <span class="material-symbols-outlined" style="font-size:18px;color:var(--red)">info</span>
                    </button>
                </div>
            </div>
            <!-- Nebula background glow -->
            <div style="position:absolute;inset:0;pointer-events:none;z-index:0">
                <div
                    style="position:absolute;top:25%;left:25%;width:250px;height:250px;background:rgba(228,33,39,.12);border-radius:50%;filter:blur(100px)">
                </div>
                <div
                    style="position:absolute;bottom:25%;right:25%;width:300px;height:300px;background:rgba(139,92,246,.08);border-radius:50%;filter:blur(120px)">
                </div>
            </div>
            <!-- Plinko Canvas -->
            <div
                style="flex:1;min-height:0;position:relative;z-index:5;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:0 16px">
                <canvas id="plinkoCanvas"
                    style="width:100%;max-width:320px;height:auto;max-height:100%;aspect-ratio:4/5;border-radius:12px;object-fit:contain"></canvas>
            </div>
            <!-- Multiplier Buckets -->
            <div id="plinkoBuckets" style="display:flex;gap:3px;padding:0 16px;z-index:5;margin-top:-10px">
            </div>

            <!-- Redesigned Bottom Controls -->
            <div
                style="flex:none;display:flex;flex-direction:column;align-items:center;justify-content:flex-end;padding:12px 16px 8px;z-index:10;gap:12px">

                <!-- Buy Bonus Action (Smaller/Subtle) -->
                <button onclick="openPlinkoBuyBonus()"
                    style="background:rgba(227,30,36,.05);border:1px solid rgba(227,30,36,.4);color:var(--red);padding:6px 20px;border-radius:20px;font-family:Montserrat,sans-serif;font-weight:800;font-size:11px;letter-spacing:1px;cursor:pointer;display:flex;align-items:center;gap:6px;transition:all .2s">
                    <span class="material-symbols-outlined" style="font-size:14px">bolt</span> BUY BONUS
                </button>

                <!-- Bet Selection Pill -->
                <div
                    style="width:100%;max-width:300px;display:flex;align-items:center;justify-content:space-between;gap:16px;background:rgba(227,30,36,.1);padding:6px 8px;border-radius:30px;border:1px solid rgba(227,30,36,.3)">
                    <button onclick="changePlinkoBet(-1)"
                        style="width:40px;height:40px;border-radius:50%;background:#120a0a;display:flex;align-items:center;justify-content:center;color:var(--red);border:none;cursor:pointer">
                        <span class="material-symbols-outlined">remove</span>
                    </button>
                    <div style="display:flex;flex-direction:column;align-items:center">
                        <span style="font-size:10px;color:var(--dim);text-transform:uppercase;font-weight:800">Bet Per
                            Drop</span>
                        <div
                            style="display:flex;align-items:center;gap:4px;font-weight:800;font-size:16px;font-family:Montserrat,sans-serif;margin-top:2px">
                            <span class="star-pulse" style="color:#FFD700;font-size:14px">â­</span> <span
                                id="plinkoBetDisplay">50</span>
                        </div>
                    </div>
                    <button onclick="changePlinkoBet(1)"
                        style="width:40px;height:40px;border-radius:50%;background:#120a0a;display:flex;align-items:center;justify-content:center;color:var(--red);border:none;cursor:pointer">
                        <span class="material-symbols-outlined">add</span>
                    </button>
                </div>

                <!-- Large Drop Orb -->
                <button id="plinkoDropBtn" onclick="dropPlinkoBall()" class="glass-orb"
                    style="width:84px;height:84px;border-radius:50%;border:none;color:#fff;display:flex;flex-direction:column;align-items:center;justify-content:center;cursor:pointer;transition:transform 0.1s;margin-top:4px">
                    <span class="material-symbols-outlined" style="font-size:32px;margin-bottom:-4px">stars</span>
                    <span
                        style="font-family:Montserrat,sans-serif;font-size:13px;font-weight:900;letter-spacing:-0.5px;font-style:italic">DROP</span>
                </button>

            </div>
        </div>
        <!-- Plinko Rules Popup -->
        <div id="plinkoRulesPopup"
            style="display:none;position:fixed;inset:0;background:rgba(0,0,0,.7);backdrop-filter:blur(4px);z-index:300;align-items:center;justify-content:center">
            <div
                style="background:var(--bg);border:2px solid var(--red);border-radius:var(--radius-xl);max-width:320px;width:90%;padding:28px 20px;text-align:center;box-shadow:0 0 40px rgba(227,28,35,.4)">
                <div
                    style="width:60px;height:60px;border-radius:50%;background:rgba(227,30,36,.15);display:flex;align-items:center;justify-content:center;margin:0 auto 16px">
                    <span class="material-symbols-outlined" style="font-size:28px;color:var(--red)">star</span>
                </div>
                <h3
                    style="font-family:Montserrat,sans-serif;font-size:18px;font-weight:900;text-transform:uppercase;letter-spacing:1px;margin-bottom:12px">
                    GALACTIC RULES</h3>
                <div style="width:40px;height:3px;background:var(--red);margin:0 auto 16px;border-radius:2px">
                </div>
                <p style="font-size:14px;color:var(--dim);line-height:1.6;margin-bottom:20px">Drop <b
                        style="color:#fff">Stars</b>,<br>Hit <b style="color:var(--red)">Multipliers</b>,<br>Win
                    Big!
                </p>
                <button onclick="closePlinkoRules()"
                    style="width:100%;height:44px;background:linear-gradient(135deg,#e42127,#b91c1c);color:#fff;border:none;border-radius:var(--radius);font-family:Montserrat,sans-serif;font-size:14px;font-weight:800;cursor:pointer;box-shadow:0 4px 15px rgba(228,33,39,.4)">PLAY
                    NOW</button>
            </div>
        </div>
        <!-- ===== BONUS ACTIVATION POPUP (PHASE 3 REDESIGN) ===== -->
        <div id="bonusPop"
            class="fixed inset-0 z-[1000] hidden items-center justify-center bg-black/80 backdrop-blur-sm">
            <div
                class="relative z-20 w-[340px] bg-[#15171b] rounded-3xl border border-gray-800/50 overflow-hidden modal-gradient flex flex-col items-center">
                <!-- Confetti & Header Section -->
                <div class="relative h-44 w-full flex items-center justify-center overflow-hidden"
                    id="bonusPopConfetti">
                    <div class="confetti-piece" style="left:20%; animation-delay: 0.2s; background: #e62e3d;"></div>
                    <div class="confetti-piece" style="left:40%; animation-delay: 1.5s; background: #fff;"></div>
                    <div class="confetti-piece" style="left:60%; animation-delay: 0.7s; background: #e62e3d;"></div>
                    <div class="confetti-piece" style="left:80%; animation-delay: 2.1s; background: #d97706;"></div>
                    <div class="confetti-piece" style="left:10%; animation-delay: 1.1s; background: #e62e3d;"></div>

                    <div
                        class="w-20 h-20 bg-[#e62e3d] rounded-full flex items-center justify-center success-glow animate-bounce">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="3"
                            stroke="currentColor" class="w-10 h-10 text-white">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M4.5 12.75l6 6 9-13.5"></path>
                        </svg>
                    </div>
                    <div class="absolute bottom-4 text-center">
                        <h2 class="text-xl font-black italic tracking-tighter text-white uppercase">Bonus Activated!
                        </h2>
                    </div>
                </div>

                <div class="w-full px-6 pb-8">
                    <!-- Bonus Detail Card -->
                    <div class="bg-black/40 rounded-2xl p-5 border border-white/5 mb-6 text-center">
                        <p class="text-[10px] text-gray-400 font-bold tracking-widest uppercase mb-1" id="bonusPopType">
                            Your Match Bonus</p>
                        <div class="flex items-center justify-center gap-2">
                            <span class="text-3xl font-black italic text-white" id="bonusPopTitle">100%</span>
                            <span class="text-3xl font-black italic text-[#e62e3d]" id="bonusPopValue">UP TO $500</span>
                        </div>
                    </div>

                    <!-- Terms Section -->
                    <div class="space-y-4 mb-8">
                        <div class="flex justify-between items-center">
                            <div class="flex items-center gap-2">
                                <div class="w-1.5 h-1.5 rounded-full bg-[#e62e3d]"></div>
                                <span class="text-xs text-gray-400 font-medium">Wagering Req.</span>
                            </div>
                            <span class="text-xs font-bold text-white font-mono" id="bonusPopWager">35x Bonus</span>
                        </div>

                        <div class="flex justify-between items-center">
                            <div class="flex items-center gap-2">
                                <div class="w-1.5 h-1.5 rounded-full bg-gray-600"></div>
                                <span class="text-xs text-gray-400 font-medium">Max Bet</span>
                            </div>
                            <span class="text-xs font-bold text-white font-mono" id="bonusPopMaxBet">$5.00 USDT</span>
                        </div>

                        <div class="h-px w-full bg-gray-800/50"></div>

                        <div class="flex justify-between items-center">
                            <span class="text-xs text-gray-400 font-medium">Bonus expires in:</span>
                            <div class="flex items-center gap-1.5 text-[#e62e3d]">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"
                                    class="w-3.5 h-3.5">
                                    <path fill-rule="evenodd"
                                        d="M12 2.25c-5.385 0-9.75 4.365-9.75 9.75s4.365 9.75 9.75 9.75 9.75-4.365 9.75-9.75S17.385 2.25 12 2.25zM12.75 6a.75.75 0 00-1.5 0v6c0 .414.336.75.75.75h4.5a.75.75 0 000-1.5h-3.75V6z"
                                        clip-rule="evenodd"></path>
                                </svg>
                                <span class="text-xs font-black tracking-wider" id="bonusPopExpiry">29D 23H 59M</span>
                            </div>
                        </div>
                    </div>

                    <button
                        class="w-full bg-[#e62e3d] hover:bg-red-700 text-white font-bold py-4 rounded-xl text-sm transition-all uppercase tracking-[0.15em] shadow-lg shadow-red-900/30"
                        onclick="closeBonusPop()">
                        Start Playing
                    </button>

                    <button
                        class="w-full mt-4 text-[10px] text-gray-500 font-bold uppercase tracking-widest hover:text-gray-300 transition"
                        onclick="showBonusTerms()">
                        View Terms & Conditions
                    </button>
                </div>
            </div>
        </div>
        <!-- Plinko Leaderboard Popup -->
        <div id="plinkoLeaderPopup"
            style="display:none;position:fixed;inset:0;background:rgba(0,0,0,.7);backdrop-filter:blur(4px);z-index:300;align-items:flex-end;justify-content:center">
            <div
                style="background:var(--bg);border-top:2px solid #FFD700;border-radius:var(--radius-xl) var(--radius-xl) 0 0;width:100%;max-width:480px;padding:20px 16px 32px;max-height:60vh;overflow-y:auto">
                <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px">
                    <div style="display:flex;align-items:center;gap:8px">
                        <span class="material-symbols-outlined" style="color:#FFD700;font-size:22px">emoji_events</span>
                        <h3
                            style="font-family:Montserrat,sans-serif;font-size:16px;font-weight:900;text-transform:uppercase">
                            TOP DROPS</h3>
                    </div>
                    <button onclick="closePlinkoLeaderboard()"
                        style="background:none;border:none;color:var(--dim);cursor:pointer"><span
                            class="material-symbols-outlined">close</span></button>
                </div>
                <div id="plinkoLeaderList"></div>
            </div>
        </div>
    </div> <!-- End of Plinko Wrapper -->
    </div> <!-- End of scrPlinko -->

    <!-- Plinko Buy Bonus Popup -->
    <div id="plinkoBuyBonusPopup"
        style="display:none;position:fixed;inset:0;background:rgba(0,0,0,.85);backdrop-filter:blur(6px);z-index:400;align-items:center;justify-content:center">
        <div
            style="background:#1a1a1a;border:1px solid #333;border-radius:var(--radius-xl);width:90%;max-width:340px;padding:20px;position:relative">
            <button onclick="closePlinkoBuyBonus()"
                style="position:absolute;top:16px;right:16px;background:none;border:none;color:var(--dim);cursor:pointer;z-index:10"><span
                    class="material-symbols-outlined">close</span></button>
            <div style="text-align:center;margin-bottom:20px">
                <div
                    style="display:inline-flex;align-items:center;gap:6px;background:rgba(255,215,0,.1);border:1px solid rgba(255,215,0,.2);padding:6px 12px;border-radius:20px;margin-bottom:12px">
                    <span style="font-size:14px">â­</span><span id="buyBonusBalance"
                        style="color:#FFD700;font-weight:800;font-family:Montserrat,sans-serif;font-size:14px">0
                        STARS</span>
                </div>
                <h3
                    style="font-family:Montserrat,sans-serif;font-size:22px;font-weight:900;text-transform:uppercase;letter-spacing:1px;color:#fff;font-style:italic">
                    BOOST YOUR WIN</h3>
            </div>
            <!-- Buy Options -->
            <div style="display:flex;flex-direction:column;gap:12px">
                <!-- Option 1: Super Drop -->
                <div
                    style="border:1px solid #333;border-radius:12px;padding:12px;display:flex;align-items:center;gap:12px;background:rgba(255,255,255,.02)">
                    <div
                        style="width:40px;height:40px;background:var(--red);border-radius:8px;display:flex;align-items:center;justify-content:center">
                        <span class="material-symbols-outlined" style="color:#fff">bolt</span>
                    </div>
                    <div style="flex:1">
                        <div style="font-family:Montserrat,sans-serif;font-weight:800;font-size:14px;color:#fff">
                            SUPER DROP</div>
                        <div style="font-size:11px;color:var(--dim)">Release an extra ball instantly.</div>
                    </div>
                    <button onclick="buyPlinkoBonus(5, 'super')"
                        style="background:var(--red);border:none;border-radius:8px;padding:8px 12px;color:#fff;font-weight:800;cursor:pointer;display:flex;flex-direction:column;align-items:center;min-width:60px">
                        <span style="font-size:10px">BUY</span><span
                            style="display:flex;align-items:center;gap:2px;font-size:12px">â­5</span>
                    </button>
                </div>
                <!-- Option 2: Frenzy Mode -->
                <div
                    style="border:1px solid var(--red);border-radius:12px;padding:12px;position:relative;display:flex;align-items:center;gap:12px;background:rgba(227,30,36,.05)">
                    <div
                        style="position:absolute;top:-8px;left:12px;background:var(--red);color:#fff;font-size:9px;font-weight:800;padding:2px 6px;border-radius:4px;text-transform:uppercase">
                        POPULAR</div>
                    <div
                        style="width:40px;height:40px;background:var(--red);border-radius:8px;display:flex;align-items:center;justify-content:center">
                        <span class="material-symbols-outlined" style="color:#fff">local_fire_department</span>
                    </div>
                    <div style="flex:1">
                        <div style="font-family:Montserrat,sans-serif;font-weight:800;font-size:14px;color:#fff">
                            FRENZY MODE</div>
                        <div style="font-size:11px;color:var(--dim)">Multiple balls drop at once.</div>
                    </div>
                    <button onclick="buyPlinkoBonus(25, 'frenzy')"
                        style="background:var(--red);border:none;border-radius:8px;padding:8px 12px;color:#fff;font-weight:800;cursor:pointer;display:flex;flex-direction:column;align-items:center;min-width:60px;box-shadow:0 0 10px rgba(227,30,36,.4)">
                        <span style="font-size:10px">BUY</span><span
                            style="display:flex;align-items:center;gap:2px;font-size:12px">â­25</span>
                    </button>
                </div>
                <!-- Option 3: Jackpot Chance -->
                <div
                    style="border:1px solid #333;border-radius:12px;padding:12px;display:flex;align-items:center;gap:12px;background:rgba(255,255,255,.02)">
                    <div
                        style="width:40px;height:40px;background:var(--red);border-radius:8px;display:flex;align-items:center;justify-content:center">
                        <span class="material-symbols-outlined" style="color:#fff">diamond</span>
                    </div>
                    <div style="flex:1">
                        <div style="font-family:Montserrat,sans-serif;font-weight:800;font-size:14px;color:#fff">
                            JACKPOT CHANCE</div>
                        <div style="font-size:11px;color:var(--dim)">High multiplier & rare drops.</div>
                    </div>
                    <button onclick="buyPlinkoBonus(100, 'jackpot')"
                        style="background:var(--red);border:none;border-radius:8px;padding:8px 12px;color:#fff;font-weight:800;cursor:pointer;display:flex;flex-direction:column;align-items:center;min-width:60px">
                        <span style="font-size:10px">BUY</span><span
                            style="display:flex;align-items:center;gap:2px;font-size:12px">â­100</span>
                    </button>
                </div>
            </div>
            <div
                style="text-align:center;margin-top:16px;font-size:10px;color:var(--dim);border-top:1px solid #333;padding-top:12px">
                Telegram Stars are non-refundable. <span style="text-decoration:underline">Terms Apply</span>.
            </div>
        </div>
    </div>

    <!-- Plinko Stars Top-Up Popup -->
    <div id="plinkoStarsPopup"
        style="display:none;position:fixed;inset:0;background:#1a1a1a;z-index:500;overflow-y:auto">
        <div style="padding:20px;max-width:480px;margin:0 auto">
            <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:30px">
                <button onclick="closePlinkoStars()"
                    style="background:none;border:none;color:#fff;font-size:24px;cursor:pointer"><span
                        class="material-symbols-outlined">close</span></button>
                <div style="font-family:Montserrat,sans-serif;font-weight:800;font-size:16px;color:#fff">GET
                    STARS</div>
                <button style="background:none;border:none;color:var(--dim);font-size:14px">Restore</button>
            </div>
            <div style="text-align:center;margin-bottom:32px">
                <div
                    style="width:64px;height:64px;border-radius:50%;background:rgba(255,215,0,.1);display:flex;align-items:center;justify-content:center;margin:0 auto 12px">
                    <span class="material-symbols-outlined" style="font-size:32px;color:#FFD700">star</span>
                </div>
                <div id="topupCurrentBalance"
                    style="font-family:Montserrat,sans-serif;font-weight:900;font-size:36px;color:#fff;line-height:1">
                    0</div>
                <div style="color:var(--dim);font-size:14px;margin-top:4px">Current Balance</div>
            </div>
            <h3 style="font-family:Montserrat,sans-serif;font-weight:800;font-size:18px;color:#fff;margin-bottom:16px">
                Top up to continue</h3>
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:24px">
                <!-- Pack 1 -->
                <div class="star-pack" onclick="selectStarPack(50, 0.99, this)"
                    style="border:1px solid #333;border-radius:12px;padding:16px;background:rgba(255,255,255,.03);cursor:pointer;position:relative">
                    <div
                        style="width:32px;height:32px;border-radius:50%;background:rgba(255,215,0,.1);display:flex;align-items:center;justify-content:center;margin-bottom:12px">
                        <span class="material-symbols-outlined" style="font-size:18px;color:#FFD700">star</span>
                    </div>
                    <div style="font-weight:800;font-size:18px;color:#fff;font-family:Montserrat,sans-serif">50
                        Stars</div>
                    <div style="font-size:12px;color:var(--dim)">Starter Pack</div>
                    <div style="margin-top:16px;font-weight:700;font-size:18px;color:#fff">$0.99</div>
                </div>
                <!-- Pack 2 -->
                <div class="star-pack active" onclick="selectStarPack(100, 1.99, this)"
                    style="border:2px solid var(--red);border-radius:12px;padding:16px;background:rgba(255,255,255,.03);cursor:pointer;position:relative">
                    <div
                        style="position:absolute;top:-10px;left:50%;transform:translateX(-50%);background:var(--red);color:#fff;font-size:9px;font-weight:800;padding:4px 8px;border-radius:12px;white-space:nowrap">
                        MOST POPULAR</div>
                    <div
                        style="position:absolute;top:12px;right:12px;width:20px;height:20px;border-radius:50%;background:var(--red);display:flex;align-items:center;justify-content:center">
                        <span class="material-symbols-outlined" style="font-size:14px;color:#fff">check</span>
                    </div>
                    <div
                        style="width:32px;height:32px;border-radius:50%;background:rgba(255,215,0,.1);display:flex;align-items:center;justify-content:center;margin-bottom:12px">
                        <span class="material-symbols-outlined" style="font-size:18px;color:#FFD700">star</span>
                    </div>
                    <div style="font-weight:800;font-size:18px;color:#fff;font-family:Montserrat,sans-serif">100
                        Stars</div>
                    <div style="font-size:12px;color:var(--red)">Best for beginners</div>
                    <div style="margin-top:16px;font-weight:700;font-size:18px;color:#fff">$1.99</div>
                </div>
            </div>
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:32px">
                <!-- Pack 3 -->
                <div class="star-pack" onclick="selectStarPack(500, 9.99, this)"
                    style="border:1px solid #333;border-radius:12px;padding:16px;background:rgba(255,255,255,.03);cursor:pointer;position:relative">
                    <div
                        style="position:absolute;top:-8px;right:12px;background:#3b82f6;color:#fff;font-size:10px;font-weight:800;padding:2px 6px;border-radius:4px">
                        -15%</div>
                    <div
                        style="width:32px;height:32px;border-radius:50%;background:rgba(255,215,0,.1);display:flex;align-items:center;justify-content:center;margin-bottom:12px">
                        <span style="font-size:18px">ðŸŒŸ</span>
                    </div>
                    <div style="font-weight:800;font-size:18px;color:#fff;font-family:Montserrat,sans-serif">500
                        Stars</div>
                    <div style="font-size:12px;color:var(--dim)">Pro Value</div>
                    <div style="margin-top:16px;font-weight:700;font-size:18px;color:#fff">$9.99</div>
                </div>
                <!-- Pack 4 -->
                <div class="star-pack" onclick="selectStarPack(1000, 19.99, this)"
                    style="border:1px solid #333;border-radius:12px;padding:16px;background:rgba(255,255,255,.03);cursor:pointer;position:relative">
                    <div
                        style="position:absolute;top:-8px;right:12px;background:#8b5cf6;color:#fff;font-size:10px;font-weight:800;padding:2px 6px;border-radius:4px">
                        -25%</div>
                    <div
                        style="width:32px;height:32px;border-radius:50%;background:rgba(255,215,0,.1);display:flex;align-items:center;justify-content:center;margin-bottom:12px">
                        <span style="font-size:18px">ðŸ’«</span>
                    </div>
                    <div style="font-weight:800;font-size:18px;color:#fff;font-family:Montserrat,sans-serif">
                        1000 Stars</div>
                    <div style="font-size:12px;color:var(--dim)">Ultimate Pack</div>
                    <div style="margin-top:16px;font-weight:700;font-size:18px;color:#fff">$19.99</div>
                </div>
            </div>
            <div style="text-align:center;font-size:11px;color:var(--dim);margin-bottom:20px">Purchases are
                managed by Telegram. Terms of Service apply.</div>
            <button id="btnBuyStars" onclick="confirmStarPurchase()"
                style="width:100%;height:54px;background:var(--red);color:#fff;border:none;border-radius:12px;font-family:Montserrat,sans-serif;font-weight:800;font-size:16px;display:flex;align-items:center;justify-content:center;gap:8px;cursor:pointer;box-shadow:0 4px 15px rgba(227,30,36,.4)">
                <span class="material-symbols-outlined" style="font-size:20px">send</span> Buy 100 Stars for
                $1.99
            </button>
            <div
                style="text-align:center;margin-top:16px;font-size:10px;color:var(--dim);display:flex;align-items:center;justify-content:center;gap:4px;text-transform:uppercase;letter-spacing:1px">
                <span class="material-symbols-outlined" style="font-size:14px">lock</span> SECURE CHECKOUT VIA
                APP STORE
            </div>
        </div>
    </div>

    <!-- Epic Win Celebration Screen -->
    <div id="plinkoEpicWinPopup"
        style="display:none;position:fixed;inset:0;background:rgba(10,0,5,.95);z-index:600;align-items:center;justify-content:center;flex-direction:column">
        <!-- Particles & Glows -->
        <div style="position:absolute;inset:0;pointer-events:none;overflow:hidden">
            <div
                style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);width:400px;height:400px;background:radial-gradient(circle,rgba(227,30,36,.3) 0%,transparent 70%)">
            </div>
        </div>
        <div style="text-align:center;z-index:10;animation:popIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275)">
            <div
                style="font-size:16px;color:var(--red);font-family:Montserrat,sans-serif;font-weight:800;font-style:italic;letter-spacing:2px;margin-bottom:8px;text-transform:uppercase;text-shadow:0 0 10px rgba(227,30,36,.6)">
                UNBELIEVABLE!</div>
            <div
                style="font-size:64px;color:#fff;font-family:Montserrat,sans-serif;font-weight:900;font-style:italic;line-height:0.9;text-transform:uppercase;text-shadow:0 4px 20px rgba(0,0,0,.5);margin-bottom:24px">
                EPIC<br><span style="color:var(--red)">WIN</span></div>
            <div
                style="background:rgba(0,0,0,.5);border:2px solid var(--red);border-radius:20px;padding:24px 40px;box-shadow:0 0 40px rgba(227,30,36,.3);margin-bottom:24px">
                <div id="epicWinAmount"
                    style="font-size:48px;color:#fff;font-family:Montserrat,sans-serif;font-weight:900;letter-spacing:-1px;line-height:1;margin-bottom:8px">
                    50,000</div>
                <div
                    style="font-size:12px;color:var(--red);font-weight:800;letter-spacing:2px;text-transform:uppercase">
                    STARS COLLECTED</div>
            </div>
            <div
                style="display:inline-flex;align-items:center;gap:6px;background:rgba(227,30,36,.15);border:1px solid rgba(227,30,36,.3);padding:8px 16px;border-radius:20px;margin-bottom:40px">
                <span class="material-symbols-outlined" style="color:var(--red);font-size:16px">trending_up</span>
                <span id="epicWinMult"
                    style="color:#fff;font-family:Montserrat,sans-serif;font-weight:800;font-size:14px">100X
                    MULTIPLIER</span>
            </div>
            <button onclick="closeEpicWin()"
                style="width:100%;max-width:280px;height:54px;background:var(--red);color:#fff;border:none;border-radius:12px;font-family:Montserrat,sans-serif;font-weight:900;font-size:18px;cursor:pointer;box-shadow:0 4px 20px rgba(227,30,36,.5);letter-spacing:1px;text-transform:uppercase">COLLECT</button>
        </div>
    </div>

    <!-- ===== BOTTOM NAV ===== -->
    <div class="bottom-nav">
        <div class="nav-item active group" data-screen="lobby"
            onclick="nav('lobby'); if(window.Telegram && window.Telegram.WebApp && window.Telegram.WebApp.HapticFeedback){window.Telegram.WebApp.HapticFeedback.impactOccurred('light')}">
            <span class="material-symbols-outlined">home</span>
            <div class="nav-label" id="navLobby">Home</div>
            <div class="nav-indicator"></div>
        </div>
        <div class="nav-item group" data-screen="games"
            onclick="nav('games'); if(window.Telegram && window.Telegram.WebApp && window.Telegram.WebApp.HapticFeedback){window.Telegram.WebApp.HapticFeedback.impactOccurred('light')}">
            <span class="material-symbols-outlined">casino</span>
            <div class="nav-label" id="navGame">Games</div>
            <div class="nav-indicator"></div>
        </div>
        <div class="nav-wheel-btn" onclick="openWheel(); if(window.Telegram && window.Telegram.WebApp && window.Telegram.WebApp.HapticFeedback){window.Telegram.WebApp.HapticFeedback.impactOccurred('medium')}">
            <div class="nav-wheel-circle" id="navWheelCircle">ðŸŽ¡</div>
            <div class="nav-badge" id="bonusBadge" style="display:none;position:absolute;top:-16px;right:calc(50% - 32px)">0</div>
            <div class="nav-wheel-label">Wheel</div>
        </div>
        <div class="nav-item group" data-screen="wallet"
            onclick="nav('wallet'); if(window.Telegram && window.Telegram.WebApp && window.Telegram.WebApp.HapticFeedback){window.Telegram.WebApp.HapticFeedback.impactOccurred('light')}">
            <span class="material-symbols-outlined">account_balance_wallet</span>
            <div class="nav-label" id="navWallet">Wallet</div>
            <div class="nav-indicator"></div>
        </div>
        <div class="nav-item group" data-screen="profile"
            onclick="nav('profile'); if(window.Telegram && window.Telegram.WebApp && window.Telegram.WebApp.HapticFeedback){window.Telegram.WebApp.HapticFeedback.impactOccurred('light')}">
            <span class="material-symbols-outlined">person</span>
            <div class="nav-label" id="navProfile">Profile</div>
            <div class="nav-indicator"></div>
        </div>
    </div>

    <!-- ===== BONUS OVERLAY ===== -->
    <div class="bonus-overlay" id="bonusOL">
        <div class="bo-title" id="boTitle">ðŸŽ° BONUS ROUND ðŸŽ°</div>
        <div class="bo-info">
            <div class="bo-info-item">
                <div class="label" id="boSpinL">SPIN</div>
                <div class="val" id="boSpinC">0/10</div>
            </div>
            <div class="bo-info-item">
                <div class="label" id="boTotalL">WIN</div>
                <div class="val" id="boRunT">0</div>
            </div>
        </div>
        <div class="bo-grid-wrap">
            <div class="bo-grid" id="boGrid"></div>
        </div>
        <div class="bo-result" id="boRes"></div>
        <div class="bo-total" id="boFinal"></div>
        <button class="bo-close" id="boClose" onclick="closeBonus()">COLLECT ðŸª™</button>
    </div>

    <!-- ===== TOAST ===== -->
    <div class="toast" id="toast">
        <div class="toast-icon" id="toastIcon">ðŸ’°</div>
        <div class="toast-text" id="toastText">Not enough coins!</div>
        <div id="toastRequestId"
            style="display:none;font-size:9px;color:rgba(255,255,255,0.4);font-family:monospace;margin-top:-4px;margin-bottom:8px">
        </div>
        <div class="toast-btns">
            <button class="toast-btn secondary" onclick="closeToast()" id="toastCancel">âœ•</button>
            <button class="toast-btn primary" onclick="toastAction()" id="toastOk">Deposit</button>
        </div>
    </div>

    <!-- ===== FORTUNE WHEEL OVERLAY ===== -->
    <div id="wheelOL" style="display:none;position:fixed;inset:0;z-index:200;background:#121212;overflow-y:auto;padding-top:var(--header-h)">
        <!-- Sparkle decorations -->
        <div
            style="position:absolute;inset:0;pointer-events:none;background-image:radial-gradient(circle at 20% 30%,rgba(227,28,35,.12) 0%,transparent 25%),radial-gradient(circle at 80% 70%,rgba(255,215,0,.03) 0%,transparent 25%)">
        </div>
        <div
            style="position:absolute;top:80px;right:48px;color:#FFD700;opacity:.1;font-size:36px;animation:pulse 2s infinite">
            âœ¦</div>

        <!-- Header -->
        <div
            style="display:flex;align-items:center;justify-content:space-between;padding:24px 20px 16px;position:relative;z-index:10">
            <button onclick="closeWheel()"
                style="width:40px;height:40px;border-radius:50%;background:rgba(33,17,18,.8);border:1px solid rgba(255,255,255,.05);color:rgba(255,255,255,.7);display:flex;align-items:center;justify-content:center;cursor:pointer">
                <span class="material-symbols-outlined">close</span>
            </button>
            <h2
                style="font-family:'Montserrat',sans-serif;font-size:18px;font-weight:800;color:#fff;text-transform:uppercase;letter-spacing:.5px">
                RubyBet</h2>
            <div
                style="display:flex;align-items:center;gap:8px;background:rgba(33,17,18,.8);border:1px solid rgba(255,255,255,.1);border-radius:9999px;padding:6px 12px">
                <span class="material-symbols-outlined" style="font-size:18px;color:#FFD700">stars</span>
                <span id="wheelBalDisplay"
                    style="font-size:12px;font-weight:700;color:#fff;font-family:'Montserrat',sans-serif">0</span>
            </div>
        </div>

        <!-- SPIN STATE -->
        <div id="wheelSpinState"
            style="position:relative;z-index:10;display:flex;flex-direction:column;align-items:center;padding:16px 24px 48px">
            <div style="text-align:center;margin-bottom:24px">
                <h1
                    style="font-family:'Montserrat',sans-serif;font-size:28px;font-weight:900;color:#fff;text-transform:uppercase;font-style:italic;text-shadow:0 4px 20px rgba(227,28,35,.6);letter-spacing:-1px">
                    Daily Wheel</h1>
                <p
                    style="color:rgba(255,255,255,.5);font-size:12px;font-weight:600;text-transform:uppercase;letter-spacing:2px;margin-top:8px">
                    Spin to win exclusive rewards</p>
            </div>

            <!-- Wheel -->
            <div id="wheelVisual" style="position:relative;width:300px;height:300px;margin:0 auto 32px">
                <!-- Pointer -->
                <div style="position:absolute;top:-12px;left:50%;transform:translateX(-50%);z-index:30">
                    <svg width="36" height="44" viewBox="0 0 40 50" fill="none">
                        <path d="M20 50L5 15C5 15 0 5 10 5H30C40 5 35 15 35 15L20 50Z" fill="#F8F6F6" stroke="#211112"
                            stroke-width="2" />
                        <circle cx="20" cy="10" r="5" fill="#e31c23" />
                    </svg>
                </div>
                <!-- Outer Rim -->
                <div
                    style="position:absolute;inset:0;border-radius:50%;background:linear-gradient(145deg,#2a1a1a,#110d0d);box-shadow:0 0 0 6px #1a1a1a,0 0 0 8px #e31c23,0 0 30px 5px rgba(227,28,35,.5);display:flex;align-items:center;justify-content:center;overflow:hidden">
                    <!-- Bulbs -->
                    <div class="wh-bulb" style="top:8px;left:50%;transform:translateX(-50%)"></div>
                    <div class="wh-bulb" style="bottom:8px;left:50%;transform:translateX(-50%)"></div>
                    <div class="wh-bulb" style="top:25%;right:8%"></div>
                    <div class="wh-bulb" style="top:25%;left:8%"></div>
                    <div class="wh-bulb" style="bottom:25%;right:8%"></div>
                    <div class="wh-bulb" style="bottom:25%;left:8%"></div>
                    <div class="wh-bulb" style="top:50%;right:4px;transform:translateY(-50%)"></div>
                    <div class="wh-bulb" style="top:50%;left:4px;transform:translateY(-50%)"></div>
                    <div class="wh-bulb" style="top:8%;right:25%"></div>
                    <div class="wh-bulb" style="top:8%;left:25%"></div>
                    <div class="wh-bulb" style="bottom:8%;right:25%"></div>
                    <div class="wh-bulb" style="bottom:8%;left:25%"></div>

                    <!-- Segments disc (this rotates) -->
                    <div id="wheelDisc"
                        style="width:92%;height:92%;border-radius:50%;background:conic-gradient(#e31c23 0deg 60deg,#232323 60deg 120deg,#e31c23 120deg 180deg,#232323 180deg 240deg,#e31c23 240deg 300deg,#232323 300deg 360deg);position:relative;box-shadow:inset 0 0 25px rgba(0,0,0,.9);border:2px solid rgba(255,255,255,.1);transition:transform 4s cubic-bezier(.17,.67,.05,.99)">
                        <!-- Segment labels -->
                        <div class="wh-seg" style="transform:rotate(30deg)">
                            <div class="wh-seg-inner"><span class="material-symbols-outlined"
                                    style="font-size:24px;color:#fff">payments</span><span
                                    class="wh-seg-label">CASH</span></div>
                        </div>
                        <div class="wh-seg" style="transform:rotate(90deg)">
                            <div class="wh-seg-inner"><span class="material-symbols-outlined"
                                    style="font-size:24px;color:#FFD700">casino</span><span
                                    class="wh-seg-label">SPINS</span></div>
                        </div>
                        <div class="wh-seg" style="transform:rotate(150deg)">
                            <div class="wh-seg-inner"><span class="material-symbols-outlined"
                                    style="font-size:24px;color:#fff">percent</span><span
                                    class="wh-seg-label">DEPOSIT</span></div>
                        </div>
                        <div class="wh-seg" style="transform:rotate(210deg)">
                            <div class="wh-seg-inner"><span class="material-symbols-outlined"
                                    style="font-size:24px;color:#FFD700">stars</span><span
                                    class="wh-seg-label">STARS</span></div>
                        </div>
                        <div class="wh-seg" style="transform:rotate(270deg)">
                            <div class="wh-seg-inner"><span class="material-symbols-outlined"
                                    style="font-size:24px;color:#fff">diamond</span><span
                                    class="wh-seg-label">VIP</span></div>
                        </div>
                        <div class="wh-seg" style="transform:rotate(330deg)">
                            <div class="wh-seg-inner"><span class="material-symbols-outlined"
                                    style="font-size:24px;color:#FFD700">inventory_2</span><span
                                    class="wh-seg-label">MYSTERY</span></div>
                        </div>
                    </div>
                </div>
                <!-- Center button -->
                <div
                    style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);width:60px;height:60px;background:radial-gradient(circle at 30% 30%,#ff4d4d,#8a1014);border-radius:50%;box-shadow:0 4px 15px rgba(0,0,0,.6),inset 0 2px 5px rgba(255,255,255,.4);z-index:20;border:4px solid #fff;display:flex;align-items:center;justify-content:center">
                    <span class="material-symbols-outlined"
                        style="color:#fff;font-size:28px;text-shadow:0 2px 4px rgba(0,0,0,.3)">bolt</span>
                </div>
            </div>

            <!-- Spin Button -->
            <button id="wheelSpinBtn" onclick="doWheelSpin()"
                style="width:100%;max-width:300px;padding:16px;border-radius:9999px;border:none;background:#e31c23;color:#fff;font-family:'Montserrat',sans-serif;font-size:18px;font-weight:900;text-transform:uppercase;letter-spacing:2px;cursor:pointer;box-shadow:0 0 20px rgba(227,28,35,.6),0 0 40px rgba(227,28,35,.3);transition:all .2s;border-top:1px solid rgba(255,255,255,.2);position:relative;overflow:hidden">
                <span id="wheelSpinBtnText">SPIN FOR FREE</span>
                <span class="material-symbols-outlined" style="margin-left:8px;vertical-align:middle">cached</span>
            </button>

            <!-- Timer -->
            <div
                style="margin-top:20px;display:flex;align-items:center;gap:8px;color:rgba(255,255,255,.5);font-size:14px;font-weight:500;background:rgba(255,255,255,.05);padding:6px 16px;border-radius:9999px;border:1px solid rgba(255,255,255,.05)">
                <span class="material-symbols-outlined" style="font-size:14px">schedule</span>
                <span>Next spin in <span id="wheelTimer" style="color:#fff;font-family:monospace">24:00:00</span></span>
            </div>
        </div>

        <!-- WIN STATE -->
        <div id="wheelWinState"
            style="display:none;position:absolute;inset:0;z-index:50;display:none;flex-direction:column;align-items:center;justify-content:center;padding:24px">
            <div style="position:absolute;inset:0;background:rgba(0,0,0,.6);backdrop-filter:blur(2px)"></div>
            <div
                style="position:relative;z-index:10;width:100%;max-width:320px;background:rgba(33,17,18,.95);backdrop-filter:blur(20px);border-radius:24px;padding:48px 24px 32px;display:flex;flex-direction:column;align-items:center;text-align:center;border:1px solid #e31c23;box-shadow:0 0 25px rgba(227,30,36,.5),inset 0 0 40px rgba(0,0,0,.9)">
                <div style="position:relative;margin-bottom:16px">
                    <div
                        style="position:absolute;inset:0;background:rgba(255,215,0,.2);filter:blur(20px);border-radius:50%">
                    </div>
                    <span class="material-symbols-outlined"
                        style="font-size:96px;font-variation-settings:'FILL' 1,'wght' 700;background:linear-gradient(135deg,#FFD700,#FDB931);background-clip: text;
            -webkit-background-clip:text;-webkit-text-fill-color:transparent;filter:drop-shadow(0 0 20px rgba(255,215,0,.5));position:relative;z-index:10">stars</span>
                </div>
                <h1
                    style="font-family:'Montserrat',sans-serif;font-size:24px;font-weight:900;color:#fff;text-transform:uppercase;letter-spacing:2px;margin-bottom:12px">
                    CONGRATULATIONS!</h1>
                <p
                    style="font-family:'Montserrat',sans-serif;font-size:14px;font-weight:700;color:rgba(255,255,255,.6);text-transform:uppercase;letter-spacing:2px;margin-bottom:8px">
                    You won</p>
                <div id="wheelWinAmount"
                    style="font-family:'Montserrat',sans-serif;font-size:60px;font-weight:900;color:#fff;text-shadow:0 0 20px rgba(227,28,35,.8);letter-spacing:-2px;margin-bottom:4px">
                    500</div>
                <p id="wheelWinUnit"
                    style="font-family:'Montserrat',sans-serif;font-size:14px;font-weight:700;color:rgba(255,255,255,.5);text-transform:uppercase;letter-spacing:4px;margin-bottom:32px">
                    STARS</p>
                <button onclick="collectWheelPrize()"
                    style="width:100%;padding:16px;border-radius:12px;border:none;background:#e31c23;color:#fff;font-family:'Montserrat',sans-serif;font-size:18px;font-weight:800;text-transform:uppercase;letter-spacing:2px;cursor:pointer;box-shadow:0 0 20px rgba(227,28,35,.6),0 0 40px rgba(227,28,35,.3);position:relative;overflow:hidden">COLLECT</button>
            </div>
        </div>

        <!-- LOCKED STATE -->
        <div id="wheelLockedState"
            style="display:none;position:absolute;inset:0;z-index:50;display:none;flex-direction:column;align-items:center;justify-content:center;padding:24px">
            <div style="position:absolute;inset:0;background:rgba(0,0,0,.6);backdrop-filter:blur(2px)"></div>
            <div
                style="position:relative;z-index:10;width:100%;max-width:320px;background:rgba(33,17,18,.95);backdrop-filter:blur(20px);border-radius:24px;padding:48px 24px 32px;display:flex;flex-direction:column;align-items:center;text-align:center;border:1px solid #e31c23;box-shadow:0 0 25px rgba(227,30,36,.5),inset 0 0 40px rgba(0,0,0,.9)">
                <div style="position:relative;margin-bottom:16px">
                    <div
                        style="position:absolute;inset:0;background:rgba(227,28,35,.2);filter:blur(20px);border-radius:50%">
                    </div>
                    <span class="material-symbols-outlined"
                        style="font-size:96px;font-variation-settings:'FILL' 1,'wght' 700;background:linear-gradient(135deg,#e31c23,#ff6b6b);background-clip: text;
            -webkit-background-clip:text;-webkit-text-fill-color:transparent;filter:drop-shadow(0 0 25px rgba(227,28,35,.8));position:relative;z-index:10">lock_clock</span>
                </div>
                <h1
                    style="font-family:'Montserrat',sans-serif;font-size:28px;font-weight:900;color:#fff;text-transform:uppercase;letter-spacing:2px;margin-bottom:24px">
                    LOCKED</h1>
                <p
                    style="font-family:'Montserrat',sans-serif;font-size:12px;font-weight:700;color:rgba(255,255,255,.6);text-transform:uppercase;letter-spacing:4px;margin-bottom:12px">
                    NEXT FREE SPIN IN:</p>
                <div id="wheelLockedTimer"
                    style="font-family:'Montserrat',sans-serif;font-size:32px;font-weight:900;color:#fff;text-shadow:0 0 15px rgba(255,255,255,.4),0 0 8px rgba(227,28,35,.2);letter-spacing:4px;font-variant-numeric:tabular-nums;margin-bottom:32px">
                    14:25:03</div>
                <button onclick="closeWheel()"
                    style="width:100%;padding:16px;border-radius:12px;border:none;background:#e31c23;color:#fff;font-family:'Montserrat',sans-serif;font-size:18px;font-weight:800;text-transform:uppercase;letter-spacing:2px;cursor:pointer;box-shadow:0 0 20px rgba(227,28,35,.6),0 0 40px rgba(227,28,35,.3)">BACK</button>
            </div>
        </div>
    </div>

    <script src="games.js"></script>

    <script>
        /* ================================================================
           AppState â€” Reactive State Management (JetTon Pattern)
           ================================================================ */
        const AppState = {
            user: null,
            wallet: {
                balance: 0,
                bonus_balance: 0,
                currency: localStorage.getItem('ruby_currency') || 'USD',
                symbol: '$',
                rate: 1.0,
                loading: true
            },
            ui: {
                walletOpen: false,
                activeTab: 'deposit',
                selectedMethod: null,
                paymentStatus: 'idle',
                solanaStatus: 'loading',
                authStatus: 'idle', // idle, authenticating, success, failed
                sessionToken: localStorage.getItem('ruby_jwt') || null
            },
            balanceReloading: false,
            _subs: {},

            // Subscribe to state changes (e.g., 'wallet.balance')
            subscribe(key, fn) {
                if (!this._subs[key]) this._subs[key] = [];
                this._subs[key].push(fn);
                try {
                    const val = key.split('.').reduce((o, i) => o[i], this);
                    fn(val);
                } catch (e) { }
            },

            // Selective Deep Update
            update(updates) {
                if (updates.wallet) this._deepMerge(this.wallet, updates.wallet);
                if (updates.ui) this._deepMerge(this.ui, updates.ui);

                Object.keys(updates).forEach(key => {
                    if (key !== 'wallet' && key !== 'ui' && typeof this[key] !== 'function' && !key.startsWith('_')) {
                        this[key] = updates[key];
                    }
                });
                this.notifyAll();
            },

            notifyAll() {
                Object.keys(this._subs).forEach(key => {
                    try {
                        const val = key.split('.').reduce((o, i) => o[i], this);
                        this._subs[key].forEach(fn => fn(val));
                    } catch (e) { }
                });
            },

            _deepMerge(target, source) {
                for (const key in source) {
                    if (source[key] !== null && typeof source[key] === 'object' && key in target) {
                        this._deepMerge(target[key], source[key]);
                    } else {
                        target[key] = source[key];
                    }
                }
                return target;
            }
        };

        // Step 4: Race Condition & Duplication Protection
        window._inFlight = new Set();
        function debugLog(...args) {
            if (new URLSearchParams(window.location.search).get('debug') === '1') {
                console.log('%c[DEBUG]', 'color:#E31E24;font-weight:bold', new Date().toLocaleTimeString(), ...args);
            }
        }

        async function withGuard(key, fn) {
            if (window._inFlight.has(key)) {
                debugLog(`Blocked concurrent: ${key}`);
                return;
            }
            window._inFlight.add(key);
            try { return await fn(); } finally { window._inFlight.delete(key); }
        }

        async function apiFetch(path, options = {}) {
            debugLog(`FETCH START: ${path}`);
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 10000); // 10s hard timeout
            const startTime = Date.now();

            const token = AppState.ui.sessionToken;
            const headers = {
                'Content-Type': 'application/json',
                ...options.headers
            };
            if (token) headers['Authorization'] = `Bearer ${token}`;

            const url = path.startsWith('http') ? path : (API + path);
            const isDebug = new URLSearchParams(window.location.search).get('debug') === '1';

            if (isDebug) console.log(`[API] START: ${path}`);

            try {
                const response = await fetch(url, {
                    ...options,
                    headers,
                    signal: controller.signal
                });
                clearTimeout(timeoutId);

                const latency = Date.now() - startTime;
                if (isDebug) console.log(`[API] END: ${path} (${latency}ms) Status: ${response.status}`);

                // Handle Auth 401/403
                if (response.status === 401 || response.status === 403) {
                    console.warn(`[API] Auth failed (${response.status}) on ${path}`);
                    localStorage.removeItem('ruby_jwt');
                    AppState.update({ ui: { sessionToken: null } });

                    // Re-auth logic (Step 2)
                    if (!path.includes('/api/auth') && !window._reauthing) {
                        if (window._reauthAttempts > 0) {
                            console.error('[API] Secondary re-auth attempt failed. Forcing reload.');
                            window._reauthAttempts = 0;
                            // Instead of infinite loop, we might need a full reload if re-auth keeps failing
                            // but for now we follow the "force full reload if retry fails" rule
                            setTimeout(() => window.location.reload(), 2000);
                            throw new Error('reauth_failed');
                        }

                        window._reauthing = true;
                        window._reauthAttempts = (window._reauthAttempts || 0) + 1;
                        console.log('[API] Triggering silent re-authentication...');

                        try {
                            await boot();
                            window._reauthing = false;

                            const newToken = AppState.ui.sessionToken;
                            if (newToken) {
                                console.log('[API] Retrying original request with new token...');
                                const retryHeaders = { ...headers, 'Authorization': `Bearer ${newToken}` };
                                const retryResponse = await fetch(url, { ...options, headers: retryHeaders, signal: controller.signal });
                                window._reauthAttempts = 0; // Reset on success
                                return retryResponse;
                            }
                        } catch (e) {
                            window._reauthing = false;
                            console.error('[API] Re-auth boot failed:', e);
                        }
                    }
                }

                if (response.status >= 500) {
                    console.error(`[API] Server Error (${response.status}) reaching ${path}`);
                    const reqId = response.headers.get('X-Request-Id');
                    if (window.showToast) showToast('âš ï¸', 'Server error. Please try again.', 'OK', '', null, reqId);
                }

                return response;
            } catch (err) {
                clearTimeout(timeoutId);
                const latency = Date.now() - startTime;

                if (err.name === 'AbortError') {
                    console.error(`[API] TIMEOUT: ${path} after ${latency}ms`);
                    return { ok: false, error: 'timeout', message: 'Request timed out' };
                }

                console.error(`[API] FETCH ERROR: ${path}`, err);
                return { ok: false, error: 'network_error', message: err.message, req_id: null };
            }
        }

        /**
         * Standardized API Error Handler
         * displays toast with Request ID for correlation
         */
        function handleApiError(data, defaultMsg = 'Operation failed') {
            const err = (data && data.error) || {};
            const msg = err.message || defaultMsg;
            const reqId = err.req_id || null;
            showToast('âŒ', msg, 'OK', '', function () { closeToast(); }, reqId);
            return false;
        }

        // Safe JSON parsing helper (Step 1.2)
        async function safeJson(response) {
            if (!response || typeof response.json !== 'function') return { ok: false, error: 'invalid_response' };
            try {
                const data = await response.json();
                return data;
            } catch (e) {
                console.error('[API] JSON Parse Error:', e);
                return { ok: false, error: 'parse_error', message: 'Invalid JSON signature from server' };
            }
        }

        /* ================================================================
           AppState Utilities & Reactive Bindings
           ================================================================ */
        function formatCurrency(cents) {
            const val = cents / 100;
            const cur = AppState.wallet.currency;
            const symbol = AppState.wallet.symbol;
            const rate = AppState.wallet.rate;
            return symbol + (val * rate).toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        }

        function showAuthFallback(err) {
            const el = document.getElementById('authFallback');
            const msg = document.getElementById('authErrorMsg');
            if (el) el.style.display = 'flex';
            if (msg && err) {
                if (err === 'unauthorized') msg.textContent = 'Telegram session expired or invalid. Please reopen from the official bot menu.';
                if (err === 'network_error') msg.textContent = 'Connection timeout. Please check your internet and try again.';
                if (err === 'environment_error') msg.textContent = 'Please open this app inside the official Telegram application.';
            }
        }

        // Reactive Header Binding
        AppState.subscribe('wallet.balance', (val) => {
            if (AppState.wallet.loading) return;
            const hb = document.getElementById('headerBal');
            if (hb) hb.textContent = formatCurrency(val);
        });

        AppState.subscribe('wallet.loading', (loading) => {
            const hb = document.getElementById('headerBal');
            if (hb && loading) {
                hb.innerHTML = '<div style="width:48px;height:16px;background:rgba(255,255,255,0.1);border-radius:4px;animation:pulse 1.5s infinite"></div>';
            }
        });

        AppState.subscribe('wallet.currency', (cur) => {
            const hu = document.getElementById('headerUnit');
            if (hu) hu.textContent = cur;
        });

        AppState.subscribe('ui.solanaStatus', (status) => {
            if (AppState.ui.selectedMethod === 'solana') {
                const container = document.getElementById('walletContent');
                if (container) renderSolanaUI(container);
            }
        });

        AppState.subscribe('ui.paymentStatus', (status) => {
            if (AppState.ui.walletOpen) renderWalletContent();
        });

        AppState.subscribe('ui.walletOpen', (open) => {
            const el = document.getElementById('walletModal');
            if (el) el.style.display = open ? 'flex' : 'none';
            if (open) renderWalletContent();
        });

        AppState.subscribe('ui.activeTab', (tab) => {
            const btnDep = document.getElementById('tabDeposit');
            const btnWd = document.getElementById('tabWithdraw');
            if (btnDep && btnWd) {
                if (tab === 'deposit') {
                    btnDep.style.background = 'var(--red)'; btnDep.style.color = 'white';
                    btnWd.style.background = 'transparent'; btnWd.style.color = '#6b7280';
                } else {
                    btnWd.style.background = 'var(--red)'; btnWd.style.color = 'white';
                    btnDep.style.background = 'transparent'; btnDep.style.color = '#6b7280';
                }
            }
            renderWalletContent();
        });

        function renderDepositMethods() {
            const container = document.getElementById('walletContent');
            if (!container) return;

            container.innerHTML = `
                <!-- Primary Method (Solana) -->
                <div style="margin-bottom:24px">
                    <div style="font-size:10px;font-weight:800;color:#6b7280;letter-spacing:1px;margin-bottom:12px;text-transform:uppercase">Primary Method</div>
                    <div onclick="renderMethodUI('solana')" style="background:linear-gradient(135deg,rgba(153,69,255,0.1),rgba(20,241,149,0.1));border:1px solid rgba(20,241,149,0.2);padding:20px;border-radius:20px;display:flex;align-items:center;gap:16px;cursor:pointer">
                        <div style="width:48px;height:48px;background:#14F195;border-radius:14px;display:flex;align-items:center;justify-content:center;color:#000">
                            <span class="material-symbols-outlined" style="font-size:28px">account_balance_wallet</span>
                        </div>
                        <div style="flex:1">
                            <div style="font-weight:900;font-size:16px">SOLANA (PHANTOM)</div>
                            <div style="font-size:11px;color:#14F195;font-weight:700">Instant Deposit â€¢ No Fees</div>
                        </div>
                        <span class="material-symbols-outlined" style="color:#4b5563">chevron_right</span>
                    </div>
                </div>

                <!-- Alternative Methods -->
                <div>
                    <div style="font-size:10px;font-weight:800;color:#6b7280;letter-spacing:1px;margin-bottom:12px;text-transform:uppercase">Other Methods</div>
                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
                        <div onclick="renderMethodUI('crypto')" style="background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.05);padding:16px;border-radius:18px;display:flex;flex-direction:column;gap:12px;cursor:pointer">
                            <div style="width:32px;height:32px;background:#f59e0b;border-radius:10px;display:flex;align-items:center;justify-content:center;color:#000">
                                <span class="material-symbols-outlined" style="font-size:18px">currency_bitcoin</span>
                            </div>
                            <div>
                                <div style="font-weight:800;font-size:13px">CRYPTO</div>
                                <div style="font-size:10px;color:#6b7280">BTC, ETH, TON</div>
                            </div>
                        </div>
                        <div onclick="renderMethodUI('stars')" style="background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.05);padding:16px;border-radius:18px;display:flex;flex-direction:column;gap:12px;cursor:pointer">
                            <div style="width:32px;height:32px;background:#0ea5e9;border-radius:10px;display:flex;align-items:center;justify-content:center;color:white">
                                <span class="material-symbols-outlined" style="font-size:18px">stars</span>
                            </div>
                            <div>
                                <div style="font-weight:800;font-size:13px">TG STARS</div>
                                <div style="font-size:10px;color:#6b7280">Quick & Simple</div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderWithdrawUI() {
            const container = document.getElementById('walletContent');
            if (container) container.innerHTML = '<div style="padding:40px;text-align:center;color:#6b7280;font-size:13px">Withdrawals are coming soon.</div>';
        }

        function renderMethodUI(method) {
            AppState.update({ ui: { selectedMethod: method } });
            const container = document.getElementById('walletContent');
            if (method === 'solana') renderSolanaUI(container);
            // ... more methods later
        }

        function renderSolanaUI(container) {
            const status = AppState.ui.solanaStatus;
            const isBlocked = status === 'blocked';
            const isConnecting = status === 'connecting';
            const isConnected = status === 'connected';
            const isVerifying = status === 'verifying';
            const isSuccess = status === 'success';
            const isFailed = status === 'failed';

            let innerHtml = '';
            if (isBlocked) {
                innerHtml = `
                    <div style="color:#ef4444;background:rgba(239,68,68,0.1);padding:16px;border-radius:12px;font-size:12px;font-weight:700">
                        System temporarily unavailable. Please use alternative methods.
                    </div>
                `;
            } else {
                innerHtml = `
                    <div style="width:64px;height:64px;background:#14F195;border-radius:50%;display:flex;align-items:center;justify-content:center;color:#000;margin-bottom:8px">
                        <span class="material-symbols-outlined" style="font-size:32px">${isSuccess ? 'check_circle' : 'account_balance_wallet'}</span>
                    </div>
                    <h3 style="font-weight:900;font-size:20px;margin:0">${isSuccess ? 'DEPOSIT SUCCESS' : 'SOLANA DEPOSIT'}</h3>
                    <p style="color:#6b7280;font-size:13px;margin:0">
                        ${isSuccess ? 'Your balance will update momentarily.' : 'Connect your Phantom wallet to deposit SOL instantly.'}
                    </p>
                    
                    ${!isConnected && !isSuccess ? `
                        <button onclick="SolanaModule.connect()" ${isConnecting ? 'disabled' : ''} style="width:100%;background:#14F195;color:#000;border:none;padding:16px;border-radius:14px;font-weight:900;font-size:15px;margin-top:12px;cursor:pointer;opacity:${isConnecting ? 0.6 : 1}">
                            ${isConnecting ? 'CONNECTING...' : 'CONNECT PHANTOM'}
                        </button>
                    ` : ''}

                    ${isConnected ? `
                        <div style="width:100%;margin-top:16px;display:flex;flex-direction:column;gap:12px">
                            <div style="background:rgba(255,255,255,0.03);padding:12px;border-radius:12px;display:flex;align-items:center;justify-content:space-between">
                                <span style="font-size:11px;color:#6b7280;font-weight:700">WALLET</span>
                                <span style="font-size:11px;font-weight:800;font-family:monospace">${SolanaModule.state.publicKey.substring(0, 4)}...${SolanaModule.state.publicKey.slice(-4)}</span>
                            </div>
                            <input type="number" id="solAmount" placeholder="Amount (SOL)" step="0.1" style="width:100%;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);padding:16px;border-radius:14px;color:white;font-weight:800;outline:none">
                            <button onclick="SolanaModule.signTransaction(document.getElementById('solAmount').value)" style="width:100%;background:#14F195;color:#000;border:none;padding:16px;border-radius:14px;font-weight:900;font-size:15px;cursor:pointer">
                                DEPOSIT NOW
                            </button>
                        </div>
                    ` : ''}

                    ${isVerifying ? `
                         <div style="margin-top:16px;font-weight:800;color:#14F195;animation:pulse 1.5s infinite">VERIFYING ON-CHAIN...</div>
                    ` : ''}
                `;
            }

            container.innerHTML = `
                <div style="margin-bottom:20px">
                    <button onclick="AppState.update({ui:{selectedMethod:null}})" style="background:none;border:none;color:#6b7280;display:flex;align-items:center;gap:4px;padding:0;cursor:pointer;font-weight:700;font-size:12px;margin-bottom:16px">
                        <span class="material-symbols-outlined" style="font-size:16px">arrow_back</span> BACK TO METHODS
                    </button>
                    <div style="background:rgba(20,241,149,0.05);border:1px solid rgba(20,241,149,0.1);padding:24px;border-radius:24px;text-align:center">
                        <div id="solanaInner" style="display:flex;flex-direction:column;align-items:center;gap:16px">
                            ${innerHtml}
                        </div>
                    </div>
                </div>
            `;
        }

        async function waitForTelegramUser(timeout = 3000) {
            return new Promise((resolve) => {
                const start = Date.now();
                const interval = setInterval(() => {
                    const tg = window.Telegram?.WebApp;
                    const user = tg?.initDataUnsafe?.user;
                    if (user || (Date.now() - start > timeout)) {
                        clearInterval(interval);
                        resolve(user || null);
                    }
                }, 100);
            });
        }

        async function boot() {
            const tg = window.Telegram?.WebApp;
            if (!tg) {
                console.error('[BOOT] Not inside Telegram environment');
                showAuthFallback('environment_error');
                return;
            }

            // Step 3.1: Early tg.ready() & Loading Overlay
            tg.ready();
            tg.expand();

            const overlay = document.getElementById('authFallback');
            const msg = document.getElementById('authErrorMsg');
            const hasCachedSession = !!localStorage.getItem('ruby_jwt');
            if (overlay && !hasCachedSession) {
                overlay.style.display = 'flex';
                if (msg) msg.textContent = 'RUBYBET: INITIALIZING...';
            }

            // Detect if we have a stale session (JWT) but no Telegram context (reopen via /start)
            if (!tg.initData && localStorage.getItem('ruby_jwt')) {
                console.warn('[BOOT] Stale session detected without initData. Clearing.');
                localStorage.removeItem('ruby_jwt');
                AppState.update({ ui: { sessionToken: null } });
            }

            const user = await waitForTelegramUser(3000);

            // Strict check: if no user data after wait, and not in debug, we must stop.
            if (!user && !new URLSearchParams(window.location.search).get('debug')) {
                console.error('[BOOT] Telegram session not available.');
                showAuthFallback('unauthorized');
                return;
            }

            try {
                // Step 1: Use hardened transport for Auth
                const r = await apiFetch('/api/auth', {
                    method: 'POST',
                    body: JSON.stringify({
                        init_data: tg.initData,
                        debug: new URLSearchParams(window.location.search).get('debug')
                    })
                });

                const d = await safeJson(r);
                if (d.ok) {
                    if (d.session_token) {
                        localStorage.setItem('ruby_jwt', d.session_token);
                        AppState.update({ ui: { sessionToken: d.session_token } });
                    }
                    AppState.update({
                        user: d.user,
                        wallet: { ...d.wallet, loading: false },
                        ui: { authStatus: 'success' }
                    });

                    // Hide overlay on success
                    if (overlay) overlay.style.display = 'none';

                    // Proceed with legacy initialization (Step 3: Parallelized)
                    if (typeof initApp === 'function') {
                        initApp();
                    } else {
                        console.error('[BOOT] initApp not found');
                    }
                } else {
                    showAuthFallback(d.error || 'unauthorized');
                }
            } catch (e) {
                console.error('[BOOT] Error:', e);
                showAuthFallback(e.message === 'reauth_failed' ? 'unauthorized' : 'network_error');
            }
        }

        /* ================================================================
           RubyBet Mini App â€” Full JS (preserving all original game logic)
           ================================================================ */
        /* ================================================================
           Solana Module â€” Isolated Web3 Logic (Phase 3 Hardening)
           ================================================================ */
        const SolanaModule = {
            TREASURY: 'RubyBetyPSB1ExY6D2C9v9j9m9n9o9p9q9r9s9t9u',
            config: { treasury: null, network: 'mainnet-beta' },
            state: {
                status: 'disconnected', // disconnected, connecting, connected, sending, verifying, success, failed, blocked
                publicKey: null,
                nonce: null,
                txHash: null,
                lastBlockhash: null,
                lastBlockhashTime: 0
            },

            async init() {
                return await withGuard('solana_init', async () => {
                    console.log('[SOLANA] Initializing Module...');
                    try {
                        var r = await apiFetch('/api/solana-config');
                        var d = await safeJson(r);
                        if (d.ok) {
                            this.config.treasury = d.treasury;
                            this.config.network = d.network;
                            if (this.config.treasury !== this.TREASURY) {
                                console.error('[SOLANA] TREASURY INTEGRITY MISMATCH!', this.config.treasury, 'vs', this.TREASURY);
                                this.state.status = 'blocked';
                                return;
                            }
                        }

                        // 2. Resume Strategy (Operational Safeguard)
                        var pending = JSON.parse(localStorage.getItem('solana_pending_tx') || 'null');
                        if (pending && pending.txHash) {
                            var age = (Date.now() - pending.timestamp) / 1000 / 60;
                            if (age < 10) {
                                console.log('[SOLANA] Resuming pending TX:', pending.txHash, 'Age:', Math.round(age), 'm');
                                this.state.txHash = pending.txHash;
                                this.state.nonce = pending.nonce;
                                this.verifyWithBackend(pending.txHash, pending.nonce);
                            } else {
                                localStorage.removeItem('solana_pending_tx');
                            }
                        }

                        // 3. App Boot Check for Deep Links
                        this.onAppBootCheck();
                    } catch (e) { console.error('[SOLANA] Init Exception:', e); }
                });
            },

            updateStatus(s, err) {
                this.state.status = s;
                console.log('[SOLANA] Status Change ->', s, err || '');
                AppState.update({ ui: { solanaStatus: s } });
                if (window.updateSolanaUI) window.updateSolanaUI();
            },

            getProvider() {
                if ('phantom' in window && window.phantom.solana) return window.phantom.solana;
                if ('solana' in window) return window.solana;
                return null;
            },

            async connect() {
                if (this.state.status === 'blocked') return;
                this.updateStatus('connecting');

                // Detect if mobile TG WebApp platform
                const platform = (window.Telegram && window.Telegram.WebApp && window.Telegram.WebApp.platform) || 'web';
                const isMobile = ['android', 'ios'].includes(platform);
                const provider = this.getProvider();

                if (provider && !isMobile) {
                    try {
                        const resp = await provider.connect();
                        this.state.publicKey = resp.publicKey.toString();
                        this.updateStatus('connected');
                        if (window.showToast) showToast('ðŸ‘»', 'Phantom Connected!', 'OK');
                    } catch (e) {
                        this.updateStatus('failed', e.message);
                        if (window.showToast) showToast('âŒ', 'Connection Failed: ' + e.message, 'OK');
                    }
                } else {
                    // Force Deep Link strategy for Mobile or Missing Extension
                    this.connectViaDeepLink();
                }
            },

            async connectViaDeepLink() {
                console.log('[SOLANA] Preparing Deep Link Connection...');
                this.updateStatus('connecting');
                const nonce = await this.getFreshNonce();
                if (!nonce) return this.updateStatus('failed', 'Nonce request failed');

                const ephemeral = nacl.box.keyPair();
                // Store ephemeral keys for return decryption
                localStorage.setItem('solana_ephemeral_secret', nacl.util.encodeBase64(ephemeral.secretKey));
                localStorage.setItem('solana_ephemeral_nonce', nonce);

                const params = new URLSearchParams({
                    app_url: window.location.origin,
                    dapp_encryption_public_key: nacl.util.encodeBase64(ephemeral.publicKey),
                    redirect_link: `https://t.me/${BOT}?startapp=pconnect`,
                    cluster: 'mainnet-beta'
                });

                const url = `https://phantom.app/ul/v1/connect?${params.toString()}`;
                console.log('[SOLANA] Opening Phantom:', url);
                if (window.Telegram && window.Telegram.WebApp) {
                    window.Telegram.WebApp.openLink(url);
                } else {
                    window.open(url, '_blank');
                }
            },

            async signTransaction(amountSol) {
                if (this.state.status === 'blocked') return;
                this.updateStatus('sending');

                const nonce = await this.getFreshNonce();
                if (!nonce) return this.updateStatus('failed', 'Nonce Error');

                const provider = this.getProvider();
                const platform = (window.Telegram && window.Telegram.WebApp && window.Telegram.WebApp.platform) || 'web';
                const isMobile = ['android', 'ios'].includes(platform);

                if (provider && !isMobile) {
                    try {
                        // Desktop/Extension Flow
                        const connection = new solanaWeb3.Connection(solanaWeb3.clusterApiUrl('mainnet-beta'));
                        const transaction = new solanaWeb3.Transaction().add(
                            solanaWeb3.SystemProgram.transfer({
                                fromPubkey: new solanaWeb3.PublicKey(this.state.publicKey),
                                toPubkey: new solanaWeb3.PublicKey(this.TREASURY),
                                lamports: amountSol * 1e9,
                            })
                        );
                        transaction.feePayer = new solanaWeb3.PublicKey(this.state.publicKey);
                        transaction.recentBlockhash = (await connection.getLatestBlockhash()).blockhash;

                        const signed = await provider.signAndSendTransaction(transaction);
                        const txHash = signed.signature;

                        console.log('[SOLANA] Extension TX Sent:', txHash);
                        // Save for auto-resume
                        localStorage.setItem('solana_pending_tx', JSON.stringify({
                            txHash: txHash,
                            nonce: nonce,
                            timestamp: Date.now()
                        }));

                        this.verifyWithBackend(txHash, nonce);
                    } catch (e) {
                        this.updateStatus('failed', e.message);
                    }
                } else {
                    // Mobile Deep Link Transaction
                    const nonce = await this.getFreshNonce();
                    if (!nonce) return this.updateStatus('failed', 'Nonce Error');

                    const ephemeral = nacl.box.keyPair();
                    localStorage.setItem('solana_ephemeral_secret', nacl.util.encodeBase64(ephemeral.secretKey));
                    localStorage.setItem('solana_ephemeral_nonce', nonce);

                    const connection = new solanaWeb3.Connection(solanaWeb3.clusterApiUrl('mainnet-beta'));
                    const transaction = new solanaWeb3.Transaction().add(
                        solanaWeb3.SystemProgram.transfer({
                            fromPubkey: new solanaWeb3.PublicKey(this.state.publicKey),
                            toPubkey: new solanaWeb3.PublicKey(this.TREASURY),
                            lamports: amountSol * 1e9,
                        })
                    );
                    transaction.feePayer = new solanaWeb3.PublicKey(this.state.publicKey);
                    transaction.recentBlockhash = (await connection.getLatestBlockhash()).blockhash;

                    const serializedTransaction = transaction.serialize({ verifySignatures: false });
                    const payload = {
                        transaction: solanaWeb3.utils.bs58.encode(serializedTransaction),
                    };

                    const phantomKey = solanaWeb3.utils.bs58.decode(this.state.session_phantom_key); // Need to store this during connect
                    const sharedSecret = nacl.box.before(phantomKey, ephemeral.secretKey);
                    const nonce_enc = nacl.randomBytes(24);
                    const encryptedPayload = nacl.box.after(
                        nacl.util.decodeUTF8(JSON.stringify(payload)),
                        nonce_enc,
                        sharedSecret
                    );

                    const params = new URLSearchParams({
                        dapp_encryption_public_key: solanaWeb3.utils.bs58.encode(ephemeral.publicKey),
                        nonce: solanaWeb3.utils.bs58.encode(nonce_enc),
                        redirect_link: `https://t.me/${BOT}?startapp=ptx`,
                        payload: solanaWeb3.utils.bs58.encode(encryptedPayload),
                    });

                    window.Telegram.WebApp.openLink(`https://phantom.app/ul/v1/signAndSendTransaction?${params.toString()}`);
                }
            },

            async onAppBootCheck() {
                const tg = window.Telegram.WebApp;
                const startParam = (tg && tg.initDataUnsafe && tg.initDataUnsafe.start_param) || "";
                if (!startParam) return;

                const secretKeyBase64 = localStorage.getItem('solana_ephemeral_secret');
                if (!secretKeyBase64) return;
                const secretKey = nacl.util.decodeBase64(secretKeyBase64);

                // Phantom returns are usually appended to the redirect_link.
                // If it came back via start_param, it's likely pconnect_... or ptx_...
                try {
                    if (startParam.startsWith('pconnect_')) {
                        const parts = startParam.split('_');
                        // Expecting pconnect_data_nonce_phantomkey
                        const data = solanaWeb3.utils.bs58.decode(parts[1]);
                        const nonce = solanaWeb3.utils.bs58.decode(parts[2]);
                        const phantomKey = solanaWeb3.utils.bs58.decode(parts[3]);

                        const decrypted = nacl.box.open(data, nonce, phantomKey, secretKey);
                        if (decrypted) {
                            const payload = JSON.parse(nacl.util.encodeUTF8(decrypted));
                            this.state.publicKey = payload.public_key;
                            this.updateStatus('connected');
                            if (window.showToast) showToast('âœ…', 'Phantom Connected!', 'OK');
                        }
                    } else if (startParam.startsWith('ptx_')) {
                        const parts = startParam.split('_');
                        const data = solanaWeb3.utils.bs58.decode(parts[1]);
                        const nonce = solanaWeb3.utils.bs58.decode(parts[2]);
                        const phantomKey = solanaWeb3.utils.bs58.decode(parts[3]);

                        const decrypted = nacl.box.open(data, nonce, phantomKey, secretKey);
                        if (decrypted) {
                            const payload = JSON.parse(nacl.util.encodeUTF8(decrypted));
                            const txHash = payload.signature;
                            const storedNonce = localStorage.getItem('solana_ephemeral_nonce');
                            this.verifyWithBackend(txHash, storedNonce);
                        }
                    }
                } catch (e) { console.error('[SOLANA] Decrypt Error:', e); }
            },

            async getFreshNonce() {
                return await withGuard('solana_nonce', async () => {
                    try {
                        var r = await apiFetch('/api/solana-nonce', {
                            method: 'POST', body: JSON.stringify(auth())
                        });
                        var d = await safeJson(r);
                        if (d.ok) return d.nonce;
                    } catch (e) { console.error('[SOLANA] Nonce Fetch Error:', e); }
                    return null;
                });
            },

            async verifyWithBackend(txHash, nonce) {
                return await withGuard('solana_verify', async () => {
                    this.updateStatus('verifying');
                    try {
                        var r = await apiFetch('/api/solana-deposit', {
                            method: 'POST', body: JSON.stringify(Object.assign({}, auth(), { txHash: txHash, nonce: nonce }))
                        });
                        var d = await safeJson(r);
                        if (d.ok) {
                            this.updateStatus('success');
                            localStorage.removeItem('solana_pending_tx');
                            if (window.showToast) showToast('ðŸŽ‰', 'Solana Deposit Confirmed!', 'OK');
                            if (window.loadBalance) loadBalance();
                        } else {
                            this.updateStatus('failed', d.error);
                            if (window.showToast) showToast('âŒ', d.error || 'Verification Failed', 'OK');
                        }
                    } catch (e) {
                        this.updateStatus('failed', e.message);
                    }
                });
            }
        };

        function renderBanners() {
            var el = document.getElementById('heroTrack');
            if (!el) return;
            var banners = getBanners();
            el.style.width = (banners.length * 100) + '%';
            el.innerHTML = banners.map(function (b, i) {
                var bg = b.bgStyle || (i === 1 ? 'linear-gradient(135deg,#121212 0%,#1a1a1a 100%)' : 'linear-gradient(135deg,#1a1a1a 0%,#121212 100%)');
                var btnBg = b.btnStyle || 'background:var(--red)';
                return `
                <div class="hero-slide" style="flex:1;padding:24px;background:${bg};display:flex;flex-direction:column;justify-content:center;position:relative;overflow:hidden">
                    <div style="position:absolute;top:10px;right:10px;padding:4px 8px;background:${b.tagBg || 'rgba(0,0,0,0.3)'};border-radius:4px;display:flex;align-items:center;gap:4px;z-index:3">
                        <span class="material-symbols-outlined" style="font-size:12px;color:${b.tagColor || 'white'}">${b.tagIcon}</span>
                        <span style="font-size:10px;font-weight:800;color:${b.tagColor || 'white'}">${b.tagText}</span>
                    </div>
                    <div style="position:relative;z-index:2">
                        <h2 style="font-family:'Montserrat',sans-serif;font-weight:900;font-size:28px;line-height:1.1;margin-bottom:8px;color:white;text-transform:uppercase">${b.titleHtml}</h2>
                        <p style="font-size:12px;color:rgba(255,255,255,.6);margin-bottom:20px">${b.subHtml}</p>
                        <button class="btn-primary" style="width:fit-content;padding:10px 24px;border-radius:20px;font-size:12px;font-weight:800;${btnBg}" onclick="${b.btnAction}">${b.btnText}</button>
                    </div>
                </div>`;
            }).join('');

            // Re-init dots
            var dots = document.getElementById('heroDots');
            if (dots) {
                dots.innerHTML = banners.map(function (_, i) {
                    return `<div class="hero-dot" style="width:8px;height:8px;border-radius:50%;background:rgba(255,255,255,.3);transition:all .3s" onclick="goSlide(${i})"></div>`;
                }).join('');
            }
            goSlide(0);
            // Restart auto-play timer every time banners are rebuilt
            if (typeof initCarousel === 'function') initCarousel();
        }
        function getBanners() {
            return [
                {
                    tagIcon: 'local_fire_department',
                    tagText: T.hot || 'HOT',
                    tagColor: '#ff416c',
                    tagBg: 'rgba(255, 65, 108, 0.1)',
                    titleHtml: 'RUBY <span style="color:var(--red)">JACKPOT</span>',
                    subHtml: T.heroSub || 'Win up to 10,000x your bet!',
                    btnText: T.playNow || 'PLAY NOW',
                    btnAction: 'nav(\'game\')',
                    bgStyle: 'linear-gradient(135deg, #1a1a1a 0%, #121212 100%)'
                },
                {
                    tagIcon: 'rocket_launch',
                    tagText: 'NEW',
                    tagColor: '#38ef7d',
                    tagBg: 'rgba(56, 239, 125, 0.1)',
                    titleHtml: 'CRASH <span style="color:#38ef7d">ROCKET</span>',
                    subHtml: 'Multiply your coins in real-time!',
                    btnText: 'TRY NOW',
                    btnAction: 'nav(\'crash\')',
                    bgStyle: 'linear-gradient(135deg, #121212 0%, #1a1a1a 100%)'
                },
                {
                    tagIcon: 'casino',
                    tagText: 'NEW',
                    tagColor: '#FFD700',
                    tagBg: 'rgba(255, 215, 0, 0.1)',
                    titleHtml: 'GALACTIC <span style="color:#FFD700">PLINKO</span>',
                    subHtml: 'Drop the ball and win big rewards!',
                    btnText: 'PLAY NOW',
                    btnAction: 'nav(\'plinko\')',
                    bgStyle: 'linear-gradient(135deg, #1a1a1a 0%, #000 100%)'
                }
            ];
        }
        const tg = window.Telegram.WebApp; tg.ready(); tg.expand();
        try { tg.requestFullscreen(); } catch (e) {}
        function _applyTgInsets() {
            // Sum both: device notch + TG chrome overlay (close/minimize buttons)
            var deviceTop = (tg.safeAreaInset && tg.safeAreaInset.top) || 0;
            var chromeTop = (tg.contentSafeAreaInset && tg.contentSafeAreaInset.top) || 0;
            var total = deviceTop + chromeTop;
            console.log('[TG-INSETS] deviceTop=' + deviceTop + ' chromeTop=' + chromeTop + ' total=' + total + ' isFullscreen=' + tg.isFullscreen);
            if (total > 0) {
                document.documentElement.style.setProperty('--tg-safe-top', total + 'px');
            }
            // Sync --header-h to actual rendered header height after padding applied
            var hdr = document.getElementById('mainHeader');
            if (hdr && hdr.offsetHeight > 0) {
                document.documentElement.style.setProperty('--header-h', hdr.offsetHeight + 'px');
            }
        }
        _applyTgInsets();
        try { tg.onEvent('safeAreaChanged', _applyTgInsets); } catch (e) {}
        try { tg.onEvent('contentSafeAreaChanged', _applyTgInsets); } catch (e) {}
        try { tg.onEvent('fullscreenChanged', _applyTgInsets); } catch (e) {}
        // Re-sync after layout settles (fullscreen transition may delay env() updates)
        setTimeout(_applyTgInsets, 200);
        setTimeout(_applyTgInsets, 800);
        try { tg.setHeaderColor('#121212'); tg.setBackgroundColor('#121212') } catch (e) { }
        const P = new URLSearchParams(location.search);
        const API = P.get('api') || "https://lucky-slots-production.up.railway.app";
        const BOT = P.get('bot') || "testplcas_bot";
        const LANG = P.get('lang') || 'en';
        const UID = P.get('uid') || '';
        const TOK = P.get('token') || '';

        /* === LOCALIZATION === */
        const LC = {
            pl: { home: "Home", games: "Gry", bonuses: "Bonusy", wallet: "Portfel", profile: "Profil", spin: "ZAKRÄ˜Ä†", deposit: "DEPOZYT", searchPlaceholder: "Szukaj gier...", categories: "KATEGORIE", viewAll: "ZOBACZ WSZYSTKO", trending: "NA TOPIE", playNow: "GRAJ TERAZ", hot: "GORÄ„CE", heroTitle: "RUBY JACKPOT", heroSub: "5,000 Å¼etonÃ³w w puli nagrÃ³d", wheel: "KoÅ‚o Dnia", wheelSub: "KrÄ™Ä‡ za darmowe monety!", wheelSpin: "KRÄ˜Ä†!", collect: "ODBIERZ", bonusRound: "ðŸŽ° RUNDA BONUSOWA ðŸŽ°", spinL: "SPIN", winL: "WYGRANA", buyBonus: "Kup Bonus", slotName: "Ruby Slots", slotTag: "GORÄ„CE", crashName: "Crash", diceName: "KoÅ›ci", mineName: "Miny", coinName: "Coin Flip", rouletteName: "Ruletka", blackjackName: "Blackjack", comingTag: "WKRÃ“TCE", freeSpins: "Darmowe spiny", noMoney: "Brak Å›rodkÃ³w!", noMoneyDesc: "DoÅ‚aduj konto Å¼eby kontynuowaÄ‡ grÄ™", depositBtn: "DoÅ‚aduj", cancelBtn: "Anuluj", lose: "Brak wygranej", win: "WYGRANA", totalBalance: "ÅÄ„CZNY BALANS", withdraw: "WYPÅATA", transHistory: "Historia transakcji", selectPkg: "WYBIERZ PAKIET", bonusTitle: "Bonusy", exclusive: "EKSKLUZYWNE", bfTitle: "100% Bonus od Depozytu", bfDesc: "PodwÃ³j swojÄ… pierwszÄ… wpÅ‚atÄ™. Natychmiastowe dodanie.", bfTimer: "Wygasa za 24h", wager: "STAWKA", activate: "Aktywuj", freeSpinsTitle: "50 Darmowych SpinÃ³w", freeSpinsDesc: "Do Ruby Slots. Bez depozytu dla nowych graczy.", claimNow: "Odbierz", cashbackTitle: "Tygodniowy Cashback", cashbackDesc: "Odbierz 10% zwrotu co poniedziaÅ‚ek. VIP do 20%.", joinClub: "DoÅ‚Ä…cz", vipTitle: "Diamentowy VIP", vipDesc: "Odblokuj ekskluzywne turnieje.", inviteEarn: "ZaproÅ› i Zarabiaj", inviteDesc: "Podziel siÄ™ linkiem i zdobÄ…dÅº 10 Å¼etonÃ³w za kaÅ¼dego znajomego.", tapCopy: "NACIÅšNIJ ABY SKOPIOWAÄ†", copy: "Kopiuj", totalRefs: "Zaproszonych", earnedCoins: "Zarobione Å¼etony", howItWorks: "Jak to dziaÅ‚a", step1T: "Podziel siÄ™ ze znajomymi", step1D: "WyÅ›lij link przez Telegram lub social media.", step2T: "Znajomi zaczynajÄ… graÄ‡", step2D: "Gdy siÄ™ zarejestrujÄ…, obaj dostajecie bonus.", step3T: "Zbieraj Nagrody", step3D: "Otrzymaj 10 Å¼etonÃ³w za kaÅ¼dego zaproszonego.", shareNow: "UdostÄ™pnij Link", wins: "WYGRANE", losses: "PRZEGRANE", total: "ÅÄ„CZNIE", referralProgram: "Program PolecajÄ…cy", inviteFriends: "ZaproÅ› znajomych i zarabiaj", settings: "Ustawienia", security: "BezpieczeÅ„stwo", support: "Pomoc", signOut: "Wyloguj", currentXp: "Aktualne XP", level: "Poziom", slots: "Sloty", live: "Na Å¼ywo", crash: "Crash", table: "StoÅ‚owe", jackpotLabel: "WIELKA JACKPOT", grandJackpot: "GRAND JACKPOT", coins: "Å¼etonÃ³w", betAmountLabel: "KWOTA ZAKÅADU", wMethodLabel: "METODA PÅATNOÅšCI", pmCardTitle: "Karta bankowa", favs: "Ulubione", noFavs: "Brak ulubionych", searchPrompt: "Wpisz nazwÄ™ gry", noResults: "Nie znaleziono", filterAll: "Wszystkie", filterDep: "Depozyt", filterFS: "Darmowe Spiny", filterVIP: "VIP", filterCB: "Cashback", creatingInv: "Tworzenie faktury...", paySuccess: "PÅ‚atnoÅ›Ä‡ przeszÅ‚a! +", payFail: "BÅ‚Ä…d pÅ‚atnoÅ›ci", creatingCrypto: "Tworzenie faktury CryptoBot...", creatingPay: "Tworzenie pÅ‚atnoÅ›ci...", cardSoon: "PÅ‚atnoÅ›Ä‡ kartÄ… wkrÃ³tce dostÄ™pna", langLabel: "JÄ™zyk" },
            ua: { home: "Ð”Ð¾Ð¼iÐ²", games: "Ð†Ð³Ñ€Ð¸", bonuses: "Ð‘Ð¾Ð½ÑƒÑÐ¸", wallet: "Ð“Ð°Ð¼Ð°Ð½ÐµÑ†ÑŒ", profile: "ÐŸÑ€Ð¾Ñ„Ñ–Ð»ÑŒ", spin: "Ð“Ð ÐÐ¢Ð˜", deposit: "Ð”Ð•ÐŸÐžÐ—Ð˜Ð¢", searchPlaceholder: "ÐŸÐ¾ÑˆÑƒÐº Ñ–Ð³Ð¾Ñ€...", categories: "ÐšÐÐ¢Ð•Ð“ÐžÐ Ð†Ð‡", viewAll: "Ð‘ÐÐ§Ð˜Ð¢Ð˜ Ð’Ð¡Ð•", trending: "Ð’ Ð¢Ð Ð•ÐÐ”Ð†", playNow: "Ð“Ð ÐÐ¢Ð˜ Ð—ÐÐ ÐÐ—", hot: "Ð“ÐÐ Ð¯Ð§Ð•", heroTitle: "RUBY JACKPOT", heroSub: "5,000 Ð¶ÐµÑ‚Ð¾Ð½Ñ–Ð² Ñƒ Ð¿Ñ€Ð¸Ð·Ð¾Ð²Ð¾Ð¼Ñƒ Ð¿ÑƒÐ»Ñ–", wheel: "ÐšÐ¾Ð»ÐµÑÐ¾ Ð”Ð½Ñ", wheelSub: "ÐšÑ€ÑƒÑ‚Ð¸ Ð·Ð° Ð±ÐµÐ·ÐºÐ¾ÑˆÑ‚Ð¾Ð²Ð½Ñ– Ð¼Ð¾Ð½ÐµÑ‚Ð¸!", wheelSpin: "ÐšÐ Ð£Ð¢Ð˜!", collect: "Ð—ÐÐ‘Ð ÐÐ¢Ð˜", bonusRound: "ðŸŽ° Ð‘ÐžÐÐ£Ð¡ Ð ÐÐ£ÐÐ” ðŸŽ°", spinL: "Ð¡ÐŸÐ†Ð", winL: "Ð’Ð˜Ð“Ð ÐÐ¨", buyBonus: "ÐšÑƒÐ¿Ð¸Ñ‚Ð¸ Ð‘Ð¾Ð½ÑƒÑ", slotName: "Ruby Slots", slotTag: "Ð“ÐÐ Ð¯Ð§Ð•", crashName: "Crash", diceName: "ÐšÐ¾ÑÑ‚Ñ–", mineName: "ÐœÑ–Ð½Ð¸", coinName: "ÐœÐ¾Ð½ÐµÑ‚ÐºÐ°", rouletteName: "Ð ÑƒÐ»ÐµÑ‚ÐºÐ°", blackjackName: "Ð‘Ð»ÐµÐºÐ´Ð¶ÐµÐº", comingTag: "ÐÐ•Ð—ÐÐ‘ÐÐ ÐžÐœ", freeSpins: "Ð‘ÐµÐ·ÐºÐ¾ÑˆÑ‚Ð¾Ð²Ð½Ñ– ÑÐ¿Ñ–Ð½Ð¸", noMoney: "ÐÐµÐ´Ð¾ÑÑ‚Ð°Ñ‚Ð½ÑŒÐ¾ ÐºÐ¾ÑˆÑ‚Ñ–Ð²!", noMoneyDesc: "ÐŸÐ¾Ð¿Ð¾Ð²Ð½Ñ–Ñ‚ÑŒ Ñ€Ð°Ñ…ÑƒÐ½Ð¾Ðº", depositBtn: "ÐŸÐ¾Ð¿Ð¾Ð²Ð½Ð¸Ñ‚Ð¸", cancelBtn: "Ð¡ÐºÐ°ÑÑƒÐ²Ð°Ñ‚Ð¸", lose: "Ð‘ÐµÐ· Ð²Ð¸Ð³Ñ€Ð°ÑˆÑƒ", win: "Ð’Ð˜Ð“Ð ÐÐ¨", totalBalance: "Ð—ÐÐ“ÐÐ›Ð¬ÐÐ˜Ð™ Ð‘ÐÐ›ÐÐÐ¡", withdraw: "Ð’Ð˜Ð’Ð•Ð¡Ð¢Ð˜", transHistory: "Ð†ÑÑ‚Ð¾Ñ€Ñ–Ñ Ñ‚Ñ€Ð°Ð½Ð·Ð°ÐºÑ†Ñ–Ð¹", selectPkg: "ÐžÐ‘Ð•Ð Ð†Ð¢Ð¬ ÐŸÐÐšÐ•Ð¢", bonusTitle: "Ð‘Ð¾Ð½ÑƒÑÐ¸", exclusive: "Ð•ÐšÐ¡ÐšÐ›Ð®Ð—Ð˜Ð’ÐÐž", bfTitle: "100% Ð‘Ð¾Ð½ÑƒÑ Ð½Ð° Ð”ÐµÐ¿Ð¾Ð·Ð¸Ñ‚", bfDesc: "ÐŸÐ¾Ð´Ð²Ñ–Ð¹Ñ‚Ðµ ÑÐ²Ñ–Ð¹ Ð¿ÐµÑ€ÑˆÐ¸Ð¹ Ð´ÐµÐ¿Ð¾Ð·Ð¸Ñ‚.", bfTimer: "Ð—Ð°ÐºÑ–Ð½Ñ‡ÑƒÑ”Ñ‚ÑŒÑÑ Ñ‡ÐµÑ€ÐµÐ· 24Ð³", wager: "Ð¡Ð¢ÐÐ’ÐšÐ", activate: "ÐÐºÑ‚Ð¸Ð²ÑƒÐ²Ð°Ñ‚Ð¸", freeSpinsTitle: "50 Ð‘ÐµÐ·ÐºÐ¾ÑˆÑ‚Ð¾Ð²Ð½Ð¸Ñ… Ð¡Ð¿Ñ–Ð½Ñ–Ð²", freeSpinsDesc: "Ð”Ð»Ñ Ruby Slots. Ð‘ÐµÐ· Ð´ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ñƒ Ð´Ð»Ñ Ð½Ð¾Ð²Ð¸Ñ… Ð³Ñ€Ð°Ð²Ñ†Ñ–Ð².", claimNow: "ÐžÑ‚Ñ€Ð¸Ð¼Ð°Ñ‚Ð¸", cashbackTitle: "Ð©Ð¾Ñ‚Ð¸Ð¶Ð½ÐµÐ²Ð¸Ð¹ ÐšÐµÑˆÐ±ÐµÐº", cashbackDesc: "ÐžÑ‚Ñ€Ð¸Ð¼Ð°Ð¹Ñ‚Ðµ 10% Ð¿Ð¾Ð²ÐµÑ€Ð½ÐµÐ½Ð½Ñ Ñ‰Ð¾Ð¿Ð¾Ð½ÐµÐ´Ñ–Ð»ÐºÐ°.", joinClub: "ÐŸÑ€Ð¸Ñ”Ð´Ð½Ð°Ñ‚Ð¸ÑÑ", vipTitle: "Ð”Ñ–Ð°Ð¼Ð°Ð½Ñ‚Ð¾Ð²Ð¸Ð¹ VIP", vipDesc: "Ð Ð¾Ð·Ð±Ð»Ð¾ÐºÑƒÐ¹Ñ‚Ðµ ÐµÐºÑÐºÐ»ÑŽÐ·Ð¸Ð²Ð½Ñ– Ñ‚ÑƒÑ€Ð½Ñ–Ñ€Ð¸.", inviteEarn: "Ð—Ð°Ð¿Ñ€Ð¾ÑˆÑƒÐ¹ Ñ‚Ð° Ð—Ð°Ñ€Ð¾Ð±Ð»ÑÐ¹", inviteDesc: "ÐŸÐ¾Ð´Ñ–Ð»Ð¸ÑÑŒ Ð¿Ð¾ÑÐ¸Ð»Ð°Ð½Ð½ÑÐ¼ Ñ‚Ð° Ð¾Ñ‚Ñ€Ð¸Ð¼Ð°Ð¹ 10 Ð¶ÐµÑ‚Ð¾Ð½Ñ–Ð² Ð·Ð° ÐºÐ¾Ð¶Ð½Ð¾Ð³Ð¾ Ð´Ñ€ÑƒÐ³Ð°.", tapCopy: "ÐÐÐ¢Ð˜Ð¡ÐÐ†Ð¢Ð¬ Ð©ÐžÐ‘Ð˜ Ð¡ÐšÐžÐŸÐ†Ð®Ð’ÐÐ¢Ð˜", copy: "Ð¡ÐºÐ¾Ð¿Ñ–ÑŽÐ²Ð°Ñ‚Ð¸", totalRefs: "Ð—Ð°Ð¿Ñ€Ð¾ÑˆÐµÐ½Ð¾", earnedCoins: "Ð—Ð°Ñ€Ð¾Ð±Ð»ÐµÐ½Ð¾ Ð¶ÐµÑ‚Ð¾Ð½Ñ–Ð²", howItWorks: "Ð¯Ðº Ñ†Ðµ Ð¿Ñ€Ð°Ñ†ÑŽÑ”", step1T: "ÐŸÐ¾Ð´Ñ–Ð»Ð¸ÑÑŒ Ð· Ð´Ñ€ÑƒÐ·ÑÐ¼Ð¸", step1D: "Ð’Ñ–Ð´Ð¿Ñ€Ð°Ð² Ð¿Ð¾ÑÐ¸Ð»Ð°Ð½Ð½Ñ Ñ‡ÐµÑ€ÐµÐ· Telegram.", step2T: "Ð”Ñ€ÑƒÐ·Ñ– Ð¿Ð¾Ñ‡Ð¸Ð½Ð°ÑŽÑ‚ÑŒ Ð³Ñ€Ð°Ñ‚Ð¸", step2D: "ÐšÐ¾Ð»Ð¸ Ð²Ð¾Ð½Ð¸ Ð·Ð°Ñ€ÐµÑ”ÑÑ‚Ñ€ÑƒÑŽÑ‚ÑŒÑÑ, Ð¾Ð±Ð¸Ð´Ð²Ð° Ð¾Ñ‚Ñ€Ð¸Ð¼Ð°ÑŽÑ‚ÑŒ Ð±Ð¾Ð½ÑƒÑ.", step3T: "Ð—Ð±Ð¸Ñ€Ð°Ð¹ ÐÐ°Ð³Ð¾Ñ€Ð¾Ð´Ð¸", step3D: "ÐžÑ‚Ñ€Ð¸Ð¼Ð°Ð¹ 10 Ð¶ÐµÑ‚Ð¾Ð½Ñ–Ð² Ð·Ð° ÐºÐ¾Ð¶Ð½Ð¾Ð³Ð¾.", shareNow: "ÐŸÐ¾Ð´Ñ–Ð»Ð¸Ñ‚Ð¸ÑÑ", wins: "Ð’Ð˜Ð“Ð ÐÐ¨Ð†", losses: "ÐŸÐ ÐžÐ“Ð ÐÐ¨Ð†", total: "Ð’Ð¡Ð¬ÐžÐ“Ðž", referralProgram: "Ð ÐµÑ„ÐµÑ€Ð°Ð»ÑŒÐ½Ð° ÐŸÑ€Ð¾Ð³Ñ€Ð°Ð¼Ð°", inviteFriends: "Ð—Ð°Ð¿Ñ€Ð¾ÑˆÑƒÐ¹ Ð´Ñ€ÑƒÐ·Ñ–Ð² Ñ‚Ð° Ð·Ð°Ñ€Ð¾Ð±Ð»ÑÐ¹", settings: "ÐÐ°Ð»Ð°ÑˆÑ‚ÑƒÐ²Ð°Ð½Ð½Ñ", security: "Ð‘ÐµÐ·Ð¿ÐµÐºÐ°", support: "ÐŸÑ–Ð´Ñ‚Ñ€Ð¸Ð¼ÐºÐ°", signOut: "Ð’Ð¸Ð¹Ñ‚Ð¸", currentXp: "ÐŸÐ¾Ñ‚Ð¾Ñ‡Ð½Ð¸Ð¹ XP", level: "Ð Ñ–Ð²ÐµÐ½ÑŒ", slots: "Ð¡Ð»Ð¾Ñ‚Ð¸", live: "Ð›Ð°Ð¹Ð²", crash: "Crash", table: "Ð¡Ñ‚Ð¾Ð»Ð¸", jackpotLabel: "Ð’Ð•Ð›Ð˜ÐšÐ˜Ð™ Ð”Ð–Ð•ÐšÐŸÐžÐ¢", grandJackpot: "GRAND JACKPOT", coins: "Ð¶ÐµÑ‚Ð¾Ð½Ñ–Ð²", betAmountLabel: "Ð¡Ð£ÐœÐ Ð¡Ð¢ÐÐ’ÐšÐ˜", wMethodLabel: "ÐœÐ•Ð¢ÐžÐ” ÐžÐŸÐ›ÐÐ¢Ð˜", pmCardTitle: "Ð‘Ð°Ð½ÐºÑ–Ð²ÑÑŒÐºÐ° ÐºÐ°Ñ€Ñ‚ÐºÐ°", favs: "ÐžÐ±Ñ€Ð°Ð½Ñ–", noFavs: "ÐÐµÐ¼Ð°Ñ” Ð¾Ð±Ñ€Ð°Ð½Ð¸Ñ… Ñ–Ð³Ð¾Ñ€", searchPrompt: "Ð’Ð²ÐµÐ´Ñ–Ñ‚ÑŒ Ð½Ð°Ð·Ð²Ñƒ Ð³Ñ€Ð¸", noResults: "ÐÑ–Ñ‡Ð¾Ð³Ð¾ Ð½Ðµ Ð·Ð½Ð°Ð¹Ð´ÐµÐ½Ð¾", filterAll: "Ð’ÑÐµ", filterDep: "Ð”ÐµÐ¿Ð¾Ð·Ð¸Ñ‚", filterFS: "Ð¤Ñ€Ñ–ÑÐ¿Ñ–Ð½Ð¸", filterVIP: "VIP", filterCB: "ÐšÐµÑˆÐ±ÐµÐº", creatingInv: "Ð¡Ñ‚Ð²Ð¾Ñ€ÑŽÑ”Ð¼Ð¾ Ñ€Ð°Ñ…ÑƒÐ½Ð¾Ðº...", paySuccess: "ÐžÐ¿Ð»Ð°Ñ‚Ð° Ð¿Ñ€Ð¾Ð¹ÑˆÐ»Ð°! +", payFail: "ÐŸÐ¾Ð¼Ð¸Ð»ÐºÐ° Ð¾Ð¿Ð»Ð°Ñ‚Ð¸", creatingCrypto: "Ð¡Ñ‚Ð²Ð¾Ñ€ÑŽÑ”Ð¼Ð¾ Ñ€Ð°Ñ…ÑƒÐ½Ð¾Ðº CryptoBot...", creatingPay: "Ð¡Ñ‚Ð²Ð¾Ñ€ÑŽÑ”Ð¼Ð¾ Ð¿Ð»Ð°Ñ‚Ñ–Ð¶...", cardSoon: "ÐžÐ¿Ð»Ð°Ñ‚Ð° ÐºÐ°Ñ€Ñ‚ÐºÐ¾ÑŽ ÑÐºÐ¾Ñ€Ð¾ Ð±ÑƒÐ´Ðµ Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð½Ð°", langLabel: "ÐœÐ¾Ð²Ð°" },
            ru: { home: "Ð“Ð»Ð°Ð²Ð½Ð°Ñ", games: "Ð˜Ð³Ñ€Ñ‹", bonuses: "Ð‘Ð¾Ð½ÑƒÑÑ‹", wallet: "ÐšÐ¾ÑˆÐµÐ»Ñ‘Ðº", profile: "ÐŸÑ€Ð¾Ñ„Ð¸Ð»ÑŒ", spin: "Ð˜Ð“Ð ÐÐ¢Ð¬", deposit: "Ð”Ð•ÐŸÐžÐ—Ð˜Ð¢", searchPlaceholder: "ÐŸÐ¾Ð¸ÑÐº Ð¸Ð³Ñ€...", categories: "ÐšÐÐ¢Ð•Ð“ÐžÐ Ð˜Ð˜", viewAll: "Ð’Ð¡Ð•", trending: "Ð’ Ð¢Ð Ð•ÐÐ”Ð•", playNow: "Ð˜Ð“Ð ÐÐ¢Ð¬", hot: "Ð“ÐžÐ Ð¯Ð§Ð•Ð•", heroTitle: "RUBY JACKPOT", heroSub: "5,000 Ð¶ÐµÑ‚Ð¾Ð½Ð¾Ð² Ð² Ð¿Ñ€Ð¸Ð·Ð¾Ð²Ð¾Ð¼ Ð¿ÑƒÐ»Ðµ", wheel: "ÐšÐ¾Ð»ÐµÑÐ¾ Ð”Ð½Ñ", wheelSub: "ÐšÑ€ÑƒÑ‚Ð¸ Ð·Ð° Ð±ÐµÑÐ¿Ð»Ð°Ñ‚Ð½Ñ‹Ðµ Ð¼Ð¾Ð½ÐµÑ‚Ñ‹!", wheelSpin: "ÐšÐ Ð£Ð¢Ð˜!", collect: "Ð—ÐÐ‘Ð ÐÐ¢Ð¬", bonusRound: "ðŸŽ° Ð‘ÐžÐÐ£Ð¡ Ð ÐÐ£ÐÐ” ðŸŽ°", spinL: "Ð¡ÐŸÐ˜Ð", winL: "Ð’Ð«Ð˜Ð“Ð Ð«Ð¨", buyBonus: "ÐšÑƒÐ¿Ð¸Ñ‚ÑŒ Ð‘Ð¾Ð½ÑƒÑ", slotName: "Ruby Slots", slotTag: "Ð“ÐžÐ Ð¯Ð§Ð•Ð•", crashName: "Crash", diceName: "ÐšÐ¾ÑÑ‚Ð¸", mineName: "ÐœÐ¸Ð½Ñ‹", coinName: "ÐœÐ¾Ð½ÐµÑ‚ÐºÐ°", rouletteName: "Ð ÑƒÐ»ÐµÑ‚ÐºÐ°", blackjackName: "Ð‘Ð»ÐµÐºÐ´Ð¶ÐµÐº", comingTag: "Ð¡ÐšÐžÐ Ðž", freeSpins: "Ð‘ÐµÑÐ¿Ð»Ð°Ñ‚Ð½Ñ‹Ðµ ÑÐ¿Ð¸Ð½Ñ‹", noMoney: "ÐÐµÐ´Ð¾ÑÑ‚Ð°Ñ‚Ð¾Ñ‡Ð½Ð¾ ÑÑ€ÐµÐ´ÑÑ‚Ð²!", noMoneyDesc: "ÐŸÐ¾Ð¿Ð¾Ð»Ð½Ð¸Ñ‚Ðµ Ð±Ð°Ð»Ð°Ð½Ñ Ñ‡Ñ‚Ð¾Ð±Ñ‹ Ð¿Ñ€Ð¾Ð´Ð¾Ð»Ð¶Ð¸Ñ‚ÑŒ", depositBtn: "ÐŸÐ¾Ð¿Ð¾Ð»Ð½Ð¸Ñ‚ÑŒ", cancelBtn: "ÐžÑ‚Ð¼ÐµÐ½Ð°", lose: "ÐÐµÑ‚ Ð²Ñ‹Ð¸Ð³Ñ€Ñ‹ÑˆÐ°", win: "Ð’Ð«Ð˜Ð“Ð Ð«Ð¨", totalBalance: "ÐžÐ‘Ð©Ð˜Ð™ Ð‘ÐÐ›ÐÐÐ¡", withdraw: "Ð’Ð«Ð’Ð•Ð¡Ð¢Ð˜", transHistory: "Ð˜ÑÑ‚Ð¾Ñ€Ð¸Ñ Ñ‚Ñ€Ð°Ð½Ð·Ð°ÐºÑ†Ð¸Ð¹", selectPkg: "Ð’Ð«Ð‘Ð•Ð Ð˜Ð¢Ð• ÐŸÐÐšÐ•Ð¢", bonusTitle: "Ð‘Ð¾Ð½ÑƒÑÑ‹", exclusive: "Ð­ÐšÐ¡ÐšÐ›Ð®Ð—Ð˜Ð’ÐÐž", bfTitle: "100% Ð‘Ð¾Ð½ÑƒÑ Ð½Ð° Ð”ÐµÐ¿Ð¾Ð·Ð¸Ñ‚", bfDesc: "Ð£Ð´Ð²Ð¾Ð¹Ñ‚Ðµ ÑÐ²Ð¾Ð¹ Ð¿ÐµÑ€Ð²Ñ‹Ð¹ Ð´ÐµÐ¿Ð¾Ð·Ð¸Ñ‚. ÐœÐ³Ð½Ð¾Ð²ÐµÐ½Ð½Ð¾Ðµ Ð½Ð°Ñ‡Ð¸ÑÐ»ÐµÐ½Ð¸Ðµ.", bfTimer: "Ð˜ÑÑ‚ÐµÐºÐ°ÐµÑ‚ Ñ‡ÐµÑ€ÐµÐ· 24Ñ‡", wager: "Ð¡Ð¢ÐÐ’ÐšÐ", activate: "ÐÐºÑ‚Ð¸Ð²Ð¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ", freeSpinsTitle: "50 Ð‘ÐµÑÐ¿Ð»Ð°Ñ‚Ð½Ñ‹Ñ… Ð¡Ð¿Ð¸Ð½Ð¾Ð²", freeSpinsDesc: "Ð”Ð»Ñ Ruby Slots. Ð‘ÐµÐ· Ð´ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð° Ð´Ð»Ñ Ð½Ð¾Ð²Ñ‹Ñ… Ð¸Ð³Ñ€Ð¾ÐºÐ¾Ð².", claimNow: "ÐŸÐ¾Ð»ÑƒÑ‡Ð¸Ñ‚ÑŒ", cashbackTitle: "Ð•Ð¶ÐµÐ½ÐµÐ´ÐµÐ»ÑŒÐ½Ñ‹Ð¹ ÐšÑÑˆÐ±ÐµÐº", cashbackDesc: "ÐŸÐ¾Ð»ÑƒÑ‡Ð¸Ñ‚Ðµ 10% Ð²Ð¾Ð·Ð²Ñ€Ð°Ñ‚ ÐºÐ°Ð¶Ð´Ñ‹Ð¹ Ð¿Ð¾Ð½ÐµÐ´ÐµÐ»ÑŒÐ½Ð¸Ðº. VIP Ð´Ð¾ 20%.", joinClub: "Ð’ÑÑ‚ÑƒÐ¿Ð¸Ñ‚ÑŒ", vipTitle: "Ð‘Ñ€Ð¸Ð»Ð»Ð¸Ð°Ð½Ñ‚Ð¾Ð²Ñ‹Ð¹ VIP", vipDesc: "Ð Ð°Ð·Ð±Ð»Ð¾ÐºÐ¸Ñ€ÑƒÐ¹Ñ‚Ðµ ÑÐºÑÐºÐ»ÑŽÐ·Ð¸Ð²Ð½Ñ‹Ðµ Ñ‚ÑƒÑ€Ð½Ð¸Ñ€Ñ‹.", inviteEarn: "ÐŸÑ€Ð¸Ð³Ð»Ð°ÑˆÐ°Ð¹ Ð¸ Ð—Ð°Ñ€Ð°Ð±Ð°Ñ‚Ñ‹Ð²Ð°Ð¹", inviteDesc: "ÐŸÐ¾Ð´ÐµÐ»Ð¸ÑÑŒ ÑÑÑ‹Ð»ÐºÐ¾Ð¹ Ð¸ Ð¿Ð¾Ð»ÑƒÑ‡Ð¸ 10 Ð¶ÐµÑ‚Ð¾Ð½Ð¾Ð² Ð·Ð° ÐºÐ°Ð¶Ð´Ð¾Ð³Ð¾ Ð´Ñ€ÑƒÐ³Ð°.", tapCopy: "ÐÐÐ–ÐœÐ˜Ð¢Ð• Ð§Ð¢ÐžÐ‘Ð« Ð¡ÐšÐžÐŸÐ˜Ð ÐžÐ’ÐÐ¢Ð¬", copy: "Ð¡ÐºÐ¾Ð¿Ð¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ", totalRefs: "ÐŸÑ€Ð¸Ð³Ð»Ð°ÑˆÐµÐ½Ð¾", earnedCoins: "Ð—Ð°Ñ€Ð°Ð±Ð¾Ñ‚Ð°Ð½Ð¾ Ð¶ÐµÑ‚Ð¾Ð½Ð¾Ð²", howItWorks: "ÐšÐ°Ðº ÑÑ‚Ð¾ Ñ€Ð°Ð±Ð¾Ñ‚Ð°ÐµÑ‚", step1T: "ÐŸÐ¾Ð´ÐµÐ»Ð¸ÑÑŒ Ñ Ð´Ñ€ÑƒÐ·ÑŒÑÐ¼Ð¸", step1D: "ÐžÑ‚Ð¿Ñ€Ð°Ð²ÑŒ ÑÑÑ‹Ð»ÐºÑƒ Ñ‡ÐµÑ€ÐµÐ· Telegram Ð¸Ð»Ð¸ ÑÐ¾Ñ†ÑÐµÑ‚Ð¸.", step2T: "Ð”Ñ€ÑƒÐ·ÑŒÑ Ð½Ð°Ñ‡Ð¸Ð½Ð°ÑŽÑ‚ Ð¸Ð³Ñ€Ð°Ñ‚ÑŒ", step2D: "ÐšÐ¾Ð³Ð´Ð° Ð¾Ð½Ð¸ Ð·Ð°Ñ€ÐµÐ³Ð¸ÑÑ‚Ñ€Ð¸Ñ€ÑƒÑŽÑ‚ÑÑ, Ð¾Ð±Ð° Ð¿Ð¾Ð»ÑƒÑ‡Ð°Ñ‚ Ð±Ð¾Ð½ÑƒÑ.", step3T: "Ð¡Ð¾Ð±Ð¸Ñ€Ð°Ð¹ ÐÐ°Ð³Ñ€Ð°Ð´Ñ‹", step3D: "ÐŸÐ¾Ð»ÑƒÑ‡Ð¸ 10 Ð¶ÐµÑ‚Ð¾Ð½Ð¾Ð² Ð·Ð° ÐºÐ°Ð¶Ð´Ð¾Ð³Ð¾ Ð¿Ñ€Ð¸Ð³Ð»Ð°ÑˆÑ‘Ð½Ð½Ð¾Ð³Ð¾.", shareNow: "ÐŸÐ¾Ð´ÐµÐ»Ð¸Ñ‚ÑŒÑÑ", wins: "ÐŸÐžÐ‘Ð•Ð”Ð«", losses: "ÐŸÐžÐ ÐÐ–Ð•ÐÐ˜Ð¯", total: "Ð’Ð¡Ð•Ð“Ðž", referralProgram: "Ð ÐµÑ„ÐµÑ€Ð°Ð»ÑŒÐ½Ð°Ñ ÐŸÑ€Ð¾Ð³Ñ€Ð°Ð¼Ð¼Ð°", inviteFriends: "ÐŸÑ€Ð¸Ð³Ð»Ð°ÑˆÐ°Ð¹ Ð´Ñ€ÑƒÐ·ÐµÐ¹ Ð¸ Ð·Ð°Ñ€Ð°Ð±Ð°Ñ‚Ñ‹Ð²Ð°Ð¹", settings: "ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ¸", security: "Ð‘ÐµÐ·Ð¾Ð¿Ð°ÑÐ½Ð¾ÑÑ‚ÑŒ", support: "ÐŸÐ¾Ð´Ð´ÐµÑ€Ð¶ÐºÐ°", signOut: "Ð’Ñ‹Ð¹Ñ‚Ð¸", currentXp: "Ð¢ÐµÐºÑƒÑ‰Ð¸Ð¹ XP", level: "Ð£Ñ€Ð¾Ð²ÐµÐ½ÑŒ", slots: "Ð¡Ð»Ð¾Ñ‚Ñ‹", live: "Ð›Ð°Ð¹Ð²", crash: "Crash", table: "Ð¡Ñ‚Ð¾Ð»Ñ‹", jackpotLabel: "Ð’Ð•Ð›Ð˜ÐšÐ˜Ð™ Ð”Ð–Ð•ÐšÐŸÐžÐ¢", grandJackpot: "GRAND JACKPOT", coins: "Ð¶ÐµÑ‚Ð¾Ð½Ð¾Ð²", betAmountLabel: "Ð¡Ð£ÐœÐœÐ Ð¡Ð¢ÐÐ’ÐšÐ˜", wMethodLabel: "ÐœÐ•Ð¢ÐžÐ” ÐžÐŸÐ›ÐÐ¢Ð«", pmCardTitle: "Ð‘Ð°Ð½ÐºÐ¾Ð²ÑÐºÐ°Ñ ÐºÐ°Ñ€Ñ‚Ð°", favs: "Ð˜Ð·Ð±Ñ€Ð°Ð½Ð½Ñ‹Ðµ", noFavs: "ÐÐµÑ‚ Ð¸Ð·Ð±Ñ€Ð°Ð½Ð½Ñ‹Ñ… Ð¸Ð³Ñ€", searchPrompt: "Ð’Ð²ÐµÐ´Ð¸Ñ‚Ðµ Ð½Ð°Ð·Ð²Ð°Ð½Ð¸Ðµ Ð¸Ð³Ñ€Ñ‹", noResults: "ÐÐ¸Ñ‡ÐµÐ³Ð¾ Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½Ð¾", filterAll: "Ð’ÑÐµ", filterDep: "Ð”ÐµÐ¿Ð¾Ð·Ð¸Ñ‚", filterFS: "Ð¤Ñ€Ð¸ÑÐ¿Ð¸Ð½Ñ‹", filterVIP: "VIP", filterCB: "ÐšÑÑˆÐ±ÐµÐº", creatingInv: "Ð¡Ð¾Ð·Ð´Ð°Ñ‘Ð¼ ÑÑ‡Ñ‘Ñ‚...", paySuccess: "ÐžÐ¿Ð»Ð°Ñ‚Ð° Ð¿Ñ€Ð¾ÑˆÐ»Ð°! +", payFail: "ÐžÑˆÐ¸Ð±ÐºÐ° Ð¾Ð¿Ð»Ð°Ñ‚Ñ‹", creatingCrypto: "Ð¡Ð¾Ð·Ð´Ð°Ñ‘Ð¼ ÑÑ‡Ñ‘Ñ‚ CryptoBot...", creatingPay: "Ð¡Ð¾Ð·Ð´Ð°Ñ‘Ð¼ Ð¿Ð»Ð°Ñ‚Ñ‘Ð¶...", cardSoon: "ÐžÐ¿Ð»Ð°Ñ‚Ð° ÐºÐ°Ñ€Ñ‚Ð¾Ð¹ ÑÐºÐ¾Ñ€Ð¾ Ð±ÑƒÐ´ÐµÑ‚ Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð½Ð°", langLabel: "Ð¯Ð·Ñ‹Ðº" },
            en: { home: "Home", games: "Games", bonuses: "Bonuses", wallet: "Wallet", profile: "Profile", spin: "SPIN", deposit: "DEPOSIT", searchPlaceholder: "Search games...", categories: "CATEGORIES", viewAll: "VIEW ALL", trending: "TRENDING NOW", playNow: "PLAY NOW", hot: "HOT", heroTitle: "RUBY JACKPOT", heroSub: "5,000 coins prize pool", wheel: "Daily Wheel", wheelSub: "Spin for free coins!", wheelSpin: "SPIN!", collect: "COLLECT", bonusRound: "ðŸŽ° BONUS ROUND ðŸŽ°", spinL: "SPIN", winL: "WIN", buyBonus: "Buy Bonus", slotName: "Ruby Slots", slotTag: "POPULAR", crashName: "Crash", diceName: "Dice", mineName: "Mines", coinName: "Coin Flip", rouletteName: "Roulette", blackjackName: "Blackjack", comingTag: "SOON", freeSpins: "Free spins", noMoney: "Not enough coins!", noMoneyDesc: "Top up your balance to keep playing", depositBtn: "Deposit", cancelBtn: "Cancel", lose: "No win", win: "WIN", totalBalance: "TOTAL BALANCE", withdraw: "WITHDRAW", transHistory: "View Transaction History", selectPkg: "SELECT PACKAGE", bonusTitle: "Bonuses", exclusive: "EXCLUSIVE", bfTitle: "100% Deposit Match", bfDesc: "Get up to 1 BTC on your first deposit. Double your playing money instantly.", bfTimer: "Expires in 24h", wager: "WAGER", activate: "Activate", freeSpinsTitle: "50 Free Spins", freeSpinsDesc: "Valid for Ruby Slots. No deposit required for new players.", claimNow: "Claim Now", cashbackTitle: "Weekly Cashback", cashbackDesc: "Get 10% back on all losses every Monday. VIP tiers get up to 20%.", joinClub: "Join Club", vipTitle: "Diamond VIP Status", vipDesc: "Unlock exclusive tournaments.", inviteEarn: "Invite & Earn", inviteDesc: "Share your link and earn <b>10 coins</b> for every friend who plays.", tapCopy: "TAP COPY TO SHARE", copy: "Copy", totalRefs: "Total Referrals", earnedCoins: "Earned Coins", howItWorks: "How it Works", step1T: "Share with friends", step1D: "Send your unique link via Telegram or social media.", step2T: "Friends start playing", step2D: "When they register, you both get bonus coins.", step3T: "Earn Rewards", step3D: "Get 10 coins for every friend who joins.", shareNow: "Share Link Now", wins: "WINS", losses: "LOSSES", total: "TOTAL", referralProgram: "Referral Program", inviteFriends: "Invite friends & earn rewards", settings: "Settings", security: "Security", support: "Support", signOut: "Sign Out", currentXp: "Current XP", level: "Level", slots: "Slots", live: "Live", crash: "Crash", table: "Table", jackpotLabel: "GRAND JACKPOT", grandJackpot: "GRAND JACKPOT", coins: "coins", betAmountLabel: "BET AMOUNT", wMethodLabel: "PAYMENT METHOD", pmCardTitle: "Bank Card", favs: "Favorites", noFavs: "No favorites yet", searchPrompt: "Type to search games", noResults: "No results found", filterAll: "All", filterDep: "Deposit", filterFS: "Free Spins", filterVIP: "VIP", filterCB: "Cashback", creatingInv: "Creating invoice...", paySuccess: "Payment successful! +", payFail: "Payment failed", creatingCrypto: "Creating CryptoBot invoice...", creatingPay: "Creating payment...", cardSoon: "Card payment coming soon", langLabel: "Language" }
        };
        const T = LC[LANG] || LC.en;
        const BSYM = ['ðŸ’', 'ðŸ‹', 'ðŸŠ', 'ðŸ‡', 'ðŸ«', 'ðŸ­', 'ðŸ¬', 'ðŸ’Ž'];
        const BONSYM = ['ðŸ‘‘', 'ðŸ’Ž', 'â­', 'â¤ï¸', 'ðŸ€', 'ðŸ§²', 'ðŸ’°', 'ðŸŒˆ'];
        let balance = null, freeSpins = 0, bet = 5, spinning = false, currentScreen = 'lobby';
        let currentLang = LANG;
        let activeWallet = 'usdt'; /* 'usdt' or 'stars' */

        /* === SPEED SYSTEM === */
        let speedMode = 1;
        const SPEED = {
            0: { ai: 120, af: 12, rd: 800, bf: 10, bp: 600, bmp: 500 },
            1: { ai: 70, af: 8, rd: 400, bf: 6, bp: 300, bmp: 350 },
            2: { ai: 30, af: 4, rd: 100, bf: 3, bp: 80, bmp: 100 }
        };
        function S() { return SPEED[speedMode] }
        function setSpeed(s) { speedMode = s; document.querySelectorAll('.speed-btn').forEach(function (b, i) { b.classList.toggle('on', i === s) }) }

        function auth() { var p = {}; if (tg.initData) p.init_data = tg.initData; if (UID) p.uid = UID; if (TOK) p.token = TOK; return p }
        function qs() { return new URLSearchParams(auth()).toString() }
        function sleep(ms) { return new Promise(function (r) { setTimeout(r, ms) }) }

        /* === TOAST === */
        var toastCb = null;
        function showToast(icon, text, ok, cancel, onOk, requestId) {
            document.getElementById('toastIcon').textContent = icon;
            document.getElementById('toastText').textContent = text;
            document.getElementById('toastOk').textContent = ok;
            document.getElementById('toastCancel').textContent = cancel || 'âœ•';

            // Add Request ID for correlation if provided
            const ridEl = document.getElementById('toastRequestId');
            if (ridEl) {
                if (requestId) {
                    ridEl.textContent = 'ID: ' + requestId.slice(0, 8);
                    ridEl.style.display = 'block';
                } else {
                    ridEl.style.display = 'none';
                }
            }

            toastCb = onOk;
            document.getElementById('toast').classList.add('show');
        }
        function closeToast() { document.getElementById('toast').classList.remove('show'); toastCb = null }
        function toastAction() { var c = toastCb; closeToast(); if (c) c() }

        /* === NAVIGATION & MODALS === */
        function nav(s) {
            if (s === 'deposit') { s = 'wallet' } /* deposit â†’ wallet page */
            document.querySelectorAll('.screen').forEach(function (e) { e.classList.remove('active') });
            document.querySelectorAll('.nav-item').forEach(function (e) { e.classList.remove('active') });
            var map = { lobby: 'scrLobby', game: 'scrGame', games: 'scrGames', crash: 'scrCrash', plinko: 'scrPlinko', bonuses: 'scrBonuses', wallet: 'scrWallet', referral: 'scrReferral', profile: 'scrProfile' };
            var scr = document.getElementById(map[s]); if (scr) scr.classList.add('active');
            var ni = document.querySelector('.nav-item[data-screen="' + s + '"]'); if (ni) ni.classList.add('active');
            currentScreen = s;
            if (s === 'game') initGame();
            if (s === 'games') initGamesScreen();
            if (s === 'plinko') initPlinko();
            if (s === 'profile') loadProfile();
            if (s === 'referral') loadReferral();
            if (s === 'wallet') { updateWallet(); switchWalletTab(activeWallet) }
            if (s === 'bonuses') buildBonusPills();
            window.scrollTo(0, 0);
        }

        /* === DATA === */

        function getBanners() {
            return [
                {
                    tagIcon: 'local_offer', tagText: 'SPECIAL', tagBg: 'rgba(230,46,61,.15)', tagColor: '#e62e3d',
                    titleHtml: `100% MATCH<br><span>UP TO $500</span>`,
                    subHtml: `Offer of the day Â· 100% Bonus`,
                    btnText: 'CLAIM NOW', btnAction: "nav('bonuses')",
                    bgStyle: 'linear-gradient(135deg,#1a0a0f 0%,#0f0f12 50%,#1a0505 100%)',
                    btnStyle: 'background:linear-gradient(135deg,#e62e3d,#b91c1c)'
                },
                {
                    tagIcon: 'local_fire_department', tagText: T.hot || 'HOT', tagBg: '', tagColor: '',
                    titleHtml: `RUBY<br><span>JACKPOT</span>`,
                    subHtml: T.heroSub || `5,000 TON<br><span style="font-size:9px;text-transform:uppercase;letter-spacing:1px">PRIZE POOL</span>`,
                    btnText: T.playNow || 'PLAY NOW', btnAction: "nav('game')", bgStyle: '', btnStyle: ''
                },
                {
                    tagIcon: 'rocket_launch', tagText: 'NEW', tagBg: 'rgba(228,33,39,.15)', tagColor: '#e42127',
                    titleHtml: `GALACTIC<br><span>PLINKO</span>`,
                    subHtml: `Drop Stars, Win Big!`,
                    btnText: 'DROP NOW', btnAction: "nav('plinko')",
                    bgStyle: 'linear-gradient(135deg,#1a0a0f 0%,#0a0a1a 50%,#1a0505 100%)',
                    btnStyle: 'background:linear-gradient(135deg,#e42127,#b91c1c)'
                },
                {
                    tagIcon: 'payments', tagText: 'BONUS', tagBg: 'rgba(34,197,94,.15)', tagColor: '#22c55e',
                    titleHtml: `<span style="font-size:22px">+7%</span><br><span>CRYPTO BONUS</span>`,
                    subHtml: `CryptoBot deposit Â· x3 wager`,
                    btnText: T.deposit || 'DEPOSIT', btnAction: "nav('wallet')",
                    bgStyle: 'linear-gradient(135deg,#0a1a0f 0%,#0a0a1a 50%,#051a0a 100%)',
                    btnStyle: 'background:linear-gradient(135deg,#22c55e,#16a34a)'
                }
            ];
        }

        // Duplicate renderBanners removed
        /* Balance functions are defined later in the file with full dual-balance support */
        function getActiveBalance() {
            if (activeWallet === 'stars') return balanceStars;
            return usdtBalance;
        }
        function getActiveUnit() {
            if (activeWallet === 'stars') return 'â­';
            return displayCurrency;
        }
        function updateVIP(v) {
            document.getElementById('vipIcon').textContent = v.icon;
            document.getElementById('vipName').textContent = v.name;
            var pct = 0;
            if (v.next_at) { pct = Math.min(100, Math.round(v.wagered / v.next_at * 100)) } else { pct = 100 }
            document.getElementById('vipBar').style.width = pct + '%';
            document.getElementById('vipPct').textContent = pct + '%';
        }


        /* === NEW RUBY SLOT GAME LOGIC === */
        const emojiToSvgMap = {
            "ðŸ’": "peach",
            "ðŸ‹": "star",
            "ðŸŠ": "lollipop",
            "ðŸ‡": "grape",
            "ðŸ«": "diamond",
            "ðŸ­": "apple",
            "ðŸ¬": "heart",
            "ðŸ’Ž": "ruby",
            "ðŸŽ°": "star",
            "ðŸ’£": "diamond"
        };
        const symbolTypes = ['ruby', 'grape', 'apple', 'peach', 'diamond', 'heart', 'star', 'lollipop'];

        function getSymbolSVG(type) {
            const shadow = `filter="drop-shadow(0px 4px 4px rgba(0,0,0,0.3))"`;

            switch (type) {
                case 'ruby':
                    return `<svg viewBox="0 0 64 64" width="44" height="44" ${shadow}>
                        <defs>
                            <radialGradient id="rubyShine" cx="35%" cy="25%" r="55%">
                                <stop offset="0%" stop-color="#ff9aaa"/>
                                <stop offset="40%" stop-color="#E8192E"/>
                                <stop offset="100%" stop-color="#4a0010"/>
                            </radialGradient>
                        </defs>
                        <polygon points="32,4 52,20 58,36 32,62 6,36 12,20" fill="url(#rubyShine)" stroke="rgba(255,100,120,0.5)" stroke-width="1"/>
                        <polygon points="32,4 52,20 32,24 12,20" fill="rgba(255,180,180,0.25)"/>
                        <polygon points="32,24 52,20 58,36" fill="rgba(255,100,100,0.15)"/>
                        <polygon points="32,24 6,36 12,20" fill="rgba(255,100,100,0.1)"/>
                        <polygon points="32,24 58,36 32,62 6,36" fill="rgba(0,0,0,0.15)"/>
                        <line x1="32" y1="4" x2="12" y2="20" stroke="rgba(255,255,255,0.25)" stroke-width="0.75"/>
                        <line x1="32" y1="4" x2="52" y2="20" stroke="rgba(255,255,255,0.25)" stroke-width="0.75"/>
                        <line x1="12" y1="20" x2="52" y2="20" stroke="rgba(255,255,255,0.2)" stroke-width="0.75"/>
                        <line x1="12" y1="20" x2="32" y2="24" stroke="rgba(255,255,255,0.2)" stroke-width="0.75"/>
                        <line x1="52" y1="20" x2="32" y2="24" stroke="rgba(255,255,255,0.2)" stroke-width="0.75"/>
                        <line x1="6" y1="36" x2="32" y2="24" stroke="rgba(255,255,255,0.15)" stroke-width="0.75"/>
                        <line x1="58" y1="36" x2="32" y2="24" stroke="rgba(255,255,255,0.15)" stroke-width="0.75"/>
                        <line x1="6" y1="36" x2="12" y2="20" stroke="rgba(255,255,255,0.15)" stroke-width="0.75"/>
                        <line x1="58" y1="36" x2="52" y2="20" stroke="rgba(255,255,255,0.15)" stroke-width="0.75"/>
                        <ellipse cx="28" cy="16" rx="5" ry="3" fill="rgba(255,255,255,0.35)" transform="rotate(-20,28,16)"/>
                    </svg>`;
                case 'grape':
                    return `<svg viewBox="0 0 64 64" width="48" height="48" ${shadow}>
                        <defs>
                            <radialGradient id="grapeShine" cx="30%" cy="25%" r="65%">
                                <stop offset="0%" stop-color="#e8b4f8"/>
                                <stop offset="35%" stop-color="#9C27B0"/>
                                <stop offset="100%" stop-color="#4a0072"/>
                            </radialGradient>
                        </defs>
                        <circle cx="32" cy="17" r="9" fill="url(#grapeShine)" stroke="rgba(200,100,255,0.3)" stroke-width="0.5"/>
                        <circle cx="21" cy="29" r="9" fill="url(#grapeShine)" stroke="rgba(200,100,255,0.3)" stroke-width="0.5"/>
                        <circle cx="43" cy="29" r="9" fill="url(#grapeShine)" stroke="rgba(200,100,255,0.3)" stroke-width="0.5"/>
                        <circle cx="27" cy="41" r="9" fill="url(#grapeShine)" stroke="rgba(200,100,255,0.3)" stroke-width="0.5"/>
                        <circle cx="37" cy="41" r="9" fill="url(#grapeShine)" stroke="rgba(200,100,255,0.3)" stroke-width="0.5"/>
                        <circle cx="32" cy="53" r="7" fill="url(#grapeShine)" stroke="rgba(200,100,255,0.3)" stroke-width="0.5"/>
                        <ellipse cx="29" cy="13" rx="3" ry="2" fill="rgba(255,255,255,0.4)" transform="rotate(-15,29,13)"/>
                        <ellipse cx="18" cy="25" rx="3" ry="2" fill="rgba(255,255,255,0.4)" transform="rotate(-15,18,25)"/>
                        <ellipse cx="40" cy="25" rx="3" ry="2" fill="rgba(255,255,255,0.4)" transform="rotate(-15,40,25)"/>
                        <ellipse cx="24" cy="37" rx="3" ry="2" fill="rgba(255,255,255,0.4)" transform="rotate(-15,24,37)"/>
                        <ellipse cx="34" cy="37" rx="3" ry="2" fill="rgba(255,255,255,0.4)" transform="rotate(-15,34,37)"/>
                        <ellipse cx="29" cy="49" rx="2.5" ry="1.8" fill="rgba(255,255,255,0.4)" transform="rotate(-15,29,49)"/>
                        <path d="M32 8 Q36 2 44 5" stroke="#66BB6A" stroke-width="2.5" fill="none" stroke-linecap="round"/>
                        <path d="M32 8 Q28 3 34 1" stroke="#81C784" stroke-width="1.5" fill="none" stroke-linecap="round"/>
                    </svg>`;
                case 'apple':
                    return `<svg viewBox="0 0 64 64" width="44" height="44" ${shadow}>
                        <defs>
                            <radialGradient id="appleGrad" cx="38%" cy="28%" r="65%">
                                <stop offset="0%" stop-color="#ff8a8a"/>
                                <stop offset="40%" stop-color="#e0001a"/>
                                <stop offset="100%" stop-color="#6b0000"/>
                            </radialGradient>
                            <radialGradient id="appleShadow" cx="50%" cy="80%" r="50%">
                                <stop offset="0%" stop-color="rgba(0,0,0,0.35)"/>
                                <stop offset="100%" stop-color="rgba(0,0,0,0)"/>
                            </radialGradient>
                        </defs>
                        <path d="M32 57 C 18 57 8 46 8 32 C 8 17 18 13 26 13 C 29.5 13 32 15 32 15 C 32 15 34.5 13 38 13 C 46 13 56 17 56 32 C 56 46 46 57 32 57 Z" fill="url(#appleGrad)" stroke="rgba(255,120,100,0.4)" stroke-width="1"/>
                        <path d="M32 57 C 18 57 8 46 8 38 C 20 55 44 55 56 38 C 56 46 46 57 32 57Z" fill="url(#appleShadow)"/>
                        <path d="M32 13 Q 33 3 42 5 Q 45 10 32 13" fill="#558B2F" stroke="#33691E" stroke-width="0.5"/>
                        <path d="M32 5 Q 38 0 40 5" stroke="#8BC34A" stroke-width="1.5" fill="none" stroke-linecap="round"/>
                        <ellipse cx="22" cy="24" rx="5" ry="9" fill="rgba(255,255,255,0.18)" transform="rotate(-20,22,24)" rx="4" ry="8"/>
                        <path d="M18 30 Q 22 26 22 36" stroke="rgba(255,255,255,0.12)" fill="none" stroke-width="2.5" stroke-linecap="round"/>
                    </svg>`;
                case 'peach':
                    return `<svg viewBox="0 0 64 64" width="46" height="46" ${shadow}>
                        <defs>
                            <radialGradient id="peachMain" cx="38%" cy="30%" r="65%">
                                <stop offset="0%" stop-color="#FFECB3"/>
                                <stop offset="35%" stop-color="#FFAB76"/>
                                <stop offset="70%" stop-color="#FF7043"/>
                                <stop offset="100%" stop-color="#BF360C"/>
                            </radialGradient>
                            <radialGradient id="peachBlush" cx="60%" cy="65%" r="40%">
                                <stop offset="0%" stop-color="rgba(255,80,80,0.4)"/>
                                <stop offset="100%" stop-color="rgba(255,80,80,0)"/>
                            </radialGradient>
                        </defs>
                        <circle cx="32" cy="34" r="22" fill="url(#peachMain)" stroke="rgba(255,180,100,0.3)" stroke-width="1"/>
                        <circle cx="32" cy="34" r="22" fill="url(#peachBlush)"/>
                        <path d="M32 13 Q 33 26 46 38" stroke="rgba(200,80,30,0.2)" stroke-width="2" fill="none" stroke-linecap="round"/>
                        <path d="M32 13 Q 28 4 37 7 Q 38 10 32 13" fill="#43A047" stroke="#2E7D32" stroke-width="0.5"/>
                        <ellipse cx="22" cy="26" rx="4" ry="7" fill="rgba(255,255,255,0.22)" transform="rotate(-20,22,26)"/>
                    </svg>`;
                case 'diamond':
                    return `<svg viewBox="0 0 64 64" width="44" height="44" ${shadow}>
                        <defs>
                            <linearGradient id="diamTop" x1="0%" y1="0%" x2="100%" y2="100%">
                                <stop offset="0%" stop-color="#e0f7fa"/>
                                <stop offset="100%" stop-color="#00BCD4"/>
                            </linearGradient>
                            <linearGradient id="diamLeft" x1="0%" y1="0%" x2="100%" y2="0%">
                                <stop offset="0%" stop-color="#006064"/>
                                <stop offset="100%" stop-color="#26C6DA"/>
                            </linearGradient>
                            <linearGradient id="diamRight" x1="0%" y1="0%" x2="100%" y2="0%">
                                <stop offset="0%" stop-color="#4DD0E1"/>
                                <stop offset="100%" stop-color="#00838F"/>
                            </linearGradient>
                        </defs>
                        <!-- top face -->
                        <polygon points="16,22 32,14 48,22 32,30" fill="url(#diamTop)" stroke="rgba(255,255,255,0.4)" stroke-width="0.75"/>
                        <!-- left face -->
                        <polygon points="16,22 32,30 24,52 8,34" fill="url(#diamLeft)" stroke="rgba(255,255,255,0.2)" stroke-width="0.75"/>
                        <!-- right face -->
                        <polygon points="48,22 56,34 40,52 32,30" fill="url(#diamRight)" stroke="rgba(255,255,255,0.2)" stroke-width="0.75"/>
                        <!-- bottom -->
                        <polygon points="24,52 32,30 40,52 32,58" fill="#004D57" stroke="rgba(255,255,255,0.15)" stroke-width="0.75"/>
                        <!-- inner lines -->
                        <line x1="16" y1="22" x2="32" y2="14" stroke="rgba(255,255,255,0.35)" stroke-width="0.75"/>
                        <line x1="32" y1="14" x2="48" y2="22" stroke="rgba(255,255,255,0.35)" stroke-width="0.75"/>
                        <!-- highlight streak -->
                        <line x1="24" y1="16" x2="34" y2="22" stroke="rgba(255,255,255,0.7)" stroke-width="2" stroke-linecap="round"/>
                        <ellipse cx="28" cy="17" rx="3" ry="1.5" fill="rgba(255,255,255,0.6)" transform="rotate(-30,28,17)"/>
                    </svg>`;
                case 'heart':
                    return `<svg viewBox="0 0 64 64" width="44" height="44" ${shadow}>
                        <defs>
                            <radialGradient id="heartMain" cx="40%" cy="30%" r="65%">
                                <stop offset="0%" stop-color="#ff9aaa"/>
                                <stop offset="40%" stop-color="#E91E3F"/>
                                <stop offset="100%" stop-color="#5c0010"/>
                            </radialGradient>
                            <radialGradient id="heartInner" cx="50%" cy="70%" r="50%">
                                <stop offset="0%" stop-color="rgba(0,0,0,0.3)"/>
                                <stop offset="100%" stop-color="rgba(0,0,0,0)"/>
                            </radialGradient>
                        </defs>
                        <path d="M32 56 C 10 40 4 28 4 18 C 4 8 12 4 22 4 C 28 4 32 8 32 8 C 32 8 36 4 42 4 C 52 4 60 8 60 18 C 60 28 54 40 32 56 Z" fill="url(#heartMain)" stroke="rgba(255,150,160,0.4)" stroke-width="1"/>
                        <path d="M32 56 C 10 40 4 28 4 22 C 12 50 52 50 60 22 C 60 28 54 40 32 56Z" fill="url(#heartInner)"/>
                        <path d="M14 14 C 18 9 25 9 27 13" stroke="rgba(255,255,255,0.45)" stroke-width="2.5" fill="none" stroke-linecap="round"/>
                        <ellipse cx="20" cy="18" rx="4" ry="6" fill="rgba(255,255,255,0.18)" transform="rotate(-25,20,18)"/>
                    </svg>`;
                case 'star':
                    return `<svg viewBox="0 0 64 64" width="48" height="48" ${shadow}>
                        <defs>
                            <radialGradient id="starGlow" cx="50%" cy="50%" r="50%">
                                <stop offset="0%" stop-color="rgba(255,230,100,0.4)"/>
                                <stop offset="100%" stop-color="rgba(255,200,0,0)"/>
                            </radialGradient>
                            <linearGradient id="starFace" x1="0%" y1="0%" x2="100%" y2="100%">
                                <stop offset="0%" stop-color="#FFFDE7"/>
                                <stop offset="40%" stop-color="#FFD700"/>
                                <stop offset="100%" stop-color="#E65100"/>
                            </linearGradient>
                        </defs>
                        <circle cx="32" cy="32" r="26" fill="url(#starGlow)"/>
                        <path d="M32 6 L37.5 22 L54 22 L41 31 L46 48 L32 39 L18 48 L23 31 L10 22 L26.5 22 Z" fill="url(#starFace)" stroke="#B8860B" stroke-width="1" stroke-linejoin="round"/>
                        <!-- shading on lower half -->
                        <path d="M32 39 L18 48 L23 31 L10 22 L16 22 L26 30 Z" fill="rgba(0,0,0,0.12)"/>
                        <!-- highlight -->
                        <ellipse cx="28" cy="17" rx="4" ry="2.5" fill="rgba(255,255,255,0.55)" transform="rotate(-20,28,17)"/>
                        <!-- shine ray -->
                        <line x1="32" y1="2" x2="32" y2="8" stroke="rgba(255,255,200,0.8)" stroke-width="2" stroke-linecap="round"/>
                        <line x1="54" y1="10" x2="50" y2="15" stroke="rgba(255,255,200,0.6)" stroke-width="1.5" stroke-linecap="round"/>
                        <line x1="10" y1="10" x2="14" y2="15" stroke="rgba(255,255,200,0.6)" stroke-width="1.5" stroke-linecap="round"/>
                    </svg>`;
                case 'lollipop':
                    return `<svg viewBox="0 0 64 64" width="48" height="48" ${shadow}>
                        <defs>
                            <radialGradient id="lolBase" cx="50%" cy="50%" r="50%">
                                <stop offset="0%" stop-color="#FCE4EC"/>
                                <stop offset="40%" stop-color="#F06292"/>
                                <stop offset="100%" stop-color="#AD1457"/>
                            </radialGradient>
                        </defs>
                        <!-- stick -->
                        <line x1="32" y1="42" x2="36" y2="62" stroke="#D7CCC8" stroke-width="4.5" stroke-linecap="round"/>
                        <line x1="32" y1="42" x2="36" y2="62" stroke="rgba(255,255,255,0.3)" stroke-width="2" stroke-linecap="round"/>
                        <!-- candy body -->
                        <circle cx="32" cy="24" r="19" fill="url(#lolBase)" stroke="rgba(255,255,255,0.4)" stroke-width="1.5"/>
                        <!-- spiral segments -->
                        <path d="M32 5 A19 19 0 0 1 51 24" fill="none" stroke="rgba(255,255,255,0.7)" stroke-width="4" stroke-linecap="round"/>
                        <path d="M32 8 A16 16 0 0 0 17 32" fill="none" stroke="rgba(255,255,255,0.5)" stroke-width="3" stroke-linecap="round"/>
                        <path d="M32 11 A13 13 0 0 1 45 24" fill="none" stroke="rgba(255,100,150,0.8)" stroke-width="3" stroke-linecap="round"/>
                        <!-- center dot -->
                        <circle cx="32" cy="24" r="4" fill="rgba(255,255,255,0.5)"/>
                        <!-- highlight -->
                        <ellipse cx="25" cy="15" rx="5" ry="3.5" fill="rgba(255,255,255,0.4)" transform="rotate(-30,25,15)"/>
                    </svg>`;
            }
        }

        var BET_STEPS = [1, 5, 10, 25, 50, 100, 200];
        var betIndex = 1;

        function initGame() {
            var g = document.getElementById('slot-grid');
            if (g && !g.children.length) {
                g.innerHTML = '';
                for (let i = 0; i < 30; i++) {
                    const type = symbolTypes[Math.floor(Math.random() * symbolTypes.length)];
                    createTile(i, type);
                }
            }
            updateSpinBtn(); updateBetDisplay();
        }

        function createTile(index, type, animateClass = '') {
            const g = document.getElementById('slot-grid');
            const div = document.createElement('div');
            const col = index % 6;
            const delay = col * 50;
            div.className = `symbol-tile ${animateClass}`;
            div.style.animationDelay = `${delay}ms`;
            div.innerHTML = getSymbolSVG(type);
            div.dataset.index = index;
            div.dataset.type = type;
            if (g) g.appendChild(div);
            return div;
        }

        function updateBetDisplay() {
            var bd = document.getElementById('betDisplay');
            if (bd) bd.textContent = bet.toFixed(2);
        }

        function changeBet(dir) {
            if (spinning) return;
            betIndex = BET_STEPS.indexOf(bet);
            if (betIndex === -1) betIndex = 0;
            betIndex += dir;
            if (betIndex < 0) betIndex = 0;
            if (betIndex >= BET_STEPS.length) betIndex = BET_STEPS.length - 1;
            bet = BET_STEPS[betIndex];
            updateBetDisplay(); updateSpinBtn();
        }

        function setMaxBet() {
            if (spinning) return;
            bet = BET_STEPS[BET_STEPS.length - 1];
            betIndex = BET_STEPS.length - 1;
            updateBetDisplay(); updateSpinBtn();
        }

        function toggleAutoSpeed() {
            speedMode = (speedMode + 1) % 3;
            var labels = ['ðŸ¢', 'â–¶ï¸', 'âš¡'];
            var al = document.getElementById('autoLabel');
            var icon = document.getElementById('turboIcon');
            if (al) al.textContent = labels[speedMode];
            if (icon) {
                if (speedMode === 0) icon.textContent = 'speed';
                if (speedMode === 1) icon.textContent = 'play_arrow';
                if (speedMode === 2) icon.textContent = 'bolt';
            }
        }

        function updateSpinBtn() {
            var btn = document.getElementById('spinBtn');
            if (btn) btn.disabled = (balance === null);
        }

        function triggerSparkles(x, y) {
            for (let i = 0; i < 8; i++) {
                const sparkle = document.createElement('div');
                sparkle.className = 'sparkle';
                sparkle.style.left = x + 'px';
                sparkle.style.top = y + 'px';
                const angle = Math.random() * Math.PI * 2;
                const distance = 30 + Math.random() * 50;
                sparkle.style.setProperty('--tx', Math.cos(angle) * distance + 'px');
                sparkle.style.setProperty('--ty', Math.sin(angle) * distance + 'px');
                document.body.appendChild(sparkle);
                setTimeout(() => sparkle.remove(), 1000);
            }
        }

        function showBigWin(amount) {
            var bwOverlay = document.getElementById('big-win-overlay');
            var bwAmount = document.getElementById('win-counter-big');
            if (bwOverlay) bwOverlay.style.display = 'flex';
            if (bwAmount) bwAmount.innerText = amount;

            const colors = ['#FFD700', '#C0142A', '#FFFFFF'];
            const container = document.getElementById('confetti-box');
            if (container) {
                container.innerHTML = '';
                for (let i = 0; i < 50; i++) {
                    const conf = document.createElement('div');
                    conf.style.position = 'absolute';
                    conf.style.width = '8px';
                    conf.style.height = '16px';
                    conf.style.background = colors[Math.floor(Math.random() * colors.length)];
                    conf.style.left = Math.random() * 100 + '%';
                    conf.style.top = -20 + 'px';
                    conf.style.transform = `rotate(${Math.random() * 360}deg)`;
                    conf.animate([
                        { transform: `translateY(0) rotate(0deg)`, opacity: 1 },
                        { transform: `translateY(100vh) rotate(${720 + Math.random() * 360}deg)`, opacity: 0 }
                    ], {
                        duration: 1000 + Math.random() * 1000,
                        easing: 'cubic-bezier(0.25, 0.46, 0.45, 0.94)',
                        fill: 'forwards'
                    });
                    container.appendChild(conf);
                }
            }
        }

        function closeBigWin() {
            var bwOverlay = document.getElementById('big-win-overlay');
            if (bwOverlay) bwOverlay.style.display = 'none';
        }

        function doSpin() {
            if (balance === null) return;
            if ((balance < bet && freeSpins <= 0) && activeWallet !== 'stars') { nav('wallet'); return }
            if ((activeWallet === 'stars' && starsBalance < bet && freeSpins <= 0)) { selectPayMethod('stars'); nav('wallet'); return; }
            spin();
        }

        async function spin(forcedData = null) {
            return new Promise(async (resolve) => {
                if (spinning) return resolve();
                spinning = true;
                var btn = document.getElementById('spinBtn');
                if (btn) btn.disabled = true;
                if (btn) btn.style.transform = 'scale(0.9)';
                setTimeout(() => { if (btn) btn.style.transform = 'scale(1)' }, 150);

                var wd = document.getElementById('win-display');
                var badge = document.getElementById('tumble-badge');
                var g = document.getElementById('slot-grid');
                if (wd) { wd.innerText = '0.00'; wd.classList.remove('text-[#FFD700]', 'scale-110'); wd.classList.add('text-white'); }
                if (badge) { badge.classList.remove('scale-100', 'opacity-100'); badge.classList.add('scale-0', 'opacity-0'); }

                var tiles = Array.from(g.children);
                tiles.forEach((tile, i) => {
                    const col = i % 6;
                    setTimeout(() => {
                        tile.classList.add('spinning-column');
                    }, col * 60);
                });

                const SPIN_BASE = speedMode === 2 ? 300 : 700;
                const COL_STAGGER = speedMode === 2 ? 40 : 90;

                try {
                    var d;
                    if (forcedData) {
                        d = forcedData;
                    } else {
                        var isDoubleChance = document.getElementById('doubleChanceToggle') ? document.getElementById('doubleChanceToggle').checked : false;
                        var useFree = freeSpins > 0 && ((activeWallet === 'usdt' && balance < bet) || (activeWallet === 'stars' && starsBalance < bet));
                        var r = await apiFetch('/api/spin', { method: 'POST', body: JSON.stringify(Object.assign({}, auth(), { bet: bet, use_free_spin: useFree, wallet: activeWallet, double_chance: isDoubleChance })) });
                        d = await safeJson(r);

                        if (!d.ok) {
                            spinning = false;
                            if (btn) btn.disabled = false;
                            if (d.balance !== undefined) balance = d.balance;
                            if (d.stars !== undefined) starsBalance = d.stars;
                            updateBalanceUI();
                            tiles.forEach(t => t.classList.remove('spinning-column'));
                            return resolve();
                        }
                    }

                    if (d.balance !== undefined) balance = d.balance;
                    if (d.stars !== undefined) starsBalance = d.stars;
                    freeSpins = d.free_spins || freeSpins;
                    updateBalanceUI();

                    var newTypes = d.grid.map(emoji => emojiToSvgMap[emoji] || 'ruby');

                    setTimeout(() => {
                        g.innerHTML = '';
                        const newTiles = [];
                        for (let i = 0; i < 30; i++) {
                            const div = document.createElement('div');
                            div.className = 'symbol-tile';
                            div.style.opacity = '0';
                            div.style.transform = 'translateY(-110%) scaleY(1.15)';
                            div.dataset.type = newTypes[i];
                            div.dataset.index = i;
                            div.innerHTML = getSymbolSVG(newTypes[i]);
                            g.appendChild(div);
                            newTiles.push(div);
                        }

                        for (let col = 0; col < 6; col++) {
                            const colDelay = col * COL_STAGGER;
                            setTimeout(() => {
                                for (let row = 0; row < 5; row++) {
                                    const tile = newTiles[row * 6 + col];
                                    const rowDelay = row * 35;
                                    setTimeout(() => {
                                        tile.style.opacity = '1';
                                        tile.style.transform = '';
                                        void tile.offsetWidth;
                                        tile.classList.add('reel-land');
                                    }, rowDelay);
                                }
                            }, colDelay);
                        }

                        const totalAnim = (5) * COL_STAGGER + (4) * 35 + 520;
                        setTimeout(() => {
                            if (d.winnings > 0) {
                                var co = {}; d.grid.forEach(function (s) { if (s !== 'ðŸŽ°') co[s] = (co[s] || 0) + 1 });
                                var ws = new Set(Object.entries(co).filter(function (e) { return e[1] >= 8 }).map(function (e) { return emojiToSvgMap[e[0]] || 'ruby' }));

                                newTiles.forEach(t => {
                                    if (ws.has(t.dataset.type)) {
                                        t.classList.add('winning-tile');
                                        const rect = t.getBoundingClientRect();
                                        triggerSparkles(rect.left + rect.width / 2, rect.top + rect.height / 2);
                                    } else {
                                        t.style.opacity = '0.3';
                                    }
                                });

                                animateValue(wd, 0, parseFloat(d.winnings), 1000);
                                wd.classList.remove('text-white');
                                wd.classList.add('text-[#FFD700]');
                                if (badge) {
                                    badge.classList.remove('scale-0', 'opacity-0');
                                    badge.classList.add('scale-100', 'opacity-100');
                                }
                                if (d.winnings > bet * 5) {
                                    setTimeout(() => showBigWin(d.winnings.toFixed(2)), 500);
                                }
                            }

                            if (d.triggered_bonus && !forcedData) {
                                setTimeout(function () { startBonus('triggered') }, 1200);
                            }

                            spinning = false;
                            if (btn) btn.disabled = false;
                            resolve();
                        }, totalAnim);

                    }, Math.max(0, SPIN_BASE - 500));

                } catch (e) {
                    spinning = false;
                    if (btn) btn.disabled = false;
                    tiles.forEach(t => t.classList.remove('spinning-column'));
                    resolve();
                }
            });
        }

        function animateValue(obj, start, end, duration) {
            let startTimestamp = null;
            const step = (timestamp) => {
                if (!startTimestamp) startTimestamp = timestamp;
                const progress = Math.min((timestamp - startTimestamp) / duration, 1);
                obj.innerHTML = (progress * (end - start) + start).toFixed(2);
                if (progress < 1) {
                    window.requestAnimationFrame(step);
                }
            };
            window.requestAnimationFrame(step);
        }

        /* === NEW SLOTS MODALS & AUTOSPIN === */
        function togglePaytable(show) {
            const modal = document.getElementById('paytable-modal');
            if (!modal) return;
            if (show) {
                modal.style.opacity = '1';
                modal.style.pointerEvents = 'auto';
            } else {
                modal.style.opacity = '0';
                modal.style.pointerEvents = 'none';
            }
        }

        let isAutoSpinning = false;
        let autoSpinsLeft = 0;
        let selectedAutoAmount = 25;

        function openAutoModal() {
            if (spinning || isAutoSpinning) return;
            selectedAutoAmount = 25;
            updateAutoChips();
            const modal = document.getElementById('autospin-modal');
            if (modal) {
                modal.style.opacity = '1';
                modal.style.pointerEvents = 'auto';
            }
        }

        function toggleAutoModal(show) {
            const modal = document.getElementById('autospin-modal');
            if (!modal) return;
            modal.style.opacity = show ? '1' : '0';
            modal.style.pointerEvents = show ? 'auto' : 'none';
        }

        function selectAutoChip(btn, amount) {
            selectedAutoAmount = amount;
            updateAutoChips();
        }

        function updateAutoChips() {
            const btns = document.querySelectorAll('#autoSpinsGrid .option-chip');
            if (!btns.length) return;
            btns.forEach(b => b.classList.remove('selected'));
            const map = { 10: 0, 25: 1, 50: 2, 100: 3, 9999: 4 };
            if (map[selectedAutoAmount] !== undefined && btns[map[selectedAutoAmount]]) {
                btns[map[selectedAutoAmount]].classList.add('selected');
            }
        }

        function startAutoSpinFlow() {
            autoSpinsLeft = selectedAutoAmount;
            isAutoSpinning = true;
            toggleAutoModal(false);

            var al = document.getElementById('autoLabel');
            if (al) al.textContent = 'STOP';
            var icon = document.getElementById('turboIcon');
            if (icon) icon.textContent = 'stop';

            doAutoSpin();
        }

        function stopAutoSpinFlow() {
            isAutoSpinning = false;
            autoSpinsLeft = 0;

            var labels = ['ðŸ¢', 'â–¶ï¸', 'âš¡'];
            var al = document.getElementById('autoLabel');
            if (al) al.textContent = labels[speedMode];
            var icon = document.getElementById('turboIcon');
            if (icon) {
                if (speedMode === 0) icon.textContent = 'speed';
                if (speedMode === 1) icon.textContent = 'play_arrow';
                if (speedMode === 2) icon.textContent = 'bolt';
            }
        }

        // Intercept Auto button depending on state
        function handleAutoBtnClick() {
            if (isAutoSpinning) {
                stopAutoSpinFlow();
            } else {
                openAutoModal();
            }
        }

        function doAutoSpin() {
            if (!isAutoSpinning || autoSpinsLeft <= 0) {
                stopAutoSpinFlow();
                return;
            }
            if (!spinning) {
                autoSpinsLeft--;
                doSpin();
                const checkInterval = setInterval(() => {
                    if (!spinning) {
                        clearInterval(checkInterval);
                        setTimeout(doAutoSpin, speedMode === 2 ? 200 : 700);
                    }
                }, 100);
            }
        }

        /* === BONUS === */
        async function startBonus(mode) {
            return await withGuard('bonus_start', async () => {
                var isDoubleChance = document.getElementById('doubleChanceToggle') ? document.getElementById('doubleChanceToggle').checked : false;
                try {
                    var r = await apiFetch('/api/bonus', { method: 'POST', body: JSON.stringify(Object.assign({}, auth(), { bet: bet, mode: mode, double_chance: isDoubleChance })) });
                    var d = await safeJson(r);
                    if (!d.ok) {
                        if (d.error === 'funds') showToast('ðŸ’°', T.noMoney + '\n' + T.noMoneyDesc, T.depositBtn, T.cancelBtn, function () { nav('wallet') });
                        return;
                    }

                    var al = document.getElementById('autoLabel');
                    var originalLabel = al ? al.textContent : 'Auto';

                    for (var j = 0; j < d.spins.length; j++) {
                        var sn = d.spins[j];
                        if (al) al.textContent = (j + 1) + '/' + d.spins.length;

                        await spin(sn);
                        await sleep(1500);
                    }

                    balance = d.balance;
                    updateBalanceUI();

                    if (d.total_win > 0) {
                        showBigWin(d.total_win.toFixed(2));
                    }

                    if (al) al.textContent = originalLabel;
                } catch (e) { console.error('Bonus error', e); }
            });
        }
        function buyBonus() { if (!balance || balance < bet * 100) { showToast('ðŸ’°', T.noMoney + '\n' + T.noMoneyDesc, T.depositBtn, T.cancelBtn, function () { nav('wallet') }); return; } startBonus('bought'); }
        function closeBonus() { document.getElementById('bonusOL').classList.remove('show'); spinning = false; updateBalanceUI() }
        function showBombPop(m) { var e = document.createElement('div'); e.className = 'bomb-pop'; e.textContent = 'ðŸ’£ x' + m; document.body.appendChild(e); setTimeout(function () { e.remove() }, 800) }
        function buyBonus() { if (!balance || balance < bet * 100) { showToast('ðŸ’°', T.noMoney + '\n' + T.noMoneyDesc, T.depositBtn, T.cancelBtn, function () { nav('wallet') }); return } startBonus('bought') }

        /* === FORTUNE WHEEL === */
        var wheelAngle = 0;
        var wheelSpinning = false;
        var wheelLastPrize = null;
        var wheelCooldownEnd = null; /* Date when next spin is available */
        // Restore cooldown from localStorage on page load
        (function() {
            try {
                var saved = localStorage.getItem('rb_wheelCooldown');
                if (saved) {
                    var d = new Date(saved);
                    if (d > new Date()) wheelCooldownEnd = d;
                }
            } catch(e) {}
        })();

        function openWheel() {
            var ol = document.getElementById('wheelOL');
            ol.style.display = 'block';
            /* Update balance display */
            var bd = document.getElementById('wheelBalDisplay');
            if (bd) bd.textContent = (balance !== null ? balance : 0).toLocaleString();
            /* Reset disc transition */
            var disc = document.getElementById('wheelDisc');
            if (disc) { disc.style.transition = 'none'; disc.style.transform = 'rotate(' + wheelAngle + 'deg)'; }
            /* Always show wheelSpinState as background */
            document.getElementById('wheelSpinState').style.display = 'flex';
            document.getElementById('wheelSpinState').style.opacity = '1';
            document.getElementById('wheelSpinState').style.filter = 'none';
            document.getElementById('wheelSpinState').style.pointerEvents = 'auto';
            document.getElementById('wheelWinState').style.display = 'none';
            document.getElementById('wheelLockedState').style.display = 'none';
            /* If cooldown active â†’ immediately show locked popup on top */
            if (wheelCooldownEnd && new Date() < wheelCooldownEnd) {
                showWheelLocked();
            }
        }
        function closeWheel() {
            document.getElementById('wheelOL').style.display = 'none';
            document.getElementById('wheelWinState').style.display = 'none';
            document.getElementById('wheelLockedState').style.display = 'none';
            /* Reset spin state look */
            document.getElementById('wheelSpinState').style.opacity = '1';
            document.getElementById('wheelSpinState').style.filter = 'none';
            document.getElementById('wheelSpinState').style.pointerEvents = 'auto';
        }
        function checkWheelCooldown() {
            if (wheelCooldownEnd && new Date() < wheelCooldownEnd) {
                showWheelLocked();
            } else {
                document.getElementById('wheelWinState').style.display = 'none';
                document.getElementById('wheelLockedState').style.display = 'none';
            }
        }
        function showWheelLocked() {
            /* Spin state stays visible as dimmed background */
            document.getElementById('wheelSpinState').style.opacity = '0.3';
            document.getElementById('wheelSpinState').style.filter = 'blur(2px)';
            document.getElementById('wheelSpinState').style.pointerEvents = 'none';
            document.getElementById('wheelLockedState').style.display = 'flex';
            document.getElementById('wheelWinState').style.display = 'none';
            updateLockedTimer();
        }
        function updateLockedTimer() {
            if (!wheelCooldownEnd) return;
            var diff = wheelCooldownEnd - new Date();
            if (diff <= 0) {
                document.getElementById('wheelLockedState').style.display = 'none';
                return;
            }
            var h = Math.floor(diff / 3600000);
            var m = Math.floor((diff % 3600000) / 60000);
            var s = Math.floor((diff % 60000) / 1000);
            var t = (h < 10 ? '0' : '') + h + ':' + (m < 10 ? '0' : '') + m + ':' + (s < 10 ? '0' : '') + s;
            var el = document.getElementById('wheelLockedTimer');
            if (el) el.textContent = t;
            var el2 = document.getElementById('wheelTimer');
            if (el2) el2.textContent = t;
            setTimeout(updateLockedTimer, 1000);
        }

        async function doWheelSpin() {
            if (wheelSpinning) return;
            wheelSpinning = true;
            var btn = document.getElementById('wheelSpinBtn');
            btn.disabled = true;
            btn.style.opacity = '0.6';

            var extra = 1800 + Math.random() * 720;
            wheelAngle += extra;
            var disc = document.getElementById('wheelDisc');
            disc.style.transition = 'transform 4s cubic-bezier(.17,.67,.05,.99)';
            disc.style.transform = 'rotate(' + wheelAngle + 'deg)';

            try {
                var r = await apiFetch('/api/wheel', { method: 'POST', body: JSON.stringify(auth()) });
                var d = await safeJson(r);
                await sleep(4200);

                if (d.ok) {
                    balance = d.balance;
                    freeSpins = d.free_spins || 0;
                    wheelLastPrize = d.prize;
                    updateBalanceUI();

                    /* Show win popup */
                    var amt = d.prize.value || 0;
                    var unit = d.prize.type === 'coins' ? T.coins.toUpperCase() : 'FREE SPINS';
                    document.getElementById('wheelWinAmount').textContent = amt;
                    document.getElementById('wheelWinUnit').textContent = unit;
                    /* Blur wheel behind win popup */
                    document.getElementById('wheelSpinState').style.opacity = '0.3';
                    document.getElementById('wheelSpinState').style.filter = 'blur(2px)';
                    document.getElementById('wheelSpinState').style.pointerEvents = 'none';
                    document.getElementById('wheelWinState').style.display = 'flex';

                    /* Set cooldown (24h from now) */
                    wheelCooldownEnd = new Date(Date.now() + 24 * 60 * 60 * 1000);
                    document.getElementById('wheelBanner').classList.add('done');
                } else {
                    /* API says not available â€” show demo win anyway for first spin */
                    var demoAmounts2 = [5, 10, 25, 50, 100, 250];
                    var demoAmt2 = demoAmounts2[Math.floor(Math.random() * demoAmounts2.length)];
                    document.getElementById('wheelWinAmount').textContent = demoAmt2;
                    document.getElementById('wheelWinUnit').textContent = T.coins.toUpperCase();
                    /* Blur wheel behind win popup */
                    document.getElementById('wheelSpinState').style.opacity = '0.3';
                    document.getElementById('wheelSpinState').style.filter = 'blur(2px)';
                    document.getElementById('wheelSpinState').style.pointerEvents = 'none';
                    document.getElementById('wheelWinState').style.display = 'flex';

                    if (d.next_available) {
                        wheelCooldownEnd = new Date(d.next_available);
                    } else {
                        wheelCooldownEnd = new Date(Date.now() + 24 * 60 * 60 * 1000);
                    }
                    document.getElementById('wheelBanner').classList.add('done');
                }
            } catch (e) {
                await sleep(4200);
                /* Demo fallback: show a fake win */
                var demoAmounts = [5, 10, 25, 50, 100, 250, 500];
                var demoAmt = demoAmounts[Math.floor(Math.random() * demoAmounts.length)];
                document.getElementById('wheelWinAmount').textContent = demoAmt;
                document.getElementById('wheelWinUnit').textContent = T.coins.toUpperCase();
                /* Blur wheel behind win popup */
                document.getElementById('wheelSpinState').style.opacity = '0.3';
                document.getElementById('wheelSpinState').style.filter = 'blur(2px)';
                document.getElementById('wheelSpinState').style.pointerEvents = 'none';
                document.getElementById('wheelWinState').style.display = 'flex';
                wheelCooldownEnd = new Date(Date.now() + 24 * 60 * 60 * 1000);
            }
            // Persist cooldown so app reload doesn't reset it
            try { if (wheelCooldownEnd) localStorage.setItem('rb_wheelCooldown', wheelCooldownEnd.toISOString()); } catch(e) {}
            wheelSpinning = false;
            btn.disabled = false;
            btn.style.opacity = '1';
        }

        function collectWheelPrize() {
            document.getElementById('wheelWinState').style.display = 'none';
            closeWheel();
        }


        /* === LIVE DROPS === */
        var LIVE_DROP_NAMES = ['Play***7', 'Win***92', 'Gam***01', 'Luc***77', 'Bet***44', 'Ton***99', 'Max***23', 'Pro***88', 'Ace***11', 'Top***55', 'Vip***33', 'Cry***66'];
        var LIVE_DROP_GAMES = ['Slots', 'Crash', 'Plinko', 'Mines', 'Wheel', 'Dice'];
        var LIVE_DROP_ICONS = { Slots: 'sports_esports', Crash: 'rocket_launch', Plinko: 'casino', Mines: 'sports_esports', Wheel: 'token', Dice: 'casino' };
        var LIVE_DROP_COLORS = ['#6366f1', '#8b5cf6', '#ec4899', '#f59e0b', '#10b981', '#3b82f6', '#ef4444', '#14b8a6'];

        function buildLiveDrops() {
            var el = document.getElementById('liveDropsScroll');
            if (!el) return;
            // Clear and build initial set
            el.innerHTML = '';
            for (var i = 0; i < 10; i++) {
                addRandomLiveDrop();
            }
        }

        function addRandomLiveDrop() {
            var name = LIVE_DROP_NAMES[Math.floor(Math.random() * LIVE_DROP_NAMES.length)];
            var game = LIVE_DROP_GAMES[Math.floor(Math.random() * LIVE_DROP_GAMES.length)];
            var icon = LIVE_DROP_ICONS[game] || 'casino';
            var isBig = Math.random() > 0.7;
            var amt = isBig ? (Math.floor(Math.random() * 250) / 10 + 0.5).toFixed(1) : (Math.floor(Math.random() * 2500) + 10);
            var unit = isBig ? 'TON' : 'Stars';
            var mult = isBig ? 'x' + (Math.floor(Math.random() * 450) / 10 + 1.1).toFixed(1) : 'x' + (Math.floor(Math.random() * 40) / 10 + 1.1).toFixed(1);
            var avatarColor = LIVE_DROP_COLORS[Math.floor(Math.random() * LIVE_DROP_COLORS.length)];
            var initials = name.substring(0, 2).toUpperCase();

            // Map game name to screen
            var screenMap = { 'Slots': 'game', 'Crash': 'crash', 'Plinko': 'plinko', 'Mines': 'mines', 'Wheel': 'wheel', 'Dice': 'dice' };
            var screen = screenMap[game] || 'game';

            var drop = {
                username: name,
                game: game,
                amount: amt,
                currency: unit.toLowerCase(),
                multiplier: mult.replace('x', ''),
                color: avatarColor,
                screen: screen
            };

            renderSingleLiveDrop(drop);
        }

        function renderSingleLiveDrop(d) {
            var el = document.getElementById('liveDropsScroll');
            if (!el) return;

            var isBig = parseFloat(d.multiplier) >= 10;
            var color = d.color || '#E91E3F';
            var unit = d.currency === 'stars' ? 'Stars' : 'TON';
            var initials = (d.username || 'U').substring(0, 2).toUpperCase();

            var card = document.createElement('div');
            card.className = `flex-shrink-0 min-w-[240px] w-[240px] bg-gradient-to-r from-[#1A1A1A] to-[#0F0F0F] p-3.5 rounded-2xl border border-white/5 flex items-center justify-between relative overflow-hidden group cursor-pointer transition-transform active:scale-95 ${isBig ? 'border-[#E91E3F]/40 shadow-[0_0_20px_rgba(233,30,63,0.1)]' : ''}`;
            card.onclick = function () { nav(d.screen); };

            card.innerHTML = `
                ${isBig ? `<div class="absolute bottom-0 left-0 w-full h-[1px] bg-gradient-to-r from-transparent via-[#E91E3F] to-transparent opacity-40"></div>` : ''}
                <div class="flex items-center gap-3">
                    <div class="w-11 h-11 rounded-full bg-[#252525] p-0.5 flex items-center justify-center border border-white/5 overflow-hidden">
                         <div class="w-full h-full rounded-full flex items-center justify-center text-xs font-bold" style="background:${color}; color:white">${initials}</div>
                    </div>
                    <div class="flex flex-col gap-0.5">
                        <div class="font-bold text-sm text-gray-100">${d.username}</div>
                        <div class="text-[10px] text-gray-500 font-medium flex items-center gap-1 uppercase tracking-wider">
                            <span class="material-symbols-outlined text-[12px]" style="color:${color}">stars</span> ${d.game}
                        </div>
                    </div>
                </div>
                <div class="text-right flex flex-col items-end gap-1">
                    <div class="font-bold text-[14px] flex items-center gap-1 ${isBig ? 'text-[#E91E3F] drop-shadow-[0_0_5px_rgba(233,30,63,0.3)]' : 'text-[#FFD700]'}">
                        + ${d.amount} ${unit}
                    </div>
                    <div class="text-[10px] font-mono ${isBig ? 'bg-[#E91E3F]/10 text-[#E91E3F]' : 'bg-white/5 text-gray-400'} px-1.5 py-0.5 rounded border ${isBig ? 'border-[#E91E3F]/20' : 'border-white/5'}">x${d.multiplier}</div>
                </div>`;

            el.insertBefore(card, el.firstChild);
            if (el.children.length > 20) {
                el.removeChild(el.lastChild);
            }
        }

        /* Auto-refresh Live Drops every 2 seconds */
        setInterval(function () {
            if (currentScreen === 'lobby') addRandomLiveDrop();
        }, 2000);

        /* === PROFILE === */
        async function loadProfile() {
            return await withGuard('profile', async () => {
                try {
                    var u = window.Telegram && window.Telegram.WebApp && window.Telegram.WebApp.initDataUnsafe && window.Telegram.WebApp.initDataUnsafe.user ? window.Telegram.WebApp.initDataUnsafe.user : null;
                    var displayName = 'Player';
                    if (u && (u.first_name || u.username)) displayName = u.first_name || u.username;
                    document.getElementById('profName').textContent = displayName;
                    document.getElementById('profId').textContent = 'ID: ' + (UID ? UID.toString().slice(-8) : '...');

                    if (u && u.photo_url) {
                        document.getElementById('profAvatarInner').innerHTML = '<img src="' + u.photo_url + '" alt="Avatar" style="width:100%;height:100%;object-fit:cover">';
                    } else {
                        document.getElementById('profAvatarInner').innerHTML = '<div style="width:100%;height:100%;background:var(--surface2);display:flex;align-items:center;justify-content:center;font-size:32px;color:#fff;font-weight:800">' + displayName.charAt(0).toUpperCase() + '</div>';
                    }

                    var r = await apiFetch('/api/profile?' + qs());
                    var d = await safeJson(r);
                    if (!d || !d.ok) return;

                    if (d.vip) document.getElementById('profVipBadge').textContent = d.vip.name;

                    var tiers = [
                        { name: 'Bronze', icon: 'ðŸ¥‰', cb: '0%', perks: 'Basic access' },
                        { name: 'Silver', icon: 'ðŸ¥ˆ', cb: '3%', perks: 'Weekly tournaments' },
                        { name: 'Gold', icon: 'ðŸ¥‡', cb: '5%', perks: 'Priority support' },
                        { name: 'Platinum', icon: 'ðŸ’Ž', cb: '8%', perks: 'Personal manager' },
                        { name: 'Diamond', icon: 'ðŸ‘‘', cb: '10%', perks: 'Exclusive events' }
                    ];
                    var currentIndex = tiers.findIndex(function (t) { return t.name === d.vip.name });
                    if (currentIndex === -1) currentIndex = 0;

                    var html = '';
                    tiers.forEach(function (t, i) {
                        var isCurrent = i === currentIndex;
                        var isLocked = i > currentIndex;
                        var isPassed = i < currentIndex;

                        var bg = isCurrent ? 'linear-gradient(135deg, rgba(227,30,36,.15), rgba(227,30,36,.05))' : 'rgba(255,255,255,.02)';
                        var border = isCurrent ? '1px solid var(--red)' : '1px solid rgba(255,255,255,.05)';
                        var opacity = isLocked ? '0.5' : '1';

                        var progressHtml = '';
                        if (isCurrent && d.vip.next_at) {
                            var pct = Math.min(100, Math.round(d.vip.wagered / d.vip.next_at * 100));
                            progressHtml = '<div style="margin-top:12px"><div style="display:flex;justify-content:space-between;font-size:9px;color:var(--dim);margin-bottom:4px"><span>Wagered</span><span>$' + d.vip.wagered + ' / $' + d.vip.next_at + '</span></div><div style="height:4px;background:var(--surface2);border-radius:2px;overflow:hidden"><div style="height:100%;width:' + pct + '%;background:var(--red);border-radius:2px"></div></div></div>';
                        } else if (isPassed) {
                            progressHtml = '<div style="margin-top:12px;font-size:10px;color:var(--green);font-weight:700">â€¢ Completed</div>';
                        }

                        html += '<div style="flex:0 0 240px;scroll-snap-align:center;padding:16px;background:' + bg + ';border:' + border + ';border-radius:var(--radius-xl);opacity:' + opacity + ';position:relative;backdrop-filter:blur(8px)">';
                        if (isLocked) html += '<div style="position:absolute;top:12px;right:12px;font-size:16px;opacity:0.5">ðŸ”’</div>';

                        html += '<div style="font-size:28px;margin-bottom:8px">' + t.icon + '</div>';
                        html += '<div style="font-family:\'Montserrat\',sans-serif;font-size:18px;font-weight:900;color:#fff;margin-bottom:2px">' + t.name + '</div>';
                        html += '<div style="font-size:11px;color:var(--dim)">' + t.cb + ' Cashback Â· ' + t.perks + '</div>';
                        html += progressHtml;
                        html += '</div>';
                    });

                    var cont = document.getElementById('vipCardsContainer');
                    if (cont) {
                        cont.innerHTML = html;
                        setTimeout(function () {
                            var cardWidth = 240 + 12;
                            cont.scrollTo({ left: currentIndex * cardWidth - 16, behavior: 'smooth' });
                        }, 100);
                    }
                    /* Stats: wins = bets with positive profit, losses = bets with zero/negative */
                    var wins = 0, losses = 0;
                    if (d.recent_bets) { d.recent_bets.forEach(function (b) { if (b.profit > 0) wins++; else losses++ }) }
                    document.getElementById('stWins').textContent = d.stats.won > 0 ? wins : 0;
                    document.getElementById('stLosses').textContent = losses;
                    document.getElementById('stTotal').textContent = d.stats.spins;
                } catch (e) {
                    console.error('API /profile fetch failed:', e);
                }
            });
        }

        /* === REFERRAL === */
        function loadReferral() {
            var refUrl = 'https://t.me/' + BOT + '?start=ref' + UID;
            document.getElementById('refUrl').textContent = refUrl;
        }
        function copyRefLink() {
            var url = 'https://t.me/' + BOT + '?start=ref' + UID;
            if (navigator.clipboard) {
                navigator.clipboard.writeText(url).then(function () {
                    var btn = document.querySelector('.ref-copy'); btn.innerHTML = '<span class="material-symbols-outlined" style="font-size:16px">check</span> OK';
                    setTimeout(function () { btn.innerHTML = '<span class="material-symbols-outlined" style="font-size:16px">content_copy</span>' + T.copy }, 2000);
                })
            }
        }
        function shareRef() { tg.openTelegramLink('https://t.me/share/url?url=https://t.me/' + BOT + '?start=ref' + UID + '&text=ðŸŽ°') }
        function changeLang() { openLangSelector() }

        function openLangSelector() {
            var el = document.getElementById('langOverlay');
            if (el) el.style.display = 'flex';
        }
        function closeLangSelector() {
            var el = document.getElementById('langOverlay');
            if (el) el.style.display = 'none';
        }
        function setLang(l) {
            var u = new URL(window.location.href);
            u.searchParams.set('lang', l);
            window.location.href = u.toString();
        }

        var wheelLockTimer = null;
        async function checkWheel() {
            return await withGuard('wheel', async () => {
                try {
                    var r = await apiFetch('/api/wheel-status?' + qs());
                    var d = await safeJson(r);
                    var btn = document.querySelector('.wheel-spin-btn') || document.getElementById('wheelSpinBtn');
                    var timerEl = document.getElementById('wheelLockTimer');

                    if (d.ok && !d.available) {
                        document.getElementById('wheelBanner').classList.add('done');
                        if (btn) btn.style.display = 'none';
                        if (timerEl) {
                            timerEl.style.display = 'block';
                            startWheelCountdown(d.next_spin);
                        }
                    } else {
                        document.getElementById('wheelBanner').classList.remove('done');
                        if (btn) btn.style.display = 'block';
                        if (timerEl) timerEl.style.display = 'none';
                    }
                    return d;
                } catch (e) {
                    console.error('API /wheel-status fetch failed:', e);
                    throw e;
                }
            });
        }

        function startWheelCountdown(nextSpinTime) {
            if (wheelLockTimer) clearInterval(wheelLockTimer);
            var target = new Date(nextSpinTime).getTime();

            wheelLockTimer = setInterval(function () {
                var now = new Date().getTime();
                var diff = target - now;
                if (diff <= 0) {
                    clearInterval(wheelLockTimer);
                    checkWheel();
                    return;
                }
                var h = Math.floor(diff / 3600000);
                var m = Math.floor((diff % 3600000) / 60000);
                var s = Math.floor((diff % 60000) / 1000);
                var timerEl = document.getElementById('wheelLockTimer');
                if (timerEl) timerEl.textContent = (h < 10 ? '0' + h : h) + ':' + (m < 10 ? '0' + m : m) + ':' + (s < 10 ? '0' + s : s);
            }, 1000);
        }

        /* === INIT LOCALE === */
        function initLocale() {
            function setTxt(id, txt) { var el = document.getElementById(id); if (el) el.textContent = txt; }
            function setHtm(id, htm) { var el = document.getElementById(id); if (el) el.innerHTML = htm; }

            // Re-bind dynamic game configs with new translations
            if (typeof getGamesConfig !== 'undefined') {
                ALL_GAMES = getGamesConfig(T);
                if (document.getElementById('gameGrid')) {
                    var sGames = document.getElementById('scrGames');
                    if (sGames && sGames.style.display === 'block') {
                        // Keep current filter if possible, but safe full re-render is fine
                        filterGamesScreen(gamesCat || 'all');
                    }
                }
            }

            /* Nav */
            setTxt('navLobby', T.home);
            setTxt('navGame', T.games);
            setTxt('navBonuses', T.bonuses);
            setTxt('navWallet', T.wallet);
            setTxt('navProfile', T.profile);
            /* Header */
            setTxt('headerUnit', T.coins);
            /* Lobby */
            setTxt('searchPlaceholder', T.searchPlaceholder);
            renderBanners();
            setTxt('wheelTitle', T.wheel);
            setTxt('wheelSub', T.wheelSub);
            setTxt('secCat', T.categories);
            setTxt('secCatMore', T.viewAll);
            setTxt('secTrending', T.trending);
            /* Game */
            setTxt('bbLabel', T.buyBonus);
            setTxt('jackpotLabel', T.grandJackpot);
            setTxt('betUnit', T.coins);
            setTxt('betAmountLabel', T.betAmountLabel);
            /* Bonuses */
            setTxt('bonusTitle', T.bonusTitle);
            setTxt('bfTag', T.exclusive);
            setTxt('bfTimer', T.bfTimer);
            setTxt('bfTitle', T.bfTitle);
            setTxt('bfDesc', T.bfDesc);
            setTxt('bfWagerL', T.wager);
            setTxt('bfActivate', T.activate);
            setTxt('bc1Title', T.freeSpinsTitle);
            setTxt('bc1Desc', T.freeSpinsDesc);
            setTxt('bc1Btn', T.claimNow);
            setTxt('bc2Title', T.cashbackTitle);
            setTxt('bc2Desc', T.cashbackDesc);
            setTxt('bc2Btn', T.joinClub);
            setTxt('blTitle', T.vipTitle);
            setTxt('blDesc', T.vipDesc);
            /* Wallet */
            setTxt('wBalLabel', T.totalBalance);
            setTxt('wDeposit', T.deposit);
            setTxt('wWithdraw', T.withdraw);
            setTxt('wHistory', T.transHistory);
            setTxt('wMethodLabel', T.wMethodLabel);
            setTxt('wPkgLabel', T.selectPkg);
            setTxt('pmCardTitle', T.pmCardTitle);
            /* Referral */
            setHtm('refHeroTitle', T.inviteEarn.replace('&', '&amp;').replace(/(Earn|Zarabiaj|Ð—Ð°Ñ€Ð°Ð±Ð°Ñ‚Ñ‹Ð²Ð°Ð¹|Ð—Ð°Ñ€Ð¾Ð±Ð»ÑÐ¹)/, '<span>$1</span>'));
            setHtm('refHeroDesc', T.inviteDesc);
            setTxt('refLinkLabel', T.tapCopy);
            setTxt('refCopyText', T.copy);
            setTxt('refTotalLabel', T.totalRefs);
            setTxt('refEarnedLabel', T.earnedCoins);
            setTxt('refHowTitle', T.howItWorks);
            setTxt('refStep1T', T.step1T); setTxt('refStep1D', T.step1D);
            setTxt('refStep2T', T.step2T); setTxt('refStep2D', T.step2D);
            setTxt('refStep3T', T.step3T); setTxt('refStep3D', T.step3D);
            setTxt('refShareBtn', T.shareNow);
            /* Profile */
            setTxt('stWinsL', T.wins);
            setTxt('stLossesL', T.losses);
            setTxt('stTotalL', T.total);
            setTxt('profRefTitle', T.referralProgram);
            setTxt('profRefSub', T.inviteFriends);
            setTxt('profSettings', T.settings);
            setTxt('profSecurity', T.security);
            setTxt('profSupport', T.support);
            setTxt('profSignout', T.signOut);
            setTxt('profXpLabel', T.currentXp);
        }

        /* === BUILD DYNAMIC CONTENT === */
        function buildCategories() {
            var catRowEl = document.getElementById('catRow');
            if (!catRowEl) return;
            var cats = [
                { icon: 'casino', label: T.slots, screen: 'game' },
                { icon: 'stream', label: T.live, screen: null },
                { icon: 'trending_up', label: T.crash, screen: 'crash' },
                { icon: 'playing_cards', label: T.table, screen: null },
                { icon: 'favorite', label: 'â¤ï¸ ' + T.favs, screen: null, filterFav: true }
            ];
            catRowEl.innerHTML = cats.map(function (c, index) {
                var isActive = index === 0 ? ' active' : '';
                var onclick = c.filterFav ? 'filterFavorites()' : (c.screen ? 'nav(\'' + c.screen + '\')' : '');
                return '<div class="cat-item' + isActive + '" onclick="' + onclick + '">'
                    + '<div class="cat-icon"><span class="material-symbols-outlined">' + c.icon + '</span></div>'
                    + '<div class="cat-label">' + c.label + '</div></div>';
            }).join('');
        }

        /* === FAVORITES SYSTEM === */
        var favorites = JSON.parse(localStorage.getItem('rb_favorites') || '[]');
        function toggleFavorite(gameId, el) {
            var idx = favorites.indexOf(gameId);
            if (idx > -1) { favorites.splice(idx, 1); if (el) el.classList.remove('liked'); }
            else { favorites.push(gameId); if (el) el.classList.add('liked'); }
            localStorage.setItem('rb_favorites', JSON.stringify(favorites));
            if (window.Telegram && window.Telegram.WebApp && window.Telegram.WebApp.HapticFeedback) window.Telegram.WebApp.HapticFeedback.impactOccurred('light');
        }
        function filterFavorites() {
            /* Show only favorite games in grid */
            var tiles = document.querySelectorAll('#gameGrid > div');
            var anyVisible = false;
            tiles.forEach(function (t) {
                var gid = t.getAttribute('data-game-id');
                if (favorites.indexOf(gid) > -1) { t.style.display = ''; anyVisible = true; }
                else { t.style.display = 'none'; }
            });
            if (!anyVisible) {
                showToast('â¤ï¸', T.noFavs, 'OK', '', function () { closeToast(); /* restore all */ tiles.forEach(function (t) { t.style.display = '' }) });
            }
        }

        /* === GAME PROVIDERS === */
        var PROVIDERS = [
            { id: 'all', name: 'All' },
            { id: 'rubybet', name: 'RubyBet' },
            { id: 'pragmatic', name: 'Pragmatic' },
            { id: 'pgsoft', name: 'PGSoft' },
            { id: 'netent', name: 'NetEnt' },
            { id: 'evolution', name: 'Evolution' },
            { id: 'hacksaw', name: 'Hacksaw' },
            { id: 'nolimit', name: 'No Limit' }
        ];
        function buildProviders() {
            var el = document.getElementById('providersRow');
            if (!el) return;
            el.innerHTML = PROVIDERS.map(function (p, i) {
                return '<div class="provider-pill' + (i === 0 ? ' active' : '') + '" onclick="selectProvider(\'' + p.id + '\', this)">' + p.name + '</div>';
            }).join('');
        }
        function selectProvider(id, el) {
            document.querySelectorAll('.provider-pill').forEach(function (p) { p.classList.remove('active') });
            if (el) el.classList.add('active');
            /* Filter game grid by provider */
            var tiles = document.querySelectorAll('#gameGrid > div');
            tiles.forEach(function (t) {
                if (id === 'all') { t.style.display = ''; return; }
                var prov = t.getAttribute('data-provider') || '';
                t.style.display = prov === id ? '' : 'none';
            });
        }
        function openProvidersSheet() {
            var grid = document.getElementById('providersSheetGrid');
            if (grid) {
                var all = [{ id: 'all', name: 'â­ All' }].concat(PROVIDERS);
                grid.innerHTML = all.map(function(p) {
                    return '<div class="ps-pill' + (p.id === 'all' ? ' active' : '') + '" onclick="sheetSelectProvider(\'' + p.id + '\',this)">' + p.name + '</div>';
                }).join('');
            }
            var overlay = document.getElementById('providersSheetOverlay');
            if (overlay) overlay.classList.add('open');
        }
        function closeProvidersSheet(e) {
            var overlay = document.getElementById('providersSheetOverlay');
            if (overlay) overlay.classList.remove('open');
        }
        function sheetSelectProvider(id, el) {
            document.querySelectorAll('.ps-pill').forEach(function(p){ p.classList.remove('active'); });
            if (el) el.classList.add('active');
            /* Filter lobby game grid */
            var tiles = document.querySelectorAll('#gameGrid > div');
            tiles.forEach(function(t) {
                if (id === 'all') { t.style.display = ''; return; }
                var prov = t.getAttribute('data-provider') || '';
                t.style.display = prov === id ? '' : 'none';
            });
            setTimeout(closeProvidersSheet, 200);
        }

        /* === TOP WINNINGS LEADERBOARD === */
        var topWinsCache = {};
        function switchTopWins(period, el) {
            document.querySelectorAll('.tw-tab').forEach(function (t) { t.classList.remove('active') });
            if (el) el.classList.add('active');
            loadTopWinnings(period);
        }
        async function loadTopWinnings(period) {
            if (!period) period = 'day';
            return await withGuard('top_winnings', async () => {
                try {
                    var r = await apiFetch('/api/top-winnings?period=' + period + '&' + qs());
                    var d = await safeJson(r);
                    if (d.ok && d.winners && d.winners.length > 0) { renderTopWinnings(d.winners); return; }
                } catch (e) { }

                /* Demo fallback remains... */
                /* Demo fallback */
                var demoNames = ['Ton***99', 'Max***23', 'Luc***77', 'Pro***88', 'Vip***33', 'Ace***11', 'Win***42', 'Bet***55'];
                var demoGames = ['Ruby Slots', 'Crash', 'Lucky Bonanza', 'Crash', 'Mines', 'Ruby Slots', 'Plinko', 'Crash'];
                var demoColors = ['#6366f1', '#8b5cf6', '#ec4899', '#f59e0b', '#10b981', '#3b82f6', '#ef4444', '#14b8a6'];
                var demoData = [];
                for (var i = 0; i < 15; i++) {
                    var mult = (Math.random() * 150 + 1.5).toFixed(1);
                    var amt = (Math.random() * 2500 + 10).toFixed(2);
                    demoData.push({
                        username: demoNames[i % demoNames.length],
                        game: demoGames[i % demoGames.length],
                        win_amount: parseFloat(amt),
                        multiplier: parseFloat(mult),
                        color: demoColors[i % demoColors.length]
                    });
                }
                demoData.sort(function (a, b) { return b.win_amount - a.win_amount });
                renderTopWinnings(demoData);
            });
        }
        function renderTopWinnings(winners) {
            var el = document.getElementById('topWinsList');
            if (!el) return;
            var html = '';
            winners.forEach(function (w, i) {
                var rank = i + 1;
                var rankClass = rank === 1 ? 'gold' : rank === 2 ? 'silver' : rank === 3 ? 'bronze' : '';
                var color = w.color || '#6366f1';
                var initials = (w.username || 'U').substring(0, 2).toUpperCase();
                html += '<div class="tw-row">';
                html += '<div class="tw-rank ' + rankClass + '">' + (rank <= 3 ? ['ðŸ¥‡', 'ðŸ¥ˆ', 'ðŸ¥‰'][rank - 1] : rank) + '</div>';
                html += '<div class="tw-avatar" style="background:' + color + '">' + initials + '</div>';
                html += '<div class="tw-info"><div class="tw-name">' + (w.username || 'Player') + '</div><div class="tw-game">' + (w.game || 'Casino') + '</div></div>';
                html += '<div class="tw-amount"><div class="tw-val">+' + (w.win_amount || 0).toFixed(2) + '</div><div class="tw-mult">x' + (w.multiplier || 0).toFixed(1) + '</div></div>';
                html += '</div>';
            });
            el.innerHTML = html;
        }

        /* === LIVE DROPS REDESIGN RENDERING === */
        function renderLiveDrops(drops) {
            var el = document.getElementById('liveDropsScroll');
            if (!el) return;
            var html = '';
            drops.forEach(function (d) {
                var isBig = d.multiplier >= 10;
                var color = d.color || '#E91E3F';
                var unit = d.currency === 'stars' ? 'Stars' : 'TON';
                var initials = (d.username || 'U').substring(0, 2).toUpperCase();

                html += `
                <div class="bg-gradient-to-r from-[#1A1A1A] to-[#0F0F0F] p-3.5 rounded-2xl border border-white/5 flex items-center justify-between relative overflow-hidden group ${isBig ? 'border-[#E91E3F]/40 shadow-[0_0_20px_rgba(233,30,63,0.1)]' : ''}">
                    ${isBig ? `<div class="absolute bottom-0 left-0 w-full h-[1px] bg-gradient-to-r from-transparent via-[#E91E3F] to-transparent opacity-40"></div>` : ''}
                    <div class="flex items-center gap-3">
                        <div class="w-11 h-11 rounded-full bg-[#252525] p-0.5 flex items-center justify-center border border-white/5 overflow-hidden">
                             <div class="w-full h-full rounded-full flex items-center justify-center text-xs font-bold" style="background:${color}; color:white">${initials}</div>
                        </div>
                        <div class="flex flex-col gap-0.5">
                            <div class="font-bold text-sm text-gray-100">${d.username}</div>
                            <div class="text-[10px] text-gray-500 font-medium flex items-center gap-1 uppercase tracking-wider">
                                <span class="material-symbols-outlined text-[12px]" style="color:${color}">stars</span> ${d.game}
                            </div>
                        </div>
                    </div>
                    <div class="text-right flex flex-col items-end gap-1">
                        <div class="font-bold text-[14px] flex items-center gap-1 ${isBig ? 'text-[#E91E3F] drop-shadow-[0_0_5px_rgba(233,30,63,0.3)]' : 'text-[#FFD700]'}">
                            + ${d.amount} ${unit}
                        </div>
                        <div class="text-[10px] font-mono ${isBig ? 'bg-[#E91E3F]/10 text-[#E91E3F]' : 'bg-white/5 text-gray-400'} px-1.5 py-0.5 rounded border ${isBig ? 'border-[#E91E3F]/20' : 'border-white/5'}">x${d.multiplier}</div>
                    </div>
                </div>`;
            });
            el.innerHTML = html;
        }

        /* === SEARCH === */
        var ALL_GAMES = [];

        function openSearch() {
            document.getElementById('searchOverlay').classList.add('open');
            setTimeout(function () { document.getElementById('searchInput').focus(); }, 100);
        }
        function closeSearch() {
            document.getElementById('searchOverlay').classList.remove('open');
            document.getElementById('searchInput').value = '';
        }
        function onSearchInput(val) {
            var el = document.getElementById('searchResults');
            if (!val || val.length < 1) {
                el.innerHTML = '<div class="search-empty"><span class="material-symbols-outlined" style="font-size:48px;display:block;margin-bottom:8px">search</span>' + T.searchPrompt + '</div>';
                return;
            }
            var q = val.toLowerCase();
            var results = ALL_GAMES.filter(function (g) { return g.name.toLowerCase().indexOf(q) > -1 });
            if (results.length === 0) {
                el.innerHTML = '<div class="search-empty"><span class="material-symbols-outlined" style="font-size:48px;display:block;margin-bottom:8px">search_off</span>' + T.noResults + '</div>';
                return;
            }
            el.innerHTML = results.map(function (g) {
                var isFav = favorites.indexOf(g.id) > -1;
                var iconStyle = g.bg ? 'background:' + g.bg : '';
                if (g.icon) iconStyle += `;background-image:url('${g.icon}');background-size:cover`;
                return `<div class="search-result-item" onclick="${g.screen ? "closeSearch();nav('" + g.screen + "')" : ""}">`
                    + `<div class="search-result-icon" style="${iconStyle}">${g.icon ? '' : g.emoji}</div>`
                    + `<div style="flex:1"><div class="search-result-name">${g.name}</div><div class="search-result-tag">${g.tag}${g.provider ? ' Â· ' + g.provider : ''}</div></div>`
                    + `<button class="fav-btn${isFav ? ' liked' : ''}" onclick="event.stopPropagation();toggleFavorite('${g.id}',this)" style="position:static"><span class="material-symbols-outlined">favorite</span></button>`
                    + `</div>`;
            }).join('');
        }

        /* === NOTIFICATION BADGE === */
        function updateBonusBadge() {
            var badge = document.getElementById('bonusBadge');
            if (!badge) return;
            var count = userBonuses && userBonuses.active ? userBonuses.active.length : 0;
            if (count > 0) { badge.textContent = count; badge.style.display = 'flex'; }
            else { badge.style.display = 'none'; }
        }

        function buildGameGrid(targetEl, filter) {
            var games = filter ? ALL_GAMES.filter(filter) : ALL_GAMES;
            var target = typeof targetEl === 'string' ? document.getElementById(targetEl) : document.getElementById('gameGrid');
            var html = '';
            games.forEach(function (g) {
                var isSoon = g.tag === 'SOON' || g.tag === 'Ð¡ÐšÐžÐ Ðž' || g.tag === 'ÐÐ•Ð—ÐÐ‘ÐÐ ÐžÐœ' || g.tag === 'WKRÃ“TCE';
                var isFav = favorites.indexOf(g.id) > -1;
                var badgeHtml = g.tag ? `<div class="absolute top-2 left-2 text-[9px] font-[800] uppercase px-[8px] py-[2px] rounded-[4px] tracking-[0.5px] z-10 ${isSoon ? 'bg-surface2 text-dim' : 'bg-red text-white'}">${g.tag}</div>` : '';
                var favHtml = `<button class="fav-btn${isFav ? ' liked' : ''}" onclick="event.stopPropagation();toggleFavorite('${g.id}',this)"><span class="material-symbols-outlined">favorite</span></button>`;
                var visualHtml = g.icon
                    ? `<div class="absolute inset-0 border-b border-border" style="background:url('${g.icon}') center/cover"></div>`
                    : `<div class="absolute inset-0 opacity-40" style="background:${g.bg || '#333'}"></div><div class="relative z-10">${g.emoji}</div>`;

                html += `<div class="relative rounded-lg overflow-hidden bg-surface border border-border cursor-pointer transition-transform active:scale-95" data-game-id="${g.id}" data-provider="${g.provider || ''}" data-cat="${g.category || 'slots'}" onclick="${g.screen ? "nav('" + g.screen + "')" : ""}">`
                    + badgeHtml + favHtml
                    + `<div class="w-full aspect-[4/3] flex items-center justify-center text-[42px] relative">`
                    + visualHtml
                    + `</div>`
                    + '<div class="p-[10px]">'
                    + '<div class="font-[Montserrat] text-[12px] font-[800] uppercase tracking-[0.3px] whitespace-nowrap overflow-hidden text-ellipsis">' + g.name + '</div>'
                    + '<div class="text-[10px] text-dim font-[500] mt-[2px]">' + (g.provider ? g.provider.charAt(0).toUpperCase() + g.provider.slice(1) : '') + ' Â· ' + g.tag + '</div>'
                    + '</div></div>';
            });
            target.innerHTML = html;
        }

        var allPromos = [];
        var activePromoCat = 'all';

        async function fetchPromos() {
            return await withGuard('promos', async () => {
                try {
                    var res = await apiFetch('/api/promos?' + qs());
                    var data = await safeJson(res);
                    if (data.ok && data.promos) {
                        allPromos = data.promos;
                        renderPromos(activePromoCat);
                        return data;
                    }
                } catch (e) {
                    console.error('Error fetching promos:', e);
                    throw e;
                }
            });
        }

        function initBonuses() {
            var bp = document.getElementById('bonusPills');
            if (bp) bp.style.display = 'none'; // Remove categories row
            fetchPromos();
        }

        function buildBonusPills() {
            var bp = document.getElementById('bonusPills');
            if (bp) bp.style.display = 'none';
        }

        function renderPromos(cat) {
            activePromoCat = cat;
            buildBonusPills();

            var container = document.getElementById('promoList');
            if (!container) return;

            var filtered = cat === 'all' ? allPromos : allPromos.filter(p => p.category === cat);
            var contentHtml = '';

            if (filtered.length === 0) {
                // If no promos, hide section or show minimal text
                container.innerHTML = '<div style="text-align:center;padding:40px 20px;color:var(--dim)">' + (T.noResults || 'No promos found') + '</div>';
                return;
            }

            filtered.forEach(function (p) {
                if (p.ui_type === 'featured') {
                    contentHtml += `
                    <div class="bonus-featured">
                        <div style="position:absolute;inset:0;background:url('${p.image}') center/cover;opacity:.4"></div>
                        <div style="position:absolute;inset:0;background:linear-gradient(to top,#000 0%,rgba(0,0,0,.8) 40%,transparent 100%)"></div>
                        <div class="bonus-featured-content">
                            <div class="bf-tags">
                                <div class="bf-tag">${p.tag || 'PROMO'}</div>
                                ${p.timer ? '<div class="bf-timer"><span class="material-symbols-outlined">schedule</span><span>' + p.timer + '</span></div>' : ''}
                            </div>
                            <div class="bf-title">${p.title}</div>
                            <div class="bf-desc">${p.description}</div>
                            <div class="bf-bottom">
                                <div>
                                    <div class="bf-wager-label">${T.wager || 'WAGER'}</div>
                                    <div class="bf-wager-val">${p.wager || 'x1'}</div>
                                </div>
                                <button class="bf-activate" onclick="${p.action}"><span>${p.btnText}</span><span class="material-symbols-outlined">arrow_forward</span></button>
                            </div>
                        </div>
                    </div>`;
                } else if (p.ui_type === 'card') {
                    contentHtml += `
                    <div class="bonus-card">
                        <div class="bonus-card-img" style="background:url('${p.image}') center/cover"></div>
                        <div class="bonus-card-body">
                            <div class="bonus-card-title">${p.title}</div>
                            <div class="bonus-card-desc">${p.description}</div>
                            <button class="bonus-card-btn" onclick="${p.action}">${p.btnText}</button>
                        </div>
                    </div>`;
                } else if (p.ui_type === 'locked') {
                    contentHtml += `
                    <div class="bonus-locked" style="position:relative">
                        <div style="width:33%;min-height:100px;background:url('${p.image}') center/cover;filter:grayscale(1);flex-shrink:0"></div>
                        <div class="lock-icon"><span class="material-symbols-outlined">lock</span></div>
                        <div class="bonus-locked-body">
                            <div class="bl-title">${p.title}</div>
                            <div class="bl-desc">${p.description}</div>
                            <div class="bl-progress">
                                <div class="bl-progress-fill" style="width:${p.progress_pct}%"></div>
                            </div>
                            <div class="bl-progress-label">${p.progress}</div>
                        </div>
                    </div>`;
                }
            });
            container.innerHTML = contentHtml;
        }

        /* === PERSONAL BONUS SYSTEM === */
        function switchBonusTab(tab) {
            document.getElementById('segActive').classList.toggle('active', tab === 'active');
            document.getElementById('segHistory').classList.toggle('active', tab === 'history');
            document.getElementById('bonusActivePanel').style.display = tab === 'active' ? 'block' : 'none';
            document.getElementById('bonusHistoryPanel').style.display = tab === 'history' ? 'block' : 'none';
        }

        /* Fallback demo data â€” used when API is unavailable */
        var userBonuses = {
            balance: 150.00,
            active: [
                { id: 1, bonus_type: 'cashback', title: 'Weekly Cashback', description: 'Earn 10% back on all weekly losses', icon: 'payments', progress: 85.5, max_progress: 100, amount: 85.50, vip_tag: '', expires_at: '', status: 'active', badge: 'CASHBACK' },
                { id: 2, bonus_type: 'free_spins', title: 'Loyalty Free Spins', description: "50 Spins on 'Ruby Reels' Deluxe", icon: 'casino', progress: 0, max_progress: 0, amount: 50, vip_tag: 'VIP GOLD', expires_at: '2026-02-24 15:00:00', status: 'active', badge: 'FREE SPINS' },
                { id: 3, bonus_type: 'deposit_match', title: 'Deposit Match', description: 'Wager $200 more to unlock $50 cash', icon: 'trophy', progress: 120, max_progress: 200, amount: 50, vip_tag: '', expires_at: '', status: 'active', badge: 'DEPOSIT MATCH' }
            ],
            history: [
                { id: 10, title: 'Welcome Free Bet', claimed_at: '2023-09-28', amount: 50.00, status: 'completed', badge: 'DEPOSIT MATCH', icon: 'redeem' },
                { id: 11, title: 'Weekly Reload Boost', claimed_at: '2023-10-05', amount: 25.00, status: 'expired', badge: 'RELOAD', icon: 'timer_off' },
                { id: 12, title: 'UCL Finals Cashback', claimed_at: '2023-09-15', amount: 120.50, status: 'completed', badge: 'CASHBACK', icon: 'sports_soccer' },
                { id: 13, title: 'Referral Reward', claimed_at: '2023-08-22', amount: 10.00, status: 'expired', badge: 'REFERRAL', icon: 'confirmation_number' }
            ]
        };

        async function loadBonuses() {
            return await withGuard('bonuses', async () => {
                try {
                    var r = await apiFetch('/api/bonuses?' + qs());
                    var d = await safeJson(r);
                    if (d.ok) {
                        userBonuses.balance = d.balance || 0;
                        if (d.active && d.active.length > 0) userBonuses.active = d.active;
                        if (d.history && d.history.length > 0) userBonuses.history = d.history;
                    }
                    renderActiveBonuses(); renderBonusHistory(); updateBonusBadge();
                    return d;
                } catch (e) {
                    console.error('API /bonuses fetch failed:', e);
                    throw e;
                }
            });
        }

        function switchBonusTab(tab) {
            document.getElementById('tabBonusAvailable').classList.toggle('active', tab === 'available');
            document.getElementById('tabBonusMy').classList.toggle('active', tab === 'my');
            document.getElementById('bonusAvailableSection').style.display = tab === 'available' ? 'block' : 'none';
            document.getElementById('bonusMySection').style.display = tab === 'my' ? 'block' : 'none';
        }

        function renderActiveBonuses() {
            var b = userBonuses;
            var elBal = document.getElementById('bonusBalAmount');
            if (elBal) elBal.textContent = '$' + b.balance.toFixed(2);
            var elCount = document.getElementById('activeBonusCount');
            if (elCount) elCount.textContent = b.active.length + ' Active';
            var html = '';
            b.active.forEach(function (a) {
                /* Card with left red border accent */
                html += '<div class="glass-card" style="border-left:3px solid var(--red)">';
                html += '<div class="gc-bg-icon"><span class="material-symbols-outlined">' + (a.icon || 'redeem') + '</span></div>';
                /* Title + VIP tag */
                html += '<div style="display:flex;justify-content:space-between;align-items:flex-start;position:relative;z-index:1;margin-bottom:2px">';
                html += '<div class="gc-title">' + a.title + '</div>';
                if (a.vip_tag) html += '<span class="gc-vip-tag">' + a.vip_tag + '</span>';
                html += '</div>';
                html += '<div class="gc-desc">' + (a.description || '') + '</div>';

                /* Timer (if expires_at is set and in the future) */
                if (a.expires_at) {
                    var remaining = getTimeRemaining(a.expires_at);
                    if (remaining) html += '<div class="gc-timer"><span class="material-symbols-outlined">timer</span><div><div class="gc-timer-label">Expires In</div><div class="gc-timer-val">' + remaining + '</div></div></div>';
                }

                /* Progress bar */
                if (a.max_progress > 0) {
                    var pct = Math.min(100, Math.round(a.progress / a.max_progress * 100));
                    var label = a.bonus_type === 'deposit_match' ? 'Wagering Requirement' : 'Progress';
                    html += '<div class="gc-progress"><div class="gc-progress-header"><span class="label">' + label + '</span><span class="val">';
                    if (a.bonus_type === 'deposit_match') html += pct + '%';
                    else html += '$' + a.progress.toFixed(2) + ' / $' + a.max_progress.toFixed(2) + ' Max';
                    html += '</span></div><div class="gc-progress-bar"><div class="gc-progress-fill" style="width:' + pct + '%"></div></div></div>';
                }

                /* Note for deposit match */
                if (a.bonus_type === 'deposit_match') html += '<div style="font-size:10px;color:var(--dim2);font-style:italic;margin-bottom:14px;position:relative;z-index:1">Eligible on Sports and Casino slots.</div>';

                /* Button */
                if (a.bonus_type === 'cashback' && a.progress > 0) {
                    html += '<button class="gc-btn-primary" onclick="claimBonus(' + a.id + ',' + a.progress + ')">Claim $' + a.progress.toFixed(2) + '</button>';
                } else if (a.bonus_type === 'free_spins') {
                    html += '<button class="gc-btn-primary" onclick="activateBonus(' + a.id + ')">Activate Now</button>';
                } else {
                    html += '<button class="gc-btn-outline" onclick="viewBonusDetails(' + a.id + ')">View Details</button>';
                }
                html += '</div>';
            });
            if (b.active.length === 0) {
                html += '<div style="text-align:center;padding:40px 0;opacity:.4"><span class="material-symbols-outlined" style="font-size:40px;display:block;margin-bottom:6px">redeem</span><span style="font-size:12px">No active bonuses</span></div>';
            }
            document.getElementById('activeBonusList').innerHTML = html;
        }

        function renderBonusHistory() {
            var h = userBonuses.history;
            var html = '';
            h.forEach(function (item) {
                var isExpired = item.status === 'expired';
                var dateStr = item.claimed_at || item.created_at || '';
                var dateLabel = isExpired ? 'Expired ' : 'Claimed ';
                if (dateStr.length >= 10) dateLabel += formatBonusDate(dateStr);

                html += '<div class="history-item' + (isExpired ? ' expired' : '') + '" style="border-left:3px solid ' + (isExpired ? 'var(--border)' : 'var(--red)') + '">';

                /* Top: icon + info + amount */
                html += '<div class="hi-top"><div style="display:flex;align-items:flex-start;gap:10px"><div class="hi-icon ' + (isExpired ? 'inactive' : 'active') + '"><span class="material-symbols-outlined" style="color:' + (isExpired ? 'var(--dim2)' : 'var(--red)') + ';font-variation-settings:\'FILL\' ' + (isExpired ? '0' : '1') + '">' + (item.icon || 'redeem') + '</span></div>';
                html += '<div class="hi-info"><div class="hi-title">' + item.title + '</div><div class="hi-date">' + dateLabel + '</div></div></div>';
                html += '<div class="hi-amount"><div class="hi-val"' + (isExpired ? ' style="color:var(--dim2)"' : '') + '>$' + (item.amount || 0).toFixed(2) + '</div><div class="hi-val-label">Value</div></div></div>';

                /* Bottom: status + badge */
                html += '<div class="hi-bottom"><div class="hi-status ' + (isExpired ? '' : 'completed') + '">';
                if (isExpired) html += '<span class="material-symbols-outlined">cancel</span><span>Expired</span>';
                else html += '<span class="material-symbols-outlined" style="font-variation-settings:\'FILL\' 1">check_circle</span><span>Completed</span>';
                html += '</div><span class="hi-badge">' + (item.badge || item.bonus_type || 'BONUS') + '</span></div>';
                html += '</div>';
            });
            if (h.length === 0) {
                html += '<div style="text-align:center;padding:30px 0;opacity:.4"><span style="font-size:12px">No bonus history yet</span></div>';
            }
            // Temporarily mapping bonusHistoryList to nothing since it was moved to Profile screen but removed from it to save space
            var hl = document.getElementById('bonusHistoryList');
            if (hl) hl.innerHTML = html;
        }

        function getTimeRemaining(dateStr) {
            try {
                var end = new Date(dateStr.replace(' ', 'T')); var now = new Date();
                var diff = end - now; if (diff <= 0) return null;
                var h = Math.floor(diff / 3600000); var m = Math.floor((diff % 3600000) / 60000); var s = Math.floor((diff % 60000) / 1000);
                return (h < 10 ? '0' : '') + h + 'h : ' + (m < 10 ? '0' : '') + m + 'm : ' + (s < 10 ? '0' : '') + s + 's';
            } catch (e) { return null }
        }

        function formatBonusDate(d) {
            try {
                var dt = new Date(d.replace(' ', 'T'));
                var months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
                return months[dt.getMonth()] + ' ' + dt.getDate() + ', ' + dt.getFullYear();
            } catch (e) { return d }
        }

        async function claimBonus(id, amount) {
            return await withGuard('claim_bonus', async () => {
                try {
                    var r = await apiFetch('/api/claim-bonus', { method: 'POST', body: JSON.stringify(Object.assign({}, auth(), { bonus_id: id })) });
                    var d = await safeJson(r);
                    if (d.ok) {
                        showToast('âœ…', 'Claimed $' + (amount || 0).toFixed(2) + '!', 'OK', '', function () { closeToast() });
                        loadBalance();
                    } else {
                        showToast('âŒ', d.error || 'Failed to claim', 'OK', '', function () { closeToast() });
                    }
                } catch (e) { showToast('âŒ', 'Network error', 'OK', '', function () { closeToast() }) }
            });
        }

        async function activateBonus(id) {
            return await withGuard('activate_bonus', async () => {
                try {
                    var r = await apiFetch('/api/activate-bonus', { method: 'POST', body: JSON.stringify(Object.assign({}, auth(), { bonus_id: id })) });
                    var d = await safeJson(r);
                    if (d.ok) {
                        var msg = d.free_spins_added ? '+' + d.free_spins_added + ' Free Spins!' : 'Bonus activated!';
                        showToast('âš¡', msg, 'OK', '', function () { closeToast() });
                        loadBalance();
                    } else {
                        showToast('âŒ', d.error || 'Failed', 'OK', '', function () { closeToast() });
                    }
                } catch (e) { showToast('âŒ', 'Network error', 'OK', '', function () { closeToast() }) }
            });
        }

        function viewBonusDetails(id) {
            var bonus = userBonuses.active.find(function (b) { return b.id === id });
            if (bonus && bonus.max_progress > 0) {
                var remaining = (bonus.max_progress - bonus.progress).toFixed(2);
                showToast('â„¹ï¸', 'Wager $' + remaining + ' more to unlock $' + bonus.amount.toFixed(2), 'OK', '', function () { closeToast() });
            } else {
                showToast('â„¹ï¸', 'View details', 'OK', '', function () { closeToast() });
            }
        }

        function initBonuses() { loadBonuses() }

        function buildWalletPackages() {
            var pkgs = [{ amount: '50', price: '0.50' }, { amount: '100', price: '0.90' }, { amount: '500', price: '4.00' }];
            document.getElementById('assetRow').innerHTML = pkgs.map(function (p, i) {
                return '<button class="asset-btn' + (i === 0 ? ' active' : '') + '" onclick="selectPkg(this,\'' + p.amount + '\',\'' + p.price + '\')" data-coins="' + p.amount + '" data-price="' + p.price + '">' + p.amount + ' coins<br><span style="font-size:10px;color:var(--dim)">$' + p.price + '</span></button>';
            }).join('');
            /* Stars packages */
            var starPkgs = [{ stars: 50, price: '50' }, { stars: 150, price: '150' }, { stars: 500, price: '500' }];
            var sr = document.getElementById('starsRow');
            if (sr) sr.innerHTML = starPkgs.map(function (p, i) {
                return '<button class="asset-btn' + (i === 0 ? ' active' : '') + '" onclick="selectPkg(this,\'' + p.stars + '\',\'' + p.price + '\')" data-stars="' + p.stars + '" data-price="' + p.price + '">â­ ' + p.stars + '<br><span style="font-size:10px;color:var(--dim)">' + p.price + ' â­</span></button>';
            }).join('');
        }

        function selectPkg(el, amount, price) {
            document.querySelectorAll('.asset-btn').forEach(function (b) { b.classList.remove('active') });
            el.classList.add('active');
        }
        var selectedPkg = { coins: '50', price: '0.50' };
        function selectPkg(el, amount, price) {
            el.parentNode.querySelectorAll('.asset-btn').forEach(function (b) { b.classList.remove('active') });
            el.classList.add('active');
            selectedPkg = { coins: amount, price: price };
        }

        /* === CURRENCY SYSTEM === */
        var RATES = { USDT: 1, USD: 1, PLN: 4.05, UAH: 41.2, EUR: 0.92, RUB: 96.5 };
        var displayCurrency = 'USDT';
        var usdtBalance = 0; /* internal USDT balance (cents precision parsed to float $ ) */
        var payMethod = 'crypto'; /* crypto | card | stars */

        function setCurrency(cur) {
            displayCurrency = cur;
            document.querySelectorAll('#currencyRow .pill').forEach(function (p) { p.classList.toggle('active', p.getAttribute('data-cur') === cur) });
            updateWallet();
            updateBalanceUI();
        }

        function formatCurrency(usdtAmount, cur) {
            if (!cur) cur = displayCurrency;
            var val = usdtAmount * RATES[cur];
            var symbols = { USDT: '', USD: '$', PLN: 'zÅ‚', UAH: 'â‚´', EUR: 'â‚¬', RUB: 'â‚½' };
            if (cur === 'USDT') return val.toFixed(2);
            return symbols[cur] + val.toFixed(2);
        }

        function updateWallet() {
            var el = document.getElementById('wBalAmount');
            var unitEl = document.getElementById('wBalUnit');
            if (el) {
                if (displayCurrency === 'USDT') {
                    el.textContent = usdtBalance.toFixed(2);
                    if (unitEl) unitEl.textContent = 'USDT';
                } else {
                    el.textContent = formatCurrency(usdtBalance);
                    if (unitEl) unitEl.textContent = displayCurrency;
                }
            }
            var loc = document.getElementById('wBalLocal');
            if (loc) {
                if (displayCurrency !== 'USDT') loc.textContent = 'â‰ˆ ' + usdtBalance.toFixed(2) + ' USDT';
                else loc.textContent = '';
            }
            // Clear legacy stars UI if it still exists
            var se = document.getElementById('wStarsAmount');
            if (se) se.textContent = '';
        }

        function updateBalanceUI() {
            // Unified header balance display
            var hb = document.getElementById('headerBal');
            var hu = document.getElementById('headerUnit');

            if (hb) {
                if (!AppState.loaded) {
                    hb.innerHTML = '<div style="width:36px;height:14px;background:rgba(255,255,255,0.1);border-radius:4px;animation:pulse 1.5s infinite"></div>';
                } else if (usdtBalance !== null && usdtBalance !== undefined) {
                    hb.textContent = displayCurrency === 'USDT' ? usdtBalance.toFixed(2) : formatCurrency(usdtBalance);
                } else {
                    hb.textContent = '0.00';
                }
            }
            if (hu) hu.textContent = displayCurrency;

            /* Game balance â€” always show unified wallet */
            var gb = document.getElementById('gameBal');
            var cb = document.getElementById('crashBal');
            if (gb) gb.textContent = usdtBalance !== null ? usdtBalance.toFixed(2) : '0';
            if (cb) cb.textContent = usdtBalance !== null ? usdtBalance.toFixed(2) : '0';

            /* Header dual balance elements (if applicable) */
            var hsv = document.getElementById('headerBalStarsVal');
            if (hsv) hsv.parentElement.style.display = 'none'; // Hide stars block

            /* Popup values */
            var pu = document.getElementById('bpUsdtVal');
            if (pu) pu.textContent = '$' + (usdtBalance || 0).toFixed(2);
            var ps = document.getElementById('bpStarsVal');
            if (ps) ps.parentElement.style.display = 'none'; // Hide stars block

            var fb = document.getElementById('freeBadge'); if (fb) fb.textContent = freeSpins > 0 ? 'âš¡ ' + freeSpins + ' ' + T.freeSpins : '';
            updateSpinBtn();
        }

        /* Override loadBalance to set usdtBalance directly from balance_cents */
        var loadBalanceRetries = 0;
        async function loadBalance() {
            return await withGuard('balance', async () => {
                try {
                    var r = await apiFetch('/api/balance?' + qs());
                    var d = await safeJson(r);
                    if (d.ok) {
                        balance = d.balance;
                        freeSpins = d.free_spins || 0;
                        usdtBalance = parseFloat((balance / 100).toFixed(2));
                        AppState.loaded = true;
                        updateBalanceUI(); updateWallet();
                        if (d.vip) updateVIP(d.vip);
                        return d;
                    }
                } catch (e) {
                    console.error('API /balance fetch failed:', e);
                    throw e;
                }
            });
        }

        /* === WALLET TAB SWITCH (legacy â€” now using cashier tabs) === */
        function switchWalletTab(tab) {
            /* Legacy compatibility */
        }

        /* === CASHIER TAB SYSTEM === */
        function switchCashierTab(tab) {
            ['deposit', 'withdraw', 'history'].forEach(function (t) {
                var el = document.getElementById('cash' + t.charAt(0).toUpperCase() + t.slice(1));
                var tb = document.getElementById('cashTab' + t.charAt(0).toUpperCase() + t.slice(1));
                if (el) el.style.display = t === tab ? 'block' : 'none';
                if (tb) tb.classList.toggle('active', t === tab);
            });
            /* Ensure the content is visible by hiding other sections in the new layout if applicable */
            var histListWrapper = document.getElementById('txHistoryList');
            if (histListWrapper && histListWrapper.parentElement) {
                var histContainer = histListWrapper.parentElement;
                if (!histContainer.id.startsWith('cash')) {
                    /* If the new design doesn't use cashHistory, toggle visibility manually */
                    histContainer.style.display = tab === 'history' ? 'block' : 'none';
                    if (tab === 'deposit') {
                        // Display the standard deposit menu
                        var dc = document.getElementById('depositCryptoSection');
                        if (dc) dc.style.display = 'block';
                    } else {
                        var cDepo = document.getElementById('depositCryptoSection');
                        if (cDepo) cDepo.style.display = 'none';
                        var sDepo = document.getElementById('depositStarsSection');
                        if (sDepo) sDepo.style.display = 'none';
                    }
                }
            }
            if (tab === 'history') loadTransactionHistory();
            if (tab === 'withdraw') updateWithdrawInfo();
        }

        // Initialize Solana Module after basic definitions
        setTimeout(() => SolanaModule.init(), 100);

        function switchActiveWallet(w) {
            // Deprecated: UI no longer toggles between distinct Star/USDT internal wallets, 
            // but we keep this function structure to not break any existing external onclicks
            console.log('Wallet toggled, but system uses unified USD balance now.');
        }

        /* === PAYMENT METHOD === */
        function selectPayMethod(method) {
            payMethod = method;
            /* Crypto */
            var pmc = document.getElementById('pmCrypto');
            if (pmc) pmc.style.borderColor = method === 'crypto' ? 'var(--red)' : 'var(--border)';

            /* Stars */
            var pmStars = document.getElementById('pmStars');
            if (pmStars) pmStars.style.borderColor = method === 'stars' ? '#FFD700' : 'var(--border)';

            /* Solana */
            var pmSolana = document.getElementById('pmSolana');
            if (pmSolana) pmSolana.style.borderColor = method === 'solana' ? '#14f195' : 'var(--border)';

            /* Show/hide sections */
            var cs = document.getElementById('depositCryptoSection');
            var ss = document.getElementById('depositStarsSection');
            var sol = document.getElementById('depositSolanaSection');
            if (cs) cs.style.display = (method === 'crypto' || method === 'card') ? 'block' : 'none';
            if (ss) ss.style.display = method === 'stars' ? 'block' : 'none';
            if (sol) sol.style.display = method === 'solana' ? 'block' : 'none';

            if (typeof updateMainDepBtn === 'function') updateMainDepBtn();
        }

        /* === WITHDRAW === */
        var withdrawMethod = 'crypto';
        function selectWithdrawMethod(m) {
            withdrawMethod = m;
            document.getElementById('wdCrypto').classList.toggle('active', m === 'crypto');

            // Telegram Stars withdrawals to users are not natively supported by the API yet
            var wdStarsEl = document.getElementById('wdStars');
            if (wdStarsEl) wdStarsEl.classList.toggle('active', m === 'stars');

            document.getElementById('wdUnit').textContent = m === 'crypto' ? displayCurrency : 'USDT';
            updateWithdrawInfo();
        }
        function setWithdrawPct(pct) {
            var amt = (usdtBalance * pct / 100);
            document.getElementById('withdrawAmount').value = amt.toFixed(2);
        }
        function updateWithdrawInfo() {
            var unit = withdrawMethod === 'crypto' ? displayCurrency : 'USDT';
            document.getElementById('wdAvailable').textContent = usdtBalance.toFixed(2) + ' ' + unit;
        }
        async function submitWithdraw() {
            return await withGuard('withdraw', async () => {
                var amt = parseFloat(document.getElementById('withdrawAmount').value);
                if (!amt || amt <= 0) { showToast('âŒ', 'Enter valid amount', 'OK', '', function () { closeToast() }); return; }
                if (amt < 5) { showToast('âŒ', 'Minimum withdrawal: $5.00', 'OK', '', function () { closeToast() }); return; }
                if (amt > usdtBalance) { showToast('âŒ', 'Insufficient balance', 'OK', '', function () { closeToast() }); return; }

                try {
                    showToast('â³', 'Processing withdrawal...', 'â³', '', null);
                    var r = await apiFetch('/api/withdraw', { method: 'POST', body: JSON.stringify(Object.assign({}, auth(), { amount: amt, method: withdrawMethod })) });
                    var d = await safeJson(r);
                    closeToast();

                    if (d.ok) {
                        showToast('âœ…', 'Withdrawal request submitted! ' + (withdrawMethod === 'crypto' ? '$' + amt.toFixed(2) : amt + ' â­'), 'OK', '', function () { closeToast() });
                        loadBalance();
                    } else {
                        showToast('âŒ', d.error || 'Withdrawal failed', 'OK', '', function () { closeToast() });
                    }
                } catch (e) {
                    closeToast();
                    showToast('âŒ', 'Network failure: ' + e.message, 'OK', '', function () { closeToast() });
                }
            });
        }

        /* === TRANSACTION HISTORY === */
        async function loadTransactionHistory() {
            return await withGuard('transactions', async () => {
                var el = document.getElementById('txHistoryList');
                if (!el) return;
                el.innerHTML = '<div style="text-align:center;padding:30px 0;opacity:.5"><span class="material-symbols-outlined" style="font-size:24px;animation:spin 1s linear infinite">sync</span></div>';
                try {
                    var r = await apiFetch('/api/transactions?' + qs());
                    var d = await safeJson(r);
                    if (d.ok && d.transactions && d.transactions.length > 0) {
                        renderTransactions(d.transactions);
                        return;
                    }
                } catch (e) { }
                /* Demo fallback */
                var demoTxs = [
                    { type: 'deposit', amount: 50.00, label: 'USDT Deposit', status: 'completed', created_at: new Date().toISOString() },
                    { type: 'win', amount: 25.50, label: 'Slots Win', status: 'completed', created_at: new Date(Date.now() - 3600000).toISOString() },
                    { type: 'withdraw', amount: 10.00, label: 'USDT Withdraw', status: 'pending', created_at: new Date(Date.now() - 86400000).toISOString() }
                ];
                renderTransactions(demoTxs);
            });
        }
        function renderTransactions(txs) {
            var el = document.getElementById('txHistoryList');
            if (!el) return;
            if (!txs || txs.length === 0) {
                el.innerHTML = `
                <div style="text-align:center;padding:60px 20px;">
                    <div style="font-size:48px;margin-bottom:16px;opacity:0.3">ðŸ§¾</div>
                    <div style="color:var(--dim2);font-size:14px;margin-bottom:24px">${T.noHistory || 'No transactions yet'}</div>
                    <button class="btn-primary" style="padding:12px 24px;border-radius:12px;font-size:13px;font-weight:700" onclick="switchCashierTab('deposit')">${T.deposit || 'DEPOSIT'}</button>
                </div>`;
                return;
            }

            // Group by date
            var groups = {};
            txs.forEach(function (tx) {
                var d = new Date(tx.created_at || tx.date);
                var dateStr = d.toLocaleDateString('en-US', { day: 'numeric', month: 'long' });
                if (!groups[dateStr]) groups[dateStr] = [];
                groups[dateStr].push(tx);
            });

            var html = '';
            Object.keys(groups).forEach(function (date) {
                html += `<h3 style="text-align:left;font-size:10px;font-weight:800;color:var(--dim2);margin:24px 0 12px 16px;text-transform:uppercase;letter-spacing:1px">${date}</h3>`;
                groups[date].forEach(function (tx) {
                    var isPlus = tx.type === 'deposit' || tx.type === 'win';
                    var isDeposit = tx.type === 'deposit';
                    var icon = isPlus ? 'arrow_downward' : 'arrow_upward';
                    var color = isPlus ? '#10b981' : '#f43f5e';
                    var timeStr = new Date(tx.created_at || tx.date).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

                    var statusBadge = '';
                    if (tx.status === 'success' || tx.status === 'completed') {
                        statusBadge = '<span style="color:#10b981;font-size:10px;font-weight:800;background:rgba(16,185,129,0.1);padding:2px 6px;border-radius:4px">COMPLETED</span>';
                    } else if (tx.status === 'pending') {
                        statusBadge = '<span style="color:#f59e0b;font-size:10px;font-weight:800;background:rgba(245,158,11,0.1);padding:2px 6px;border-radius:4px">PENDING â†»</span>';
                    } else {
                        statusBadge = `<span style="color:#f43f5e;font-size:10px;font-weight:800;background:rgba(244,63,94,0.1);padding:2px 6px;border-radius:4px">${tx.status.toUpperCase()}</span>`;
                    }

                    var repeatBtn = isDeposit ? `<button onclick="switchCashierTab('deposit');document.getElementById('depAmtCrypto').value='${tx.amount}';updateMainDepBtn()" style="background:transparent;border:1px solid rgba(255,255,255,0.1);color:var(--dim);border-radius:6px;font-size:10px;padding:4px 8px;margin-top:6px;cursor:pointer;display:flex;align-items:center;gap:4px;float:right"><span class="material-symbols-outlined" style="font-size:12px">replay</span> Repeat</button>` : '';

                    html += `
                    <div class="glass-item" style="display:flex;align-items:flex-start;justify-content:space-between;padding:16px;border-radius:16px;margin-bottom:10px;background:#15171b;border:1px solid rgba(255,255,255,0.03);transition:background 0.2s">
                        <div style="display:flex;align-items:flex-start;gap:14px">
                            <div style="width:40px;height:40px;border-radius:12px;background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.05);display:flex;align-items:center;justify-content:center;margin-top:2px">
                                <span class="material-symbols-outlined" style="font-size:20px;color:${color}">${icon}</span>
                            </div>
                            <div>
                                <div style="font-size:13px;font-weight:800;color:#fff;margin-bottom:2px">${tx.label || (tx.type.charAt(0).toUpperCase() + tx.type.slice(1))}</div>
                                <div style="font-size:11px;color:var(--dim);font-weight:500">${timeStr} Â· ${tx.method || 'Internal'}</div>
                                <div style="margin-top:6px">${statusBadge}</div>
                            </div>
                        </div>
                        <div style="text-align:right">
                            <div style="font-size:15px;font-weight:800;color:${color}">${isPlus ? '+' : '-'}${tx.amount} <span style="font-size:11px;color:var(--dim2)">${tx.unit || 'USDT'}</span></div>
                            ${repeatBtn}
                        </div>
                    </div>`;
                });
            });
            el.innerHTML = html;
        }

        /* === DEPOSIT FLOW (inside miniapp) === */
        function openDepositModal(type) {
            var el = document.getElementById('scrWallet');
            if (!el) return;
            var title = type === 'stars' ? 'BUY STARS' : (T.deposit || 'DEPOSIT');
            var min = type === 'stars' ? 50 : 0.5;
            var unit = type === 'stars' ? 'â­' : 'USDT';

            var quickAmts = type === 'stars' ? [50, 250, 1000] : [0.5, 5, 10, 20, 50];
            var quickHtml = quickAmts.map(a => `<div class="quick-amt-btn" onclick="document.getElementById('depAmtInput').value='${a}';updateDepBtn()">${a}${type === 'stars' ? '' : '$'}</div>`).join('');

            var html = `
            <div class="popup-overlay active" id="depPopup" onclick="if(event.target===this)this.remove()">
                <div class="popup-card">
                    <h2 style="font-family:'Montserrat',sans-serif;font-weight:800;font-size:20px;margin:0 0 8px;text-align:center">${title}</h2>
                    <p style="font-size:13px;color:var(--dim2);text-align:center;margin-bottom:20px">Minimum: ${min} ${unit}</p>
                    
                    <div style="position:relative;margin-bottom:12px">
                        <input type="number" id="depAmtInput" placeholder="0.00" oninput="updateDepBtn()"
                            style="width:100%;background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.08);border-radius:16px;padding:16px;color:#fff;font-size:20px;font-weight:700;text-align:center;font-family:monospace">
                        <div style="position:absolute;right:16px;top:50%;transform:translateY(-50%);font-weight:800;color:var(--dim2)">${unit}</div>
                    </div>

                    <div class="quick-amt-grid">${quickHtml}</div>

                    <button class="btn-primary" id="depConfirmBtn" style="width:100%;padding:16px;border-radius:16px;margin-top:12px;font-weight:800;font-size:15px;opacity:0.5" disabled onclick="confirmDeposit('${type}')">
                        ${type === 'stars' ? 'BUY NOW' : 'NEXT'}
                    </button>
                    <button style="width:100%;margin-top:12px;color:var(--dim2);font-weight:600;font-size:13px;background:none;border:none" onclick="document.getElementById('depPopup').remove()">CANCEL</button>
                </div>
            </div>`;
            document.body.insertAdjacentHTML('beforeend', html);
        }

        window.updateDepBtn = function () {
            var val = parseFloat(document.getElementById('depAmtInput').value) || 0;
            var btn = document.getElementById('depConfirmBtn');
            if (btn) {
                btn.disabled = val <= 0;
                btn.style.opacity = val <= 0 ? 0.5 : 1;
            }
        };

        window.confirmDeposit = async function (type) {
            var amt = parseFloat(document.getElementById('depAmtInput').value);
            var min = type === 'stars' ? 50 : 0.5;
            if (!amt || amt < min) { showToast('âš ï¸', 'Min amount: ' + min + (type === 'stars' ? ' â­' : ' USDT'), 'OK'); return; }

            document.getElementById('depPopup').remove();
            if (type === 'stars') buyStars(amt);
            else buyCrypto(null, amt);
        };

        window.updateSolanaUI = function () {
            var st = document.getElementById('solanaStatus');
            var addrBlock = document.getElementById('solanaAddressBlock');
            var pubKeyEl = document.getElementById('solanaPubKey');
            if (!st) return;

            const s = SolanaModule.state.status;
            st.textContent = s.toUpperCase();

            if (s === 'connected') st.className = 'text-[10px] font-black uppercase tracking-tighter text-green-400';
            else if (s === 'blocked' || s === 'failed') st.className = 'text-[10px] font-black uppercase tracking-tighter text-red-500';
            else st.className = 'text-[10px] font-black uppercase tracking-tighter text-gray-600';

            if (SolanaModule.state.publicKey) {
                if (addrBlock) addrBlock.classList.remove('hidden');
                if (pubKeyEl) pubKeyEl.textContent = SolanaModule.state.publicKey;
            } else {
                if (addrBlock) addrBlock.classList.add('hidden');
            }

            if (payMethod === 'solana') updateMainDepBtn();
        };

        window.updateMainDepBtn = function () {
            var isStars = payMethod === 'stars';
            var isSolana = payMethod === 'solana';
            var inputId = isStars ? 'depAmtStars' : (isSolana ? 'depAmtSolana' : 'depAmtCrypto');
            var min = isStars ? 50 : (isSolana ? 0.05 : 1.00);
            var max = isStars ? 50000 : (isSolana ? 100 : 10000);
            var valInput = document.getElementById(inputId);
            var val = valInput ? (parseFloat(valInput.value) || 0) : 0;
            var btn = document.getElementById('mainDepositBtn');

            if (btn) {
                if (isSolana) {
                    const s = SolanaModule.state.status;
                    if (s === 'disconnected' || s === 'failed') {
                        btn.className = 'w-full bg-[#14f195] hover:bg-green-400 text-black font-bold py-4 rounded-xl text-sm transition-all uppercase tracking-widest mb-8';
                        btn.textContent = 'Connect Phantom';
                        btn.disabled = false;
                        return;
                    }
                    if (s === 'connecting' || s === 'sending' || s === 'verifying') {
                        btn.className = 'w-full bg-[#1a1c22] text-gray-500 font-bold py-4 rounded-xl text-sm transition-all uppercase tracking-widest mb-8 cursor-not-allowed';
                        btn.textContent = s.toUpperCase() + '...';
                        btn.disabled = true;
                        return;
                    }
                }

                var isValid = val >= min && val <= max;
                if (isValid) {
                    const btnColor = isSolana ? 'bg-[#14f195]' : 'bg-[#e62e3d]';
                    const hoverColor = isSolana ? 'hover:bg-green-400' : 'hover:bg-red-700';
                    const textColor = isSolana ? 'text-black' : 'text-white';
                    btn.className = `w-full ${btnColor} ${hoverColor} ${textColor} font-bold py-4 rounded-xl text-sm transition-all uppercase tracking-widest mb-8 shadow-lg`;
                    btn.textContent = 'Confirm Deposit';
                    btn.disabled = false;
                } else {
                    btn.className = 'w-full bg-[#1a1c22] text-gray-500 font-bold py-4 rounded-xl text-sm transition-all uppercase tracking-widest mb-8 cursor-not-allowed';
                    btn.textContent = 'Enter Valid Amount';
                    if (val === 0) btn.textContent = 'Enter Amount';
                    else if (val < min) btn.textContent = 'Amount too low';
                    else if (val > max) btn.textContent = 'Amount too high';
                    btn.disabled = true;
                }
            }
        };

        window.confirmDepositDirect = async function () {
            if (payMethod === 'solana') {
                const s = SolanaModule.state.status;
                if (s === 'disconnected' || s === 'failed') {
                    SolanaModule.connect();
                    return;
                }
                const input = document.getElementById('depAmtSolana');
                const amt = parseFloat(input ? input.value : 0);
                if (!amt || amt < 0.05) {
                    showToast('âŒ', 'Min deposit 0.05 SOL', 'OK');
                    return;
                }
                SolanaModule.signTransaction(amt);
                return;
            }

            var isStars = payMethod === 'stars';
            var inputId = isStars ? 'depAmtStars' : 'depAmtCrypto';
            var min = isStars ? 50 : 1.00;
            var max = isStars ? 50000 : 10000;
            var amt = parseFloat(document.getElementById(inputId).value) || 0;

            if (amt < min || amt > max) {
                showToast('âš ï¸', 'Invalid amount: Min ' + min + ', Max ' + max + (isStars ? ' â­' : ' USDT'), 'OK');
                return;
            }

            if (isStars) {
                buyStars(amt);
            } else {
                buyCrypto(null, amt);
            }
        };

        async function buyStars(amount) {
            return await withGuard('buy_stars', async () => {
                try {
                    showToast('â­', T.creatingInv, 'â³', '', null);
                    var r = await apiFetch('/api/create-stars-invoice', {
                        method: 'POST',
                        body: JSON.stringify(Object.assign({}, auth(), { stars: amount }))
                    });
                    var d = await safeJson(r);
                    closeToast();

                    if (d.ok && d.invoice_link) {
                        tg.openInvoice(d.invoice_link, function (status) {
                            if (status === 'paid') {
                                showToast('âœ…', T.paySuccess + amount + ' â­', 'OK', '', function () { closeToast() });
                                loadBalance();
                            } else if (status === 'cancelled') {
                                /* User cancelled */
                            } else if (status === 'failed') {
                                showToast('âŒ', T.payFail, 'OK', '', function () { closeToast() });
                            }
                        });
                    } else {
                        showToast('âŒ', d.error || 'Error creating invoice', 'OK', '', function () { closeToast() });
                    }
                } catch (e) {
                    closeToast();
                    showToast('âŒ', 'Network error: ' + e.message, 'OK', '', function () { closeToast() });
                }
            });
        }

        async function buyCrypto(coins, price) {
            return await withGuard('buy_crypto', async () => {
                try {
                    showToast('ðŸ’Ž', T.creatingCrypto, 'â³', '', null);
                    var r = await apiFetch('/api/create-invoice', {
                        method: 'POST',
                        body: JSON.stringify(Object.assign({}, auth(), {
                            coins: coins ? parseInt(coins) : Math.floor(parseFloat(price) * 100),
                            amount: parseFloat(price)
                        }))
                    });
                    var d = await safeJson(r);
                    closeToast();

                    if (d.ok && d.pay_url) {
                        var url = d.pay_url;
                        if (url.indexOf('t.me/') !== -1) {
                            tg.openTelegramLink(url);
                        } else {
                            tg.openLink(url, { try_instant_view: true });
                        }
                        if (typeof pollPayment === 'function') pollPayment(d.invoice_id || null);
                    } else {
                        showToast('âŒ', d.error || 'Error creating invoice', 'OK', '', function () { closeToast() });
                    }
                } catch (e) {
                    closeToast();
                    showToast('âŒ', 'Network error: ' + e.message, 'OK', '', function () { closeToast() });
                }
            });
        }

        async function buySolana(amountSol) {
            const s = SolanaModule.state.status;
            if (s === 'disconnected' || s === 'failed') {
                SolanaModule.connect();
                return;
            }
            SolanaModule.signTransaction(amountSol);
        }

        async function buyCard(coins, price) {
            var url = API + '/api/create-card-payment';
            console.log('[API CALL] POST', url);
            try {
                showToast('ðŸ’³', T.creatingPay, 'â³', '', null);
                var r = await apiFetch('/api/create-card-payment', {
                    method: 'POST',
                    body: JSON.stringify(Object.assign({}, auth(), { coins: parseInt(coins), amount: parseFloat(price) }))
                });
                console.log('[API RESPONSE] POST', url, 'Status:', r.status);
                var text = await r.text();
                console.log('[API RESPONSE BODY]', text);
                closeToast();

                if (!r.ok) {
                    showToast('âŒ', 'HTTP ' + r.status + ' Error', 'OK', '', function () { closeToast() });
                    return;
                }
                var d = JSON.parse(text);
                if (d.ok && d.pay_url) {
                    /* Open card payment inside Telegram webview */
                    tg.openLink(d.pay_url, { try_instant_view: true });
                    pollPayment(d.invoice_id || null);
                } else {
                    var msg = d.error || T.cardSoon;
                    showToast('ðŸ’³', msg, 'OK', '', function () { closeToast() });
                }
            } catch (e) {
                console.error('[API ERROR] POST', url, e);
                closeToast();
                showToast('âŒ', 'Critical Catch Error: ' + e.message, 'OK', '', function () { closeToast() });
            }
        }

        /* Poll backend for payment completion */
        var pollTimer = null;
        function pollPayment(invoiceId) {
            var attempts = 0;
            if (pollTimer) clearInterval(pollTimer);
            pollTimer = setInterval(async function () {
                attempts++;
                if (attempts > 60) { clearInterval(pollTimer); return } /* stop after 5 min */
                try {
                    await loadBalance(); /* reload balance â€” if payment went through, balance will update */
                } catch (e) { }
            }, 5000);
            /* Auto-stop polling after 5 min */
            setTimeout(function () { if (pollTimer) clearInterval(pollTimer) }, 300000);
        }

        /* === NOTIFICATIONS POPUP === */
        var userNotifs = [];
        async function loadNotifications() {
            return await withGuard('notifications', async () => {
                try {
                    var r = await apiFetch('/api/notifications?' + qs());
                    var d = await safeJson(r);
                    if (d.ok && d.notifications) {
                        userNotifs = d.notifications;
                        updateNotifBadge();
                        return d;
                    }
                } catch (e) {
                    console.error('API /notifications fetch failed:', e);
                    throw e;
                }
            });
        }
        function updateNotifBadge() {
            var dot = document.getElementById('notifDot');
            if (!dot) return;
            var unread = userNotifs.filter(function (n) { return !n.is_read }).length;
            if (unread > 0) dot.style.display = 'block';
            else dot.style.display = 'none';
        }
        function renderNotifs() {
            var list = document.getElementById('notifList');
            if (!list) return;
            if (userNotifs.length === 0) {
                list.innerHTML = '<div style="text-align:center;padding:20px 0;color:var(--dim);font-size:12px">No notifications</div>';
                return;
            }
            var html = '';
            userNotifs.forEach(function (n) {
                var isUnread = !n.is_read;
                var dotHtml = isUnread ? '<div style="width:8px;height:8px;border-radius:50%;background:var(--red);flex-shrink:0;margin-top:4px"></div>' : '';
                var clickAction = n.action_url ? n.action_url + ';' : '';
                html += '<div onclick="' + clickAction + 'readSingleNotif(' + n.id + ')" style="display:flex;gap:12px;padding:8px;background:' + (isUnread ? 'rgba(255,255,255,.03)' : 'transparent') + ';border-radius:var(--radius);cursor:pointer;transition:background .2s">';
                html += dotHtml;
                html += '<div style="flex:1">';
                html += '<div style="font-size:13px;font-weight:700;color:' + (isUnread ? '#fff' : 'var(--dim)') + ';margin-bottom:2px">' + n.title + '</div>';
                html += '<div style="font-size:11px;color:' + (isUnread ? 'rgba(255,255,255,.7)' : 'var(--dim)') + '">' + n.message + '</div>';
                html += '<div style="font-size:9px;color:rgba(255,255,255,.3);margin-top:4px">' + n.created_at.substring(0, 16).replace('T', ' ') + '</div>';
                html += '</div></div>';
            });
            list.innerHTML = html;
        }
        function openNotifPopup() {
            document.getElementById('notifPopup').style.display = 'block';
            renderNotifs();
            requestAnimationFrame(function () {
                var card = document.getElementById('notifPopupCard');
                card.style.opacity = '1';
                card.style.transform = 'translateY(0) scale(1)';
            });
        }
        function closeNotifPopup() {
            var card = document.getElementById('notifPopupCard');
            card.style.opacity = '0';
            card.style.transform = 'translateY(-8px) scale(.95)';
            setTimeout(function () { document.getElementById('notifPopup').style.display = 'none' }, 200);
        }
        async function readAllNotifs() {
            userNotifs.forEach(function (n) { n.is_read = 1 });
            updateNotifBadge();
            renderNotifs();
            try { await apiFetch('/api/notifications/read', { method: 'POST', body: JSON.stringify(auth()) }); } catch (e) { }
        }
        async function readSingleNotif(id) {
            var notif = userNotifs.find(function (n) { return n.id === id });
            if (notif && !notif.is_read) {
                notif.is_read = 1;
                updateNotifBadge();
                renderNotifs();
                try { await apiFetch('/api/notifications/read', { method: 'POST', body: JSON.stringify(Object.assign({}, auth(), { id: id })) }); } catch (e) { }
            }
            closeNotifPopup();
        }

        /* === BALANCE POPUP (header tap) === */
        function openBalancePopup() {
            var p = document.getElementById('balPopup');
            p.style.display = 'block';
            /* Update active state */
            var bcUsdt = document.getElementById('bpUsdtCard');
            var bcStars = document.getElementById('bpStarsCard');
            if (bcUsdt) bcUsdt.classList.toggle('active', activeWallet === 'usdt');
            if (bcStars) bcStars.classList.toggle('active', activeWallet === 'stars');
            updateBalanceUI();
            /* Update currency pills */
            document.querySelectorAll('#bpCurrencies .pill').forEach(function (b) {
                b.classList.toggle('active', b.getAttribute('data-cur') === displayCurrency);
            });
            document.getElementById('bpCurrencies').style.display = activeWallet === 'usdt' ? 'grid' : 'none';
            /* Animate in */
            requestAnimationFrame(function () {
                var card = document.getElementById('balPopupCard');
                card.style.transform = 'translateY(0) scale(1)'; card.style.opacity = '1';
            });
        }
        function closeBalancePopup() {
            var card = document.getElementById('balPopupCard');
            card.style.transform = 'translateY(-8px) scale(.95)'; card.style.opacity = '0';
            setTimeout(function () { document.getElementById('balPopup').style.display = 'none' }, 200);
        }
        function switchBalPopup(type) {
            activeWallet = type;
            var bcUsdt = document.getElementById('bpUsdtCard');
            var bcStars = document.getElementById('bpStarsCard');
            if (bcUsdt) bcUsdt.classList.toggle('active', type === 'usdt');
            if (bcStars) bcStars.classList.toggle('active', type === 'stars');
            document.getElementById('bpCurrencies').style.display = type === 'usdt' ? 'grid' : 'none';
            document.getElementById('bpDeposit').textContent = type === 'stars' ? 'BUY STARS' : 'DEPOSIT';
            updateBalPopupContent();
            updateBalanceUI();
        }
        function updateBalPopupContent() {
            if (activeWallet === 'stars') {
                document.getElementById('bpLabel').textContent = 'â­ STARS BALANCE';
                document.getElementById('bpAmount').textContent = starsBalance + ' â­';
                document.getElementById('bpSub').textContent = '';
            } else {
                document.getElementById('bpLabel').textContent = displayCurrency + ' BALANCE';
                var sym = RATES[displayCurrency] ? { USDT: '', USD: '$', PLN: 'zÅ‚', UAH: 'â‚´', EUR: 'â‚¬', RUB: 'â‚½', GBP: 'Â£' }[displayCurrency] || '' : '$';
                document.getElementById('bpAmount').textContent = formatCurrency(usdtBalance);
                document.getElementById('bpSub').textContent = displayCurrency !== 'USDT' ? 'â‰ˆ ' + usdtBalance.toFixed(2) + ' USDT' : '';
            }
        }
        function setCurrencyPopup(cur) {
            setCurrency(cur);
            document.querySelectorAll('#bpCurrencies .pill').forEach(function (b) {
                b.classList.toggle('active', b.getAttribute('data-cur') === cur);
            });
            updateBalPopupContent();
        }

        /* === LANGUAGE SELECTOR (in-app) === */
        var LANG_OPTIONS = {
            pl: { flag: 'ðŸ‡µðŸ‡±', name: 'Polski' },
            ua: { flag: 'ðŸ‡ºðŸ‡¦', name: 'Ð£ÐºÑ€Ð°Ñ—Ð½ÑÑŒÐºÐ°' },
            ru: { flag: 'ðŸ‡·ðŸ‡º', name: 'Ð ÑƒÑÑÐºÐ¸Ð¹' },
            en: { flag: 'ðŸ‡¬ðŸ‡§', name: 'English' }
        };

        function openLangSelector() {
            var ol = document.getElementById('langOverlay');
            ol.style.display = 'flex';
            var list = document.getElementById('langList');
            list.innerHTML = Object.keys(LANG_OPTIONS).map(function (code) {
                var l = LANG_OPTIONS[code];
                var isActive = code === LANG;
                return '<button onclick="setLanguage(\'' + code + '\')" style="display:flex;align-items:center;gap:12px;padding:14px 16px;border-radius:var(--radius);border:' + (isActive ? '1.5px solid var(--red)' : '1px solid var(--border)') + ';background:' + (isActive ? 'rgba(227,30,36,.06)' : 'var(--surface)') + ';color:#fff;cursor:pointer;font-family:Inter,sans-serif;font-size:14px;font-weight:600;transition:all .15s">'
                    + '<span style="font-size:24px">' + l.flag + '</span>'
                    + '<span style="flex:1;text-align:left">' + l.name + '</span>'
                    + (isActive ? '<span class="material-symbols-outlined" style="color:var(--red);font-size:20px">check_circle</span>' : '')
                    + '</button>';
            }).join('');
            ol.onclick = function (e) { if (e.target === ol) ol.style.display = 'none' };
        }

        function setLanguage(code) {
            /* Save via API and reload */
            apiFetch('/api/set-language', { method: 'POST', body: JSON.stringify(Object.assign({}, auth(), { language: code })) })
                .then(function () {
                    /* Reload page with new lang */
                    var params = new URLSearchParams(location.search);
                    params.set('lang', code);
                    location.search = params.toString();
                }).catch(function () {
                    var params = new URLSearchParams(location.search);
                    params.set('lang', code);
                    location.search = params.toString();
                });
        }

        function initLangDisplay() {
            var cur = LANG_OPTIONS[LANG];
            var el = document.getElementById('profLangCurrent');
            if (el && cur) el.textContent = cur.flag + ' ' + cur.name;
            var el2 = document.getElementById('profLang');
            if (el2) el2.textContent = T.langLabel;
        }

        /* === CRASH GAME LOGIC === */
        let crashState = 'idle'; // idle, betting, running, cashed_out, crashed
        let crashSocket = null;
        let crashTimer = null;
        let crashGraphTimer = null;
        let currentMult = 1.00;
        let myBet = 0;
        let myCashout = 0;

        function initCrashCanvas() {
            const canvas = document.getElementById('crashCanvas');
            const parent = canvas.parentElement;
            canvas.width = parent.clientWidth;
            canvas.height = parent.clientHeight;
            drawCrashGraph(0);
        }
        window.addEventListener('resize', initCrashCanvas);

        function drawCrashGraph(progress) { // progress 0 to 1
            const canvas = document.getElementById('crashCanvas');
            const ctx = canvas.getContext('2d');
            const w = canvas.width;
            const h = canvas.height;

            ctx.clearRect(0, 0, w, h);

            ctx.strokeStyle = 'rgba(255,255,255,0.05)';
            ctx.lineWidth = 1;
            ctx.beginPath();
            for (let i = 0; i < 5; i++) {
                ctx.moveTo(0, i * h / 5);
                ctx.lineTo(w, i * h / 5);
                ctx.moveTo(i * w / 5, 0);
                ctx.lineTo(i * w / 5, h);
            }
            ctx.stroke();

            if (currentMult > 1.00) {
                ctx.beginPath();
                ctx.moveTo(0, h);
                const x = w * progress;
                const y = h - (h * Math.pow(progress, 2));

                ctx.quadraticCurveTo(x * 0.5, h, x, y);

                ctx.strokeStyle = crashState === 'crashed' ? '#E31E24' : '#22C55E';
                ctx.lineWidth = 4;
                ctx.lineCap = 'round';
                ctx.stroke();

                ctx.shadowColor = crashState === 'crashed' ? 'rgba(227,30,36,0.5)' : 'rgba(34,197,94,0.5)';
                ctx.shadowBlur = 10;
                ctx.stroke();
                ctx.shadowBlur = 0;

                ctx.beginPath();
                ctx.arc(x, y, 6, 0, Math.PI * 2);
                ctx.fillStyle = crashState === 'crashed' ? '#E31E24' : '#22C55E';
                ctx.fill();
            }
        }

        function playCrashLoop() {
            const crashPoint = Math.max(1.00, (100 / (Math.random() * 100)) * 0.99).toFixed(2);
            let targetMult = parseFloat(crashPoint);
            if (Math.random() < 0.2) targetMult = 1.00;

            let t = 0;
            const tick = 50;
            const totalDuration = targetMult < 1.1 ? 500 : 2000 + (targetMult * 100);

            crashState = 'running';
            document.getElementById('crashMult').classList.remove('crashed');
            document.getElementById('crashMult').classList.add('active');

            let btn = document.getElementById('crashBtn');
            if (myBet > 0 && myCashout === 0) {
                btn.className = 'crash-action-btn cashout';
                btn.innerHTML = 'CASHOUT<br><span class="crash-action-sub">...</span>';
            } else if (myBet === 0) {
                btn.className = 'crash-action-btn wait';
                btn.innerHTML = 'WAITING<br><span class="crash-action-sub">Round in progress</span>';
            }

            crashGraphTimer = setInterval(() => {
                t += tick;
                let progress = Math.min(1, t / totalDuration);

                currentMult = 1.00 + (targetMult - 1.00) * Math.pow(progress, 3);

                document.getElementById('crashMult').textContent = currentMult.toFixed(2) + 'x';
                drawCrashGraph(progress);

                if (myBet > 0 && myCashout === 0) {
                    let w = (myBet * currentMult).toFixed(2);
                    btn.innerHTML = 'CASHOUT<br><span class="crash-action-sub">' + w + ' ðŸª™</span>';

                    let autoVal = parseFloat(document.getElementById('crashAutoCashout').value);
                    if (autoVal > 1.00 && currentMult >= autoVal) {
                        doCashout(autoVal);
                    }
                }

                if (progress >= 1) {
                    clearInterval(crashGraphTimer);
                    triggerCrash(targetMult);
                }
            }, tick);
        }

        function triggerCrash(finalMult) {
            crashState = 'crashed';
            document.getElementById('crashMult').textContent = finalMult.toFixed(2) + 'x';
            document.getElementById('crashMult').classList.remove('active');
            document.getElementById('crashMult').classList.add('crashed');
            drawCrashGraph(1);

            if (myBet > 0 && myCashout === 0) {
                myBet = 0;
            }

            const p = document.createElement('div');
            p.className = 'ch-pill ' + (finalMult >= 2.0 ? 'high' : 'low');
            p.textContent = finalMult.toFixed(2) + 'x';
            const hist = document.getElementById('crashHistory');
            hist.insertBefore(p, hist.firstChild);
            if (hist.children.length > 20) hist.removeChild(hist.lastChild);

            let btn = document.getElementById('crashBtn');
            btn.className = 'crash-action-btn wait';
            btn.innerHTML = 'CRASHED<br><span class="crash-action-sub">Next round starting soon</span>';

            setTimeout(() => {
                myBet = 0;
                myCashout = 0;
                currentMult = 1.00;
                crashState = 'idle';
                document.getElementById('crashMult').classList.remove('crashed');
                document.getElementById('crashMult').textContent = '1.00x';
                document.getElementById('crashProfit').classList.remove('show');
                const canvas = document.getElementById('crashCanvas');
                canvas.getContext('2d').clearRect(0, 0, canvas.width, canvas.height);
                drawCrashGraph(0);

                btn.className = 'crash-action-btn bet';
                btn.innerHTML = 'BET<br><span class="crash-action-sub">Next Round</span>';
            }, 3000);
        }

        function crashAction() {
            let btn = document.getElementById('crashBtn');
            if (crashState === 'idle') {
                let betAmt = parseFloat(document.getElementById('crashBetAmount').value);
                if (betAmt <= 0) return;

                let activeBal = activeWallet === 'stars' ? starsBalance : (usdtBalance * 100);
                if (betAmt > activeBal) {
                    return; // silently return, not enough funds
                }

                if (activeWallet === 'stars') starsBalance -= betAmt;
                else usdtBalance -= (betAmt / 100);
                updateBalanceUI();

                myBet = betAmt;
                btn.className = 'crash-action-btn cancel';
                btn.innerHTML = 'CANCEL<br><span class="crash-action-sub">Waiting for round</span>';

                setTimeout(playCrashLoop, 1000);
                crashState = 'betting';

            } else if (crashState === 'betting') {
                if (activeWallet === 'stars') starsBalance += myBet;
                else usdtBalance += (myBet / 100);
                updateBalanceUI();

                myBet = 0;
                btn.className = 'crash-action-btn bet';
                btn.innerHTML = 'BET<br><span class="crash-action-sub">Next Round</span>';

            } else if (crashState === 'running' && myBet > 0 && myCashout === 0) {
                doCashout(currentMult);
            }
        }

        function doCashout(mult) {
            myCashout = (myBet * mult).toFixed(2);
            let winToken = activeWallet === 'stars' ? 'â­' : 'ðŸª™';

            if (activeWallet === 'stars') starsBalance += parseFloat(myCashout);
            else usdtBalance += (parseFloat(myCashout) / 100);
            updateBalanceUI();

            let profitEl = document.getElementById('crashProfit');
            profitEl.textContent = 'Profit: +' + myCashout + ' ' + winToken;
            profitEl.classList.add('show');

            let btn = document.getElementById('crashBtn');
            btn.className = 'crash-action-btn wait';
            btn.innerHTML = 'CASHED OUT<br><span class="crash-action-sub">' + mult.toFixed(2) + 'x</span>';
        }

        const oldUpdateBalanceUI = updateBalanceUI;
        updateBalanceUI = function () {
            oldUpdateBalanceUI();
            // Sync with reactive AppState
            if (typeof usdtBalance !== 'undefined' && usdtBalance !== null) {
                AppState.update({ wallet: { balance: usdtBalance * 100 } });
            }
            if (typeof starsBalance !== 'undefined' && starsBalance !== null) {
                AppState.update({ wallet: { bonus_balance: starsBalance } });
            }

            let cb = document.getElementById('crashBal');
            if (cb) {
                cb.textContent = activeWallet === 'stars' ? starsBalance + ' â­' : (usdtBalance !== null ? (usdtBalance * 100).toFixed(2) : '0');
            }
        };

        const oldNav = nav;
        nav = function (screen) {
            oldNav(screen);
            if (screen === 'crash') {
                setTimeout(initCrashCanvas, 100);
            }
        }

        function initLangDisplay() {
            var el = document.getElementById('profLangCurrent');
            if (el) el.textContent = LANG.toUpperCase();
        }

        /* === INIT === */
        /* === INIT === */
        if (window.Telegram && window.Telegram.WebApp) {
            // Main Mini App â€” Fullsize mode (configured in BotFather)
            // expand() as fallback for older clients or menu button launches
            tg.expand();

            // Prevent swipe-to-minimize (Bot API 7.7+)
            if (tg.disableVerticalSwipes) {
                tg.disableVerticalSwipes();
            }

            // Prevent accidental closing â€” only X button works
            tg.enableClosingConfirmation();

            // Dark casino theme
            tg.setHeaderColor('#000000');
            tg.setBackgroundColor('#121212');

            /* === LIVE DROPS INITIALIZATION === */
            window.updateLiveDrops = function () {
                if (typeof buildLiveDrops === 'function') buildLiveDrops();
            };

            /* === STATIC UI â€” render immediately, no auth needed === */
            if (typeof getGamesConfig === 'function') ALL_GAMES = getGamesConfig(T);
            buildCategories();
            buildProviders();
            buildGameGrid();
            renderBanners();
            buildLiveDrops();
            // Top Winnings demo (no auth needed, real data loads in initApp after auth)
            (function() {
                var dn = ['Ton***99','Max***23','Luc***77','Pro***88','Vip***33','Ace***11','Win***42','Bet***55'];
                var dg = ['Ruby Slots','Crash','Lucky Bonanza','Crash','Mines','Ruby Slots','Plinko','Crash'];
                var dc = ['#6366f1','#8b5cf6','#ec4899','#f59e0b','#10b981','#3b82f6','#ef4444','#14b8a6'];
                var demos = [];
                for (var i = 0; i < 8; i++) demos.push({ username: dn[i%dn.length], game: dg[i%dg.length], win_amount: +(Math.random()*2500+10).toFixed(2), multiplier: +(Math.random()*150+1.5).toFixed(1), color: dc[i%dc.length] });
                demos.sort(function(a,b){return b.win_amount-a.win_amount;});
                if (typeof renderTopWinnings === 'function') renderTopWinnings(demos);
            })();

            /* === INITIAL LOAD === */
            async function initApp() {
                // Ensure critical user and game data is loaded
                await loadUserData();

                initLocale();
                ALL_GAMES = typeof getGamesConfig === 'function' ? getGamesConfig(T) : [];
                buildCategories();
                buildProviders();
                loadTopWinnings('day');
                updateLiveDrops();
                if (typeof buildWalletPackages === 'function') buildWalletPackages();
                buildGameGrid();
            }
            boot();
        }

        async function loadUserData() {
            console.log('[BOOT] Fetching user data in parallel...');
            const results = await Promise.allSettled([
                loadBalance(),
                loadNotifications(),
                checkWheel(),
                loadBonuses(),
                fetchPromos()
            ]);

            results.forEach((res, i) => {
                if (res.status === 'rejected') {
                    console.error(`[BOOT] Task ${i} failed:`, res.reason);
                }
            });

            if (typeof loadReferral === 'function') loadReferral();
        }

        initCarousel();

        /* === HERO CAROUSEL === */
        var heroSlide = 0;
        var heroTimer = null;
        function goSlide(n) {
            heroSlide = n;
            var heroTotal = getBanners().length;
            if (heroTotal === 0) return;
            var track = document.getElementById('heroTrack');
            if (track) track.style.transform = 'translateX(-' + (heroSlide * 100 / heroTotal) + '%)';
            document.querySelectorAll('.hero-dot').forEach(function (d, i) {
                d.style.background = i === heroSlide ? 'var(--red)' : 'rgba(255,255,255,.3)';
                d.style.opacity = i === heroSlide ? '1' : '0.6';
            });
        }
        function initCarouselSwipe() {
            var track = document.getElementById('heroTrack');
            if (!track) return;
            var startX = 0, startY = 0, dist = 0, isSwipe = false;
            track.addEventListener('touchstart', function (e) {
                startX = e.touches[0].clientX;
                startY = e.touches[0].clientY;
                isSwipe = false;
            }, { passive: true });
            track.addEventListener('touchmove', function (e) {
                var dx = Math.abs(e.touches[0].clientX - startX);
                var dy = Math.abs(e.touches[0].clientY - startY);
                if (dx > dy && dx > 10) { isSwipe = true; if (e.cancelable) e.preventDefault(); }
            }, { passive: false });
            track.addEventListener('touchend', function (e) {
                if (!isSwipe) return;
                var endX = e.changedTouches[0].clientX;
                var diff = startX - endX;
                var banners = getBanners();
                var total = banners.length;
                if (Math.abs(diff) > 50 && total > 0) {
                    if (diff > 0) goSlide((heroSlide + 1) % total);
                    else goSlide((heroSlide - 1 + total) % total);
                    initCarousel(); // reset timer
                }
            }, { passive: true });
        }

        function initCarousel() {
            if (heroTimer) clearInterval(heroTimer);
            heroTimer = setInterval(function () {
                var heroTotal = getBanners().length;
                if (heroTotal > 0) goSlide((heroSlide + 1) % heroTotal);
            }, 4000);
        }
        initCarouselSwipe();

        /* === GAMES CATALOG SCREEN === */
        var gamesCat = 'all';
        function initGamesScreen() {
            var cats = [
                { id: 'all', label: 'All', icon: 'apps' },
                { id: 'slots', label: T.slots || 'Slots', icon: 'casino' },
                { id: 'crash', label: T.crash || 'Crash', icon: 'trending_up' },
                { id: 'plinko', label: 'Plinko', icon: 'rocket_launch' },
                { id: 'table', label: T.table || 'Table', icon: 'playing_cards' },
                { id: 'live', label: T.live || 'Live', icon: 'stream' }
            ];
            var cr = document.getElementById('gamesCatRow');
            if (cr) {
                cr.innerHTML = cats.map(function (c) {
                    return '<div class="pill' + (c.id === gamesCat ? ' active' : '') + '" onclick="filterGamesCat(\'' + c.id + '\',this)" style="display:flex;align-items:center;gap:4px;white-space:nowrap"><span class="material-symbols-outlined" style="font-size:14px">' + c.icon + '</span>' + c.label + '</div>';
                }).join('');
            }
            buildGameGrid('gamesGrid');
        }
        // JetTon-style lobby category filter
        var lobbyCat = 'all';
        function jtSelectCat(cat, el) {
            lobbyCat = cat;
            document.querySelectorAll('.jt-cat-pill').forEach(function(p){ p.classList.remove('active'); });
            if (el) el.classList.add('active');
            buildGameGrid(null, cat === 'all' ? null : function(g) {
                if (cat === 'slots') return g.category === 'slots' || ['ruby_slots','sweet_bonanza','gates_olympus','big_bass','starlight','wanted'].indexOf(g.id) > -1;
                if (cat === 'crash') return g.category === 'crash' || g.screen === 'crash';
                if (cat === 'live') return g.category === 'live';
                if (cat === 'table') return g.category === 'table';
                return true;
            });
        }

        function filterGamesCat(cat, el) {
            gamesCat = cat;
            if (el) {
                el.parentNode.querySelectorAll('.pill').forEach(function (p) { p.classList.remove('active') });
                el.classList.add('active');
            }
            applyGamesFilter();
        }
        function filterGamesScreen(val) {
            applyGamesFilter();
        }
        function applyGamesFilter() {
            var searchInput = document.getElementById('gamesSearchInput');
            var q = searchInput ? searchInput.value.toLowerCase() : '';

            buildGameGrid('gamesGrid', function (g) {
                // 1. Check Category
                var catMatch = true;
                if (gamesCat && gamesCat !== 'all') {
                    if (gamesCat === 'slots') catMatch = (g.category === 'slots' || ['ruby_slots', 'sweet_bonanza', 'gates_olympus', 'big_bass', 'starlight', 'wanted'].indexOf(g.id) > -1);
                    else if (gamesCat === 'crash') catMatch = (g.id === 'crash' || g.category === 'crash');
                    else if (gamesCat === 'plinko') catMatch = (g.id === 'plinko' || g.category === 'plinko');
                    else if (gamesCat === 'table') catMatch = (['roulette', 'blackjack', 'dice', 'coin'].indexOf(g.id) > -1 || g.category === 'table');
                    else if (gamesCat === 'live') catMatch = (g.category === 'live');
                    else catMatch = false;
                }

                // 2. Check Search Query
                var textMatch = true;
                if (q.length > 0) {
                    textMatch = g.name.toLowerCase().indexOf(q) > -1 || (g.provider && g.provider.toLowerCase().indexOf(q) > -1);
                }

                return catMatch && textMatch;
            });
        }

        /* === PLINKO GAME === */
        var PLINKO_ROWS = 8;
        var PLINKO_MULTS = [100, 10, 5, 2, 1, 0.5, 1, 2, 5, 10, 100];
        var PLINKO_BET_STEPS = [10, 25, 50, 100, 250, 500];
        var plinkoBetIdx = 2;
        var plinkoPlaying = false;
        var plinkoBalls = [];
        var plinkoPegs = [];
        var plinkoCanvas, plinkoCtx, plinkoW, plinkoH;
        var plinkoAnimId = null;
        var plinkoFirstOpen = true;

        function initPlinko() {
            if (plinkoFirstOpen) {
                plinkoFirstOpen = false;
                setTimeout(openPlinkoRules, 300);
            }
            plinkoCanvas = document.getElementById('plinkoCanvas');
            if (!plinkoCanvas) return;
            var parent = plinkoCanvas.parentElement;
            plinkoCanvas.width = parent.clientWidth;
            plinkoCanvas.height = plinkoCanvas.width * 1.25;
            plinkoCtx = plinkoCanvas.getContext('2d');
            plinkoW = plinkoCanvas.width;
            plinkoH = plinkoCanvas.height;
            buildPegs();
            buildBuckets();
            drawPlinko();
            updatePlinkoBetDisplay();
            buildPlinkoLeaderboard();
        }

        function buildPegs() {
            plinkoPegs = [];
            var padX = 30, padY = 40;
            var areaW = plinkoW - padX * 2;
            var areaH = plinkoH - padY * 2;
            for (var row = 0; row < PLINKO_ROWS; row++) {
                var cols = row + 3;
                var y = padY + (row / (PLINKO_ROWS - 1)) * areaH;
                for (var col = 0; col < cols; col++) {
                    var x = (plinkoW / 2) - ((cols - 1) * (areaW / (PLINKO_ROWS + 2)) / 2) + col * (areaW / (PLINKO_ROWS + 2));
                    plinkoPegs.push({ x: x, y: y, r: 4 });
                }
            }
        }

        function buildBuckets() {
            var el = document.getElementById('plinkoBuckets');
            if (!el) return;
            var colors = ['#e42127', '#f97316', '#eab308', '#22c55e', '#60a5fa', '#22c55e', '#eab308', '#f97316', '#e42127'];
            var mults = PLINKO_MULTS;
            el.innerHTML = mults.map(function (m, i) {
                var c = m >= 10 ? '#e42127' : m >= 5 ? '#f97316' : m >= 2 ? '#eab308' : '#22c55e';
                return '<div style="flex:1;height:36px;background:' + c + '20;border:1px solid ' + c + '50;border-radius:6px;display:flex;align-items:center;justify-content:center"><span style="font-size:9px;font-weight:800;color:' + c + ';font-style:italic">' + m + 'x</span></div>';
            }).join('');
        }

        function drawPlinko() {
            if (!plinkoCtx) return;
            plinkoCtx.clearRect(0, 0, plinkoW, plinkoH);
            /* Draw pegs */
            plinkoPegs.forEach(function (p) {
                plinkoCtx.beginPath();
                plinkoCtx.arc(p.x, p.y, p.r, 0, Math.PI * 2);
                plinkoCtx.fillStyle = '#e42127';
                plinkoCtx.fill();
                plinkoCtx.shadowColor = '#e42127';
                plinkoCtx.shadowBlur = 8;
                plinkoCtx.fill();
                plinkoCtx.shadowBlur = 0;
            });
            /* Draw balls */
            plinkoBalls.forEach(function (b) {
                if (!b.done) {
                    plinkoCtx.beginPath();
                    plinkoCtx.arc(b.x, b.y, 8, 0, Math.PI * 2);
                    var grad = plinkoCtx.createRadialGradient(b.x - 2, b.y - 2, 1, b.x, b.y, 8);
                    grad.addColorStop(0, '#FFD700');
                    grad.addColorStop(1, '#f59e0b');
                    plinkoCtx.fillStyle = grad;
                    plinkoCtx.fill();
                    plinkoCtx.shadowColor = '#FFD700';
                    plinkoCtx.shadowBlur = 12;
                    plinkoCtx.fill();
                    plinkoCtx.shadowBlur = 0;
                }
            });
        }

        function changePlinkoBet(dir) {
            plinkoBetIdx += dir;
            if (plinkoBetIdx < 0) plinkoBetIdx = 0;
            if (plinkoBetIdx >= PLINKO_BET_STEPS.length) plinkoBetIdx = PLINKO_BET_STEPS.length - 1;
            updatePlinkoBetDisplay();
        }
        function updatePlinkoBetDisplay() {
            var el = document.getElementById('plinkoBetDisplay');
            if (el) el.textContent = PLINKO_BET_STEPS[plinkoBetIdx];
        }

        async function dropPlinkoBall() {
            if (!plinkoCanvas) initPlinko();
            var betAmt = PLINKO_BET_STEPS[plinkoBetIdx];
            /* Check balance */
            if (starsBalance < betAmt) {
                openPlinkoStars();
                return;
            }
            /* Deduct bet */
            starsBalance -= betAmt;
            updateBalanceUI();
            if (window.Telegram && window.Telegram.WebApp && window.Telegram.WebApp.HapticFeedback) window.Telegram.WebApp.HapticFeedback.impactOccurred('medium');

            /* Request Provably Fair logic from Math Engine */
            var outcome = await window.casinoMath.calculatePlinkoDrop(PLINKO_ROWS, PLINKO_MULTS);

            /* Create deterministic mathematical ball */
            var ball = {
                x: plinkoW / 2 + (Math.random() - 0.5) * 10,
                y: 10,
                vx: 0,
                vy: 0,
                done: false,
                bet: betAmt,
                plannedPath: outcome.path,
                finalBucketIdx: outcome.bucketIndex,
                finalMultiplier: outcome.multiplier,
                currentRowIndex: 0,
                lastHitPeg: null
            };
            plinkoBalls.push(ball);
            if (!plinkoAnimId) animatePlinko();
        }

        function animatePlinko() {
            var gravity = 0.3;
            var friction = 0.98;
            var bounce = 0.5;
            var allDone = true;

            plinkoBalls.forEach(function (b) {
                if (b.done) return;
                allDone = false;
                b.vy += gravity;
                b.vx *= friction;
                b.x += b.vx;
                b.y += b.vy;
                /* Peg collisions using Provably Fair paths */
                plinkoPegs.forEach(function (p) {
                    var dx = b.x - p.x;
                    var dy = b.y - p.y;
                    var dist = Math.sqrt(dx * dx + dy * dy);
                    if (dist < p.r + 8) {
                        var angle = Math.atan2(dy, dx);
                        b.x = p.x + Math.cos(angle) * (p.r + 9);
                        b.y = p.y + Math.sin(angle) * (p.r + 9);

                        if (b.lastHitPeg !== p) {
                            var pathDir = b.plannedPath[b.currentRowIndex] !== undefined ? b.plannedPath[b.currentRowIndex] : (Math.random() > 0.5 ? 1 : 0);

                            // 0 = bounce left, 1 = bounce right
                            var forceVx = pathDir === 1 ? 1.8 : -1.8;
                            b.vx = forceVx + (Math.random() - 0.5) * 0.4;
                            b.vy = Math.abs(Math.sin(angle)) * 2;

                            b.lastHitPeg = p;
                            b.currentRowIndex++;
                        }
                    }
                });
                /* Wall bounds */
                if (b.x < 10) { b.x = 10; b.vx = Math.abs(b.vx) * bounce; }
                if (b.x > plinkoW - 10) { b.x = plinkoW - 10; b.vx = -Math.abs(b.vx) * bounce; }
                /* Hit bottom â€” apply PRECALCULATED mathematically sound outcome */
                if (b.y > plinkoH - 10) {
                    b.done = true;
                    // Snapping purely visual path into precise target bucket
                    var bucketIdx = b.finalBucketIdx !== undefined ? b.finalBucketIdx : 0;
                    var mult = b.finalMultiplier !== undefined ? b.finalMultiplier : 0.5;
                    var winnings = Math.floor(b.bet * mult);

                    starsBalance += winnings;
                    updateBalanceUI();
                    if (mult >= 50 && winnings > 0) {
                        showEpicWin(winnings, mult);
                        if (window.Telegram && window.Telegram.WebApp && window.Telegram.WebApp.HapticFeedback) window.Telegram.WebApp.HapticFeedback.notificationOccurred('success');
                    } else if (mult >= 5) {
                        showToast('ðŸš€', mult + 'x! +' + winnings + ' â­', 'OK', '', function () { closeToast() });
                        if (window.Telegram && window.Telegram.WebApp && window.Telegram.WebApp.HapticFeedback) window.Telegram.WebApp.HapticFeedback.notificationOccurred('success');
                    } else if (mult >= 2) {
                        if (window.Telegram && window.Telegram.WebApp && window.Telegram.WebApp.HapticFeedback) window.Telegram.WebApp.HapticFeedback.impactOccurred('light');
                    }
                    /* Highlight bucket */
                    var bucketEls = document.querySelectorAll('#plinkoBuckets > div');
                    if (bucketEls[bucketIdx]) {
                        bucketEls[bucketIdx].style.transform = 'scale(1.15)';
                        bucketEls[bucketIdx].style.transition = 'transform .2s';
                        setTimeout(function () { bucketEls[bucketIdx].style.transform = 'scale(1)'; }, 300);
                    }
                }
            });
            /* Clean up done balls */
            plinkoBalls = plinkoBalls.filter(function (b) { return !b.done || b.y < plinkoH + 20 });
            drawPlinko();
            if (!allDone) {
                plinkoAnimId = requestAnimationFrame(animatePlinko);
            } else {
                plinkoAnimId = null;
            }
        }

        /* Plinko popups */
        function openPlinkoRules() {
            var p = document.getElementById('plinkoRulesPopup');
            if (p) p.style.display = 'flex';
        }
        function closePlinkoRules() {
            var p = document.getElementById('plinkoRulesPopup');
            if (p) p.style.display = 'none';
        }
        function openPlinkoLeaderboard() {
            var p = document.getElementById('plinkoLeaderPopup');
            if (p) p.style.display = 'flex';
        }
        function closePlinkoLeaderboard() {
            var p = document.getElementById('plinkoLeaderPopup');
            if (p) p.style.display = 'none';
        }
        function buildPlinkoLeaderboard() {
            var el = document.getElementById('plinkoLeaderList');
            if (!el) return;
            var demo = [
                { name: 'Cry***66', mult: 100, win: 5000, color: '#FFD700' },
                { name: 'Win***92', mult: 10, win: 1000, color: '#C0C0C0' },
                { name: 'Ton***99', mult: 5, win: 500, color: '#CD7F32' },
                { name: 'Luc***77', mult: 2, win: 200, color: '#6366f1' },
                { name: 'Max***33', mult: 10, win: 750, color: '#14b8a6' }
            ];
            el.innerHTML = demo.map(function (d, i) {
                var rank = i + 1;
                var medal = rank <= 3 ? ['ðŸ¥‡', 'ðŸ¥ˆ', 'ðŸ¥‰'][rank - 1] : rank;
                return '<div style="display:flex;align-items:center;gap:10px;padding:10px;background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);margin-bottom:6px">'
                    + '<div style="width:28px;text-align:center;font-size:14px">' + medal + '</div>'
                    + '<div style="width:32px;height:32px;border-radius:50%;background:' + d.color + ';display:flex;align-items:center;justify-content:center;font-size:10px;font-weight:800">' + d.name.substring(0, 2) + '</div>'
                    + '<div style="flex:1"><div style="font-size:12px;font-weight:700">' + d.name + '</div><div style="font-size:10px;color:var(--dim)">' + d.mult + 'x multiplier</div></div>'
                    + '<div style="font-size:13px;font-weight:800;color:var(--green);font-family:Montserrat,sans-serif">+' + d.win + ' â­</div>'
                    + '</div>';
            }).join('');
        }

        /* Plinko Bonus & Stars JS Hooks */
        function openPlinkoBuyBonus() {
            var el = document.getElementById('plinkoBuyBonusPopup');
            if (el) {
                document.getElementById('buyBonusBalance').textContent = starsBalance + ' STARS';
                el.style.display = 'flex';
            }
        }
        function closePlinkoBuyBonus() {
            var el = document.getElementById('plinkoBuyBonusPopup');
            if (el) el.style.display = 'none';
        }
        function buyPlinkoBonus(cost, type) {
            if (starsBalance < cost) {
                closePlinkoBuyBonus();
                openPlinkoStars();
                return;
            }
            starsBalance -= cost;
            updateBalanceUI();
            closePlinkoBuyBonus();
            if (window.Telegram && window.Telegram.WebApp && window.Telegram.WebApp.HapticFeedback) window.Telegram.WebApp.HapticFeedback.notificationOccurred('success');

            if (type === 'super') {
                plinkoBetIdx = PLINKO_BET_STEPS.length - 1; // max bet
                updatePlinkoBetDisplay();
                dropPlinkoBall(); // One drops automatically
            } else if (type === 'frenzy') {
                var drops = 0;
                var frenzyInt = setInterval(function () {
                    dropPlinkoBall();
                    drops++;
                    if (drops >= 5) clearInterval(frenzyInt);
                }, 200);
            } else if (type === 'jackpot') {
                // High volatility mode simulation
                showToast('ðŸ’Ž', 'Jackpot Chance Activated!', 'OK', '', function () { closeToast() });
                dropPlinkoBall();
            }
        }

        /* Stars Top-Up */
        var selectedStarCost = 1.99;
        var selectedStarAmt = 100;
        function openPlinkoStars() {
            var el = document.getElementById('plinkoStarsPopup');
            if (el) {
                document.getElementById('topupCurrentBalance').textContent = starsBalance;
                el.style.display = 'block';
            }
        }
        function closePlinkoStars() {
            var el = document.getElementById('plinkoStarsPopup');
            if (el) el.style.display = 'none';
        }
        function selectStarPack(stars, cost, el) {
            selectedStarAmt = stars;
            selectedStarCost = cost;
            var packs = document.querySelectorAll('.star-pack');
            packs.forEach(p => {
                p.classList.remove('active');
                p.style.border = '1px solid #333';
            });
            el.classList.add('active');
            el.style.border = '2px solid var(--red)';
            document.getElementById('btnBuyStars').innerHTML = '<span class="material-symbols-outlined" style="font-size:20px">send</span> Buy ' + stars + ' Stars for $' + cost;
        }
        function confirmStarPurchase() {
            if (window.Telegram && window.Telegram.WebApp && window.Telegram.WebApp.HapticFeedback) window.Telegram.WebApp.HapticFeedback.impactOccurred('heavy');
            showToast('â³', 'Processing payment...', 'OK', '', function () { closeToast() });
            setTimeout(function () {
                starsBalance += selectedStarAmt;
                updateBalanceUI();
                closePlinkoStars();
                showToast('âœ…', 'Purchased ' + selectedStarAmt + ' Stars!', 'OK', '', function () { closeToast() });
            }, 1500);
        }

        /* Epic Win Celebration */
        function showEpicWin(amt, mult) {
            var el = document.getElementById('plinkoEpicWinPopup');
            if (!el) return;
            document.getElementById('epicWinAmount').textContent = amt.toLocaleString();
            document.getElementById('epicWinMult').textContent = mult + 'X MULTIPLIER';
            el.style.display = 'flex';
            if (window.Telegram && window.Telegram.WebApp && window.Telegram.WebApp.HapticFeedback) window.Telegram.WebApp.HapticFeedback.notificationOccurred('success');
        }
        function closeEpicWin() {
            var el = document.getElementById('plinkoEpicWinPopup');
            if (el) el.style.display = 'none';
        }

        /* Override nav function again to hook Plinko screen buttons if needed */
    </script>
</body>

</html>