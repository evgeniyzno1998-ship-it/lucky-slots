<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Lucky Slots</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<style>
@import url('https://fonts.googleapis.com/css2?family=Fredoka+One&family=Nunito:wght@400;700;900&display=swap');

:root {
  --bg1: #1a0533;
  --bg2: #2d0a5e;
  --gold: #ffd700;
  --gold2: #ffaa00;
  --pink: #ff4da6;
  --cyan: #00f5d4;
  --purple: #9b59b6;
  --win: #00e676;
  --lose: #ff5252;
}

* { margin:0; padding:0; box-sizing:border-box; -webkit-tap-highlight-color:transparent; }

body {
  background: radial-gradient(ellipse at top, var(--bg2), var(--bg1) 70%);
  min-height: 100vh;
  font-family: 'Nunito', sans-serif;
  color: #fff;
  overflow-x: hidden;
  user-select: none;
}

/* Floating stars background */
.stars {
  position: fixed; inset: 0; pointer-events: none; z-index: 0; overflow: hidden;
}
.star {
  position: absolute;
  border-radius: 50%;
  background: #fff;
  animation: twinkle var(--d) ease-in-out infinite alternate;
  opacity: 0;
}
@keyframes twinkle {
  from { opacity: 0; transform: scale(0.5); }
  to   { opacity: 0.7; transform: scale(1.2); }
}

.game-wrap {
  position: relative; z-index: 1;
  max-width: 420px;
  margin: 0 auto;
  padding: 16px 12px 24px;
  display: flex;
  flex-direction: column;
  gap: 14px;
}

/* Header */
.header {
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.logo {
  font-family: 'Fredoka One', sans-serif;
  font-size: 26px;
  background: linear-gradient(135deg, var(--gold), var(--pink));
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  text-shadow: none;
  filter: drop-shadow(0 0 8px rgba(255,215,0,0.4));
}

.balance-box {
  background: rgba(255,255,255,0.08);
  border: 1px solid rgba(255,215,0,0.3);
  border-radius: 20px;
  padding: 6px 14px;
  display: flex;
  align-items: center;
  gap: 6px;
}

.balance-icon { font-size: 16px; }
.balance-val {
  font-family: 'Fredoka One', sans-serif;
  font-size: 18px;
  color: var(--gold);
}

/* Reels container */
.reels-outer {
  background: rgba(0,0,0,0.4);
  border: 2px solid rgba(255,215,0,0.25);
  border-radius: 24px;
  padding: 16px 10px;
  position: relative;
  overflow: hidden;
}

.reels-outer::before {
  content: '';
  position: absolute;
  inset: 0;
  background: linear-gradient(180deg,
    rgba(0,0,0,0.5) 0%,
    transparent 20%,
    transparent 80%,
    rgba(0,0,0,0.5) 100%
  );
  pointer-events: none;
  z-index: 2;
}

/* Win line highlight */
.win-line {
  position: absolute;
  top: 50%; left: 0; right: 0;
  height: 90px;
  transform: translateY(-50%);
  border-top: 2px solid transparent;
  border-bottom: 2px solid transparent;
  z-index: 3;
  transition: border-color 0.3s;
  pointer-events: none;
}
.win-line.active {
  border-color: var(--gold);
  box-shadow: 0 0 20px rgba(255,215,0,0.3);
}

.reels {
  display: flex;
  justify-content: center;
  gap: 8px;
  position: relative;
  z-index: 1;
}

.reel {
  width: 80px;
  height: 270px;
  overflow: hidden;
  border-radius: 14px;
  background: rgba(255,255,255,0.04);
  border: 1px solid rgba(255,255,255,0.1);
  position: relative;
}

.reel-strip {
  display: flex;
  flex-direction: column;
  transition: transform 0.0s;
}

.reel-strip.spinning {
  animation: none;
}

.symbol {
  width: 80px;
  height: 90px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 44px;
  flex-shrink: 0;
  position: relative;
}

.symbol.winning {
  animation: winPulse 0.5s ease-in-out infinite alternate;
}

@keyframes winPulse {
  from { transform: scale(1); filter: brightness(1); }
  to   { transform: scale(1.15); filter: brightness(1.4) drop-shadow(0 0 12px gold); }
}

/* Multiplier display */
.mult-display {
  text-align: center;
  height: 36px;
  display: flex;
  align-items: center;
  justify-content: center;
}

.mult-text {
  font-family: 'Fredoka One', sans-serif;
  font-size: 22px;
  opacity: 0;
  transform: scale(0.5);
  transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
}

.mult-text.show {
  opacity: 1;
  transform: scale(1);
}

.mult-text.win  { color: var(--win); text-shadow: 0 0 20px var(--win); }
.mult-text.lose { color: var(--lose); }
.mult-text.push { color: var(--gold); }

/* Bet controls */
.bet-section {
  background: rgba(255,255,255,0.05);
  border-radius: 20px;
  padding: 14px;
}

.bet-label {
  font-size: 12px;
  color: rgba(255,255,255,0.5);
  text-transform: uppercase;
  letter-spacing: 1px;
  margin-bottom: 10px;
  text-align: center;
}

.bet-buttons {
  display: flex;
  gap: 8px;
  justify-content: center;
}

.bet-btn {
  flex: 1;
  padding: 10px 0;
  border-radius: 12px;
  border: 2px solid rgba(255,215,0,0.3);
  background: rgba(255,215,0,0.08);
  color: var(--gold);
  font-family: 'Fredoka One', sans-serif;
  font-size: 16px;
  cursor: pointer;
  transition: all 0.2s;
  max-width: 90px;
}

.bet-btn:hover, .bet-btn.active {
  background: rgba(255,215,0,0.25);
  border-color: var(--gold);
  transform: translateY(-2px);
  box-shadow: 0 4px 16px rgba(255,215,0,0.2);
}

/* Spin button */
.spin-btn {
  width: 100%;
  padding: 18px;
  border-radius: 20px;
  border: none;
  background: linear-gradient(135deg, #ff4da6, #ff9500);
  color: #fff;
  font-family: 'Fredoka One', sans-serif;
  font-size: 24px;
  cursor: pointer;
  letter-spacing: 1px;
  transition: all 0.2s;
  box-shadow: 0 6px 24px rgba(255,77,166,0.4);
  position: relative;
  overflow: hidden;
}

.spin-btn::after {
  content: '';
  position: absolute;
  inset: 0;
  background: linear-gradient(135deg, rgba(255,255,255,0.2), transparent);
}

.spin-btn:active { transform: scale(0.97); }
.spin-btn:disabled {
  background: linear-gradient(135deg, #555, #333);
  box-shadow: none;
  cursor: not-allowed;
}

.spin-btn.spinning {
  animation: spinBtnPulse 0.6s ease-in-out infinite alternate;
}

@keyframes spinBtnPulse {
  from { box-shadow: 0 6px 24px rgba(255,77,166,0.4); }
  to   { box-shadow: 0 6px 40px rgba(255,77,166,0.8); }
}

/* History */
.history-section {
  background: rgba(255,255,255,0.04);
  border-radius: 20px;
  padding: 14px;
}

.history-title {
  font-size: 12px;
  color: rgba(255,255,255,0.4);
  text-transform: uppercase;
  letter-spacing: 1px;
  margin-bottom: 10px;
}

.history-list {
  display: flex;
  flex-direction: column;
  gap: 6px;
}

.history-item {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 8px 10px;
  border-radius: 10px;
  background: rgba(255,255,255,0.04);
  font-size: 13px;
  animation: slideIn 0.3s ease;
}

@keyframes slideIn {
  from { opacity: 0; transform: translateX(-10px); }
  to   { opacity: 1; transform: translateX(0); }
}

.h-symbols { font-size: 16px; letter-spacing: 2px; }
.h-result { font-weight: 700; }
.h-result.win  { color: var(--win); }
.h-result.lose { color: var(--lose); opacity: 0.7; }
.h-result.push { color: var(--gold); }

/* Win overlay */
.win-overlay {
  position: fixed; inset: 0;
  display: flex; align-items: center; justify-content: center;
  z-index: 100;
  pointer-events: none;
  opacity: 0;
  transition: opacity 0.3s;
}

.win-overlay.show { opacity: 1; }

.win-popup {
  background: radial-gradient(ellipse, #2d0a5e, #1a0533);
  border: 3px solid var(--gold);
  border-radius: 30px;
  padding: 30px 50px;
  text-align: center;
  box-shadow: 0 0 60px rgba(255,215,0,0.5);
  animation: popIn 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
}

@keyframes popIn {
  from { transform: scale(0.3) rotate(-10deg); opacity: 0; }
  to   { transform: scale(1) rotate(0deg); opacity: 1; }
}

.win-popup-emoji { font-size: 56px; margin-bottom: 8px; }
.win-popup-title {
  font-family: 'Fredoka One', sans-serif;
  font-size: 32px;
  color: var(--gold);
  text-shadow: 0 0 20px var(--gold);
  margin-bottom: 4px;
}
.win-popup-amount {
  font-family: 'Fredoka One', sans-serif;
  font-size: 48px;
  color: var(--win);
  text-shadow: 0 0 30px var(--win);
}

/* Confetti particle */
.confetti {
  position: fixed;
  width: 10px; height: 10px;
  border-radius: 2px;
  pointer-events: none;
  z-index: 99;
  animation: confettiFall var(--dur) ease-in forwards;
}

@keyframes confettiFall {
  0%   { transform: translateY(-20px) rotate(0deg); opacity: 1; }
  100% { transform: translateY(100vh) rotate(720deg); opacity: 0; }
}

/* Paytable */
.paytable {
  background: rgba(255,255,255,0.04);
  border-radius: 20px;
  padding: 14px;
}

.paytable-title {
  font-size: 12px;
  color: rgba(255,255,255,0.4);
  text-transform: uppercase;
  letter-spacing: 1px;
  margin-bottom: 10px;
}

.paytable-grid {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 6px;
}

.pt-item {
  background: rgba(255,255,255,0.05);
  border-radius: 10px;
  padding: 8px 4px;
  text-align: center;
}

.pt-sym { font-size: 24px; }
.pt-mult { font-size: 12px; color: var(--gold); font-weight: 700; margin-top: 2px; }
</style>
</head>
<body>

<div class="stars" id="stars"></div>

<div class="win-overlay" id="winOverlay">
  <div class="win-popup">
    <div class="win-popup-emoji">üéâ</div>
    <div class="win-popup-title">WYGRANA!</div>
    <div class="win-popup-amount" id="winAmount">+50</div>
  </div>
</div>

<div class="game-wrap">
  <div class="header">
    <div class="logo">üé∞ Lucky Slots</div>
    <div class="balance-box">
      <span class="balance-icon">ü™ô</span>
      <span class="balance-val" id="balanceVal">‚Äî</span>
    </div>
  </div>

  <!-- Reels -->
  <div class="reels-outer">
    <div class="win-line" id="winLine"></div>
    <div class="reels" id="reels">
      <div class="reel" id="reel0"><div class="reel-strip" id="strip0"></div></div>
      <div class="reel" id="reel1"><div class="reel-strip" id="strip1"></div></div>
      <div class="reel" id="reel2"><div class="reel-strip" id="strip2"></div></div>
    </div>
  </div>

  <div class="mult-display">
    <div class="mult-text" id="multText"></div>
  </div>

  <!-- Bet -->
  <div class="bet-section">
    <div class="bet-label">Stawka (≈ºetony)</div>
    <div class="bet-buttons">
      <button class="bet-btn active" data-bet="5" onclick="selectBet(5)">5</button>
      <button class="bet-btn" data-bet="10" onclick="selectBet(10)">10</button>
      <button class="bet-btn" data-bet="25" onclick="selectBet(25)">25</button>
    </div>
  </div>

  <button class="spin-btn" id="spinBtn" onclick="spin()">üé∞ ZAKRƒòƒÜ!</button>

  <!-- History -->
  <div class="history-section">
    <div class="history-title">Ostatnie spiny</div>
    <div class="history-list" id="historyList">
      <div style="text-align:center;color:rgba(255,255,255,0.3);font-size:13px">Brak historii</div>
    </div>
  </div>

  <!-- Paytable -->
  <div class="paytable">
    <div class="paytable-title">Tabela wyp≈Çat (3 takie same)</div>
    <div class="paytable-grid">
      <div class="pt-item"><div class="pt-sym">üçí</div><div class="pt-mult">x2</div></div>
      <div class="pt-item"><div class="pt-sym">üçã</div><div class="pt-mult">x3</div></div>
      <div class="pt-item"><div class="pt-sym">üçä</div><div class="pt-mult">x4</div></div>
      <div class="pt-item"><div class="pt-sym">üçá</div><div class="pt-mult">x6</div></div>
      <div class="pt-item"><div class="pt-sym">üíé</div><div class="pt-mult">x10</div></div>
      <div class="pt-item"><div class="pt-sym">7Ô∏è‚É£</div><div class="pt-mult">x20</div></div>
    </div>
    <div style="margin-top:8px;text-align:center;font-size:12px;color:rgba(255,255,255,0.4)">
      Para (2 takie same) = zwrot stawki
    </div>
  </div>
</div>

<script>
// ==================== TELEGRAM WEBAPP ====================
const tg = window.Telegram?.WebApp;
if (tg) {
  tg.ready();
  tg.expand();
  tg.setHeaderColor('#1a0533');
  tg.setBackgroundColor('#1a0533');
}

// ==================== GAME CONFIG ====================
const SYMBOLS   = ['üçí','üçã','üçä','üçá','üíé','7Ô∏è‚É£'];
const WEIGHTS   = [30, 25, 20, 15, 7, 3];
const PAYOUTS   = { 'üçí':2, 'üçã':3, 'üçä':4, 'üçá':6, 'üíé':10, '7Ô∏è‚É£':20 };
const COLORS    = ['#ff6b6b','#ffd93d','#ff9500','#a855f7','#00f5d4','#ffd700'];

let balance  = 100;   // –°—Ç–∞—Ä—Ç–æ–≤—ã–π –±–∞–ª–∞–Ω—Å (–¥–ª—è —Ç–µ—Å—Ç–∞)
let bet      = 5;
let spinning = false;
let history  = [];

// –ü–æ–ª—É—á–∞–µ–º –±–∞–ª–∞–Ω—Å –∏–∑ Telegram initData (–≤ —Ä–µ–∞–ª—å–Ω–æ–º –¥–µ–ø–ª–æ–µ)
const initData = tg?.initDataUnsafe;
const userId   = initData?.user?.id;

// ==================== STARS ====================
function createStars() {
  const container = document.getElementById('stars');
  for (let i = 0; i < 60; i++) {
    const s = document.createElement('div');
    s.className = 'star';
    const size = Math.random() * 3 + 1;
    s.style.cssText = `
      width:${size}px; height:${size}px;
      left:${Math.random()*100}%;
      top:${Math.random()*100}%;
      --d:${(Math.random()*3+1).toFixed(1)}s;
      animation-delay:${(Math.random()*3).toFixed(1)}s;
    `;
    container.appendChild(s);
  }
}

// ==================== REELS ====================
function buildStrip(id, symbols) {
  const strip = document.getElementById('strip' + id);
  strip.innerHTML = '';
  symbols.forEach(sym => {
    const div = document.createElement('div');
    div.className = 'symbol';
    div.textContent = sym;
    strip.appendChild(div);
  });
}

function randomSymbol() {
  const total = WEIGHTS.reduce((a,b) => a+b, 0);
  let r = Math.random() * total;
  for (let i = 0; i < SYMBOLS.length; i++) {
    r -= WEIGHTS[i];
    if (r <= 0) return SYMBOLS[i];
  }
  return SYMBOLS[0];
}

function initReels() {
  for (let i = 0; i < 3; i++) {
    const syms = Array.from({length: 5}, () => randomSymbol());
    buildStrip(i, syms);
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Ä–µ–¥–Ω–∏–π —Å–∏–º–≤–æ–ª
    const strip = document.getElementById('strip' + i);
    strip.style.transform = 'translateY(-180px)';
  }
}

// ==================== SPIN LOGIC ====================
function weightedRandom() {
  return randomSymbol();
}

function calcResult(reels) {
  const [a, b, c] = reels;
  if (a === b && b === c) return { type: 'three', mult: PAYOUTS[a], sym: a };
  if (a === b || b === c || a === c) return { type: 'pair', mult: 1 };
  return { type: 'none', mult: 0 };
}

function selectBet(val) {
  bet = val;
  document.querySelectorAll('.bet-btn').forEach(btn => {
    btn.classList.toggle('active', parseInt(btn.dataset.bet) === val);
  });
}

async function spin() {
  if (spinning) return;
  if (balance < bet) {
    showMessage('NiewystarczajƒÖce ≈ºetony! Kup wiƒôcej üëá', 'lose');
    if (tg) tg.HapticFeedback.notificationOccurred('error');
    return;
  }

  spinning = true;
  const spinBtn = document.getElementById('spinBtn');
  spinBtn.disabled = true;
  spinBtn.classList.add('spinning');
  spinBtn.textContent = '‚è≥ Krƒôcƒô...';
  setMultText('', '');

  // Generate final symbols
  const finalSyms = [weightedRandom(), weightedRandom(), weightedRandom()];

  // Animate reels
  const promises = [0, 1, 2].map((i) => animateReel(i, finalSyms[i], i * 300));
  await Promise.all(promises);

  // Calculate result
  const result = calcResult(finalSyms);
  let winnings = 0;
  if (result.type === 'three') winnings = bet * result.mult;
  else if (result.type === 'pair') winnings = bet;

  // Send to API ‚Äî API –∞—Ç–æ–º–∞—Ä–Ω–æ —Å–ø–∏—Å—ã–≤–∞–µ—Ç –∏ –∑–∞—á–∏—Å–ª—è–µ—Ç, –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ä–µ–∞–ª—å–Ω—ã–π –±–∞–ª–∞–Ω—Å
  const ok = await recordSpin(finalSyms, winnings, bet);

  if (ok === false) {
    // –ë–∞–ª–∞–Ω—Å –∫–æ–Ω—á–∏–ª—Å—è –ø–æ–∫–∞ –∫—Ä—É—Ç–∏–ª–∏ ‚Äî –≤–æ–∑–≤—Ä–∞—â–∞–µ–º —Å—Ç–∞–≤–∫—É –ª–æ–∫–∞–ª—å–Ω–æ
    setMultText('‚ùå B≈ÇƒÖd balansu!', 'lose');
    spinBtn.disabled = false;
    spinBtn.classList.remove('spinning');
    spinBtn.textContent = 'üé∞ ZAKRƒòƒÜ!';
    spinning = false;
    return;
  }

  // –ï—Å–ª–∏ dev mode ‚Äî –æ–±–Ω–æ–≤–ª—è–µ–º –ª–æ–∫–∞–ª—å–Ω–æ
  if (!initDataRaw) {
    balance -= bet;
    balance += winnings;
    updateBalance();
  }

  if (result.type === 'three') {
    setMultText(`üéâ x${result.mult} ‚Äî +${winnings} ≈ºet.`, 'win');
    highlightWinning(finalSyms, result.sym);
    if (tg) tg.HapticFeedback.notificationOccurred('success');
    showWinOverlay(winnings);
    confetti();
  } else if (result.type === 'pair') {
    setMultText('‚ú® Para! Zwrot stawki.', 'push');
    if (tg) tg.HapticFeedback.impactOccurred('medium');
  } else {
    setMultText(`üòî -${bet} ≈ºeton√≥w`, 'lose');
    if (tg) tg.HapticFeedback.notificationOccurred('error');
  }

  addHistory(finalSyms, winnings, bet);

  spinBtn.disabled = false;
  spinBtn.classList.remove('spinning');
  spinBtn.textContent = 'üé∞ ZAKRƒòƒÜ!';
  spinning = false;
}

function animateReel(reelIdx, finalSym, delay) {
  return new Promise(resolve => {
    setTimeout(async () => {
      const strip = document.getElementById('strip' + reelIdx);

      // Build long strip with random symbols + final at position 3
      const spinSyms = [];
      for (let i = 0; i < 20; i++) spinSyms.push(randomSymbol());
      spinSyms.push(randomSymbol()); // top dummy
      spinSyms.push(finalSym);       // CENTER ‚Äî this is what we show
      spinSyms.push(randomSymbol()); // bottom dummy

      strip.style.transition = 'none';
      strip.innerHTML = '';
      spinSyms.forEach(sym => {
        const div = document.createElement('div');
        div.className = 'symbol';
        div.textContent = sym;
        strip.appendChild(div);
      });

      // Start from top
      strip.style.transform = 'translateY(0px)';

      // Animate to show center symbol (index 21 = finalSym)
      // Each symbol is 90px tall, center symbol at index 21
      // We want center of reel (135px) to align with symbol center (21*90 + 45 = 1935)
      // offset = 1935 - 135 = 1800
      await new Promise(r => requestAnimationFrame(r));
      await new Promise(r => requestAnimationFrame(r));

      const targetOffset = -(spinSyms.length - 3) * 90 + 90;

      strip.style.transition = `transform ${0.8 + reelIdx * 0.15}s cubic-bezier(0.17, 0.67, 0.35, 1.0)`;
      strip.style.transform = `translateY(${targetOffset}px)`;

      strip.addEventListener('transitionend', () => {
        // Rebuild clean strip
        buildStrip(reelIdx, [randomSymbol(), finalSym, randomSymbol()]);
        strip.style.transition = 'none';
        strip.style.transform = 'translateY(-90px)';
        resolve();
      }, { once: true });

    }, delay);
  });
}

function highlightWinning(reels, winningSym) {
  document.querySelectorAll('.symbol').forEach(el => {
    if (el.textContent.trim() === winningSym) {
      el.classList.add('winning');
    }
  });
  document.getElementById('winLine').classList.add('active');
  setTimeout(() => {
    document.querySelectorAll('.symbol').forEach(el => el.classList.remove('winning'));
    document.getElementById('winLine').classList.remove('active');
  }, 3000);
}

// ==================== UI HELPERS ====================
function updateBalance() {
  document.getElementById('balanceVal').textContent = balance;
}

function setMultText(text, cls) {
  const el = document.getElementById('multText');
  el.classList.remove('show', 'win', 'lose', 'push');
  el.textContent = text;
  if (text) {
    setTimeout(() => { el.classList.add('show', cls); }, 50);
  }
}

function showMessage(text, cls) {
  setMultText(text, cls);
}

function addHistory(reels, winnings, bet) {
  const item = { reels, winnings, bet };
  history.unshift(item);
  if (history.length > 5) history.pop();
  renderHistory();
}

function renderHistory() {
  const list = document.getElementById('historyList');
  if (!history.length) {
    list.innerHTML = '<div style="text-align:center;color:rgba(255,255,255,0.3);font-size:13px">Brak historii</div>';
    return;
  }
  list.innerHTML = history.map(item => {
    let cls, text;
    const net = item.winnings - item.bet;
    if (item.winnings > item.bet) { cls = 'win'; text = `+${net}`; }
    else if (item.winnings === item.bet) { cls = 'push'; text = '¬±0'; }
    else { cls = 'lose'; text = `-${item.bet}`; }
    return `
      <div class="history-item">
        <span class="h-symbols">${item.reels.join(' ')}</span>
        <span class="h-result ${cls}">${text} ≈ºet.</span>
      </div>`;
  }).join('');
}

function showWinOverlay(amount) {
  const overlay = document.getElementById('winOverlay');
  document.getElementById('winAmount').textContent = `+${amount} ≈ºet.`;
  overlay.classList.add('show');
  setTimeout(() => overlay.classList.remove('show'), 2200);
}

function confetti() {
  const colors = ['#ffd700','#ff4da6','#00f5d4','#ff9500','#a855f7','#fff'];
  for (let i = 0; i < 60; i++) {
    setTimeout(() => {
      const el = document.createElement('div');
      el.className = 'confetti';
      el.style.cssText = `
        left:${Math.random()*100}vw;
        top:-10px;
        background:${colors[Math.floor(Math.random()*colors.length)]};
        width:${Math.random()*10+5}px;
        height:${Math.random()*10+5}px;
        --dur:${(Math.random()*2+1.5).toFixed(1)}s;
        border-radius:${Math.random() > 0.5 ? '50%' : '2px'};
      `;
      document.body.appendChild(el);
      setTimeout(() => el.remove(), 4000);
    }, i * 30);
  }
}

// ==================== API INTEGRATION ====================
// –ó–∞–º–µ–Ω–∏ –Ω–∞ URL —Ç–≤–æ–µ–≥–æ —Å–µ—Ä–≤–µ—Ä–∞ –∫–æ–≥–¥–∞ –∑–∞–¥–µ–ø–ª–æ–∏—à—å –±–æ—Ç–∞ –Ω–∞ VPS
// –ü–æ–∫–∞ –±–æ—Ç –Ω–∞ –ª–æ–∫–∞–ª–∫–µ ‚Äî –∏—Å–ø–æ–ª—å–∑—É–µ–º ngrok –∏–ª–∏ –ø—Ä–æ—Å—Ç–æ —Ç–µ—Å—Ç–∏—Ä—É–µ–º –±–µ–∑ API
const API_BASE = window.SLOTS_API_URL || 'https://–¢–í–û–ô_–°–ï–†–í–ï–†:8081';
const initDataRaw = tg?.initData || '';

async function fetchBalance() {
  if (!initDataRaw) {
    // –†–µ–∂–∏–º —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ ‚Äî –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–µ—Å—Ç–æ–≤—ã–π –±–∞–ª–∞–Ω—Å
    console.log('Dev mode: no initData, using test balance');
    return;
  }
  try {
    const res = await fetch(`${API_BASE}/api/balance?init_data=${encodeURIComponent(initDataRaw)}`);
    const data = await res.json();
    if (data.ok) {
      balance = data.balance;
      updateBalance();
    }
  } catch(e) {
    console.warn('Balance fetch failed (dev mode?):', e.message);
  }
}

async function recordSpin(reels, winnings, bet) {
  if (!initDataRaw) return; // dev mode ‚Äî –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º

  try {
    const res = await fetch(`${API_BASE}/api/spin`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        init_data: initDataRaw,
        bet,
        winnings,
        reels
      })
    });
    const data = await res.json();
    if (data.ok) {
      balance = data.balance;
      updateBalance();
    } else if (data.error === 'Insufficient balance') {
      balance = data.balance;
      updateBalance();
      return false; // —Å–∏–≥–Ω–∞–ª —á—Ç–æ –±–∞–ª–∞–Ω—Å–∞ –Ω–µ —Ö–≤–∞—Ç–∏–ª–æ
    }
  } catch(e) {
    console.warn('Spin record failed:', e.message);
  }
  return true;
}

// ==================== INIT ====================
createStars();
initReels();
updateBalance();
fetchBalance(); // –∑–∞–≥—Ä—É–∂–∞–µ–º —Ä–µ–∞–ª—å–Ω—ã–π –±–∞–ª–∞–Ω—Å –∏–∑ –±–æ—Ç–∞
</script>
</body>
</html>
